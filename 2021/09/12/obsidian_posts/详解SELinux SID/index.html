<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.zhougy.top","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="IntroSID &#x3D; Security Identifier (即Security ID)。其作用就是取代安全上下文，在权限匹配时，提升规则搜索速度，以及降低整个策略数据的空间复杂度，提升了整个SELinux特性的性能损耗。例如一次权限匹配的函数调用原型如下：12int avc_has_perm(struct selinux_state *state, u32 ssid, u32 tsid, u1">
<meta property="og:type" content="article">
<meta property="og:title" content="详解SELinux SID">
<meta property="og:url" content="https://blog.zhougy.top/2021/09/12/obsidian_posts/%E8%AF%A6%E8%A7%A3SELinux%20SID/index.html">
<meta property="og:site_name" content="Big Ben">
<meta property="og:description" content="IntroSID &#x3D; Security Identifier (即Security ID)。其作用就是取代安全上下文，在权限匹配时，提升规则搜索速度，以及降低整个策略数据的空间复杂度，提升了整个SELinux特性的性能损耗。例如一次权限匹配的函数调用原型如下：12int avc_has_perm(struct selinux_state *state, u32 ssid, u32 tsid, u1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.zhougy.top/2021/09/12/obsidian_posts/%E8%AF%A6%E8%A7%A3SELinux%20SID/948A5192-E302-40F3-9A2D-D3C2D5B2FF75.png">
<meta property="article:published_time" content="2021-09-12T06:26:36.976Z">
<meta property="article:modified_time" content="2021-09-12T06:37:21.861Z">
<meta property="article:author" content="Ben Zhou">
<meta property="article:tag" content="SELinux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.zhougy.top/2021/09/12/obsidian_posts/%E8%AF%A6%E8%A7%A3SELinux%20SID/948A5192-E302-40F3-9A2D-D3C2D5B2FF75.png">


<link rel="canonical" href="https://blog.zhougy.top/2021/09/12/obsidian_posts/%E8%AF%A6%E8%A7%A3SELinux%20SID/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://blog.zhougy.top/2021/09/12/obsidian_posts/%E8%AF%A6%E8%A7%A3SELinux%20SID/","path":"2021/09/12/obsidian_posts/详解SELinux SID/","title":"详解SELinux SID"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>详解SELinux SID | Big Ben</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Big Ben</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一个半吊子的编码爱好者</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">Intro</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">2.</span> <span class="nav-text">initial SID</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">2.1.</span> <span class="nav-text">启动时的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">2.2.</span> <span class="nav-text">系统标签无效时</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">3.</span> <span class="nav-text">其他SID</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">5.</span> <span class="nav-text">相关工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">5.1.</span> <span class="nav-text">seinfo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">5.2.</span> <span class="nav-text">initial_contexts</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">6.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ben Zhou</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">179</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zhougy0717" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhougy0717" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:benzhou.guangyu@gmail.com" title="E-Mail → mailto:benzhou.guangyu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.zhougy.top/2021/09/12/obsidian_posts/%E8%AF%A6%E8%A7%A3SELinux%20SID/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ben Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Ben">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          详解SELinux SID
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-09-12 14:26:36 / Modified: 14:37:21" itemprop="dateCreated datePublished" datetime="2021-09-12T14:26:36+08:00">2021-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1><span id="intro">Intro</span></h1><p>SID = Security Identifier (即Security ID)。其作用就是取代安全上下文，在权限匹配时，提升规则搜索速度，以及降低整个策略数据的空间复杂度，提升了整个SELinux特性的性能损耗。<br>例如一次权限匹配的函数调用原型如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avc_has_perm</span><span class="params">(struct selinux_state *state, u32 ssid, u32 tsid, u16 tclass,</span></span></span><br><span class="line"><span class="params"><span class="function">		 u32 requested, struct common_audit_data *auditdata)</span></span></span><br></pre></td></tr></table></figure></p>
<p>其中ssid, tsid就代表了源(source)SID和目的(target)SID。在最终的av(access vector)计算中，SID被转化为context。</p>
<blockquote>
<p>什么是context？<br>context，即安全上下文，是SELinux的核心概念。形如<code>user_u:role_r:type_t:s0-s1:c0,c1-c255</code>的就是context。其中user字段和role字段用于RBAC，type字段用于TEAC，后面的s0-s1,c1-c255用于mls/mcs。而所有的这些字段，都由策略编译工具生成了整数数据，在SELinux加载策略时一并加载到内存policydb中。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context定义</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">	u32 user;</span><br><span class="line">	u32 role;</span><br><span class="line">	u32 type;</span><br><span class="line">	u32 len;        <span class="comment">/* length of string in bytes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mls_range</span> <span class="title">range</span>;</span></span><br><span class="line">	<span class="keyword">char</span> *str;	<span class="comment">/* string representation if context cannot be mapped. */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// context加载</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">context_read_and_validate</span><span class="params">(struct context *c,</span></span></span><br><span class="line"><span class="params"><span class="function">				     struct policydb *p,</span></span></span><br><span class="line"><span class="params"><span class="function">				     <span class="keyword">void</span> *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    c-&gt;user = le32_to_cpu(buf[<span class="number">0</span>]);</span><br><span class="line">    c-&gt;role = le32_to_cpu(buf[<span class="number">1</span>]);</span><br><span class="line">    c-&gt;type = le32_to_cpu(buf[<span class="number">2</span>]);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>在真正的权限匹配时，SELinux通过SID获取到对应的context，再通过context中的type属性，所搜policydb中相应的hash表找到对应的map array，并获取对应某个权限的一个bit位，来得到权限判定结果。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 搜索sidtab获取SID对应的context，并用context数据结构来计算权限</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_compute_av</span><span class="params">(struct selinux_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">			 u32 ssid,</span></span></span><br><span class="line"><span class="params"><span class="function">			 u32 tsid,</span></span></span><br><span class="line"><span class="params"><span class="function">			 u16 orig_tclass,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct av_decision *avd,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct extended_perms *xperms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    scontext = sidtab_search(sidtab, ssid);</span><br><span class="line">    ...</span><br><span class="line">    tcontext = sidtab_search(sidtab, tsid);</span><br><span class="line">    ...</span><br><span class="line">    context_struct_compute_av(policydb, scontext, tcontext, tclass, avd,</span><br><span class="line">				  xperms);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过context的type字段从policydb中获取权限数据</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">context_struct_compute_av</span><span class="params">(struct policydb *policydb,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct context *scontext,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct context *tcontext,</span></span></span><br><span class="line"><span class="params"><span class="function">				      u16 tclass,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct av_decision *avd,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct extended_perms *xperms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    sattr = flex_array_get(policydb-&gt;type_attr_map_array,</span><br><span class="line">                   scontext-&gt;type - <span class="number">1</span>);</span><br><span class="line">    tattr = flex_array_get(policydb-&gt;type_attr_map_array,</span><br><span class="line">                   tcontext-&gt;type - <span class="number">1</span>);</span><br><span class="line">    ebitmap_for_each_positive_bit(sattr, snode, i) &#123;</span><br><span class="line">        ebitmap_for_each_positive_bit(tattr, tnode, j) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">for</span> (node = avtab_search_node(&amp;policydb-&gt;te_avtab,</span><br><span class="line">                              &amp;avkey);</span><br><span class="line">                 node;</span><br><span class="line">                 node = avtab_search_node_next(node, avkey.specified)) &#123;</span><br><span class="line">                <span class="comment">// Get and assign perm data</span></span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1><span id="initial-sid">initial SID</span></h1><p>initial SID是一种比较特殊的SID。他在策略编译和SELinux启动中都扮演了非常重要的角色。通常在编译policy的时候，需要一些flask文件，例如Fedora refpolicy：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ls refpolicy-master/policy/flask/</span></span><br><span class="line">access_vectors   initial_sids     security_classes</span><br></pre></td></tr></table></figure>
<p>其中initial_sids就指定了policy二进制中所有的initial SID。内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># FLASK</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Define initial security identifiers</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">sid kernel</span><br><span class="line">sid security</span><br><span class="line">sid unlabeled</span><br><span class="line">sid fs</span><br><span class="line">sid file</span><br><span class="line">sid file_labels</span><br><span class="line">sid init</span><br><span class="line">sid any_socket</span><br><span class="line">sid port</span><br><span class="line">sid netif</span><br><span class="line">sid netmsg</span><br><span class="line">sid node</span><br><span class="line">sid igmp_packet</span><br><span class="line">sid icmp_socket</span><br><span class="line">sid tcp_socket</span><br><span class="line">sid sysctl_modprobe</span><br><span class="line">sid sysctl</span><br><span class="line">sid sysctl_fs</span><br><span class="line">sid sysctl_kernel</span><br><span class="line">sid sysctl_net</span><br><span class="line">sid sysctl_net_unix</span><br><span class="line">sid sysctl_vm</span><br><span class="line">sid sysctl_dev</span><br><span class="line">sid kmod</span><br><span class="line">sid policy</span><br><span class="line">sid scmp_packet</span><br><span class="line">sid devnull</span><br><span class="line"></span><br><span class="line"># FLASK</span><br></pre></td></tr></table></figure>
<p>参考《Building The Sample Policy》中的介绍，这些flask文件的内容将被写到最终的policy二进制文件中（即policy.conf),如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notebook-tools/build-sepolicy -o policy.conf -d ../../flask-files</span><br></pre></td></tr></table></figure><br>build-sepolicy是一个python的示例程序，他是这样处理flask文件的:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f = Flask()</span><br><span class="line">    f.parseSids(flask_dir + <span class="string">&quot;/initial_sids&quot;</span>)</span><br><span class="line">    f.parseClasses(flask_dir + <span class="string">&quot;/security_classes&quot;</span>)</span><br><span class="line">    f.parseVectors(flask_dir + <span class="string">&quot;/access_vectors&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Open the file and then create the requested policy source file</span></span><br><span class="line">    of = <span class="built_in">open</span>(outf, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> include == <span class="number">1</span>:</span><br><span class="line">        of.writelines(f.createPolicyHdr(mode))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Output header file&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cil == <span class="number">1</span>:</span><br><span class="line">        of.writelines(f.createCilPolicy(mode))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Output CIL policy&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> class_perm == <span class="number">1</span>:</span><br><span class="line">        of.writelines(f.createCilClassPerms(mode))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Output CIL class permission sets&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> sids == <span class="number">1</span>:</span><br><span class="line">        of.writelines(f.createCilInitialSIDS(mode))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Output CIL initial SIDs&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        of.writelines(f.createPolicy(mode))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Output Kernel Language policy&quot;</span>)</span><br><span class="line">    of.close()</span><br></pre></td></tr></table></figure><br>可见这些文件的内容，被写入到一个Flask对象中，而该对象的内容最终会被写入策略二进制数据。在后续的策略编译中，这些文件会被checkpolicy来处理。</p>
<blockquote>
<p><strong>initial SID的作用</strong><br><em>from “SELinux by Example: Using Security Enhanced Linux”</em><br>Some objects are labeled via an initial SID early in system initialization, <strong><em>even before the policy is loaded</em></strong>. This labeling behavior is needed, for example, to label objects such as the kernel security server and the root filesystem, which are present in the system before the first policy load. <strong><em>When the policy is eventually loaded, the initial SIDs are then associated with the appropriate security context</em></strong>.<br><strong><em>Initial SIDs are also used to prevent objects from having a missing or invalid security context, which would make it impossible for SELinux to correctly enforce access</em></strong>. Instead, SELinux associates these objects with the special unlabeled initial SID. The unlabeled initial SID should have a security context that allows only limited access, thereby preventing inappropriate access until the objects can be relabeled by the administrator or destroyed.<br>Invalid security contexts most commonly result from loading a new policy that removes users, roles, or types, or changes role or type authorizations. In this situation, the <strong><em>SIDs representing security contexts that use these invalid names or associations will become invalid and are mapped to the unlabeled SID at policy load</em></strong>. Invalid security contexts can also arise when transferring object instances between systems (for example, using removable media). Further, if the objects are created on a non-SELinux system, they will have no associated security context. Regardless of whether the security context is invalid or missing, SELinux will use the unlabeled initial SID on first access to the object as the security context.</p>
</blockquote>
<p>总结一下，一共有这几点：</p>
<ul>
<li>系统启动时，policy尚未加载，也就是所有的context还没被抽象成SID，存储在内存中的policydb里。allow规则也还没加载，这时候，为了保证代码归一，所以需要这些unlabeled SID，在SELinux启动流程中，再具体介绍。</li>
<li>当系统策略变化时，有些role，user或type被删除，导致一些安全上下文失效了，此时这些安全上下文，在策略加载时，会被映射到这些initial SID上。（这里还没找到具体的代码位置）</li>
</ul>
<h2><span id="启动时的使用">启动时的使用</span></h2><p>init进程在加载策略之前，首先将SELinux的enforcing模式打开。其打开的方式就是往selinuxfs的enforce文件写1。注意此时策略未加载，初始化也未完成。所以策略判断直接取allow。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_compute_av</span><span class="params">(struct selinux_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">			 u32 ssid,</span></span></span><br><span class="line"><span class="params"><span class="function">			 u32 tsid,</span></span></span><br><span class="line"><span class="params"><span class="function">			 u16 orig_tclass,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct av_decision *avd,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct extended_perms *xperms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span> (!state-&gt;initialized)</span><br><span class="line">		<span class="keyword">goto</span> allow;</span><br><span class="line">    ...</span><br><span class="line">allow:</span><br><span class="line">	avd-&gt;allowed = <span class="number">0xffffffff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>但由于用户态的入口是一致的，即启动完成后，用户态可以写同样的enforce文件完成SELinux状态的切换，所以为了判断此时用户态进程是否具有设置的权限，在enforce文件的入口处，对用户态进程权限进行了判定：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">length = avc_has_perm(&amp;selinux_state,</span><br><span class="line">                  current_sid(), SECINITSID_SECURITY,</span><br><span class="line">                  SECCLASS_SECURITY, SECURITY__SETENFORCE,</span><br><span class="line">                  <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><br>这里就用到了initial SID - <code>SECINITSID_SECURITY</code>。这里其实已经可以使用selinuxfs的inode.i_security.sid，但由于selinuxfs未通过系统的file open调用，所以无法使用到inode下的SID标签。</p>
<h2><span id="系统标签无效时">系统标签无效时</span></h2><p>以socket bind时，对IP地址进行权限判断为例。该权限判断流程大致如下：</p>
<p><pre class="mermaid">graph TD
A["selinux_socket_bind"]
A --> B["sock_has_perm(SOCKET__BIND)"]
B --> C["get nodecon sid by sel_netnode_sid"]
C --> D["av_has_perm"]</pre><br><code>security_node_sid</code>会从<code>policydb-&gt;ocontexts[OCON_NODE]</code>中搜索policydb中关于该IP地址的nodecon定义，如果找不着，说明此IP相关的nodecon无效（未定义），则会走默认的initial SID。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!c-&gt;sid[<span class="number">0</span>]) &#123;</span><br><span class="line">        rc = sidtab_context_to_sid(sidtab,</span><br><span class="line">                       &amp;c-&gt;context[<span class="number">0</span>],</span><br><span class="line">                       &amp;c-&gt;sid[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (rc)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    *out_sid = c-&gt;sid[<span class="number">0</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *out_sid = SECINITSID_NODE; <span class="comment">// &lt;===== intial SID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1><span id="其他sid">其他SID</span></h1><p>除了initial SID由内核直接加载生成，其他的SID则由对应的打标签流程生成。例如：文件的SID则由setfiles/restorecon工具打入文件系统的扩展属性上，socket则由socket系统调用创建时生成。<br>以socket bind为例，因为比较简单。当socket bind系统调用被执行时，一个socket object被绑定到一个node上。而此时该node的SID才被写入policydb中。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sel_netnode_sid</span><span class="params">(<span class="keyword">void</span> *addr, u16 family, u32 *sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sel_netnode</span> *<span class="title">node</span>;</span></span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	node = sel_netnode_find(addr, family);</span><br><span class="line">	<span class="keyword">if</span> (node != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		*sid = node-&gt;nsec.sid;</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sel_netnode_sid_slow(addr, family, sid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>sel_netnode_sid_slow</code>调用<code>security_node_sid</code>,并最终调用<code>sidtab_context_to_sid</code>将相关的SID以及对应的context数据结构插入到表中。</p>
<p><pre class="mermaid">graph TD
A["security_node_sid"]
A --> B["search policydb->ocontexts[OCON_NODE]"]
B --> C{"find?"}
C --> |N| B
C --> |Y| D["sidtab_context_to_sid(context，&sid)"]
D --> E("end")
C --> |Never find| F["set an initial SID"]
F --> E</pre></p>
<ul>
<li><code>security_node_sid</code>使用传入的IP地址在policydb中匹配查找context，如果找到则进行下一步，匹配或生成SID，找不到，则直接使用initial SID。</li>
<li><code>sidtab_context_to_sid</code>将context写入sidtab，并获取返回的SID记入policydb中，后续通过context找SID，直接匹配<code>policydb-&gt;ocontexts[OCON_NODE];</code>即可。对于SID本身的生成也很简单，就是一个单向增长的整形数字，在<code>sidtab_context_to_sid</code>中。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sid = sidtab_search_context(s, context);</span><br><span class="line"><span class="keyword">if</span> (sid)</span><br><span class="line">    <span class="keyword">goto</span> unlock_out;</span><br><span class="line">...</span><br><span class="line">sid = s-&gt;next_sid++;</span><br><span class="line">..</span><br><span class="line">ret = sidtab_insert(s, sid, context);</span><br></pre></td></tr></table></figure>
先尝试在sidtab中查找，如果找不到就加一条记录，并为sid赋值。<h1><span id="总结">总结</span></h1>SID在整个SELinux子系统中的作用就是提升匹配性能（从安全上下文的字符串匹配，降低到整数匹配）,所以在整个SELinux子系统生命周期内，SID总是与安全上下文（context）一一对应的。在一次权限匹配过程中，SID的使用如下：<br><img src="/2021/09/12/obsidian_posts/%E8%AF%A6%E8%A7%A3SELinux%20SID/948A5192-E302-40F3-9A2D-D3C2D5B2FF75.png" alt="7fe0cdf2b84938b1e0610fe99bd3c917"><br>context和SID的定义分别为：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">u32 sid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">	u32 user;</span><br><span class="line">	u32 role;</span><br><span class="line">	u32 type;</span><br><span class="line">	u32 len;        <span class="comment">/* length of string in bytes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mls_range</span> <span class="title">range</span>;</span></span><br><span class="line">	<span class="keyword">char</span> *str;	<span class="comment">/* string representation if context cannot be mapped. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="相关工具">相关工具</span></h1>没有一个专门的工具用来转换SID与context。但libselinux提供了相应的接口，参考<a href="https://linux.die.net/man/3/sidget">sidget(3) - Linux man page</a>。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avc_context_to_sid</span><span class="params">(<span class="keyword">security_context_t</span> ctx, <span class="keyword">security_id_t</span> *sid)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avc_sid_to_context</span><span class="params">(<span class="keyword">security_id_t</span> sid, <span class="keyword">security_context_t</span> *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<h2><span id="seinfo">seinfo</span></h2></li>
</ul>
<ol>
<li>打印所有initial SID<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[ben@localhost ~]$ seinfo --initialsid</span><br><span class="line"></span><br><span class="line">Initial SIDs: 27</span><br><span class="line">   any_socket</span><br><span class="line">   devnull</span><br><span class="line">   file</span><br><span class="line">   file_labels</span><br><span class="line">   fs</span><br><span class="line">   icmp_socket</span><br><span class="line">   igmp_packet</span><br><span class="line">   init</span><br><span class="line">   kernel</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li>打印selinuxfs context<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ben@localhost ~]$ seinfo --genfscon|grep selinux</span><br><span class="line">   genfscon selinuxfs /  system_u:object_r:security_t:s0</span><br></pre></td></tr></table></figure>
<h2><span id="initial_contexts">initial_contexts</span></h2>策略加载后，每个initial SID都有一个对应的context。这些context在各策略模块中定义。这些context在selinuxfs可以查看：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ben@localhost ~]$ sudo cat /sys/fs/selinux/initial_contexts/kernel</span><br><span class="line">system_u:system_r:kernel_t:s0</span><br></pre></td></tr></table></figure>
<h1><span id="参考文献">参考文献</span></h1></li>
</ol>
<ul>
<li><a href="https://github.com/fedora-selinux/selinux-policy">Fedora refpolicy</a></li>
<li>Frank Mayer, Karl MacMillan, David Caplan， July 27, 2006- “SELinux by Example: Using Security Enhanced Linux”</li>
<li>SELinux官方教材，”<a href="https://github.com/SELinuxProject/selinux-notebook">The SELinux Notebook</a>“ Volume II, Building The Sample Policy</li>
<li>SELinux官方教材，”<a href="https://github.com/SELinuxProject/selinux-notebook">The SELinux Notebook 4th Edition</a>“</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SELinux/" rel="tag"># SELinux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/09/obsidian_posts/RSS%20Everywhere/" rel="prev" title="RSS Everywhere">
                  <i class="fa fa-chevron-left"></i> RSS Everywhere
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/09/12/obsidian_posts/setcap%20vs.%20LD_PRELOAD/" rel="next" title="setcap vs. LD_PRELOAD">
                  setcap vs. LD_PRELOAD <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ben Zhou</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.12.0/dist/mermaid.min.js","integrity":"sha256-0dD7vUjUCTGJjeLnPotQQJIcSzug5fO6WDMYYyNIX4c="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
