{
    "version": "https://jsonfeed.org/version/1",
    "title": "Big Ben • All posts by \"linux\" tag",
    "description": null,
    "home_page_url": "https://blog.zhougy.top",
    "items": [
        {
            "id": "https://blog.zhougy.top/2021/09/12/obsidian_posts/setcap%20vs.%20LD_PRELOAD/",
            "url": "https://blog.zhougy.top/2021/09/12/obsidian_posts/setcap%20vs.%20LD_PRELOAD/",
            "title": "setcap vs. LD_PRELOAD",
            "date_published": "2021-09-12T06:29:34.553Z",
            "content_html": "<p>在Linux中，一个进程拉起另一个进程的流程大致如下：</p>\n<p><pre class=\"mermaid\">graph LR;\nF[parent process] --> A[start]\nA --fork--> B[child]\nA --> C[wait]\nB --exec--> D[new process]\nD --> E[end]\nC --> E</pre><br>最常见的就是通过shell终端执行命令。此场景下，/bin/bash就是这个parent process，而要执行的那个命令就是new process。<br>Linux有一些特性，可以使得创建出的进程比拉起的进程权限高。例如可执行文件配置了set-user-ID位，则拉起的进程就是root权限，而其父进程有可能是普通用户权限。如果可执行文件配置了file capability，则创建出的进程就具备了某些capability，如果父进程没有这些capability，则这也是一种权限放大的场景。<br>当发生这种权限放大的场景时，Linux的安全特性要求，此时子进程中的某些敏感环境变量会被清空，例如：LD_PRELOAD,LD_LIBRARY_PATH。由于这些环境变量都是从父进程继承过来的，如果不清空，则表明会使用高权限级别执行这些环境变量指定的可执行代码。</p>\n<h1 id=\"LD-LIBRARY-PATH\"><a href=\"#LD-LIBRARY-PATH\" class=\"headerlink\" title=\"LD_LIBRARY_PATH\"></a>LD_LIBRARY_PATH</h1><p>参考文献[1]，ld.so搜索动态库的顺序如下：</p>\n<ol>\n<li>DT_PATH指定的库文件（deprecated）</li>\n<li>LD_LIBRARY_PATH指定的库文件</li>\n<li>DT_RUNPATH指定的库文件</li>\n<li>/etc/ld.so.cache这个二进制文件指定的库文件，该文件通过ldconfig命令生成</li>\n<li>In the default path /lib, and then /usr/lib.  (On some 64-bit architectures, the default paths for 64-bit shared objects are /lib64, and then /usr/lib64.)  If the binary was linked with the -z nodeflib linker option, this step is skipped.</li>\n</ol>\n<p>所以针对LD_LIBRARY_PATH，除了第二条的方法失效，其他的都可以用。</p>\n<h1 id=\"LD-PRELOAD\"><a href=\"#LD-PRELOAD\" class=\"headerlink\" title=\"LD_PRELOAD\"></a>LD_PRELOAD</h1><p>那针对LD_PRELOAD，是不是就没法用呢？其实也不是。<br>在没有setcap以及set-user-ID的情况下，如果ld.so需要预加载一个库文件，指定方法在文献[1]中同样有描述：</p>\n<ol>\n<li>The <code>LD_PRELOAD</code> environment variable.</li>\n<li>The <code>--preload</code> command-line option when invoking the dynamic linker directly.</li>\n<li>The <code>/etc/ld.so.preload</code> file.</li>\n</ol>\n<p>在secure-execution模式下，方法2和方法3均不受影响。方法1也仍然可以使用。但是需要一些特殊的设置，在[1]中也有描述。</p>\n<blockquote>\n<p>In secure-execution mode, <strong>preload pathnames containing slashes are ignored</strong>.  Furthermore, shared objects are preloaded <strong>only from the standard search directories</strong> and only if <strong>they have set-user-ID mode bit enabled</strong> (which is not typical).</p>\n</blockquote>\n<p>综上，需要3点配置：</p>\n<ul>\n<li>LD_PRELOAD环境变量指定的库文件不能包含斜线’/‘</li>\n<li>库文件只会从标准路径下加载。这里标准路径可以参考LD_LIBRARY_PATH中的描述。注意，此时ld.so只会搜索标准路径，不会搜索通过其他手段配置的路径（如上一节描述的）。</li>\n<li>库文件必须使能了set-user-id位</li>\n</ul>\n<h1 id=\"示例代码\"><a href=\"#示例代码\" class=\"headerlink\" title=\"示例代码\"></a>示例代码</h1><p>代码目录树：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ben@localhost test]$ tree .</span><br><span class=\"line\">.</span><br><span class=\"line\">├── lib.c</span><br><span class=\"line\">├── libtest.so</span><br><span class=\"line\">├── main</span><br><span class=\"line\">├── main.c</span><br><span class=\"line\">├── test</span><br><span class=\"line\">└── test.c</span><br></pre></td></tr></table></figure><br>main.c生成main可执行程序，test.c生成test可执行程序，lib.c生成libtest.so。<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// main.c</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/wait.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">pid_t</span> pid = fork();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">char</span> *envp[] = &#123;</span><br><span class=\"line\">                        <span class=\"string\">&quot;LD_PRELOAD=libtest.so&quot;</span>,</span><br><span class=\"line\">                        <span class=\"comment\">// &quot;LD_PRELOAD=./libtest.so&quot;,</span></span><br><span class=\"line\">                        <span class=\"literal\">NULL</span></span><br><span class=\"line\">                &#125;;</span><br><span class=\"line\">                <span class=\"keyword\">char</span> *argv[] = &#123;</span><br><span class=\"line\">                        <span class=\"string\">&quot;test&quot;</span>,</span><br><span class=\"line\">                        <span class=\"literal\">NULL</span></span><br><span class=\"line\">                &#125;;</span><br><span class=\"line\">                <span class=\"keyword\">int</span> err = execve(<span class=\"string\">&quot;./test&quot;</span>, argv, envp);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">int</span> status;</span><br><span class=\"line\">                wait(&amp;status);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// test.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span> <span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *preload = getenv(<span class=\"string\">&quot;LD_PRELOAD&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;LD_PRELOAD = %s\\n&quot;</span>, preload);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lib.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span> __<span class=\"title\">attribute__</span><span class=\"params\">((constructor))</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;I&#x27;m libtest.so loaded\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>在test可执行程序是普通的二进制时，输出为<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ben@localhost test]$ ./main</span><br><span class=\"line\">I&#x27;m libtest.so loaded</span><br><span class=\"line\">LD_PRELOAD = ./libtest.so</span><br></pre></td></tr></table></figure><br>当test配置了capability以后：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ben@localhost test]$ sudo setcap cap_net_admin,cap_net_raw=eip ./test</span><br><span class=\"line\">[ben@localhost test]$ ./main</span><br><span class=\"line\">LD_PRELOAD = (null)</span><br></pre></td></tr></table></figure><br>可见LD_PRELOAD指定libtest.so未被加载，且LD_PRELOAD环境变量被清空了。</p>\n<h2 id=\"LD-PRELOAD不含斜线\"><a href=\"#LD-PRELOAD不含斜线\" class=\"headerlink\" title=\"LD_PRELOAD不含斜线\"></a>LD_PRELOAD不含斜线</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ben@localhost test]$ ./main</span><br><span class=\"line\">ERROR: ld.so: object &#x27;libtest.so&#x27; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</span><br><span class=\"line\">LD_PRELOAD = (null)</span><br></pre></td></tr></table></figure>\n<p>LD_PRELOAD仍然被清空了，但ld.so似乎尝试去加载libtest.so了，但是没找着。</p>\n<h2 id=\"将libtest-so放入标准路径\"><a href=\"#将libtest-so放入标准路径\" class=\"headerlink\" title=\"将libtest.so放入标准路径\"></a>将libtest.so放入标准路径</h2><p>如果没有配置set-user-id位：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ben@localhost test]$ ./main</span><br><span class=\"line\">ERROR: ld.so: object &#x27;libtest.so&#x27; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</span><br><span class=\"line\">LD_PRELOAD = (null)</span><br></pre></td></tr></table></figure><br>仍然提示找不到。如果设置了set-user-id位：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ben@localhost test]$ sudo chmod a+s /usr/lib64/libtest.so </span><br><span class=\"line\">[ben@localhost test]$ ./main</span><br><span class=\"line\">I&#x27;m libtest.so loaded</span><br><span class=\"line\">LD_PRELOAD = (null)</span><br></pre></td></tr></table></figure><br>在满足上一节提到的3个条件时，libteso.so就可以正常加载了。<br>看看如果放到/usr/lib下面会怎么样？<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ben@localhost test]$ ls /usr/lib/libtest.so -l</span><br><span class=\"line\">-rwsr-sr-x. 1 root root 8208 1月  24 19:48 /usr/lib/libtest.so</span><br><span class=\"line\">[ben@localhost test]$ ./main</span><br><span class=\"line\">ERROR: ld.so: object &#x27;libtest.so&#x27; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</span><br><span class=\"line\">LD_PRELOAD = (null)</span><br></pre></td></tr></table></figure><br>看看还是一样找不到。可见在x64平台上，/usr/lib并非标准路径，而/usr/lib64以及/lib64才是。</p>\n<h1 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h1><p>[1] <a href=\"https://man7.org/linux/man-pages/man8/ld.so.8.html\">ld.so(8) — Linux manual page</a><br>[2] <a href=\"https://stackoverflow.com/questions/18058426/does-using-linux-capabilities-disables-ld-preload\">Stackoverflow - Does using linux capabilities disables LD_PRELOAD</a></p>\n",
            "tags": [
                "Linux",
                "capability",
                "LD_PRELOAD"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2019/11/30/seccomp%E4%BB%8B%E7%BB%8D/",
            "url": "https://blog.zhougy.top/2019/11/30/seccomp%E4%BB%8B%E7%BB%8D/",
            "title": "seccomp介绍",
            "date_published": "2019-11-30T08:53:07.000Z",
            "content_html": "<div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">\n&#x672C;&#x6587;&#x4E3B;&#x8981;&#x57FA;&#x4E8E;[2], &#x63D0;&#x53D6;&#x51FA;&#x6838;&#x5FC3;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x5E76;&#x7406;&#x6E05;&#x601D;&#x8DEF;</span></div><h2 style=\"box-sizing: content-box; font-size: 34px; border-bottom: 1px solid rgb(219, 219, 219);\"><span style=\"font-size: 34px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">seccomp&#x7684;&#x524D;&#x4E16;&#x4ECA;&#x751F;</span></h2><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">seccomp&#x6700;&#x65E9;&#x51FA;&#x73B0;&#x5728;Linux kernel 2.6.12&#xFF0C;&#x65F6;&#x95F4;&#x662F;2005&#x5E74;&#x3002;2012&#x5E74;&#x7684;Linux 3.5&#x7248;&#x672C;&#xFF0C;&#x52A0;&#x5165;&#x4E86;&quot;seccomp mode 2&quot; (or &quot;seccomp filter mode&quot;)&#x529F;&#x80FD;&#x3002;</span></div><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">It added a second mode for seccomp: </span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">SECCOMP_MODE_FILTER</span><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">. Using that mode, processes can specify which system calls are permitted. By using a mini-program in the Berkeley packet filter (BPF) language, processes could restrict system calls entirely or only for certain argument values.</span></div></blockquote><div style=\"box-sizing: content-box; margin: 10px 0px;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x7528;&#x7684;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;seccomp2&#xFF0C;&#x6216;&#x8005;&#x53EB;seccomp-bpf&#x3002;&#x90A3;&#x4E48;&#x4E3A;&#x5565;&#x53EB;seccomp-bpf?BPF&#x5230;&#x5E95;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</span></div><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">\nBPF&#x5168;&#x79F0;&#x662F;Berkeley Packet Filter&#x3002;</span></div></div><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x6700;&#x521D;&#x6784;&#x60F3;&#x63D0;&#x51FA;&#x4E8E;1992&#x5E74;&#xFF0C;&#x5176;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x4F9B;&#x4E00;&#x79CD;&#x8FC7;&#x6EE4;&#x5305;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;&#x8981;&#x907F;&#x514D;&#x4ECE;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x5230;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x7684;&#x65E0;&#x7528;&#x7684;&#x6570;&#x636E;&#x5305;&#x590D;&#x5236;&#x884C;&#x4E3A;&#x3002;&#x5B83;&#x6700;&#x521D;&#x662F;&#x7531;&#x4ECE;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x6CE8;&#x5165;&#x5230;&#x5185;&#x6838;&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5B57;&#x8282;&#x7801;&#x6784;&#x6210;&#xFF0C;&#x5B83;&#x5728;&#x90A3;&#x4E2A;&#x4F4D;&#x7F6E;&#x5229;&#x7528;&#x4E00;&#x4E2A;&#x6821;&#x9A8C;&#x5668;&#x8FDB;&#x884C;&#x68C0;&#x67E5; &#x2014;&#x2014; &#x4EE5;&#x907F;&#x514D;&#x5185;&#x6838;&#x5D29;&#x6E83;&#x6216;&#x8005;&#x5B89;&#x5168;&#x95EE;&#x9898; &#x2014;&#x2014; &#x5E76;&#x9644;&#x7740;&#x5230;&#x4E00;&#x4E2A;&#x5957;&#x63A5;&#x5B57;&#x4E0A;&#x3002;&#x5176;&#x7B80;&#x5316;&#x7684;&#x8BED;&#x8A00;&#x4EE5;&#x53CA;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x6838;&#x4E2D;&#x7684;&#x5373;&#x65F6;&#x7F16;&#x8BD1;&#x5668;&#xFF08;JIT&#xFF09;&#xFF0C;&#x4F7F; BPF &#x6210;&#x4E3A;&#x4E00;&#x4E2A;&#x6027;&#x80FD;&#x5353;&#x8D8A;&#x7684;&#x5DE5;&#x5177;&#x3002;</span></div></blockquote><div style=\"box-sizing: content-box; margin: 10px 0px;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x4E3A;&#x5565;&#x8FD9;&#x4E24;&#x4E2A;&#x4E1C;&#x897F;&#x4F1A;&#x7ED1;&#x5230;&#x4E00;&#x8D77;&#x5462;&#xFF1F;</span></div><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">\n&#x56E0;&#x4E3A;seccomp&#x5728;&#x8FC7;&#x6EE4;syscall&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x501F;&#x52A9;&#x4E86;BPF&#x5B9A;&#x4E49;&#x7684;&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#xFF0C;&#x4EE5;&#x53CA;&#x5904;&#x4E8E;&#x5185;&#x6838;&#x7684;&#x7528;BPF language&#x5199;&#x7684;mini-program&#x3002;&#x6240;&#x4EE5;&#x91C7;&#x7528;&#x4E86;BPF&#x65B9;&#x6CD5;&#x5BF9;syscall&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#x7684;seccomp&#x5C31;&#x662F;seccomp-bpf&#x3002;</span></div></div><h2 style=\"box-sizing: content-box; font-size: 34px; border-bottom: 1px solid rgb(219, 219, 219);\"><span style=\"font-size: 34px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">seccomp&#x600E;&#x4E48;&#x7528;</span></h2><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">The seccomp filter system uses the Berkley Packet Filter system. Combined with argument checking and the many possible filter return values (kill, trap, trace, errno), this is allows for extensive logic.[2]</span></div></blockquote><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">[2]&#x4EE5;&#x53CA;&#x672C;&#x6587;&#x4E3B;&#x8981;&#x9610;&#x8FF0;&#x4E86;&#x6700;&#x57FA;&#x672C;&#x7684;case&#xFF0C;seccomp&#x7684;&#x9AD8;&#x9636;&#x7528;&#x6CD5;&#x53EF;&#x4EE5;&#x53C2;&#x8003;</span><a href=\"https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">seccomp&#x7684;&#x5185;&#x6838;&#x6587;&#x6863;</a><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x3002;</span></div><h3 style=\"box-sizing: content-box; font-size: 27px;\"><span style=\"font-size: 27px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">Detect seccomp</span></h3><div style=\"box-sizing: content-box; border: 0px; border-radius: 0px; margin: 2px 0px 8px; background-color: rgb(245, 247, 248);\"><div style=\"overflow-x: auto; background: rgb(30, 30, 30); box-sizing: content-box; border: 0px; border-radius: 0px; letter-spacing: -0.3px; padding: 18px; white-space: pre-wrap;\"><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">root@kube-master:~#  cat /boot/config-`uname -r` | grep CONFIG_SECCOMP</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">CONFIG_SECCOMP_FILTER=y</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">CONFIG_SECCOMP=y</span></div></div></div><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x4E5F;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x8FD9;&#x4E2A;&#x94FE;&#x63A5;&#xFF08;</span><a href=\"https://outflux.net/teach-seccomp/autodetect.html\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">Detecting seccomp features at runtime</a><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#xFF09;&#x5199;&#x4E00;&#x4E2A;Linux&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;prctl&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6765;&#x68C0;&#x6D4B;&#x3002;</span></div><h3 style=\"box-sizing: content-box; font-size: 27px;\"><span style=\"font-size: 27px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">Basic seccomp filtering</span></h3><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x57FA;&#x672C;&#x7684;SYSCALL&#x8FC7;&#x6EE4;&#x975E;&#x5E38;&#x7B80;&#x5355;&#xFF0C;&#x5927;&#x81F4;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</span></div><div style=\"box-sizing: content-box; margin: 10px 0px;\">\n        <img class=\"enMedia\" src=\"/images/seccomp&#x4ECB;&#x7ECD;/&#x5C4F;&#x5E55;&#x5FEB;&#x7167; 2020-01-05 &#x4E0B;&#x5348;10.12.13.png\" hash=\"332e39437bbfaa94a82db3d2e78cf393\" align alt longdesc width=\"836\" height=\"510\" border hspace vspace usemap style title lang xml:lang dir>\n      </div><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x540E;&#x9762;&#x4E24;&#x6B65;&#x90FD;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x53EF;&#x89C1;&#x5173;&#x952E;&#x7684;&#x662F;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5B9A;&#x4E49;SYSCALL&#x8FC7;&#x6EE4;&#x5217;&#x8868;&#x3002;</span></div><div style=\"box-sizing: content-box; border: 0px; border-radius: 0px; margin: 2px 0px 8px; background-color: rgb(245, 247, 248);\"><div style=\"overflow-x: auto; background: rgb(30, 30, 30); box-sizing: content-box; border: 0px; border-radius: 0px; letter-spacing: -0.3px; padding: 18px; white-space: pre-wrap;\"><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">struct</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(220, 220, 220); line-height: 160%;\">sock_filter</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(220, 220, 220); line-height: 160%;\">filter</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\">[] = {</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(87, 166, 74); font-style: italic; line-height: 160%;\">/* Validate architecture. */</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    VALIDATE_ARCHITECTURE,</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(87, 166, 74); font-style: italic; line-height: 160%;\">/* Grab the system call number. */</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    EXAMINE_SYSCALL,</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(87, 166, 74); font-style: italic; line-height: 160%;\">/* List allowed syscalls. */</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    ALLOW_SYSCALL(rt_sigreturn),</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    ...</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    KILL_PROCESS,</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">};</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">struct</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(220, 220, 220); line-height: 160%;\">sock_fprog</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(220, 220, 220); line-height: 160%;\">prog</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\"> = {</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    .len = (</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">unsigned</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">short</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">)(</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">sizeof</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">(filter)/</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">sizeof</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">(filter[</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(184, 215, 163); line-height: 160%;\">0</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">])),</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    .filter = filter,</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">};</span></div><div><br></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">if</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> (prctl(PR_SET_NO_NEW_PRIVS, </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(184, 215, 163); line-height: 160%;\">1</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">, </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(184, 215, 163); line-height: 160%;\">0</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">, </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(184, 215, 163); line-height: 160%;\">0</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">, </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(184, 215, 163); line-height: 160%;\">0</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">)) {</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    perror(</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(214, 157, 133); line-height: 160%;\">&quot;prctl(NO_NEW_PRIVS)&quot;</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">);</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">goto</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> failed;</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">}</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">if</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;prog)) {</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    perror(</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(214, 157, 133); line-height: 160%;\">&quot;prctl(SECCOMP)&quot;</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">);</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">goto</span><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> failed;</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">}</span></div></div></div><h3 style=\"box-sizing: content-box; font-size: 27px;\"><span style=\"font-size: 27px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">BPF</span></h3><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x8FD9;&#x91CC;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;</span><span style=\"font-size: 14px; box-sizing: content-box; border: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; padding: 4px 4px 2px 0px; letter-spacing: -0.3px; color: rgb(193, 120, 139); line-height: 160%;\">EXAMINE_SYSCALL</span><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">, </span><span style=\"font-size: 14px; box-sizing: content-box; border: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; padding: 4px 4px 2px 0px; letter-spacing: -0.3px; color: rgb(193, 120, 139); line-height: 160%;\">ALLOW_SYSCALL</span><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x548C; </span><span style=\"font-size: 14px; box-sizing: content-box; border: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; padding: 4px 4px 2px 0px; letter-spacing: -0.3px; color: rgb(193, 120, 139); line-height: 160%;\">KILL_PROCESS</span><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x90FD;&#x4E0D;&#x662F;&#x6807;&#x51C6;&#x5E93;&#x63D0;&#x4F9B;&#x7684;&#x3002;&#x770B;&#x672C;&#x9879;&#x76EE;&#x7684;</span><a href=\"https://outflux.net/teach-seccomp/step-3/seccomp-bpf.h\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">seccomp-bpf.h</a><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x3002;&#x8FD9;&#x4E9B;&#x90FD;&#x662F;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x5B8F;&#xFF1A;</span></div><div style=\"box-sizing: content-box; border: 0px; border-radius: 0px; margin: 2px 0px 8px; background-color: rgb(245, 247, 248);\"><div style=\"overflow-x: auto; background: rgb(30, 30, 30); box-sizing: content-box; border: 0px; border-radius: 0px; letter-spacing: -0.3px; padding: 18px; white-space: pre-wrap;\"><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> VALIDATE_ARCHITECTURE \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_STMT(BPF_LD+BPF_W+BPF_ABS, arch_nr), \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, ARCH_NR, 1, 0), \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL)</span></div><div><br></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> EXAMINE_SYSCALL \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_STMT(BPF_LD+BPF_W+BPF_ABS, syscall_nr)</span></div><div><br></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> ALLOW_SYSCALL(name) \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_##name, 0, 1), \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)</span></div><div><br></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> KILL_PROCESS \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL)</span></div></div></div><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x67E5;&#x770B;Linux&#x6E90;&#x7801;&#x53EF;&#x77E5;, BPF_STMT</span></div><div style=\"box-sizing: content-box; border: 0px; border-radius: 0px; margin: 2px 0px 8px; background-color: rgb(245, 247, 248);\"><div style=\"overflow-x: auto; background: rgb(30, 30, 30); box-sizing: content-box; border: 0px; border-radius: 0px; letter-spacing: -0.3px; padding: 18px; white-space: pre-wrap;\"><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">./include/uapi/linux/filter.h</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">48:#ifndef BPF_STMT</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">49:#define BPF_STMT(code, k) { (unsigned short)(code), 0, 0, k }</span></div></div></div><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">If one is &quot;feeling masochistic&quot;, they could write BPF programs numerically, but </span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">there are some constants and macros available to make it easier</span><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">. [3]</span></div></blockquote><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">BPF&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x5957;&#x6307;&#x4EE4;&#x96C6;&#x6765;&#x5B9E;&#x73B0;filter&#x529F;&#x80FD;&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x5199;&#x4E8C;&#x8FDB;&#x5236;&#xFF08;&#x6C47;&#x7F16;&#xFF09;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x91C7;&#x7528;Linux&#x62BD;&#x8C61;&#x7684;&#x5B8F;&#xFF0C;&#x66F4;&#x9AD8;&#x9636;&#x4E00;&#x70B9;&#x7684;API&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;Libseccomp&#x3002;&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x4E0D;&#x5C11;sample&#x4EE3;&#x7801;&#x3002;Android&#x4F7F;&#x7528;&#x7684;&#x662F;</span><a href=\"https://github.com/google/minijail\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">minijai</a><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x3002;</span></div><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">There are a number of tools and resources that can make it easier to work with seccomp filters and BPF. Libseccomp provides a higher-level API for creating filters. He noted that the project also has man pages (for example, seccomp_init()) with lots of examples. [3]</span></div></blockquote><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x9664;&#x4E86;&#x9AD8;&#x9636;API&#x53EF;&#x7528;&#xFF0C;[3]&#x4E2D;&#x8FD8;&#x63D0;&#x53CA;&#x4E86;&#x4E00;&#x4E9B;&#x7F16;&#x8BD1;BPF&#x6307;&#x4EE4;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</span></div><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px 0px 10px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">There is also a </span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">BPF compiler (bpfc)</span><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\"> that is part of the netsniff-ng toolkit project. LLVM has a BPF backend as of its 3.7 release that compiles a subset of C to BPF, though he noted that there is little documentation as yet.</span></div><div style=\"box-sizing: content-box; margin: 10px 0px 0px;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">Finally, the kernel has a </span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">just-in-time (JIT) compiler</span><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\"> that turns the BPF bytecode into native machine code, which can achieve 2-3x performance (or even better in some cases). The JIT compiler is disabled by default, but it can be enabled by writing a &quot;1&quot; to: </span><span style=\"font-size: 14px; box-sizing: content-box; border: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; padding: 4px 4px 2px 0px; letter-spacing: -0.3px; color: rgb(193, 120, 139); line-height: 160%;\">/proc/sys/net/core/bpf_jit_enable</span></div><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">\nKerrisk&apos;s slides have a wealth of information, including additional &gt;resources for more information.</span></div></div></blockquote><h3 style=\"box-sizing: content-box; font-size: 27px;\"><span style=\"font-size: 27px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">seccomp&#x9AD8;&#x9636;&#x7528;&#x6CD5;&#x7B80;&#x4ECB;</span></h3><div style=\"box-sizing: content-box; margin: 10px 0px;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">seccomp&#x7684;&#x9AD8;&#x9636;&#x7528;&#x6CD5;&#x8FD8;&#x662F;&#x8981;&#x53C2;&#x8003;</span><a href=\"https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">seccomp&#x7684;&#x5185;&#x6838;&#x6587;&#x6863;</a><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#xFF0C;&#x672C;&#x8282;&#x4EC5;&#x505A;&#x4E00;&#x4E9B;&#x7F57;&#x5217;&#x548C;&#x63D0;&#x793A;&#x3002;</span></div><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">\n&#x5728;[2]&#x4E2D;&#x7684;example&#x4EE3;&#x7801;&#x91CC;&#xFF0C;&#x4E0D;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x8C03;&#x7528;&#xFF0C;&#x4F1A;&#x88AB;&#x76F4;&#x63A5;kill process&#x3002;&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x8FD4;&#x56DE;&#x503C;&#xFF1A;</span></div></div><ul style=\"box-sizing: content-box; list-style-type: disc; padding-left: 30px; margin: 6px 0px 10px;\"><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_KILL_PROCESS</span></div></li><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_KILL_THREAD</span></div></li><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_TRAP</span></div></li><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_ERRNO</span></div></li><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_USER_NOTIF</span></div></li><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_TRACE</span></div></li><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_LOG</span></div></li><li style=\"box-sizing: content-box; position: relative;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">SECCOMP_RET_ALLOW</span></div></li></ul><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px 0px 10px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">If multiple filters exist, the return value for the evaluation of a given system call will always use the highest precedent value.</span></div><div style=\"box-sizing: content-box; margin: 10px 0px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">Precedence is only determined using the SECCOMP_RET_ACTION mask. When multiple filters return values of the same precedence, only the SECCOMP_RET_DATA from the most recently installed filter will be returned.</span></div></blockquote><h3 style=\"box-sizing: content-box; font-size: 27px;\"><span style=\"font-size: 27px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">&#x5751;&#xFF08;Pitfalls&#xFF09;</span></h3><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x6765;&#x81EA;[5]&#xFF0C;&#x6211;&#x53EA;&#x662F;&#x642C;&#x8FD0;&#x5DE5;</span></div><blockquote style=\"box-sizing: content-box; margin: 15px 0px; border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px;\"><div style=\"box-sizing: content-box; margin: 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">The biggest pitfall to avoid during use is filtering on system call number without checking the architecture value. Why? On any architecture that supports multiple system call invocation conventions, the system call numbers may vary based on the specific invocation. If the numbers in the different calling conventions overlap, then checks in the filters may be abused. Always check the arch value!</span></div></blockquote><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x7FFB;&#x8BD1;&#x4E00;&#x4E0B;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x610F;&#x601D;&#x662F;&#x63D0;&#x9192;seccomp&#x7684;&#x4F7F;&#x7528;&#x8005;&#xFF0C;&#x5728;&#x8BBE;&#x7F6E;filtering&#x4E4B;&#x524D;&#x8981;&#x8BB0;&#x5F97;&#x9A8C;&#x8BC1;&#x4F53;&#x7CFB;&#x67B6;&#x6784;&#xFF0C;&#x56E0;&#x4E3A;&#x4E0D;&#x540C;&#x7684;&#x4F53;&#x7CFB;&#x67B6;&#x6784;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x53EF;&#x80FD;&#x662F;&#x4E0D;&#x540C;&#x7684;&#x3002;&#x4F8B;&#x5982;[2]&#x7684;example&#x4E2D;&#x6709;&#xFF1A;</span></div><div style=\"box-sizing: content-box; border: 0px; border-radius: 0px; margin: 2px 0px 8px; background-color: rgb(245, 247, 248);\"><div style=\"overflow-x: auto; background: rgb(30, 30, 30); box-sizing: content-box; border: 0px; border-radius: 0px; letter-spacing: -0.3px; padding: 18px; white-space: pre-wrap;\"><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(86, 156, 214); line-height: 160%;\">struct</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(220, 220, 220); line-height: 160%;\">sock_filter</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(220, 220, 220); line-height: 160%;\">filter</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(184, 215, 163); line-height: 160%;\">[] = {</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(87, 166, 74); font-style: italic; line-height: 160%;\">/* Validate architecture. */</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    VALIDATE_ARCHITECTURE,</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">    ...</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">};</span></div><div><br></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(87, 166, 74); font-style: italic; line-height: 160%;\">// in seccomp-bpf.h</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> syscall_nr (offsetof(struct seccomp_data, nr))</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> arch_nr (offsetof(struct seccomp_data, arch))</span></div><div><br></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">if</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> defined(__i386__)</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"># </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> REG_SYSCALL&#xA0;&#xA0;&#xA0;&#xA0;REG_EAX</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"># </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> ARCH_NR&#xA0;&#xA0;&#xA0;&#xA0;AUDIT_ARCH_I386</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">elif</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> defined(__x86_64__)</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"># </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> REG_SYSCALL&#xA0;&#xA0;&#xA0;&#xA0;REG_RAX</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"># </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> ARCH_NR&#xA0;&#xA0;&#xA0;&#xA0;AUDIT_ARCH_X86_64</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">#<span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">else</span></span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"># </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">warning</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(214, 157, 133); line-height: 160%;\">&quot;Platform does not support seccomp filter yet&quot;</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"># </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> REG_SYSCALL&#xA0;&#xA0;&#xA0;&#xA0;0</span></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"># </span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> ARCH_NR&#xA0;&#xA0;&#xA0;&#xA0;0</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">#<span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">endif</span></span></div><div><br></div><div><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\">#</span><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">define</span><span style=\"font-size: 14px; box-sizing: content-box; color: rgb(155, 155, 155); line-height: 160%;\"> VALIDATE_ARCHITECTURE \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_STMT(BPF_LD+BPF_W+BPF_ABS, arch_nr), \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, ARCH_NR, 1, 0), \\</span></div><div><span style=\"box-sizing: content-box; font-size: 14px; color: rgb(155, 155, 155); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL)</span></div></div></div><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">seccomp_data&#x662F;&#x5565;&#xFF1F;</span></div><div style=\"box-sizing: content-box; border: 0px; border-radius: 0px; margin: 2px 0px 8px; background-color: rgb(245, 247, 248);\"><div style=\"overflow-x: auto; background: rgb(30, 30, 30); box-sizing: content-box; border: 0px; border-radius: 0px; letter-spacing: -0.3px; padding: 18px; white-space: pre-wrap;\"><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">/**</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> * struct seccomp_data - the format the BPF program executes over.</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> * @nr: the system call number</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> * @arch: indicates system call convention as an AUDIT_ARCH_* value</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> *        as defined in &lt;linux/audit.h&gt;.</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> * @instruction_pointer: at the time of the system call.</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> * @args: up to 6 system call arguments always stored as 64-bit values</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> *        regardless of the architecture.</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\"> */</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">struct seccomp_data {</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;int nr;</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;__u32 arch;</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;__u64 instruction_pointer;</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">&#xA0;&#xA0;&#xA0;&#xA0;__u64 args[6];</span></div><div><span style=\"font-size: 14px; color: rgb(244, 244, 244); line-height: 160%;\">};</span></div></div></div><div style=\"box-sizing: content-box; margin: 10px 0px;\"><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x6211;&#x7684;&#x7406;&#x89E3;&#xFF1A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;(example.c)&#x628A;sock_filter&#x7ED3;&#x6784;&#x4F53;&#x5199;&#x5165;&#x5185;&#x6838;(&#x901A;&#x8FC7;prctl)&#xFF0C;&#x4E4B;&#x540E;&#x5185;&#x6838;&#x63A5;&#x53D7;SYSCALL&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6784;&#x9020;&#x51FA;seccomp_data&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6765;&#x8C03;&#x7528;&#x8FD9;&#x4E00;&#x6BB5;BPF&#x4EE3;&#x7801;&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x8FC7;&#x6EE4;&#x7684;&#x7ED3;&#x679C;&#x3002;</span></div><h2 style=\"box-sizing: content-box; font-size: 34px; border-bottom: 1px solid rgb(219, 219, 219);\"><span style=\"font-size: 34px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">&#x603B;&#x7ED3;</span></h2><div style=\"box-sizing: content-box; margin: 10px 0px;\"><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">seccomp&#x662F;&#x5185;&#x6838;&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x79CD;SYSCALL&#x8FC7;&#x6EE4;&#x673A;&#x5236;&#xFF0C;&#x5B83;&#x57FA;&#x4E8E;BPF&#x8FC7;&#x6EE4;&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;&#x5199;&#x5165;BPF&#x8FC7;&#x6EE4;&#x5668;&#x4EE3;&#x7801;&#x6765;&#x8FBE;&#x5230;&#x8FC7;&#x6EE4;&#x7684;&#x76EE;&#x7684;&#x3002;BPF&#x89C4;&#x5219;&#x8BED;&#x8A00;&#x539F;&#x751F;&#x662F;&#x4E3A;&#x4E86;&#x8FC7;&#x6EE4;&#x7F51;&#x7EDC;&#x5305;&#xFF0C;&#x60C5;&#x666F;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x3002;&#x9488;&#x5BF9;SYSCALL&#x573A;&#x666F;&#xFF0C;&#x8BED;&#x6CD5;&#x6BD4;&#x8F83;&#x56FA;&#x5B9A;&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x64B0;&#x5199;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;Libseccomp&#x5E93;&#x63D0;&#x4F9B;&#x7684;API&#x6765;&#x7F16;&#x5199;&#x3002;</span></div><div><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">\n&#x56E0;&#x4E3A;&#x7A0B;&#x5E8F;&#x5728;fork/clone&#x6216;execve&#x65F6;&#xFF0C;BPF filter&#x4F1A;&#x4ECE;&#x7236;&#x8FDB;&#x7A0B;&#x7EE7;&#x627F;&#x5230;&#x5B50;&#x8FDB;&#x7A0B;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x60F3;&#x63A7;&#x5236;&#x7B2C;&#x4E09;&#x65B9;&#x7684;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;SYSCALL&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5728;fork/clone&#x6216;&#x8005;execve&#x65F6;&#xFF0C;&#x4F20;&#x5165;&#x5408;&#x9002;&#x7684;sock_filter&#x5373;&#x53EF;&#x3002;</span></div></div><h2 style=\"box-sizing: content-box; font-size: 34px; border-bottom: 1px solid rgb(219, 219, 219);\"><span style=\"font-size: 34px; color: rgb(51, 51, 51); font-weight: 700; line-height: 160%;\">&#x53C2;&#x8003;&#x6587;&#x732E;</span></h2><ol style=\"box-sizing: content-box; padding-left: 30px; margin: 6px 0px 10px; list-style-type: decimal;\"><li style=\"box-sizing: content-box;\"><div><a href=\"http://atum.li/2017/04/25/linuxsandbox/#linux%E4%B8%AD%E7%9A%84%E6%B2%99%E7%AE%B1%E6%8A%80%E6%9C%AF\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">linux&#x4E2D;&#x7684;&#x5BB9;&#x5668;&#x4E0E;&#x6C99;&#x7BB1;&#x521D;&#x63A2;</a></div></li><li style=\"box-sizing: content-box;\"><div><a href=\"https://outflux.net/teach-seccomp/\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">Using simple seccomp filters</a></div></li><li style=\"box-sizing: content-box;\"><div><a href=\"https://lwn.net/Articles/656307/\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">A seccomp overview</a></div></li><li style=\"box-sizing: content-box;\"><div><a href=\"https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">seccomp&#x7684;&#x5185;&#x6838;&#x6587;&#x6863;</a><span style=\"font-size: 14px; color: rgb(51, 51, 51); line-height: 160%;\">&#x3002;</span></div></li><li style=\"box-sizing: content-box;\"><div><a href=\"https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">kernel doc - Seccomp BPF (SECure COMPuting with filters)</a></div></li><li style=\"box-sizing: content-box;\"><div><a href=\"https://www.jianshu.com/p/62ede45cfb2e\" style=\"box-sizing: content-box; font-size: 14px; color: rgb(82, 134, 188); line-height: 160%; text-decoration: underline;\">Android&#x4E2D;&#x7684;seccomp</a></div></li></ol><center style=\"display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden\">Linux%E9%87%8C%E9%9D%A2%E6%9C%89%E5%BE%88%E5%A4%9A%E5%AE%89%E5%85%A8feature%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E6%9E%84%E6%88%90%E5%BA%94%E7%94%A8%E6%B2%99%E7%AE%B1%EF%BC%8C%E6%9D%A5%E8%BE%BE%E5%88%B0%E6%8E%A7%E5%88%B6%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8F%91%E8%A1%8C%E7%9A%84app%E7%9A%84%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E3%80%82%E5%8F%82%E8%80%83%5B1%5D%E5%8F%AF%E4%BB%A5%E6%9C%89%E4%B8%80%E4%B8%AA%E5%A4%A7%E8%87%B4%E7%9A%84%E4%BA%86%E8%A7%A3%E3%80%82Secure%20Computing%2C%20%E7%AE%80%E7%A7%B0seccomp%E6%98%AF%E5%85%B6%E4%B8%AD%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95%E3%80%82%E9%80%9A%E8%BF%87seccomp%E5%8F%AF%E4%BB%A5%E6%8E%A7%E5%88%B6%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%AF%B9%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E8%AE%BF%E9%97%AE%E3%80%82%0A%3E%20seccomp%E6%B2%99%E7%AE%B1%E4%B8%BB%E8%A6%81%E6%9C%89%E4%B8%A4%E7%A7%8D%E6%A8%A1%E5%BC%8F%EF%BC%8CSECCOMP_SET_MODE_STRICT%E5%8F%AA%E8%BF%90%E8%A1%8C%E8%B0%83%E7%94%A84%E4%B8%AA%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8read(2)%2C%20write(2)%2C%20%5C_exit(2)%2C%20sigreturn(2)%E5%9B%9B%E4%B8%AA%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%8C%E8%80%8CSECCOMP_SET_MODE_FILTER%E5%88%99%E5%85%81%E8%AE%B8%E9%80%9A%E8%BF%87BPF%E6%8C%87%E5%AE%9A%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E9%BB%91%E5%90%8D%E5%8D%95%E6%88%96%E8%80%85%E7%99%BD%E5%90%8D%E5%8D%95%5B1%5D%0A%0A%E6%96%87%E7%8C%AE%5B2%5D%E6%8F%90%E4%BE%9B%E4%BA%86seccomp%E5%85%A5%E9%97%A8%E9%9D%9E%E5%B8%B8%E5%A5%BD%E7%9A%84%E4%B8%80%E4%B8%AAexample%E9%A1%B9%E7%9B%AE%E3%80%82%E9%80%9A%E8%BF%87%E4%B8%80%E4%B8%AA%E6%9C%80%E5%B0%8F%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%EF%BC%8Cstep%20by%20step%E5%9C%B0%E6%BC%94%E7%A4%BA%E4%BA%86seccomp%E6%98%AF%E5%A6%82%E4%BD%95%E8%BF%87%E6%BB%A4%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E3%80%82%0A%E6%9C%AC%E6%96%87%E4%B8%BB%E8%A6%81%E5%9F%BA%E4%BA%8E%5B2%5D%2C%20%E6%8F%90%E5%8F%96%E5%87%BA%E6%A0%B8%E5%BF%83%E7%9A%84%E6%8F%8F%E8%BF%B0%EF%BC%8C%E5%B9%B6%E7%90%86%E6%B8%85%E6%80%9D%E8%B7%AF%0A%0A%23%23%20seccomp%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F%0Aseccomp%E6%9C%80%E6%97%A9%E5%87%BA%E7%8E%B0%E5%9C%A8Linux%20kernel%202.6.12%EF%BC%8C%E6%97%B6%E9%97%B4%E6%98%AF2005%E5%B9%B4%E3%80%822012%E5%B9%B4%E7%9A%84Linux%203.5%E7%89%88%E6%9C%AC%EF%BC%8C%E5%8A%A0%E5%85%A5%E4%BA%86%22seccomp%20mode%202%22%20(or%20%22seccomp%20filter%20mode%22)%E5%8A%9F%E8%83%BD%E3%80%82%0A%3E%20It%20added%20a%20second%20mode%20for%20seccomp%3A%20**SECCOMP_MODE_FILTER**.%20Using%20that%20mode%2C%20processes%20can%20specify%20which%20system%20calls%20are%20permitted.%20By%20using%20a%20mini-program%20in%20the%20Berkeley%20packet%20filter%20(BPF)%20language%2C%20processes%20could%20restrict%20system%20calls%20entirely%20or%20only%20for%20certain%20argument%20values.%20%0A%0A%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E7%8E%B0%E5%9C%A8%E7%94%A8%E7%9A%84%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B8%AAseccomp2%EF%BC%8C%E6%88%96%E8%80%85%E5%8F%ABseccomp-bpf%E3%80%82%E9%82%A3%E4%B9%88%E4%B8%BA%E5%95%A5%E5%8F%ABseccomp-bpf%3FBPF%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%0ABPF%E5%85%A8%E7%A7%B0%E6%98%AFBerkeley%20Packet%20Filter%E3%80%82%0A%3E%20%E6%9C%80%E5%88%9D%E6%9E%84%E6%83%B3%E6%8F%90%E5%87%BA%E4%BA%8E1992%E5%B9%B4%EF%BC%8C%E5%85%B6%E7%9B%AE%E7%9A%84%E6%98%AF%E4%B8%BA%E4%BA%86%E6%8F%90%E4%BE%9B%E4%B8%80%E7%A7%8D%E8%BF%87%E6%BB%A4%E5%8C%85%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%A6%81%E9%81%BF%E5%85%8D%E4%BB%8E%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%88%B0%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%9A%84%E6%97%A0%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8C%85%E5%A4%8D%E5%88%B6%E8%A1%8C%E4%B8%BA%E3%80%82%E5%AE%83%E6%9C%80%E5%88%9D%E6%98%AF%E7%94%B1%E4%BB%8E%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E6%B3%A8%E5%85%A5%E5%88%B0%E5%86%85%E6%A0%B8%E7%9A%84%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%AD%97%E8%8A%82%E7%A0%81%E6%9E%84%E6%88%90%EF%BC%8C%E5%AE%83%E5%9C%A8%E9%82%A3%E4%B8%AA%E4%BD%8D%E7%BD%AE%E5%88%A9%E7%94%A8%E4%B8%80%E4%B8%AA%E6%A0%A1%E9%AA%8C%E5%99%A8%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5%20%E2%80%94%E2%80%94%20%E4%BB%A5%E9%81%BF%E5%85%8D%E5%86%85%E6%A0%B8%E5%B4%A9%E6%BA%83%E6%88%96%E8%80%85%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%20%E2%80%94%E2%80%94%20%E5%B9%B6%E9%99%84%E7%9D%80%E5%88%B0%E4%B8%80%E4%B8%AA%E5%A5%97%E6%8E%A5%E5%AD%97%E4%B8%8A%E3%80%82%E5%85%B6%E7%AE%80%E5%8C%96%E7%9A%84%E8%AF%AD%E8%A8%80%E4%BB%A5%E5%8F%8A%E5%AD%98%E5%9C%A8%E4%BA%8E%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%88JIT%EF%BC%89%EF%BC%8C%E4%BD%BF%20BPF%20%E6%88%90%E4%B8%BA%E4%B8%80%E4%B8%AA%E6%80%A7%E8%83%BD%E5%8D%93%E8%B6%8A%E7%9A%84%E5%B7%A5%E5%85%B7%E3%80%82%0A%0A%E4%B8%BA%E5%95%A5%E8%BF%99%E4%B8%A4%E4%B8%AA%E4%B8%9C%E8%A5%BF%E4%BC%9A%E7%BB%91%E5%88%B0%E4%B8%80%E8%B5%B7%E5%91%A2%EF%BC%9F%0A%E5%9B%A0%E4%B8%BAseccomp%E5%9C%A8%E8%BF%87%E6%BB%A4syscall%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%80%9F%E5%8A%A9%E4%BA%86BPF%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%A4%84%E4%BA%8E%E5%86%85%E6%A0%B8%E7%9A%84%E7%94%A8BPF%20language%E5%86%99%E7%9A%84mini-program%E3%80%82%E6%89%80%E4%BB%A5%E9%87%87%E7%94%A8%E4%BA%86BPF%E6%96%B9%E6%B3%95%E5%AF%B9syscall%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4%E7%9A%84seccomp%E5%B0%B1%E6%98%AFseccomp-bpf%E3%80%82%0A%23%23%20seccomp%E6%80%8E%E4%B9%88%E7%94%A8%0A%3E%20The%20seccomp%20filter%20system%20uses%20the%20Berkley%20Packet%20Filter%20system.%20Combined%20with%20argument%20checking%20and%20the%20many%20possible%20filter%20return%20values%20(kill%2C%20trap%2C%20trace%2C%20errno)%2C%20this%20is%20allows%20for%20extensive%20logic.%5B2%5D%0A%0A%5B2%5D%E4%BB%A5%E5%8F%8A%E6%9C%AC%E6%96%87%E4%B8%BB%E8%A6%81%E9%98%90%E8%BF%B0%E4%BA%86%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84case%EF%BC%8Cseccomp%E7%9A%84%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%5Bseccomp%E7%9A%84%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3%5D(https%3A%2F%2Fwww.kernel.org%2Fdoc%2Fhtml%2Flatest%2Fuserspace-api%2Fseccomp_filter.html)%E3%80%82%0A%23%23%23%20Detect%20seccomp%0A%60%60%60%0Aroot%40kube-master%3A~%23%20%20cat%20%2Fboot%2Fconfig-%60uname%20-r%60%20%7C%20grep%20CONFIG_SECCOMP%0ACONFIG_SECCOMP_FILTER%3Dy%0ACONFIG_SECCOMP%3Dy%0A%60%60%60%0A%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%E8%BF%99%E4%B8%AA%E9%93%BE%E6%8E%A5%EF%BC%88%5BDetecting%20seccomp%20features%20at%20runtime%5D(https%3A%2F%2Foutflux.net%2Fteach-seccomp%2Fautodetect.html)%EF%BC%89%E5%86%99%E4%B8%80%E4%B8%AALinux%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%B0%83%E7%94%A8prctl%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%9D%A5%E6%A3%80%E6%B5%8B%E3%80%82%0A%0A%23%23%23%20Basic%20seccomp%20filtering%0A%E5%9F%BA%E6%9C%AC%E7%9A%84SYSCALL%E8%BF%87%E6%BB%A4%E9%9D%9E%E5%B8%B8%E7%AE%80%E5%8D%95%EF%BC%8C%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%60%60%60mermaid%0Agraph%20TD%0AA%5B%22%E5%AE%9A%E4%B9%89filter%E6%95%B0%E7%BB%84%22%5D%0AA%20--%3E%20B%5B%22%E5%AE%9A%E4%B9%89prog%E5%8F%82%E6%95%B0%22%5D%0AB%20--%3E%20C%5B%22prctl(PR_SET_SECCOMP%2C%20SECCOMP_MODE_FILTER%2C%20%26prog)%22%5D%0A%60%60%60%0A%E5%90%8E%E9%9D%A2%E4%B8%A4%E6%AD%A5%E9%83%BD%E5%B7%AE%E4%B8%8D%E5%A4%9A%EF%BC%8C%E5%8F%AF%E8%A7%81%E5%85%B3%E9%94%AE%E7%9A%84%E6%98%AF%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%AE%9A%E4%B9%89SYSCALL%E8%BF%87%E6%BB%A4%E5%88%97%E8%A1%A8%E3%80%82%0A%60%60%60c%0Astruct%20sock_filter%20filter%5B%5D%20%3D%20%7B%0A%20%20%20%20%2F*%20Validate%20architecture.%20*%2F%0A%20%20%20%20VALIDATE_ARCHITECTURE%2C%0A%20%20%20%20%2F*%20Grab%20the%20system%20call%20number.%20*%2F%0A%20%20%20%20EXAMINE_SYSCALL%2C%0A%20%20%20%20%2F*%20List%20allowed%20syscalls.%20*%2F%0A%20%20%20%20ALLOW_SYSCALL(rt_sigreturn)%2C%0A%20%20%20%20...%0A%20%20%20%20KILL_PROCESS%2C%0A%7D%3B%0Astruct%20sock_fprog%20prog%20%3D%20%7B%0A%20%20%20%20.len%20%3D%20(unsigned%20short)(sizeof(filter)%2Fsizeof(filter%5B0%5D))%2C%0A%20%20%20%20.filter%20%3D%20filter%2C%0A%7D%3B%0A%0Aif%20(prctl(PR_SET_NO_NEW_PRIVS%2C%201%2C%200%2C%200%2C%200))%20%7B%0A%20%20%20%20perror(%22prctl(NO_NEW_PRIVS)%22)%3B%0A%20%20%20%20goto%20failed%3B%0A%7D%0Aif%20(prctl(PR_SET_SECCOMP%2C%20SECCOMP_MODE_FILTER%2C%20%26prog))%20%7B%0A%20%20%20%20perror(%22prctl(SECCOMP)%22)%3B%0A%20%20%20%20goto%20failed%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%20BPF%0A%E8%BF%99%E9%87%8C%E5%80%BC%E5%BE%97%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%60EXAMINE_SYSCALL%60%2C%20%60ALLOW_SYSCALL%60%E5%92%8C%20%60KILL_PROCESS%60%E9%83%BD%E4%B8%8D%E6%98%AF%E6%A0%87%E5%87%86%E5%BA%93%E6%8F%90%E4%BE%9B%E7%9A%84%E3%80%82%E7%9C%8B%E6%9C%AC%E9%A1%B9%E7%9B%AE%E7%9A%84%5Bseccomp-bpf.h%5D(https%3A%2F%2Foutflux.net%2Fteach-seccomp%2Fstep-3%2Fseccomp-bpf.h)%E5%8F%AF%E4%BB%A5%E7%9F%A5%E9%81%93%E3%80%82%E8%BF%99%E4%BA%9B%E9%83%BD%E6%98%AF%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%AE%8F%EF%BC%9A%0A%60%60%60C%0A%23define%20VALIDATE_ARCHITECTURE%20%5C%0A%09BPF_STMT(BPF_LD%2BBPF_W%2BBPF_ABS%2C%20arch_nr)%2C%20%5C%0A%09BPF_JUMP(BPF_JMP%2BBPF_JEQ%2BBPF_K%2C%20ARCH_NR%2C%201%2C%200)%2C%20%5C%0A%09BPF_STMT(BPF_RET%2BBPF_K%2C%20SECCOMP_RET_KILL)%0A%0A%23define%20EXAMINE_SYSCALL%20%5C%0A%09BPF_STMT(BPF_LD%2BBPF_W%2BBPF_ABS%2C%20syscall_nr)%0A%0A%23define%20ALLOW_SYSCALL(name)%20%5C%0A%09BPF_JUMP(BPF_JMP%2BBPF_JEQ%2BBPF_K%2C%20__NR_%23%23name%2C%200%2C%201)%2C%20%5C%0A%09BPF_STMT(BPF_RET%2BBPF_K%2C%20SECCOMP_RET_ALLOW)%0A%0A%23define%20KILL_PROCESS%20%5C%0A%09BPF_STMT(BPF_RET%2BBPF_K%2C%20SECCOMP_RET_KILL)%0A%60%60%60%0A%E6%9F%A5%E7%9C%8BLinux%E6%BA%90%E7%A0%81%E5%8F%AF%E7%9F%A5%2C%20BPF_STMT%0A%60%60%60%0A.%2Finclude%2Fuapi%2Flinux%2Ffilter.h%0A48%3A%23ifndef%20BPF_STMT%0A49%3A%23define%20BPF_STMT(code%2C%20k)%20%7B%20(unsigned%20short)(code)%2C%200%2C%200%2C%20k%20%7D%0A%60%60%60%0A%3EIf%20one%20is%20%22feeling%20masochistic%22%2C%20they%20could%20write%20BPF%20programs%20numerically%2C%20but%20**there%20are%20some%20constants%20and%20macros%20available%20to%20make%20it%20easier**.%20%5B3%5D%0A%0ABPF%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E5%A5%97%E6%8C%87%E4%BB%A4%E9%9B%86%E6%9D%A5%E5%AE%9E%E7%8E%B0filter%E5%8A%9F%E8%83%BD%E3%80%82%E4%BD%A0%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E5%86%99%E4%BA%8C%E8%BF%9B%E5%88%B6%EF%BC%88%E6%B1%87%E7%BC%96%EF%BC%89%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%87%87%E7%94%A8Linux%E6%8A%BD%E8%B1%A1%E7%9A%84%E5%AE%8F%EF%BC%8C%E6%9B%B4%E9%AB%98%E9%98%B6%E4%B8%80%E7%82%B9%E7%9A%84API%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83Libseccomp%E3%80%82%E9%87%8C%E9%9D%A2%E4%B9%9F%E6%9C%89%E4%B8%8D%E5%B0%91sample%E4%BB%A3%E7%A0%81%E3%80%82Android%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF%5Bminijai%5D(https%3A%2F%2Fgithub.com%2Fgoogle%2Fminijail)%E3%80%82%0A%3EThere%20are%20a%20number%20of%20tools%20and%20resources%20that%20can%20make%20it%20easier%20to%20work%20with%20seccomp%20filters%20and%20BPF.%20Libseccomp%20provides%20a%20higher-level%20API%20for%20creating%20filters.%20He%20noted%20that%20the%20project%20also%20has%20man%20pages%20(for%20example%2C%20seccomp_init())%20with%20lots%20of%20examples.%20%5B3%5D%0A%0A%0A%E9%99%A4%E4%BA%86%E9%AB%98%E9%98%B6API%E5%8F%AF%E7%94%A8%EF%BC%8C%5B3%5D%E4%B8%AD%E8%BF%98%E6%8F%90%E5%8F%8A%E4%BA%86%E4%B8%80%E4%BA%9B%E7%BC%96%E8%AF%91BPF%E6%8C%87%E4%BB%A4%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%9A%0A%3EThere%20is%20also%20a%20**BPF%20compiler%20(bpfc)**%20that%20is%20part%20of%20the%20netsniff-ng%20toolkit%20project.%20LLVM%20has%20a%20BPF%20backend%20as%20of%20its%203.7%20release%20that%20compiles%20a%20subset%20of%20C%20to%20BPF%2C%20though%20he%20noted%20that%20there%20is%20little%20documentation%20as%20yet.%0A%3E%0A%3EFinally%2C%20the%20kernel%20has%20a%20**just-in-time%20(JIT)%20compiler**%20that%20turns%20the%20BPF%20bytecode%20into%20native%20machine%20code%2C%20which%20can%20achieve%202-3x%20performance%20(or%20even%20better%20in%20some%20cases).%20The%20JIT%20compiler%20is%20disabled%20by%20default%2C%20but%20it%20can%20be%20enabled%20by%20writing%20a%20%221%22%20to%3A%20%60%2Fproc%2Fsys%2Fnet%2Fcore%2Fbpf_jit_enable%60%0A%3EKerrisk&apos;s%20slides%20have%20a%20wealth%20of%20information%2C%20including%20additional%20%3Eresources%20for%20more%20information.%0A%0A%23%23%23%20seccomp%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95%E7%AE%80%E4%BB%8B%0Aseccomp%E7%9A%84%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95%E8%BF%98%E6%98%AF%E8%A6%81%E5%8F%82%E8%80%83%5Bseccomp%E7%9A%84%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3%5D(https%3A%2F%2Fwww.kernel.org%2Fdoc%2Fhtml%2Flatest%2Fuserspace-api%2Fseccomp_filter.html)%EF%BC%8C%E6%9C%AC%E8%8A%82%E4%BB%85%E5%81%9A%E4%B8%80%E4%BA%9B%E7%BD%97%E5%88%97%E5%92%8C%E6%8F%90%E7%A4%BA%E3%80%82%0A%E5%9C%A8%5B2%5D%E4%B8%AD%E7%9A%84example%E4%BB%A3%E7%A0%81%E9%87%8C%EF%BC%8C%E4%B8%8D%E7%AC%A6%E5%90%88%E8%A6%81%E6%B1%82%E7%9A%84%E8%B0%83%E7%94%A8%EF%BC%8C%E4%BC%9A%E8%A2%AB%E7%9B%B4%E6%8E%A5kill%20process%E3%80%82%E5%85%B6%E5%AE%9E%E8%BF%98%E6%9C%89%E5%BE%88%E5%A4%9A%E8%BF%94%E5%9B%9E%E5%80%BC%EF%BC%9A%0A-%20SECCOMP_RET_KILL_PROCESS%0A-%20SECCOMP_RET_KILL_THREAD%0A-%20SECCOMP_RET_TRAP%0A-%20SECCOMP_RET_ERRNO%0A-%20SECCOMP_RET_USER_NOTIF%0A-%20SECCOMP_RET_TRACE%0A-%20SECCOMP_RET_LOG%0A-%20SECCOMP_RET_ALLOW%0A%0A%3EIf%20multiple%20filters%20exist%2C%20the%20return%20value%20for%20the%20evaluation%20of%20a%20given%20system%20call%20will%20always%20use%20the%20highest%20precedent%20value.%0A%3E%0A%3EPrecedence%20is%20only%20determined%20using%20the%20SECCOMP_RET_ACTION%20mask.%20When%20multiple%20filters%20return%20values%20of%20the%20same%20precedence%2C%20only%20the%20SECCOMP_RET_DATA%20from%20the%20most%20recently%20installed%20filter%20will%20be%20returned.%0A%0A%23%23%23%20%E5%9D%91%EF%BC%88Pitfalls%EF%BC%89%0A%E6%9D%A5%E8%87%AA%5B5%5D%EF%BC%8C%E6%88%91%E5%8F%AA%E6%98%AF%E6%90%AC%E8%BF%90%E5%B7%A5%0A%3E%20The%20biggest%20pitfall%20to%20avoid%20during%20use%20is%20filtering%20on%20system%20call%20number%20without%20checking%20the%20architecture%20value.%20Why%3F%20On%20any%20architecture%20that%20supports%20multiple%20system%20call%20invocation%20conventions%2C%20the%20system%20call%20numbers%20may%20vary%20based%20on%20the%20specific%20invocation.%20If%20the%20numbers%20in%20the%20different%20calling%20conventions%20overlap%2C%20then%20checks%20in%20the%20filters%20may%20be%20abused.%20Always%20check%20the%20arch%20value!%0A%0A%E7%BF%BB%E8%AF%91%E4%B8%80%E4%B8%8B%EF%BC%8C%E8%BF%99%E9%87%8C%E7%9A%84%E6%84%8F%E6%80%9D%E6%98%AF%E6%8F%90%E9%86%92seccomp%E7%9A%84%E4%BD%BF%E7%94%A8%E8%80%85%EF%BC%8C%E5%9C%A8%E8%AE%BE%E7%BD%AEfiltering%E4%B9%8B%E5%89%8D%E8%A6%81%E8%AE%B0%E5%BE%97%E9%AA%8C%E8%AF%81%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84%EF%BC%8C%E5%9B%A0%E4%B8%BA%E4%B8%8D%E5%90%8C%E7%9A%84%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84%EF%BC%8C%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%8F%B7%E5%8F%AF%E8%83%BD%E6%98%AF%E4%B8%8D%E5%90%8C%E7%9A%84%E3%80%82%E4%BE%8B%E5%A6%82%5B2%5D%E7%9A%84example%E4%B8%AD%E6%9C%89%EF%BC%9A%0A%60%60%60c%0Astruct%20sock_filter%20filter%5B%5D%20%3D%20%7B%0A%20%20%20%20%2F*%20Validate%20architecture.%20*%2F%0A%20%20%20%20VALIDATE_ARCHITECTURE%2C%0A%20%20%20%20...%0A%7D%3B%0A%0A%2F%2F%20in%20seccomp-bpf.h%0A%23define%20syscall_nr%20(offsetof(struct%20seccomp_data%2C%20nr))%0A%23define%20arch_nr%20(offsetof(struct%20seccomp_data%2C%20arch))%0A%0A%23if%20defined(__i386__)%0A%23%20define%20REG_SYSCALL%09REG_EAX%0A%23%20define%20ARCH_NR%09AUDIT_ARCH_I386%0A%23elif%20defined(__x86_64__)%0A%23%20define%20REG_SYSCALL%09REG_RAX%0A%23%20define%20ARCH_NR%09AUDIT_ARCH_X86_64%0A%23else%0A%23%20warning%20%22Platform%20does%20not%20support%20seccomp%20filter%20yet%22%0A%23%20define%20REG_SYSCALL%090%0A%23%20define%20ARCH_NR%090%0A%23endif%0A%0A%23define%20VALIDATE_ARCHITECTURE%20%5C%0A%09BPF_STMT(BPF_LD%2BBPF_W%2BBPF_ABS%2C%20arch_nr)%2C%20%5C%0A%09BPF_JUMP(BPF_JMP%2BBPF_JEQ%2BBPF_K%2C%20ARCH_NR%2C%201%2C%200)%2C%20%5C%0A%09BPF_STMT(BPF_RET%2BBPF_K%2C%20SECCOMP_RET_KILL)%0A%60%60%60%0A%0Aseccomp_data%E6%98%AF%E5%95%A5%EF%BC%9F%0A%60%60%60%0A%2F**%0A%20*%20struct%20seccomp_data%20-%20the%20format%20the%20BPF%20program%20executes%20over.%0A%20*%20%40nr%3A%20the%20system%20call%20number%0A%20*%20%40arch%3A%20indicates%20system%20call%20convention%20as%20an%20AUDIT_ARCH_*%20value%0A%20*%20%20%20%20%20%20%20%20as%20defined%20in%20%3Clinux%2Faudit.h%3E.%0A%20*%20%40instruction_pointer%3A%20at%20the%20time%20of%20the%20system%20call.%0A%20*%20%40args%3A%20up%20to%206%20system%20call%20arguments%20always%20stored%20as%2064-bit%20values%0A%20*%20%20%20%20%20%20%20%20regardless%20of%20the%20architecture.%0A%20*%2F%0Astruct%20seccomp_data%20%7B%0A%09int%20nr%3B%0A%09__u32%20arch%3B%0A%09__u64%20instruction_pointer%3B%0A%09__u64%20args%5B6%5D%3B%0A%7D%3B%0A%60%60%60%0A%E6%88%91%E7%9A%84%E7%90%86%E8%A7%A3%EF%BC%9A%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F(example.c)%E6%8A%8Asock_filter%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%99%E5%85%A5%E5%86%85%E6%A0%B8(%E9%80%9A%E8%BF%87prctl)%EF%BC%8C%E4%B9%8B%E5%90%8E%E5%86%85%E6%A0%B8%E6%8E%A5%E5%8F%97SYSCALL%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%9E%84%E9%80%A0%E5%87%BAseccomp_data%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%9D%A5%E8%B0%83%E7%94%A8%E8%BF%99%E4%B8%80%E6%AE%B5BPF%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%9D%A5%E8%8E%B7%E5%BE%97%E8%BF%87%E6%BB%A4%E7%9A%84%E7%BB%93%E6%9E%9C%E3%80%82%0A%0A%23%23%20%E6%80%BB%E7%BB%93%0Aseccomp%E6%98%AF%E5%86%85%E6%A0%B8%E6%8F%90%E4%BE%9B%E7%9A%84%E4%B8%80%E7%A7%8DSYSCALL%E8%BF%87%E6%BB%A4%E6%9C%BA%E5%88%B6%EF%BC%8C%E5%AE%83%E5%9F%BA%E4%BA%8EBPF%E8%BF%87%E6%BB%A4%E6%96%B9%E6%B3%95%EF%BC%8C%E9%80%9A%E8%BF%87%E5%86%99%E5%85%A5BPF%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BB%A3%E7%A0%81%E6%9D%A5%E8%BE%BE%E5%88%B0%E8%BF%87%E6%BB%A4%E7%9A%84%E7%9B%AE%E7%9A%84%E3%80%82BPF%E8%A7%84%E5%88%99%E8%AF%AD%E8%A8%80%E5%8E%9F%E7%94%9F%E6%98%AF%E4%B8%BA%E4%BA%86%E8%BF%87%E6%BB%A4%E7%BD%91%E7%BB%9C%E5%8C%85%EF%BC%8C%E6%83%85%E6%99%AF%E6%AF%94%E8%BE%83%E5%A4%8D%E6%9D%82%E3%80%82%E9%92%88%E5%AF%B9SYSCALL%E5%9C%BA%E6%99%AF%EF%BC%8C%E8%AF%AD%E6%B3%95%E6%AF%94%E8%BE%83%E5%9B%BA%E5%AE%9A%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E6%92%B0%E5%86%99%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9F%BA%E4%BA%8ELibseccomp%E5%BA%93%E6%8F%90%E4%BE%9B%E7%9A%84API%E6%9D%A5%E7%BC%96%E5%86%99%E3%80%82%0A%E5%9B%A0%E4%B8%BA%E7%A8%8B%E5%BA%8F%E5%9C%A8fork%2Fclone%E6%88%96execve%E6%97%B6%EF%BC%8CBPF%20filter%E4%BC%9A%E4%BB%8E%E7%88%B6%E8%BF%9B%E7%A8%8B%E7%BB%A7%E6%89%BF%E5%88%B0%E5%AD%90%E8%BF%9B%E7%A8%8B%EF%BC%8C%E6%89%80%E4%BB%A5%E5%A6%82%E6%9E%9C%E6%83%B3%E6%8E%A7%E5%88%B6%E7%AC%AC%E4%B8%89%E6%96%B9%E7%9A%84%E7%A8%8B%E5%BA%8F%E8%B0%83%E7%94%A8SYSCALL%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%9C%A8fork%2Fclone%E6%88%96%E8%80%85execve%E6%97%B6%EF%BC%8C%E4%BC%A0%E5%85%A5%E5%90%88%E9%80%82%E7%9A%84sock_filter%E5%8D%B3%E5%8F%AF%E3%80%82%0A%0A%23%23%20%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%0A1.%20%5Blinux%E4%B8%AD%E7%9A%84%E5%AE%B9%E5%99%A8%E4%B8%8E%E6%B2%99%E7%AE%B1%E5%88%9D%E6%8E%A2%5D(http%3A%2F%2Fatum.li%2F2017%2F04%2F25%2Flinuxsandbox%2F%23linux%25E4%25B8%25AD%25E7%259A%2584%25E6%25B2%2599%25E7%25AE%25B1%25E6%258A%2580%25E6%259C%25AF)%0A2.%20%5BUsing%20simple%20seccomp%20filters%5D(https%3A%2F%2Foutflux.net%2Fteach-seccomp%2F)%0A3.%20%5BA%20seccomp%20overview%5D(https%3A%2F%2Flwn.net%2FArticles%2F656307%2F)%0A4.%20%5Bseccomp%E7%9A%84%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3%5D(https%3A%2F%2Fwww.kernel.org%2Fdoc%2Fhtml%2Flatest%2Fuserspace-api%2Fseccomp_filter.html)%E3%80%82%0A5.%20%5Bkernel%20doc%20-%20Seccomp%20BPF%20(SECure%20COMPuting%20with%20filters)%5D(https%3A%2F%2Fwww.kernel.org%2Fdoc%2Fhtml%2Flatest%2Fuserspace-api%2Fseccomp_filter.html)%0A6.%20%5BAndroid%E4%B8%AD%E7%9A%84seccomp%5D(https%3A%2F%2Fwww.jianshu.com%2Fp%2F62ede45cfb2e)</center>",
            "tags": [
                "Linux",
                "security"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2019/02/22/tmux_+_vim%E7%9A%84%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/",
            "url": "https://blog.zhougy.top/2019/02/22/tmux_+_vim%E7%9A%84%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/",
            "title": "tmux + vim的复制配置",
            "date_published": "2019-02-21T22:52:36.000Z",
            "content_html": "<div style=\"font-size: 14px; margin: 0; padding: 0; width: 100%;\"><p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x505A;&#x5D4C;&#x5165;&#x5F0F;&#x7684;&#x540C;&#x5B66;&#xFF0C;&#x5927;&#x591A;&#x5728;Linux&#x73AF;&#x5883;&#x4E0B;&#x5F00;&#x53D1;&#x3002;&#x73B0;&#x5728;&#x4E5F;&#x6709;&#x5F88;&#x591A;&#x540C;&#x5B66;&#x7528;OSX&#x5F00;&#x53D1;&#x3002;&#x5176;&#x5B9E;&#x4ED6;&#x4EEC;&#x90FD;&#x662F;&#x7C7B;Unix&#x7CFB;&#x7EDF;&#x3002;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x5F00;&#x53D1;&#x8005;&#xFF0C;&#x6548;&#x7387;&#x5F88;&#x91CD;&#x8981;&#x3002;&#x6709;&#x5F88;&#x591A;&#x91CD;&#x590D;&#x7410;&#x788E;&#x7684;&#x52A8;&#x4F5C;&#xFF0C;&#x5982;&#x679C;&#x80FD;&#x63D0;&#x9AD8;&#x4E00;&#x70B9;&#x6548;&#x7387;&#xFF0C;&#x591A;&#x6B21;&#x7D2F;&#x79EF;&#x8D77;&#x6765;&#xFF0C;&#x8282;&#x7701;&#x7684;&#x65F6;&#x95F4;&#x548C;&#x7CBE;&#x529B;&#x4E5F;&#x662F;&#x53EF;&#x89C2;&#x7684;&#x3002;&#x5728;&#x63D0;&#x5347;&#x6548;&#x7387;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x505A;&#x4E00;&#x4E2A;&#x5F88;&#x6709;&#x6548;&#x7387;&#xFF0C;&#x800C;&#x907F;&#x514D;&#x7410;&#x788E;&#x91CD;&#x590D;&#x7684;&#x52A8;&#x4F5C;&#xFF0C;&#x4E5F;&#x5F88;&#x6709;&#x52A9;&#x4E8E;&#x5FC3;&#x60C5;&#x7684;&#x6109;&#x60A6;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x4F46;&#x51E1;&#x6709;&#x673A;&#x4F1A;&#xFF0C;&#x6211;&#x90FD;&#x4F1A;&#x7ED9;&#x522B;&#x4EBA;&#x5B89;&#x5229;&#x4E00;&#x4E9B;&#x597D;&#x7528;&#x7684;&#x5DE5;&#x5177;&#xFF0C;&#x4F8B;&#x5982;tmux&#xFF0C;vim&#xFF0C;fish&#x554A;&#xFF0C;&#x7B49;&#x7B49;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x6709;&#x4EBA;&#x79F0;tmux, zsh, vim&#x662F;&#x6587;&#x672C;&#x5904;&#x7406;&#x7684;&#x4E09;&#x5251;&#x5BA2;&#x3002;&#x8FD9;&#x4E09;&#x4E2A;&#x5DE5;&#x5177;&#x7528;&#x597D;&#x4E86;&#x786E;&#x5B9E;&#x597D;&#x7528;&#x3002;&#x6211;&#x76EE;&#x524D;&#x7684;&#x5F00;&#x53D1;&#x73AF;&#x5883;&#x4F7F;&#x7528;&#x7684;&#x662F;fish + tmux + vim&#x3002;fish&#x7684;&#x4F5C;&#x7528;&#x548C;zsh&#x5DEE;&#x4E0D;&#x591A;&#x3002;&#x672C;&#x6587;&#x60F3;&#x7740;&#x91CD;&#x4ECB;&#x7ECD;&#x7684;&#x662F;&#x56F0;&#x6270;&#x6211;&#x5F88;&#x591A;&#x5E74;&#x7684;tmux + vim&#x7684;&#x526A;&#x8D34;&#x677F;&#x95EE;&#x9898;&#x3002;</p>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">tmux&#x4E0B;&#x7684;&#x590D;&#x5236;</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5728;&#x6BD5;&#x4E1A;&#x540E;&#x7684;&#x82E5;&#x5E72;&#x5E74;&#x5185;&#xFF0C;&#x6211;&#x4E00;&#x76F4;&#x5728;Windows&#x4E0B;&#xFF0C;&#x4F7F;&#x7528;putty + ssh +tmux&#x8FDE;&#x63A5;&#x8FDC;&#x7AEF;&#x7684;Linux&#x670D;&#x52A1;&#x5668;&#x505A;&#x5F00;&#x53D1;&#x3002;&#x597D;&#x5904;&#x662F;&#xFF0C;tmux&#x53EF;&#x4EE5;&#x505A;session&#x7BA1;&#x7406;&#xFF0C;&#x5373;&#x4FBF;putty ssh&#x5173;&#x95ED;&#xFF0C;&#x4EFB;&#x52A1;&#x4E0D;&#x4F1A;&#x4E2D;&#x65AD;&#x3002;&#x53EA;&#x8981;&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x5173;&#x95ED;&#xFF0C;&#x4E0B;&#x6B21;&#x6253;&#x5F00;&#x4ECD;&#x7136;&#x53EF;&#x4EE5;&#x5FEB;&#x901F;&#x6062;&#x590D;&#x5DE5;&#x4F5C;&#x73B0;&#x573A;&#x3002;</p>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">tmux&#x5206;&#x5C4F;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#x6587;&#x672C;&#x9009;&#x4E2D;</h3>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">tmux&#x4E2D;&#x7684;panel&#x5728;&#x591A;&#x4EFB;&#x52A1;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x975E;&#x5E38;&#x597D;&#x7528;&#x3002;&#x4F46;&#x5E26;&#x6765;&#x7684;&#x95EE;&#x9898;&#x662F;&#xFF0C;&#x5F53;tmux&#x6709;&#x6A2A;&#x5411;&#x5206;&#x5C4F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x590D;&#x5236;&#x597D;&#x56F0;&#x96BE;&#x3002;&#x6587;&#x672C;&#x7684;&#x9009;&#x4E2D;&#x4F1A;&#x8DE8;&#x8D8A;panel&#x8FB9;&#x754C;&#xFF08;&#x56FE;&#x622A;&#x4E0D;&#x51FA;&#x6765;&#xFF0C;&#x76F8;&#x4FE1;&#x4F7F;&#x7528;tmux&#x7684;&#x65B0;&#x624B;&#x540C;&#x5B66;&#xFF0C;&#x5E94;&#x8BE5;&#x90FD;&#x9047;&#x5230;&#x8FC7;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF09;&#x3002;&#x89E3;&#x51B3;&#x7684;&#x529E;&#x6CD5;&#x662F;&#xFF0C;&#x6253;&#x5F00;tmux&#x7684;&#x9F20;&#x6807;&#x6A21;&#x5F0F;&#xFF1A;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\">set-option -g mouse on\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x6B64;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x901A;&#x8FC7;&#x9F20;&#x6807;&#x9009;&#x4E2D;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x8DE8;&#x8D8A;&#x5206;&#x5C4F;&#x8FB9;&#x754C;&#x3002;&#x600E;&#x4E48;&#x590D;&#x5236;&#xFF0C;&#x5BF9;&#x4E8E;&#x65B0;&#x624B;&#x6765;&#x8BF4;&#xFF0C;&#x53C8;&#x662F;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x3002;</p>\n<blockquote style=\"line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;\">\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;\">vim&#x7528;:vsplit&#x547D;&#x4EE4;&#x5206;&#x5C4F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x6709;&#x540C;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#x5982;&#x51FA;&#x4E00;&#x8F99;&#xFF0C;&#x4F7F;&#x80FD;&#x9F20;&#x6807;&#x6A21;&#x5F0F;&#xFF0C;set mouse=a&#x3002;</p>\n</blockquote>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">tmux&#x590D;&#x5236;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#x590D;&#x5236;</h3>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">tmux&#x7684;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x901A;&#x8FC7;bind-key&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x672C;&#x8EAB;&#x6709;&#x4E00;&#x5957;&#x9ED8;&#x8BA4;&#x7684;bind-key table&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#xFF0C;tmux&#x63D2;&#x4EF6;&#x4E5F;&#x53EF;&#x4EE5;&#x5E2E;&#x4F60;&#x5B9A;&#x4E49;&#x3002;&#x6240;&#x4EE5;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x6E05;&#x695A;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x81EA;&#x884C;&#x67E5;bind-key table&#x3002;&#x65B9;&#x6CD5;&#x662F;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x901A;&#x8FC7;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">ctrl + [:</code>&#x8FDB;&#x5165;tmux&#x547D;&#x4EE4;&#x6A21;&#x5F0F;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x6267;&#x884C;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">list-keys</code>&#x547D;&#x4EE4;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x8F83;&#x65B0;&#x7684;tmux &#x4E2D;&#x7684;bind-key table&#x8F83;&#x8001;&#x7248;&#x672C;&#x7684;&#x5B8C;&#x5168;&#x4E0D;&#x540C;&#x3002;&#x4F8B;&#x5982;&#x7B14;&#x8005;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x6700;&#x65B0;release&#x7248;tmux2.8&#xFF0C;&#x800C;Ubuntu 16.04 LTS&#x7248;&#x672C;&#x6E90;&#x4E2D;&#x81EA;&#x5E26;&#x7684;&#x662F;tmux 2.1&#x3002;&#x636E;&#x8BF4;tmux&#x4E2D;&#x95F4;&#x8FDB;&#x884C;&#x8FC7;&#x91CD;&#x6784;&#xFF0C;&#x5BFC;&#x81F4;&#x5F88;&#x591A;&#x529F;&#x80FD;&#x5176;&#x5B9E;&#x5E76;&#x4E0D;&#x517C;&#x5BB9;&#x8001;&#x7248;&#x672C;&#x3002;&#x6240;&#x4EE5;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x65B0;&#x7248;&#x672C;&#x3002;</p>\n<blockquote style=\"line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;\">\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;\">Ubuntu 16.04 LTS&#x7248;&#x672C;&#x7684;&#x6E90;&#x4E2D;&#x81EA;&#x5E26;&#x7684;tmux&#x662F;2.1&#x7684;&#x3002;&#x8FD9;&#x4F1A;&#x5BFC;&#x81F4;&#x5F88;&#x591A;&#x529F;&#x80FD;&#x6CA1;&#x6CD5;&#x4F7F;&#x7528;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"># tmux 2.8 list-keys\nbind-key    -T copy-mode    C-Space           send-keys -X begin-selection\nbind-key    -T copy-mode    C-a               send-keys -X start-of-line\nbind-key    -T copy-mode    C-b               send-keys -X cursor-left\nbind-key    -T copy-mode    C-c               send-keys -X cancel\nbind-key    -T copy-mode    C-e               send-keys -X end-of-line\nbind-key    -T copy-mode    C-f               send-keys -X cursor-right\nbind-key    -T copy-mode    C-g               send-keys -X clear-selection\nbind-key    -T copy-mode    C-k               send-keys -X copy-end-of-line\nbind-key    -T copy-mode    C-n               send-keys -X cursor-down\nbind-key    -T copy-mode    C-p               send-keys -X cursor-up\n\n# tmux 2.1 list-keys\nbind-key        C-b send-prefix                                                     \nbind-key        C-o rotate-window\nbind-key        C-z suspend-client\nbind-key      Space next-layout\nbind-key          ! break-pane\nbind-key          &quot; split-window\nbind-key          # list-buffers\nbind-key          $ command-prompt -I #S &quot;rename-session &apos;%%&apos;&quot;\nbind-key          % split-window -h\nbind-key          &amp; confirm-before -p &quot;kill-window #W? (y/n)&quot; kill-window\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x662F;&#x4E0D;&#x662F;&#x5F88;&#x4E0D;&#x4E00;&#x6837;&#xFF1F;&#x8BF7;&#x81EA;&#x884C;&#x5FFD;&#x7565;2.1&#x7248;&#x672C;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">2.8&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x884C;&#x5176;&#x5B9E;&#x8FD0;&#x884C;&#x7684;&#x662F;&#x4E00;&#x4E2A;bind-key&#x547D;&#x4EE4;&#xFF0C;&#x5177;&#x4F53;&#x53C2;&#x6570;&#x53EF;&#x4EE5;&#x53C2;&#x8003;<a href=\"http://man.openbsd.org/OpenBSD-current/man1/tmux.1\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">tmux man page</a></p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">-T: &#x6307;&#x5B9A;&#x8868;&#x683C;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">-r: &#x6307;&#x5B9A;&#x8BE5;&#x6309;&#x952E;&#x53EF;&#x4EE5;repeat&#x3002;&#x4F8B;&#x5982;&#x8C03;&#x6574;panel&#x5927;&#x5C0F;&#xFF0C;&#x4F60;&#x4E0D;&#x60F3;&#x6BCF;&#x653E;&#x5927;&#x7F29;&#x5C0F;&#x4E00;&#x6B21;&#x90FD;&#x8981;&#x6309;prefix&#x5427;&#xFF0C;&#x90A3;&#x4F1A;&#x6293;&#x72C2;&#x7684;&#x3002;</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-bottom: 0;\">copy-mode&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5177;&#x4F53;table&#xFF0C;&#x5728;&#x4F60;&#x6309;&#x4E0B;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">ctrl + [</code>&#x8FDB;&#x5165;&#x590D;&#x5236;&#x6A21;&#x5F0F;&#x65F6;&#x751F;&#x6548;&#x3002;&#x540C;&#x7406;&#x8FD8;&#x6709;&#x4E2A;&#x53EB;prefix&#x7684;table&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x666E;&#x901A;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#x6309;&#x952E;&#x8868;&#x3002;</p>\n</blockquote>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8BDD;&#x8BF4;&#x8FD9;&#x4E48;&#x591A;&#xFF0C;&#x5230;&#x5E95;&#x600E;&#x4E48;&#x590D;&#x5236;&#xFF1F;&#x641C;&#x7D22;&#x8FD9;&#x4E2A;&#x8868;&#x683C;&#x7684;&#x662F;&#x5426;&#x6709;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">copy-selection</code>&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;&#x6240;&#x4EE5;&#x901A;&#x5E38;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">Enter</code>&#x4F1A;&#x88AB;&#x6620;&#x5C04;&#x6210;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">send-keys -X copy-selection-and-cancel</code>&#x3002;&#x4E5F;&#x5C31;&#x662F;<strong style=\"line-height: 160%; box-sizing: content-box; font-weight: 700;\">&#x6309;&#x4E0B;Enter&#xFF0C;&#x9009;&#x4E2D;&#x7684;&#x6587;&#x5B57;&#x4F1A;&#x88AB;&#x590D;&#x5236;&#x5230;tmux&#x526A;&#x8D34;&#x677F;</strong>&#x3002;</p>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">tmux&#x4E0B;&#x590D;&#x5236;&#x5230;Windows&#x526A;&#x8D34;&#x677F;</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x624D;&#x662F;&#x672C;&#x7BC7;&#x60F3;&#x8BF4;&#x7684;&#x8BDD;&#x9898;&#x3002;&#x56E0;&#x4E3A;&#x6211;&#x82B1;&#x4E86;&#x597D;&#x4E9B;&#x5E74;&#x624D;&#x627E;&#x5230;&#x7B54;&#x6848;&#x3002;&#x6240;&#x4EE5;&#x53EF;&#x89C1;&#x7ECF;&#x9A8C;&#x7684;&#x4F20;&#x627F;&#x662F;&#x591A;&#x4E48;&#x91CD;&#x8981;&#x3002;&#x4E0B;&#x9762;&#x5148;&#x8BF4;&#x600E;&#x4E48;&#x505A;&#xFF0C;&#x518D;&#x8BF4;&#x4E3A;&#x4EC0;&#x4E48;&#x3002;</p>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">&#x5982;&#x4F55;&#x505A;&#xFF1F;</h3>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x9996;&#x5148;&#x5355;&#x7EAF;&#x9760;putty&#x662F;&#x6CA1;&#x529E;&#x6CD5;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;putty&#x53EA;&#x662F;&#x5355;&#x7EAF;&#x7684;terminal emulator&#x3002;&#x800C;Linux&#x7684;&#x526A;&#x8D34;&#x677F;&#x7BA1;&#x7406;&#x662F;&#x9700;&#x8981;X-Window&#x652F;&#x6301;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x4F60;&#x9700;&#x8981;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;X11 forwarding&#x7684;&#x73AF;&#x5883;&#x3002;X11 forwarding&#x6709;&#x5F88;&#x591A;&#x9014;&#x5F84;&#x53EF;&#x4EE5;&#x505A;&#x5230;&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x884C;google&#xFF0C;&#x7B14;&#x8005;&#x9009;&#x62E9;&#x4E86;&#x4E00;&#x4E2A;turn key solution&#xFF0C;&#x5C31;&#x662F;&#x5B89;&#x88C5;<a href=\"https://mobaxterm.mobatek.net/\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">MobaXTerm</a>&#x3002;&#x9ED8;&#x8BA4;&#x7684;&#x914D;&#x7F6E;&#x5C31;&#x5DF2;&#x7ECF;&#x4F7F;&#x80FD;X11 server&#x548C;X11 forwarding&#x4E86;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x786E;&#x5B9A;&#x4F60;&#x7684;Linux&#x7CFB;&#x7EDF;&#x91CC;&#x6709;X11&#x754C;&#x9762;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BF7;&#x81EA;&#x884C;google&#x5B89;&#x88C5;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x786E;&#x5B9A;&#x4F60;&#x7684;Linux&#x7CFB;&#x7EDF;&#x91CC;&#x6709;xclip, xsel&#x6216;xclipboard&#x4E09;&#x8005;&#x4E4B;&#x4E00;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x5982;&#x679C;&#x4F60;&#x7684;DISPLAY&#x53D8;&#x91CF;&#x5728;tmux&#x4E0B;&#x4E0D;&#x6B63;&#x5E38;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;.tmux.conf&#x4E0B;&#x6DFB;&#x52A0;</li>\n</ul>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\">set -g update-environment &quot;\\\n    DISPLAY \\\n    &quot;\n</code></pre>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">bind-key -T copy-mode y send-keys -X copy-pipe-and-cancel &quot;xsel -i --clipboard&quot;</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x6700;&#x540E;&#x4E00;&#x6B65;&#x66F4;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#x662F;&#x5B89;&#x88C5;<a href=\"https://github.com/tmux-plugins/tmux-yank\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">tmux-yank</a>&#x63D2;&#x4EF6;&#x3002;</p>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8FD9;&#x4E48;&#x505A;&#xFF1F;</h3>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">Linux&#x7684;&#x684C;&#x9762;&#x7CFB;&#x7EDF;&#x7BA1;&#x7406;&#x4E86;&#x4E00;&#x4E2A;&#x526A;&#x8D34;&#x677F;&#xFF0C;&#x8FD9;&#x4E2A;&#x526A;&#x8D34;&#x677F;&#x4F9D;&#x8D56;&#x4E8E;X Window&#x7CFB;&#x7EDF;&#xFF0C;&#x7531;&#x524D;&#x8FF0;&#x7684;&#x51E0;&#x79CD;app&#x7BA1;&#x7406;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;Windows&#x4E0B;&#x7684;clip.exe&#x3002;&#x5F53;&#x5728;Windows&#x4E0B;&#x7528;ssh&#x8FDE;&#x63A5;Linux&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;X11 forwarding&#xFF0C;&#x5219;&#x5728;Windows&#x4E0B;&#x662F;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x5230;xsel&#xFF0C;xclip&#x6216;&#x8005;xclipboard&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x65E0;&#x6CD5;&#x8BBF;&#x95EE;Linux&#x7684;&#x526A;&#x8D34;&#x677F;&#x5185;&#x5BB9;&#x3002;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x597D;&#x4E86;X11 forwarding&#xFF0C;&#x5219;&#x5728;Windows&#x4E0B;&#x5C31;&#x80FD;&#x8BBF;&#x95EE;Linux&#x526A;&#x8D34;&#x677F;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">tmux&#x672C;&#x8EAB;&#x4E5F;&#x7BA1;&#x7406;&#x4E86;&#x4E00;&#x4E2A;&#x526A;&#x8D34;&#x677F;&#xFF0C;&#x79F0;&#x4E3A;buffer&#x3002;tmux&#x7684;&#x547D;&#x4EE4;copy-selection, paste-buffer, list-buffers&#x5C31;&#x662F;&#x9488;&#x5BF9;tmux&#x81EA;&#x8EAB;&#x7684;&#x526A;&#x8D34;&#x677F;&#x7684;&#x64CD;&#x4F5C;&#x3002;tmux&#x539F;&#x751F;&#x652F;&#x6301;&#xFF0C;&#x901A;&#x8FC7;&#x7A7A;&#x683C;&#x9009;&#x4E2D;&#xFF0C;Enter&#x590D;&#x5236;&#xFF0C;ctrl + ] &#x7C98;&#x8D34;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5982;&#x679C;&#x60F3;tmux&#x4E0B;&#x5C06;&#x7EC8;&#x7AEF;&#x663E;&#x793A;&#x5185;&#x5BB9;&#x590D;&#x5236;&#x5230;Windows&#x526A;&#x8D34;&#x677F;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x628A;tmux&#x526A;&#x8D34;&#x677F;&#x53D1;&#x9001;&#x5230;X11&#x7684;&#x526A;&#x8D34;&#x677F;&#x4E2D;&#x3002;tmux-yank&#x63D2;&#x4EF6;&#x505A;&#x7684;&#x5C31;&#x662F;&#x8FD9;&#x4EF6;&#x4E8B;&#x3002;&#x5F53;&#x7136;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5728;copy-mode-vi&#x8868;&#x683C;&#x91CC;&#x7ED1;&#x5B9A;&#x4EFB;&#x4F55;&#x6309;&#x952E;&#x6765;&#x505A;&#x8FD9;&#x4EF6;&#x4E8B;&#x60C5;&#x3002;</p>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">vim&#x590D;&#x5236;&#x5230;Windows&#x526A;&#x8D34;&#x677F;</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x6CA1;&#x6709;&#x8FD0;&#x884C;&#x5728;tmux&#x4E0B;&#x7684;vim&#x6216;&#x662F;gvim&#x8981;&#x590D;&#x5236;&#x5230;Windows&#x526A;&#x8D34;&#x677F;&#xFF0C;&#x6216;&#x8005;&#x8BF4;&#x662F;&#x7CFB;&#x7EDF;&#x526A;&#x8D34;&#x677F;&#xFF0C;&#x4F9D;&#x8D56;&#x7684;&#x662F;vim&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x64CD;&#x4F5C;&#x3002;&#x53EF;&#x4EE5;&#x81EA;&#x884C;google&#x3002;&#x7CFB;&#x7EDF;&#x526A;&#x8D34;&#x677F;&#x5BF9;&#x5E94;&#x7684;vim&#x5BC4;&#x5B58;&#x5668;&#x662F;&quot;+&#x3002;&#x6240;&#x4EE5;&#x5728;vim&#x4E0B;&#x5982;&#x679C;&#x60F3;&#x590D;&#x5236;&#x5230;&#x7CFB;&#x7EDF;&#x526A;&#x8D34;&#x677F;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7528;&quot;+y&#x6765;&#x53D6;&#x4EE3;&#x5E73;&#x65F6;&#x5E38;&#x7528;&#x7684;y&#x3002;&#x4F8B;&#x5982;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&quot;+yy&#xFF1A;&#x590D;&#x5236;&#x5F53;&#x524D;&#x884C;&#x5230;&#x7CFB;&#x7EDF;&#x526A;&#x8D34;&#x677F;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&quot;+yw&#xFF1A;&#x590D;&#x5236;&#x5F53;&#x524D;&#x7684;&#x5355;&#x8BCD;&#x5230;&#x7CFB;&#x7EDF;&#x526A;&#x8D34;&#x677F;</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5982;&#x679C;vim&#x8FD0;&#x884C;&#x5728;tmux&#x4E0B;&#xFF0C;&#x56E0;&#x4E3A;tmux&#x81EA;&#x5E26;&#x7684;&#x526A;&#x8D34;&#x677F;&#x5C31;&#x6709;&#x70B9;&#x9EBB;&#x70E6;&#x4E86;&#x3002;&#x8FD9;&#x65F6;&#x5019;&#x6709;&#x4E00;&#x4E2A;&#x63D2;&#x4EF6;&#x5C31;&#x6BD4;&#x8F83;&#x6709;&#x7528;&#x4E86;&#x2014;&#x2014;<a href=\"https://github.com/roxma/vim-tmux-clipboard\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">vim-tmux-clipboard</a>&#x3002;&#x4ED6;&#x4F9D;&#x8D56;&#x4E8E;&#x53E6;&#x4E00;&#x4E2A;vim&#x63D2;&#x4EF6;<a href=\"https://github.com/tmux-plugins/vim-tmux-focus-events\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">vim-tmux-focus-events</a>&#x3002;&#x88C5;&#x597D;&#x8FD9;&#x4E24;&#x4E2A;&#x63D2;&#x4EF6;&#xFF0C;&#x5728;.tmux.conf&#x4E2D;&#x6DFB;&#x52A0;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\">set -g focus-events on\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5927;&#x529F;&#x544A;&#x6210;&#x3002;&#x73B0;&#x5728;&#x5728;vim&#x4E0B;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;yank&#x5FEB;&#x6377;&#x952E;&#xFF0C;&#x4E0D;&#x7528;&#x6307;&#x5B9A;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x590D;&#x5236;&#x5185;&#x5BB9;&#x5230;tmux&#x526A;&#x8D34;&#x677F;&#xFF0C;&#x540C;&#x65F6;&#x56E0;&#x4E3A;tmux-yank&#x7684;&#x5B58;&#x5728;&#xFF0C;&#x6587;&#x672C;&#x4E5F;&#x4F1A;&#x88AB;&#x590D;&#x5236;&#x5230;&#x7CFB;&#x7EDF;&#x526A;&#x8D34;&#x677F;&#x3002;</p>\n</div><center style=\"display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden\">%E5%81%9A%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%9A%84%E5%90%8C%E5%AD%A6%EF%BC%8C%E5%A4%A7%E5%A4%9A%E5%9C%A8Linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%BC%80%E5%8F%91%E3%80%82%E7%8E%B0%E5%9C%A8%E4%B9%9F%E6%9C%89%E5%BE%88%E5%A4%9A%E5%90%8C%E5%AD%A6%E7%94%A8OSX%E5%BC%80%E5%8F%91%E3%80%82%E5%85%B6%E5%AE%9E%E4%BB%96%E4%BB%AC%E9%83%BD%E6%98%AF%E7%B1%BBUnix%E7%B3%BB%E7%BB%9F%E3%80%82%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%BC%80%E5%8F%91%E8%80%85%EF%BC%8C%E6%95%88%E7%8E%87%E5%BE%88%E9%87%8D%E8%A6%81%E3%80%82%E6%9C%89%E5%BE%88%E5%A4%9A%E9%87%8D%E5%A4%8D%E7%90%90%E7%A2%8E%E7%9A%84%E5%8A%A8%E4%BD%9C%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%83%BD%E6%8F%90%E9%AB%98%E4%B8%80%E7%82%B9%E6%95%88%E7%8E%87%EF%BC%8C%E5%A4%9A%E6%AC%A1%E7%B4%AF%E7%A7%AF%E8%B5%B7%E6%9D%A5%EF%BC%8C%E8%8A%82%E7%9C%81%E7%9A%84%E6%97%B6%E9%97%B4%E5%92%8C%E7%B2%BE%E5%8A%9B%E4%B9%9F%E6%98%AF%E5%8F%AF%E8%A7%82%E7%9A%84%E3%80%82%E5%9C%A8%E6%8F%90%E5%8D%87%E6%95%88%E7%8E%87%E7%9A%84%E5%90%8C%E6%97%B6%EF%BC%8C%E5%81%9A%E4%B8%80%E4%B8%AA%E5%BE%88%E6%9C%89%E6%95%88%E7%8E%87%EF%BC%8C%E8%80%8C%E9%81%BF%E5%85%8D%E7%90%90%E7%A2%8E%E9%87%8D%E5%A4%8D%E7%9A%84%E5%8A%A8%E4%BD%9C%EF%BC%8C%E4%B9%9F%E5%BE%88%E6%9C%89%E5%8A%A9%E4%BA%8E%E5%BF%83%E6%83%85%E7%9A%84%E6%84%89%E6%82%A6%E3%80%82%E6%89%80%E4%BB%A5%EF%BC%8C%E4%BD%86%E5%87%A1%E6%9C%89%E6%9C%BA%E4%BC%9A%EF%BC%8C%E6%88%91%E9%83%BD%E4%BC%9A%E7%BB%99%E5%88%AB%E4%BA%BA%E5%AE%89%E5%88%A9%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%BE%8B%E5%A6%82tmux%EF%BC%8Cvim%EF%BC%8Cfish%E5%95%8A%EF%BC%8C%E7%AD%89%E7%AD%89%E3%80%82%0A%0A%E6%9C%89%E4%BA%BA%E7%A7%B0tmux%2C%20zsh%2C%20vim%E6%98%AF%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%89%E5%89%91%E5%AE%A2%E3%80%82%E8%BF%99%E4%B8%89%E4%B8%AA%E5%B7%A5%E5%85%B7%E7%94%A8%E5%A5%BD%E4%BA%86%E7%A1%AE%E5%AE%9E%E5%A5%BD%E7%94%A8%E3%80%82%E6%88%91%E7%9B%AE%E5%89%8D%E7%9A%84%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AFfish%20%2B%20tmux%20%2B%20vim%E3%80%82fish%E7%9A%84%E4%BD%9C%E7%94%A8%E5%92%8Czsh%E5%B7%AE%E4%B8%8D%E5%A4%9A%E3%80%82%E6%9C%AC%E6%96%87%E6%83%B3%E7%9D%80%E9%87%8D%E4%BB%8B%E7%BB%8D%E7%9A%84%E6%98%AF%E5%9B%B0%E6%89%B0%E6%88%91%E5%BE%88%E5%A4%9A%E5%B9%B4%E7%9A%84tmux%20%2B%20vim%E7%9A%84%E5%89%AA%E8%B4%B4%E6%9D%BF%E9%97%AE%E9%A2%98%E3%80%82%0A%0A%23%23%20tmux%E4%B8%8B%E7%9A%84%E5%A4%8D%E5%88%B6%0A%0A%E5%9C%A8%E6%AF%95%E4%B8%9A%E5%90%8E%E7%9A%84%E8%8B%A5%E5%B9%B2%E5%B9%B4%E5%86%85%EF%BC%8C%E6%88%91%E4%B8%80%E7%9B%B4%E5%9C%A8Windows%E4%B8%8B%EF%BC%8C%E4%BD%BF%E7%94%A8putty%20%2B%20ssh%20%2Btmux%E8%BF%9E%E6%8E%A5%E8%BF%9C%E7%AB%AF%E7%9A%84Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%81%9A%E5%BC%80%E5%8F%91%E3%80%82%E5%A5%BD%E5%A4%84%E6%98%AF%EF%BC%8Ctmux%E5%8F%AF%E4%BB%A5%E5%81%9Asession%E7%AE%A1%E7%90%86%EF%BC%8C%E5%8D%B3%E4%BE%BFputty%20ssh%E5%85%B3%E9%97%AD%EF%BC%8C%E4%BB%BB%E5%8A%A1%E4%B8%8D%E4%BC%9A%E4%B8%AD%E6%96%AD%E3%80%82%E5%8F%AA%E8%A6%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8D%E5%85%B3%E9%97%AD%EF%BC%8C%E4%B8%8B%E6%AC%A1%E6%89%93%E5%BC%80%E4%BB%8D%E7%84%B6%E5%8F%AF%E4%BB%A5%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D%E5%B7%A5%E4%BD%9C%E7%8E%B0%E5%9C%BA%E3%80%82%0A%0A%23%23%23%20tmux%E5%88%86%E5%B1%8F%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E6%96%87%E6%9C%AC%E9%80%89%E4%B8%AD%0A%0Atmux%E4%B8%AD%E7%9A%84panel%E5%9C%A8%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E9%9D%9E%E5%B8%B8%E5%A5%BD%E7%94%A8%E3%80%82%E4%BD%86%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98%E6%98%AF%EF%BC%8C%E5%BD%93tmux%E6%9C%89%E6%A8%AA%E5%90%91%E5%88%86%E5%B1%8F%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%A4%8D%E5%88%B6%E5%A5%BD%E5%9B%B0%E9%9A%BE%E3%80%82%E6%96%87%E6%9C%AC%E7%9A%84%E9%80%89%E4%B8%AD%E4%BC%9A%E8%B7%A8%E8%B6%8Apanel%E8%BE%B9%E7%95%8C%EF%BC%88%E5%9B%BE%E6%88%AA%E4%B8%8D%E5%87%BA%E6%9D%A5%EF%BC%8C%E7%9B%B8%E4%BF%A1%E4%BD%BF%E7%94%A8tmux%E7%9A%84%E6%96%B0%E6%89%8B%E5%90%8C%E5%AD%A6%EF%BC%8C%E5%BA%94%E8%AF%A5%E9%83%BD%E9%81%87%E5%88%B0%E8%BF%87%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%89%E3%80%82%E8%A7%A3%E5%86%B3%E7%9A%84%E5%8A%9E%E6%B3%95%E6%98%AF%EF%BC%8C%E6%89%93%E5%BC%80tmux%E7%9A%84%E9%BC%A0%E6%A0%87%E6%A8%A1%E5%BC%8F%EF%BC%9A%0A%0A%60%60%60tmux%0Aset-option%20-g%20mouse%20on%0A%60%60%60%0A%0A%E6%AD%A4%E6%97%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E9%80%9A%E8%BF%87%E9%BC%A0%E6%A0%87%E9%80%89%E4%B8%AD%EF%BC%8C%E5%B0%B1%E4%B8%8D%E4%BC%9A%E8%B7%A8%E8%B6%8A%E5%88%86%E5%B1%8F%E8%BE%B9%E7%95%8C%E3%80%82%E6%80%8E%E4%B9%88%E5%A4%8D%E5%88%B6%EF%BC%8C%E5%AF%B9%E4%BA%8E%E6%96%B0%E6%89%8B%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%E3%80%82%0A%0A%3E%20vim%E7%94%A8%3Avsplit%E5%91%BD%E4%BB%A4%E5%88%86%E5%B1%8F%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%B9%9F%E6%9C%89%E5%90%8C%E6%A0%B7%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E5%A6%82%E5%87%BA%E4%B8%80%E8%BE%99%EF%BC%8C%E4%BD%BF%E8%83%BD%E9%BC%A0%E6%A0%87%E6%A8%A1%E5%BC%8F%EF%BC%8Cset%20mouse%3Da%E3%80%82%0A%0A%23%23%23%20tmux%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%A4%8D%E5%88%B6%0A%0Atmux%E7%9A%84%E6%89%80%E6%9C%89%E6%93%8D%E4%BD%9C%E9%83%BD%E6%98%AF%E9%80%9A%E8%BF%87bind-key%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%82%E6%9C%AC%E8%BA%AB%E6%9C%89%E4%B8%80%E5%A5%97%E9%BB%98%E8%AE%A4%E7%9A%84bind-key%20table%EF%BC%8C%E5%BD%93%E7%84%B6%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%87%AA%E5%AE%9A%E4%B9%89%EF%BC%8Ctmux%E6%8F%92%E4%BB%B6%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%B8%AE%E4%BD%A0%E5%AE%9A%E4%B9%89%E3%80%82%E6%89%80%E4%BB%A5%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E6%B8%85%E6%A5%9A%E7%9A%84%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E8%87%AA%E8%A1%8C%E6%9F%A5bind-key%20table%E3%80%82%E6%96%B9%E6%B3%95%E6%98%AF%EF%BC%9A%0A%0A-%20%E9%80%9A%E8%BF%87%60ctrl%20%2B%20%5B%3A%60%E8%BF%9B%E5%85%A5tmux%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F%0A-%20%E6%89%A7%E8%A1%8C%60list-keys%60%E5%91%BD%E4%BB%A4%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%0A%0A%E8%BF%99%E9%87%8C%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%E8%BE%83%E6%96%B0%E7%9A%84tmux%20%E4%B8%AD%E7%9A%84bind-key%20table%E8%BE%83%E8%80%81%E7%89%88%E6%9C%AC%E7%9A%84%E5%AE%8C%E5%85%A8%E4%B8%8D%E5%90%8C%E3%80%82%E4%BE%8B%E5%A6%82%E7%AC%94%E8%80%85%E5%BD%93%E5%89%8D%E4%BD%BF%E7%94%A8%E7%9A%84%E6%9C%80%E6%96%B0release%E7%89%88tmux2.8%EF%BC%8C%E8%80%8CUbuntu%2016.04%20LTS%E7%89%88%E6%9C%AC%E6%BA%90%E4%B8%AD%E8%87%AA%E5%B8%A6%E7%9A%84%E6%98%AFtmux%202.1%E3%80%82%E6%8D%AE%E8%AF%B4tmux%E4%B8%AD%E9%97%B4%E8%BF%9B%E8%A1%8C%E8%BF%87%E9%87%8D%E6%9E%84%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%BE%88%E5%A4%9A%E5%8A%9F%E8%83%BD%E5%85%B6%E5%AE%9E%E5%B9%B6%E4%B8%8D%E5%85%BC%E5%AE%B9%E8%80%81%E7%89%88%E6%9C%AC%E3%80%82%E6%89%80%E4%BB%A5%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%E6%96%B0%E7%89%88%E6%9C%AC%E3%80%82%0A%0A%3E%20Ubuntu%2016.04%20LTS%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E4%B8%AD%E8%87%AA%E5%B8%A6%E7%9A%84tmux%E6%98%AF2.1%E7%9A%84%E3%80%82%E8%BF%99%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%BE%88%E5%A4%9A%E5%8A%9F%E8%83%BD%E6%B2%A1%E6%B3%95%E4%BD%BF%E7%94%A8%0A%3E%0A%3E%20%60%60%60tmux%0A%3E%20%23%20tmux%202.8%20list-keys%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-Space%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20begin-selection%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20start-of-line%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-b%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20cursor-left%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20cancel%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20end-of-line%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-f%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20cursor-right%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-g%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20clear-selection%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-k%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20copy-end-of-line%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20cursor-down%0A%3E%20bind-key%20%20%20%20-T%20copy-mode%20%20%20%20C-p%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send-keys%20-X%20cursor-up%0A%3E%20%0A%3E%20%23%20tmux%202.1%20list-keys%0A%3E%20bind-key%20%20%20%20%20%20%20%20C-b%20send-prefix%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%3E%20bind-key%20%20%20%20%20%20%20%20C-o%20rotate-window%0A%3E%20bind-key%20%20%20%20%20%20%20%20C-z%20suspend-client%0A%3E%20bind-key%20%20%20%20%20%20Space%20next-layout%0A%3E%20bind-key%20%20%20%20%20%20%20%20%20%20!%20break-pane%0A%3E%20bind-key%20%20%20%20%20%20%20%20%20%20%22%20split-window%0A%3E%20bind-key%20%20%20%20%20%20%20%20%20%20%23%20list-buffers%0A%3E%20bind-key%20%20%20%20%20%20%20%20%20%20%24%20command-prompt%20-I%20%23S%20%22rename-session%20&apos;%25%25&apos;%22%0A%3E%20bind-key%20%20%20%20%20%20%20%20%20%20%25%20split-window%20-h%0A%3E%20bind-key%20%20%20%20%20%20%20%20%20%20%26%20confirm-before%20-p%20%22kill-window%20%23W%3F%20(y%2Fn)%22%20kill-window%0A%3E%20%60%60%60%0A%3E%0A%3E%20%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BE%88%E4%B8%8D%E4%B8%80%E6%A0%B7%EF%BC%9F%E8%AF%B7%E8%87%AA%E8%A1%8C%E5%BF%BD%E7%95%A52.1%E7%89%88%E6%9C%AC%E3%80%82%0A%3E%0A%3E%202.8%E4%B8%AD%E7%9A%84%E6%AF%8F%E4%B8%80%E8%A1%8C%E5%85%B6%E5%AE%9E%E8%BF%90%E8%A1%8C%E7%9A%84%E6%98%AF%E4%B8%80%E4%B8%AAbind-key%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%85%B7%E4%BD%93%E5%8F%82%E6%95%B0%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%5Btmux%20man%20page%5D(http%3A%2F%2Fman.openbsd.org%2FOpenBSD-current%2Fman1%2Ftmux.1)%0A%3E%0A%3E%20-%20-T%3A%20%E6%8C%87%E5%AE%9A%E8%A1%A8%E6%A0%BC%0A%3E%20-%20-r%3A%20%E6%8C%87%E5%AE%9A%E8%AF%A5%E6%8C%89%E9%94%AE%E5%8F%AF%E4%BB%A5repeat%E3%80%82%E4%BE%8B%E5%A6%82%E8%B0%83%E6%95%B4panel%E5%A4%A7%E5%B0%8F%EF%BC%8C%E4%BD%A0%E4%B8%8D%E6%83%B3%E6%AF%8F%E6%94%BE%E5%A4%A7%E7%BC%A9%E5%B0%8F%E4%B8%80%E6%AC%A1%E9%83%BD%E8%A6%81%E6%8C%89prefix%E5%90%A7%EF%BC%8C%E9%82%A3%E4%BC%9A%E6%8A%93%E7%8B%82%E7%9A%84%E3%80%82%0A%3E%0A%3E%20copy-mode%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E5%85%B7%E4%BD%93table%EF%BC%8C%E5%9C%A8%E4%BD%A0%E6%8C%89%E4%B8%8B%60ctrl%20%2B%20%5B%60%E8%BF%9B%E5%85%A5%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%BC%8F%E6%97%B6%E7%94%9F%E6%95%88%E3%80%82%E5%90%8C%E7%90%86%E8%BF%98%E6%9C%89%E4%B8%AA%E5%8F%ABprefix%E7%9A%84table%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E6%99%AE%E9%80%9A%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E6%8C%89%E9%94%AE%E8%A1%A8%E3%80%82%0A%0A%E8%AF%9D%E8%AF%B4%E8%BF%99%E4%B9%88%E5%A4%9A%EF%BC%8C%E5%88%B0%E5%BA%95%E6%80%8E%E4%B9%88%E5%A4%8D%E5%88%B6%EF%BC%9F%E6%90%9C%E7%B4%A2%E8%BF%99%E4%B8%AA%E8%A1%A8%E6%A0%BC%E7%9A%84%E6%98%AF%E5%90%A6%E6%9C%89%60copy-selection%60%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%E3%80%82%E6%89%80%E4%BB%A5%E9%80%9A%E5%B8%B8%60Enter%60%E4%BC%9A%E8%A2%AB%E6%98%A0%E5%B0%84%E6%88%90%60send-keys%20-X%20copy-selection-and-cancel%60%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF**%E6%8C%89%E4%B8%8BEnter%EF%BC%8C%E9%80%89%E4%B8%AD%E7%9A%84%E6%96%87%E5%AD%97%E4%BC%9A%E8%A2%AB%E5%A4%8D%E5%88%B6%E5%88%B0tmux%E5%89%AA%E8%B4%B4%E6%9D%BF**%E3%80%82%0A%0A%23%23%20tmux%E4%B8%8B%E5%A4%8D%E5%88%B6%E5%88%B0Windows%E5%89%AA%E8%B4%B4%E6%9D%BF%0A%0A%E8%BF%99%E4%B8%AA%E6%89%8D%E6%98%AF%E6%9C%AC%E7%AF%87%E6%83%B3%E8%AF%B4%E7%9A%84%E8%AF%9D%E9%A2%98%E3%80%82%E5%9B%A0%E4%B8%BA%E6%88%91%E8%8A%B1%E4%BA%86%E5%A5%BD%E4%BA%9B%E5%B9%B4%E6%89%8D%E6%89%BE%E5%88%B0%E7%AD%94%E6%A1%88%E3%80%82%E6%89%80%E4%BB%A5%E5%8F%AF%E8%A7%81%E7%BB%8F%E9%AA%8C%E7%9A%84%E4%BC%A0%E6%89%BF%E6%98%AF%E5%A4%9A%E4%B9%88%E9%87%8D%E8%A6%81%E3%80%82%E4%B8%8B%E9%9D%A2%E5%85%88%E8%AF%B4%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%8C%E5%86%8D%E8%AF%B4%E4%B8%BA%E4%BB%80%E4%B9%88%E3%80%82%0A%0A%23%23%23%20%E5%A6%82%E4%BD%95%E5%81%9A%EF%BC%9F%0A%0A%E9%A6%96%E5%85%88%E5%8D%95%E7%BA%AF%E9%9D%A0putty%E6%98%AF%E6%B2%A1%E5%8A%9E%E6%B3%95%E7%9A%84%EF%BC%8C%E5%9B%A0%E4%B8%BAputty%E5%8F%AA%E6%98%AF%E5%8D%95%E7%BA%AF%E7%9A%84terminal%20emulator%E3%80%82%E8%80%8CLinux%E7%9A%84%E5%89%AA%E8%B4%B4%E6%9D%BF%E7%AE%A1%E7%90%86%E6%98%AF%E9%9C%80%E8%A6%81X-Window%E6%94%AF%E6%8C%81%E7%9A%84%E3%80%82%E6%89%80%E4%BB%A5%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84X11%20forwarding%E7%9A%84%E7%8E%AF%E5%A2%83%E3%80%82X11%20forwarding%E6%9C%89%E5%BE%88%E5%A4%9A%E9%80%94%E5%BE%84%E5%8F%AF%E4%BB%A5%E5%81%9A%E5%88%B0%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8Cgoogle%EF%BC%8C%E7%AC%94%E8%80%85%E9%80%89%E6%8B%A9%E4%BA%86%E4%B8%80%E4%B8%AAturn%20key%20solution%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%AE%89%E8%A3%85%5BMobaXTerm%5D(https%3A%2F%2Fmobaxterm.mobatek.net%2F)%E3%80%82%E9%BB%98%E8%AE%A4%E7%9A%84%E9%85%8D%E7%BD%AE%E5%B0%B1%E5%B7%B2%E7%BB%8F%E4%BD%BF%E8%83%BDX11%20server%E5%92%8CX11%20forwarding%E4%BA%86%E3%80%82%0A%0A%E6%8E%A5%E4%B8%8B%E6%9D%A5%EF%BC%8C%E8%A6%81%E5%81%9A%E7%9A%84%E5%B0%B1%E6%98%AF%EF%BC%9A%0A%0A-%20%E7%A1%AE%E5%AE%9A%E4%BD%A0%E7%9A%84Linux%E7%B3%BB%E7%BB%9F%E9%87%8C%E6%9C%89X11%E7%95%8C%E9%9D%A2%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E8%AF%B7%E8%87%AA%E8%A1%8Cgoogle%E5%AE%89%E8%A3%85%0A-%20%E7%A1%AE%E5%AE%9A%E4%BD%A0%E7%9A%84Linux%E7%B3%BB%E7%BB%9F%E9%87%8C%E6%9C%89xclip%2C%20xsel%E6%88%96xclipboard%E4%B8%89%E8%80%85%E4%B9%8B%E4%B8%80%0A-%20%E5%A6%82%E6%9E%9C%E4%BD%A0%E7%9A%84DISPLAY%E5%8F%98%E9%87%8F%E5%9C%A8tmux%E4%B8%8B%E4%B8%8D%E6%AD%A3%E5%B8%B8%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8.tmux.conf%E4%B8%8B%E6%B7%BB%E5%8A%A0%0A%0A%60%60%60tmux%0Aset%20-g%20update-environment%20%22%5C%0A%20%20%20%20DISPLAY%20%5C%0A%20%20%20%20%22%0A%60%60%60%0A%0A-%20bind-key%20-T%20copy-mode%20y%20send-keys%20-X%20copy-pipe-and-cancel%20%22xsel%20-i%20--clipboard%22%0A%0A%E6%9C%80%E5%90%8E%E4%B8%80%E6%AD%A5%E6%9B%B4%E4%BC%98%E9%9B%85%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%98%AF%E5%AE%89%E8%A3%85%5Btmux-yank%5D(https%3A%2F%2Fgithub.com%2Ftmux-plugins%2Ftmux-yank)%E6%8F%92%E4%BB%B6%E3%80%82%0A%0A%23%23%23%20%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%99%E4%B9%88%E5%81%9A%EF%BC%9F%0A%0ALinux%E7%9A%84%E6%A1%8C%E9%9D%A2%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E4%BA%86%E4%B8%80%E4%B8%AA%E5%89%AA%E8%B4%B4%E6%9D%BF%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%89%AA%E8%B4%B4%E6%9D%BF%E4%BE%9D%E8%B5%96%E4%BA%8EX%20Window%E7%B3%BB%E7%BB%9F%EF%BC%8C%E7%94%B1%E5%89%8D%E8%BF%B0%E7%9A%84%E5%87%A0%E7%A7%8Dapp%E7%AE%A1%E7%90%86%EF%BC%8C%E7%B1%BB%E4%BC%BC%E4%BA%8EWindows%E4%B8%8B%E7%9A%84clip.exe%E3%80%82%E5%BD%93%E5%9C%A8Windows%E4%B8%8B%E7%94%A8ssh%E8%BF%9E%E6%8E%A5Linux%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9C%AA%E8%AE%BE%E7%BD%AEX11%20forwarding%EF%BC%8C%E5%88%99%E5%9C%A8Windows%E4%B8%8B%E6%98%AF%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%E5%88%B0xsel%EF%BC%8Cxclip%E6%88%96%E8%80%85xclipboard%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AELinux%E7%9A%84%E5%89%AA%E8%B4%B4%E6%9D%BF%E5%86%85%E5%AE%B9%E3%80%82%E5%A6%82%E6%9E%9C%E8%AE%BE%E7%BD%AE%E5%A5%BD%E4%BA%86X11%20forwarding%EF%BC%8C%E5%88%99%E5%9C%A8Windows%E4%B8%8B%E5%B0%B1%E8%83%BD%E8%AE%BF%E9%97%AELinux%E5%89%AA%E8%B4%B4%E6%9D%BF%E3%80%82%0A%0Atmux%E6%9C%AC%E8%BA%AB%E4%B9%9F%E7%AE%A1%E7%90%86%E4%BA%86%E4%B8%80%E4%B8%AA%E5%89%AA%E8%B4%B4%E6%9D%BF%EF%BC%8C%E7%A7%B0%E4%B8%BAbuffer%E3%80%82tmux%E7%9A%84%E5%91%BD%E4%BB%A4copy-selection%2C%20paste-buffer%2C%20list-buffers%E5%B0%B1%E6%98%AF%E9%92%88%E5%AF%B9tmux%E8%87%AA%E8%BA%AB%E7%9A%84%E5%89%AA%E8%B4%B4%E6%9D%BF%E7%9A%84%E6%93%8D%E4%BD%9C%E3%80%82tmux%E5%8E%9F%E7%94%9F%E6%94%AF%E6%8C%81%EF%BC%8C%E9%80%9A%E8%BF%87%E7%A9%BA%E6%A0%BC%E9%80%89%E4%B8%AD%EF%BC%8CEnter%E5%A4%8D%E5%88%B6%EF%BC%8Cctrl%20%2B%20%5D%20%E7%B2%98%E8%B4%B4%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E6%83%B3tmux%E4%B8%8B%E5%B0%86%E7%BB%88%E7%AB%AF%E6%98%BE%E7%A4%BA%E5%86%85%E5%AE%B9%E5%A4%8D%E5%88%B6%E5%88%B0Windows%E5%89%AA%E8%B4%B4%E6%9D%BF%E8%A6%81%E5%81%9A%E7%9A%84%E5%B0%B1%E6%98%AF%E6%8A%8Atmux%E5%89%AA%E8%B4%B4%E6%9D%BF%E5%8F%91%E9%80%81%E5%88%B0X11%E7%9A%84%E5%89%AA%E8%B4%B4%E6%9D%BF%E4%B8%AD%E3%80%82tmux-yank%E6%8F%92%E4%BB%B6%E5%81%9A%E7%9A%84%E5%B0%B1%E6%98%AF%E8%BF%99%E4%BB%B6%E4%BA%8B%E3%80%82%E5%BD%93%E7%84%B6%E4%BD%A0%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%9C%A8copy-mode-vi%E8%A1%A8%E6%A0%BC%E9%87%8C%E7%BB%91%E5%AE%9A%E4%BB%BB%E4%BD%95%E6%8C%89%E9%94%AE%E6%9D%A5%E5%81%9A%E8%BF%99%E4%BB%B6%E4%BA%8B%E6%83%85%E3%80%82%0A%0A%23%23%20vim%E5%A4%8D%E5%88%B6%E5%88%B0Windows%E5%89%AA%E8%B4%B4%E6%9D%BF%0A%0A%E6%B2%A1%E6%9C%89%E8%BF%90%E8%A1%8C%E5%9C%A8tmux%E4%B8%8B%E7%9A%84vim%E6%88%96%E6%98%AFgvim%E8%A6%81%E5%A4%8D%E5%88%B6%E5%88%B0Windows%E5%89%AA%E8%B4%B4%E6%9D%BF%EF%BC%8C%E6%88%96%E8%80%85%E8%AF%B4%E6%98%AF%E7%B3%BB%E7%BB%9F%E5%89%AA%E8%B4%B4%E6%9D%BF%EF%BC%8C%E4%BE%9D%E8%B5%96%E7%9A%84%E6%98%AFvim%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8%E6%93%8D%E4%BD%9C%E3%80%82%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8Cgoogle%E3%80%82%E7%B3%BB%E7%BB%9F%E5%89%AA%E8%B4%B4%E6%9D%BF%E5%AF%B9%E5%BA%94%E7%9A%84vim%E5%AF%84%E5%AD%98%E5%99%A8%E6%98%AF%22%2B%E3%80%82%E6%89%80%E4%BB%A5%E5%9C%A8vim%E4%B8%8B%E5%A6%82%E6%9E%9C%E6%83%B3%E5%A4%8D%E5%88%B6%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E8%B4%B4%E6%9D%BF%EF%BC%8C%E4%BD%A0%E5%8F%AF%E4%BB%A5%E7%94%A8%22%2By%E6%9D%A5%E5%8F%96%E4%BB%A3%E5%B9%B3%E6%97%B6%E5%B8%B8%E7%94%A8%E7%9A%84y%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%9A%0A%0A-%20%22%2Byy%EF%BC%9A%E5%A4%8D%E5%88%B6%E5%BD%93%E5%89%8D%E8%A1%8C%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E8%B4%B4%E6%9D%BF%0A-%20%22%2Byw%EF%BC%9A%E5%A4%8D%E5%88%B6%E5%BD%93%E5%89%8D%E7%9A%84%E5%8D%95%E8%AF%8D%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E8%B4%B4%E6%9D%BF%0A%0A%E5%A6%82%E6%9E%9Cvim%E8%BF%90%E8%A1%8C%E5%9C%A8tmux%E4%B8%8B%EF%BC%8C%E5%9B%A0%E4%B8%BAtmux%E8%87%AA%E5%B8%A6%E7%9A%84%E5%89%AA%E8%B4%B4%E6%9D%BF%E5%B0%B1%E6%9C%89%E7%82%B9%E9%BA%BB%E7%83%A6%E4%BA%86%E3%80%82%E8%BF%99%E6%97%B6%E5%80%99%E6%9C%89%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6%E5%B0%B1%E6%AF%94%E8%BE%83%E6%9C%89%E7%94%A8%E4%BA%86%E2%80%94%E2%80%94%5Bvim-tmux-clipboard%5D(https%3A%2F%2Fgithub.com%2Froxma%2Fvim-tmux-clipboard)%E3%80%82%E4%BB%96%E4%BE%9D%E8%B5%96%E4%BA%8E%E5%8F%A6%E4%B8%80%E4%B8%AAvim%E6%8F%92%E4%BB%B6%5Bvim-tmux-focus-events%5D(https%3A%2F%2Fgithub.com%2Ftmux-plugins%2Fvim-tmux-focus-events)%E3%80%82%E8%A3%85%E5%A5%BD%E8%BF%99%E4%B8%A4%E4%B8%AA%E6%8F%92%E4%BB%B6%EF%BC%8C%E5%9C%A8.tmux.conf%E4%B8%AD%E6%B7%BB%E5%8A%A0%0A%0A%60%60%60tmux%0Aset%20-g%20focus-events%20on%0A%60%60%60%0A%0A%E5%A4%A7%E5%8A%9F%E5%91%8A%E6%88%90%E3%80%82%E7%8E%B0%E5%9C%A8%E5%9C%A8vim%E4%B8%8B%EF%BC%8C%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8yank%E5%BF%AB%E6%8D%B7%E9%94%AE%EF%BC%8C%E4%B8%8D%E7%94%A8%E6%8C%87%E5%AE%9A%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%A4%8D%E5%88%B6%E5%86%85%E5%AE%B9%E5%88%B0tmux%E5%89%AA%E8%B4%B4%E6%9D%BF%EF%BC%8C%E5%90%8C%E6%97%B6%E5%9B%A0%E4%B8%BAtmux-yank%E7%9A%84%E5%AD%98%E5%9C%A8%EF%BC%8C%E6%96%87%E6%9C%AC%E4%B9%9F%E4%BC%9A%E8%A2%AB%E5%A4%8D%E5%88%B6%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E8%B4%B4%E6%9D%BF%E3%80%82</center>",
            "tags": [
                "Linux",
                "vim",
                "tmux"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2019/02/03/PIP%E5%9C%A8Linux+glibc%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0/",
            "url": "https://blog.zhougy.top/2019/02/03/PIP%E5%9C%A8Linux+glibc%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0/",
            "title": "PIP在Linux+glibc中的实现",
            "date_published": "2019-02-03T12:00:24.000Z",
            "content_html": "<div style=\"font-size: 14px; margin: 0; padding: 0; width: 100%;\"><h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">&#x4F18;&#x5148;&#x7EA7;&#x53CD;&#x8F6C;</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x4F18;&#x5148;&#x7EA7;&#x53CD;&#x8F6C;&#x6307;&#x4E00;&#x4E2A;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x4EFB;&#x52A1;&#x56E0;&#x4E3A;&#x8D44;&#x6E90;&#x88AB;&#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#x4EFB;&#x52A1;&#x5360;&#x7528;&#xFF0C;&#x800C;&#x4E0D;&#x5F97;&#x4E0D;&#x7B49;&#x5F85;&#x3002;&#x8FD9;&#x4E2A;&#x903B;&#x8F91;&#x672C;&#x8EAB;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#x3002;&#x4F18;&#x5148;&#x7EA7;&#x53CD;&#x8F6C;&#x5E26;&#x6765;&#x6700;&#x76F4;&#x63A5;&#x7684;&#x95EE;&#x9898;&#x5C31;&#x662F;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x53EF;&#x80FD;&#x56E0;&#x4E3A;&#x8FD9;&#x6B21;&#x963B;&#x585E;&#xFF0C;&#x800C;&#x65E0;&#x6CD5;&#x786E;&#x5B9A;&#x963B;&#x585E;&#x65F6;&#x5EF6;&#x3002;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x3002;<br>\n\n        <img class=\"enMedia\" src=\"/images/PIP&#x5728;Linux+glibc&#x4E2D;&#x7684;&#x5B9E;&#x73B0;/1547609810638.png\" hash=\"8df099f053cbeaee4881a9d6ffc8963f\" align alt longdesc width=\"765\" height=\"210\" border hspace vspace usemap style title lang xml:lang dir>\n      </p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">Task 9&#x4F18;&#x5148;&#x7EA7;&#x8F83;&#x4F4E;&#xFF0C;&#x6240;&#x4EE5;&#x5F88;&#x5BB9;&#x6613;&#x88AB;&#x5176;&#x4ED6;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x4EFB;&#x52A1;&#x62A2;&#x5360;&#x8FD0;&#x884C;&#xFF0C;&#x5BFC;&#x81F4;&#x5BF9;&#x8D44;&#x6E90;S&#x7684;&#x9501;&#x65E0;&#x6CD5;&#x91CA;&#x653E;&#xFF0C;&#x800C;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x4EFB;&#x52A1;&#x56E0;&#x4E3A;&#x8981;&#x6301;&#x6709;&#x8BE5;&#x9501;&#xFF0C;&#x4E0D;&#x5F97;&#x4E0D;&#x7B49;&#x5F85;&#x3002;</p>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">Priority Inheritance Protocol&#x7FFB;&#x8BD1;&#x4E3A;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#xFF0C;&#x7B80;&#x79F0;PIP&#x3002;&#x8FD9;&#x662F;&#x89E3;&#x51B3;&#x4E0A;&#x8FF0;Unbounded inversion&#x6700;&#x76F4;&#x63A5;&#x7684;&#x529E;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;&#x5C06;&#x5360;&#x6709;&#x9501;&#x7684;&#x7EBF;&#x7A0B;&#x4F18;&#x5148;&#x7EA7;&#x8C03;&#x6574;&#x5230;&#x5728;&#x7B49;&#x5F85;&#x7684;&#x4EFB;&#x52A1;&#x7684;&#x6700;&#x9AD8;&#x503C;&#x3002;&#x8FD9;&#x4E2A;&#x7B97;&#x6CD5;&#x662F;&#x8D2A;&#x5A6A;&#x7684;&#xFF0C;&#x5C40;&#x90E8;&#x6700;&#x4F18;&#xFF0C;&#x4F46;&#x4E0D;&#x662F;&#x6574;&#x4F53;&#x6700;&#x4F18;&#x89E3;&#xFF0C;&#x5728;&#x6B64;&#x4E4B;&#x4E0A;&#x53C8;&#x6709;PCP(&#x4F18;&#x5148;&#x7EA7;&#x5929;&#x82B1;&#x677F;)&#x548C;SRP(&#x57FA;&#x4E8E;&#x6808;&#x7684;&#x8D44;&#x6E90;&#x7B56;&#x7565;)&#x3002;&#x672C;&#x6587;&#x4E0D;&#x505A;&#x8BA8;&#x8BBA;&#x3002;&#x672C;&#x6587;&#x4E3B;&#x8981;&#x4ECE;&#x6E90;&#x7801;&#x7684;&#x89D2;&#x5EA6;&#xFF0C;&#x9610;&#x8FF0;PIP&#x5728;Linux&#x548C;glibc&#x4E2D;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x3002;</p>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">Overview</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">\n        <img class=\"enMedia\" src=\"/images/PIP&#x5728;Linux+glibc&#x4E2D;&#x7684;&#x5B9E;&#x73B0;/1549009792507.png\" hash=\"b16f478e9d2cf9485b4b8bba9e81e3b0\" align alt longdesc width=\"719\" height=\"287\" border hspace vspace usemap style title lang xml:lang dir>\n      </p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">Linux&#x4E0B;&#x7684;PIP&#x5B9E;&#x73B0;&#x5206;&#x6210;&#x4EE5;&#x4E0A;3&#x4E2A;&#x90E8;&#x5206;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">glibc&#x4E2D;&#x7684;pthread_mutex_lock&#x63D0;&#x4F9B;&#x7528;&#x6237;&#x63A5;&#x53E3;&#xFF0C;&#x901A;&#x8FC7;FUTEX_LOCK_PI&#x5B9E;&#x73B0;&#x4F18;&#x5148;&#x7EA7;&#x8C03;&#x6574;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">Linux&#x7684;futex&#x90E8;&#x5206;&#x63D0;&#x4F9B;FUTEX_LOCK_PI&#x7684;&#x5B9E;&#x73B0;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x6700;&#x7EC8;&#x7684;&#x9501;&#x673A;&#x5236;&#x901A;&#x8FC7;rt_mutex&#x6765;&#x5B9E;&#x73B0;</li>\n</ul>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">pthread_mutex</h2>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">Types</h3>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">pthread mutex&#x662F;POSIX pthread&#x5E93;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x4E00;&#x79CD;&#x9501;&#x673A;&#x5236;&#xFF0C;&#x4E0E;&#x4FE1;&#x53F7;&#x91CF;&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x4E2A;&#x9501;&#x53EA;&#x6709;&#x4E24;&#x79CD;&#x72B6;&#x6001;&#xFF1A;locked&#x6216;unlocked&#x3002;&#x4E0E;binary semaphore&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF0C;mutex&#x53EA;&#x80FD;&#x88AB;lock&#x7684;&#x7EBF;&#x7A0B;unlock&#xFF0C;&#x5373;&#x53EA;&#x80FD;&#x88AB;mutex owner unlock&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x76EE;&#x524D;<a href=\"http://pubs.opengroup.org/onlinepubs/9699919799/functions/contents.html\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">POSIX&#x6807;&#x51C6;(1003.1-2008)</a>&#x4E2D;&#x5B9A;&#x4E49;&#x4E86;4&#x79CD;&#x7C7B;&#x578B;&#x7684;mutex:</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">PTHREAD_MUTEX_NORMAL</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">PTHREAD_MUTEX_ERRORCHECK</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">PTHREAD_MUTEX_RECURSIVE</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">PTHREAD_MUTEX_DEFAULT</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;4&#x79CD;mutex&#x4E0D;&#x540C;&#x4E4B;&#x5904;&#x5982;&#x4E0B;</p>\n<table style=\"margin: 2px 0 14px; color: #333; width: auto; border-collapse: collapse; box-sizing: border-box;\"><thead style=\"line-height: 160%; box-sizing: content-box;\"><tr style=\"line-height: 160%; box-sizing: content-box;\"><th style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;\"></th><th style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;\">attempting to relock this mutex without first unlocking</th><th style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;\">Attempting to unlock a mutex locked by a different thread</th></tr></thead><tbody style=\"line-height: 160%; box-sizing: content-box;\"><tr style=\"line-height: 160%; box-sizing: content-box;\"><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">NORMAL</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">deadlock</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">undefined</td></tr><tr style=\"line-height: 160%; box-sizing: content-box;\"><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">ERRORCHECK</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">return error -EDEADLOCK</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">return error</td></tr><tr style=\"line-height: 160%; box-sizing: content-box;\"><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">RECURSIVE</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">succeed in locking</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">return error</td></tr><tr style=\"line-height: 160%; box-sizing: content-box;\"><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">DEFAULT</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">undefined</td><td style=\"line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;\">undefined</td></tr></tbody></table>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">glibc&#x5BF9;&#x4E0A;&#x8FF0;4&#x79CD;&#x7C7B;&#x578B;&#x7684;mutex&#x8FDB;&#x884C;&#x4E86;&#x6269;&#x5C55;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\">    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_RECURSIVE_NP:\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_ERRORCHECK_NP:\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_NORMAL_NP:\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_ADAPTIVE_NP:\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_ROBUST_RECURSIVE_NP:\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_ROBUST_ERRORCHECK_NP:\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_ROBUST_NORMAL_NP:\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> PTHREAD_MUTEX_PI_ROBUST_ADAPTIVE_NP:\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x4E3B;&#x8981;&#x591A;&#x4E86;&#x8FD9;3&#x79CD;&#x5C5E;&#x6027;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">ADAPTIVE&#xFF1A;&#x5728;SMP&#x67B6;&#x6784;&#x4E0B;&#xFF0C;&#x5E76;&#x4E0D;&#x76F4;&#x63A5;&#x8FDB;&#x5165;wait&#xFF0C;&#x800C;&#x662F;&#x5148;&#x8C03;&#x7528;spinlock&#x7B49;&#x5F85;&#x4E00;&#x5C0F;&#x6BB5;&#x65F6;&#x95F4;&#x3002;musl&#x91CC;&#x9ED8;&#x8BA4;&#x90FD;&#x91C7;&#x7528;&#x4E86;&#x8FD9;&#x79CD;&#x5B9E;&#x73B0;</p>\n</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">PI&#xFF1A;&#x5305;&#x542B;&#x8BE5;&#x5C5E;&#x6027;&#x7684;mutex&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;(Priority Inheritance, PI)</p>\n</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">ROBUST&#xFF1A;&#x82E5;&#x7EBF;&#x7A0B;&#x9000;&#x51FA;&#x65F6;&#x672A;&#x91CA;&#x653E;&#x9501;&#xFF0C;&#x5219;&#x4EE5;&#x540E;&#x5BF9;&#x8BE5;&#x9501;&#x64CD;&#x4F5C;&#x90FD;&#x4F1A;&#x8FD4;&#x56DE;-EOWNERDEAD&#xFF0C;&#x4E0E;&#x4E4B;&#x5BF9;&#x5E94;&#x7684;&#x662F;PTHREAD_MUTEX_STALLED(&#x8FD9;&#x662F;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;)&#xFF0C;&#x5BF9;&#x8BE5;&#x5F02;&#x5E38;&#x9501;&#x7684;&#x64CD;&#x4F5C;&#x4F1A;&#x51FA;&#x73B0;undefined&#x884C;&#x4E3A;&#x3002;</p>\n</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x518D;&#x4E0E;&#x539F;&#x5148;&#x7684;4&#x79CD;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x6392;&#x5217;&#x7EC4;&#x5408;&#x3002;</p>\n<blockquote style=\"line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;\">\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;\"><strong style=\"line-height: 160%; box-sizing: content-box; font-weight: 700;\">&quot;_NP&quot; suffix</strong></p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">Note: the _NP suffix indicates a non-portable extension to the POSIX specification. In fact the latest specification, 1003.1-2008 [<a href=\"http://2net.co.uk/tutorial/mutex_mutandis#ref_2\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">2]</a>, includes most of the Linux additions so you can leave the _NP ending off. I have chosen not to because some older versions of the header files only have the _NP variants.</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-bottom: 0;\">&#x6839;&#x636E;&#x6700;&#x65B0;&#x7684;POSIX&#x6807;&#x51C6;1003.1-2008&#xFF0C;&#x8FD9;&#x4E9B;&#x6269;&#x5C55;&#x5E76;&#x6CA1;&#x6709;&#x52A0;&#x5165;&#x3002;</p>\n</blockquote>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x672C;&#x6587;&#x53EA;&#x5173;&#x6CE8;MUTEX_PI&#x5B9E;&#x73B0;&#x3002;</p>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">PTHREAD_MUTEX_PI</h3>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">pthread_mutex_lock</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x91CD;&#x8981;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">typedef</span> <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">union</span>\n&#123;\n  <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> __<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">pthread_mutex_s</span> __<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">data</span>;</span>\n  <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">char</span> __size[__SIZEOF_PTHREAD_MUTEX_T];\n  <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">long</span> <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> __align;\n&#125; <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">pthread_mutex_t</span>;\n<span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> __<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">pthread_mutex_s</span>\n&#123;</span>\n  <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> __lock __LOCK_ALIGNMENT;\n  <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">unsigned</span> <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> __count;\n  <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> __owner;\n  ...\n&#125;\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5982;&#x679C;&#x4E0D;&#x8003;&#x8651;ROBUST&#x60C5;&#x51B5;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x4E00;&#x6B21;&#x9488;&#x5BF9;&#x5B9E;&#x73B0;&#x4E86;PI&#x5C5E;&#x6027;&#x7684;pthread_mutex_lock&#x64CD;&#x4F5C;&#x5982;&#x4E0B;&#xFF1A;<br>\n\n        <img class=\"enMedia\" src=\"/images/PIP&#x5728;Linux+glibc&#x4E2D;&#x7684;&#x5B9E;&#x73B0;/1549014356838.png\" hash=\"36c67b688ae44843223a576d9cc0be30\" align alt longdesc width=\"599\" height=\"632\" border hspace vspace usemap style title lang xml:lang dir>\n      </p>\n<blockquote style=\"line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;\">\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;\"><strong style=\"line-height: 160%; box-sizing: content-box; font-weight: 700;\">atomic_compare_and_exchange_val_acq</strong></p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x539F;&#x5B50;&#x64CD;&#x4F5C;&#xFF0C;&#x5148;&#x6BD4;&#x8F83;&#x518D;&#x8D4B;&#x503C;&#xFF0C;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"><span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">compare_and_swap</span><span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">(<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span>* reg, <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> oldval, <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> newval)</span>\n</span>&#123;\n    ATOMIC();\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> old_reg_val = *reg;\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">if</span> (old_reg_val == oldval)\n      *reg = newval;\n    END_ATOMIC();\n    <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">return</span> old_reg_val;\n&#125;\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x9488;&#x5BF9;&#x4EE3;&#x7801;&#x4E2D;&#x7684;&#x5177;&#x4F53;&#x60C5;&#x51B5;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">oldval == 0</code>: &#x8868;&#x793A;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">mutex-&gt;__data.__lock == 0</code>&#xFF0C;&#x5373;&#x8BE5;lock&#x65E0;owner&#xFF0C;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x3002;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">oldval != 0</code>: &#x8868;&#x793A;&#x8BE5;mutex&#x88AB;lock&#x4E86;&#xFF0C;&#x4ECE;&#x800C;&#x8FDB;&#x5165;kernel&#x6765;&#x5904;&#x7406;&#x9501;&#x7684;&#x60C5;&#x51B5;&#x3002;</li>\n</ul>\n</blockquote>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">pthread_mutex_lock&#x7684;&#x903B;&#x8F91;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x539F;&#x5B50;&#x64CD;&#x4F5C;&#x5224;&#x65AD;&#x9501;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;&#x9501;&#x4F4F;&#x3002;&#x5982;&#x679C;&#x6CA1;&#x9501;&#x4F4F;&#x5C31;&#x66F4;&#x65B0;owner&#xFF0C;&#x4EE5;&#x53CA;user&#x8BA1;&#x6570;&#x3002;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x88AB;&#x9501;&#x4F4F;&#xFF0C;&#x5219;&#x9677;&#x5165;&#x5185;&#x6838;&#x8C03;&#x7528;FUTEX_LOCK_PI&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5B8C;&#x6210;&#x4E0A;&#x9501;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">pthread_mutex_unlock</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x57FA;&#x672C;&#x4E0A;&#x5C31;&#x662F;&#x76F4;&#x63A5;&#x8C03;&#x7528;futex_unlock_pi SYSCALL&#x6765;&#x5B8C;&#x6210;&#x5DE5;&#x4F5C;&#xFF1A;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\">      <span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">/* Unlock the mutex using a CAS unless there are futex waiters or our\n&#x203A;    TID is not the value of __lock anymore, in which case we let the\n&#x203A;    kernel take care of the situation.  Use release MO in the CAS to\n&#x203A;    synchronize with acquire MO in lock acquisitions.  */</span>\n      <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> l = atomic_load_relaxed (&amp;mutex-&gt;__data.__lock);\n      <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">do</span>\n&#x203A;   &#123;\n&#x203A;     <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">if</span> (((l &amp; FUTEX_WAITERS) != <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">0</span>)\n&#x203A;         || (l != THREAD_GETMEM (THREAD_SELF, tid)))\n&#x203A;       &#123;\n&#x203A;         INTERNAL_SYSCALL_DECL (__err);\n&#x203A;         INTERNAL_SYSCALL (futex, __err, <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">2</span>, &amp;mutex-&gt;__data.__lock,\n&#x203A;   &#x203A;   &#x203A;   &#x203A;   __lll_private_flag (FUTEX_UNLOCK_PI, <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">private</span>));\n&#x203A;         <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">break</span>;\n&#x203A;       &#125;\n&#x203A;   &#125;\n      <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">while</span> (!atomic_compare_exchange_weak_release (&amp;mutex-&gt;__data.__lock,\n&#x203A;   &#x203A;   &#x203A;   &#x203A;   &#x203A;   &#x203A;       &amp;l, <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">0</span>));\n</code></pre>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">futex</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">futex&#x662F;&#x4E00;&#x79CD;&#x5185;&#x6838;&#x7684;&#x7B49;&#x5F85;&#x673A;&#x5236;&#xFF0C;&#x7B49;&#x5F85;&#x67D0;&#x4E2A;&#x7528;&#x6237;&#x6001;&#x6570;&#x636E;&#x88AB;&#x8BBE;&#x7F6E;&#x6210;&#x67D0;&#x4E2A;&#x503C;&#x3002;&#x9488;&#x5BF9;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#x7684;futex&#x7565;&#x6709;&#x4E0D;&#x540C;&#x3002;&#x5B83;&#x4E0D;&#x518D;&#x7B49;&#x5F85;&#x7528;&#x6237;&#x4F20;&#x5165;&#x7684;&#x5730;&#x5740;&#x4E0A;&#x7684;&#x503C;&#xFF0C;&#x800C;&#x662F;&#x57FA;&#x4E8E;&#x5185;&#x6838;rt_mutex&#x673A;&#x5236;&#x5B9E;&#x73B0;&#x7B49;&#x5F85;&#xFF0C;&#x4E0A;&#x9501;&#x548C;&#x89E3;&#x9501;&#x7684;&#x529F;&#x80FD;&#x3002;&#x770B;&#x4E0B;&#x9762;glibc&#x548C;Linux&#x7684;&#x63A5;&#x53E3;&#x5BF9;&#x63A5;&#xFF1A;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"><span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">// glibc: pthread_mutex_lock.c</span>\n<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> e = INTERNAL_SYSCALL (futex, __err, <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">4</span>, &amp;mutex-&gt;__data.__lock,\n&#x203A;   &#x203A;         __lll_private_flag (FUTEX_LOCK_PI,\n&#x203A;   &#x203A;   &#x203A;   &#x203A;   &#x203A;     <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">private</span>), <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">1</span>, <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">0</span>);\n\n<span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">// Linux: futex.c</span>\n<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">long</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">do_futex</span><span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">(u32 __user *uaddr, <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> op, u32 val, <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">ktime_t</span> *timeout,\n&#x203A;   &#x203A;   u32 __user *uaddr2, u32 val2, u32 val3)</span>\n</span>&#123;\n...\n\t<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">case</span> FUTEX_LOCK_PI:\n&#x203A;   \t<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">return</span> futex_lock_pi(uaddr, flags, <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">NULL</span>, <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">1</span>);    \n... \n&#125;\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x53EF;&#x89C1;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">uaddr = &amp;mutex-&gt;__data.__lock</code></li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">flags = __lll_private_flag (FUTEX_LOCK_PI, private)</code></li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">val = 1, timeout = NULL</code></li>\n</ul>\n<blockquote style=\"line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;\">\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;\">&#x5173;&#x4E8E;lock/unlock&#x7684;&#x53D9;&#x8FF0;&#x4F1A;&#x7B80;&#x5316;&#x6389;time&#x76F8;&#x5173;&#x90E8;&#x5206;&#xFF0C;&#x4EE5;&#x53CA;PI&#x65E0;&#x5173;&#x7684;ROBUST&#x7B49;&#x7279;&#x6027;&#x3002;</p>\n</blockquote>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">&#x91CD;&#x8981;&#x6570;&#x636E;&#x7ED3;&#x6784;</h3>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"><span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">/*\n * Hash buckets are shared by all the futex_keys that hash to the same\n * location.  Each key may have multiple futex_q structures, one for each task\n * waiting on a futex.\n */</span>\n<span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">futex_hash_bucket</span> &#123;</span>\n&#x203A;   <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">atomic_t</span> waiters;\n&#x203A;   <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">spinlock_t</span> lock;\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">plist_head</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">chain</span>;</span>\n&#125; ____cacheline_aligned_in_smp;\n\n<span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">/**\n * struct futex_q - The hashed futex queue entry, one per waiting task\n * @list:&#x203A;  &#x203A;   priority-sorted list of tasks waiting on this futex\n * @task:&#x203A;  &#x203A;   the task waiting on the futex\n * @lock_ptr:&#x203A;  &#x203A;   the hash bucket lock\n * @key:&#x203A;   &#x203A;   the key the futex is hashed on\n * @pi_state:&#x203A;  &#x203A;   optional priority inheritance state\n * @rt_waiter:&#x203A; &#x203A;   rt_waiter storage for use with requeue_pi\n * @requeue_pi_key:&#x203A;the requeue_pi target futex key\n * @bitset:&#x203A;&#x203A;   bitset for the optional bitmasked wakeup\n *\n * We use this hashed waitqueue, instead of a normal wait_queue_entry_t, so\n * we can wake only the relevant ones (hashed queues may be shared).\n *\n * A futex_q has a woken state, just like tasks have TASK_RUNNING.\n * It is considered woken when plist_node_empty(&amp;q-&gt;list) || q-&gt;lock_ptr == 0.\n * The order of wakeup is always to make the first condition true, then\n * the second.\n *\n * PI futexes are typically woken before they are removed from the hash list via\n * the rt_mutex code. See unqueue_me_pi().\n */</span>\n<span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">futex_q</span> &#123;</span>\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">plist_node</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">list</span>;</span>\n\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">task_struct</span> *<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">task</span>;</span>\n&#x203A;   <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">spinlock_t</span> *lock_ptr;\n&#x203A;   <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">union</span> futex_key key;\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">futex_pi_state</span> *<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">pi_state</span>;</span>\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">rt_mutex_waiter</span> *<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">rt_waiter</span>;</span>\n&#x203A;   <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">union</span> futex_key *requeue_pi_key;\n&#x203A;   u32 <span style=\"color: #4ec9b0; line-height: 160%; box-sizing: content-box;\">bitset</span>;\n&#125; __randomize_layout;\n\n<span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">/*\n * Priority Inheritance state:\n */</span>\n<span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">futex_pi_state</span> &#123;</span>\n&#x203A;   <span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">/*\n&#x203A;    * list of &apos;owned&apos; pi_state instances - these have to be\n&#x203A;    * cleaned up in do_exit() if the task exits prematurely:\n&#x203A;    */</span>\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">list_head</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">list</span>;</span>\n\n&#x203A;   <span style=\"color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;\">/*\n&#x203A;    * The PI object:\n&#x203A;    */</span>\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">rt_mutex</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">pi_mutex</span>;</span>\n\n&#x203A;   <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">struct</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">task_struct</span> *<span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">owner</span>;</span>\n&#x203A;   <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">atomic_t</span> refcount;\n\n&#x203A;   <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">union</span> futex_key key;\n&#125; __randomize_layout;\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">futex_hash_bucket</code>&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x6001;&#x7684;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">uaddr</code>&#x3002;&#x901A;&#x8FC7;&#x7528;&#x6237;&#x6001;&#x4F20;&#x5165;&#x7684;uaddr&#x5730;&#x5740;&#xFF0C;&#x6765;&#x83B7;&#x5F97;&#x5BF9;&#x5E94;&#x7684;futex&#x7ED3;&#x6784;&#x4F53;&#x3002;&#x7528;hash&#x7684;&#x539F;&#x56E0;&#x662F;&#x4F20;&#x5165;&#x7684;&#x662F;uaddr&#x5730;&#x5740;&#x503C;&#xFF0C;&#x6570;&#x5B57;&#x5F88;&#x5927;&#xFF0C;&#x5206;&#x5E03;&#x5F88;&#x6563;&#xFF0C;&#x6240;&#x4EE5;&#x7528;hash&#x53EF;&#x4EE5;&#x6709;&#x6548;&#x7D22;&#x5F15;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">futex_q</code>&#x662F;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#xFF0C;&#x5BF9;&#x5E94;&#x4E86;&#x4E00;&#x4E2A;futex&#x7684;waiter&#x7EBF;&#x7A0B;&#x3002;&#x5B83;&#x901A;&#x5E38;&#x88AB;&#x7528;&#x6765;&#x4F20;&#x9012;&#x5404;&#x79CD;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">pi_state</code>&#x662F;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">task_struct</code>&#x5185;&#x90E8;&#x7684;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#xFF0C;&#x5728;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">futex_lock_pi</code>&#x8C03;&#x7528;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">refill_pi_state_cache</code>&#x91CC;&#x9762;&#x505A;&#x5206;&#x914D;&#x3002;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"><span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">static</span> <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">refill_pi_state_cache</span><span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">(<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">void</span>)</span>\n</span>&#123;\n...\n\tpi_state = kzalloc(<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">sizeof</span>(*pi_state), GFP_KERNEL);\n    current-&gt;pi_state_cache = pi_state;\n...\n&#125;\n</code></pre>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">futex_lock_pi</h3>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x903B;&#x8F91;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x76F4;&#x7EBF;&#x7684;&#xFF0C;&#x540C;&#x5927;&#x591A;&#x6570;&#x9501;&#x7684;&#x5B9E;&#x73B0;&#x4E00;&#x6837;&#xFF0C;&#x5148;&#x5C1D;&#x8BD5;&#x539F;&#x5B50;&#x9501;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x884C;&#xFF0C;&#x5219;&#x8C03;&#x7528;rt_mutex&#x7684;&#x5B9E;&#x73B0;&#x6765;&#x5904;&#x7406;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#x7684;&#x673A;&#x5236;&#x3002;&#x4EE5;&#x4E0B;&#x6361;&#x53D6;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x51FD;&#x6570;&#x505A;&#x9610;&#x8FF0;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x53C2;&#x8003;&#x6587;&#x732E;[3], [4]&#x4E2D;&#x7684;&#x63CF;&#x8FF0;&#x3002;</p>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">queue_lock, queue_unlock</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5BF9;hash_bucket&#x8FDB;&#x884C;&#x9501;&#x64CD;&#x4F5C;&#x3002;&#x4ED6;&#x4EEC;&#x64CD;&#x4F5C;&#x7684;&#x662F;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">hash_bucket</code>&#x4E0B;&#x7684;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">lock</code>&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x662F;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">futex_q</code>&#x4E0B;&#x7684;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">lock_ptr</code>&#x3002;&#x8FD9;&#x91CC;&#x9501;&#x7684;&#x51FA;&#x73B0;&#x6BD4;&#x8F83;&#x6DF7;&#x4E71;&#xFF0C;&#x6709;&#x65F6;&#x8C03;&#x7528;&#x4E0A;&#x9762;&#x7684;&#x8FD9;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x6709;&#x65F6;&#x76F4;&#x63A5;&#x5BF9;lock&#x6307;&#x9488;&#x64CD;&#x4F5C;&#x3002;&#x9700;&#x8981;&#x5C0F;&#x5FC3;&#x3002;</p>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">__queue_me, unqueue_me</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x91CC;&#x5C06;&#x7533;&#x8BF7;futex&#x7684;&#x7EBF;&#x7A0B;&#x5728;hash_bucket&#x7684;chain&#x4E0A;&#x505A;&#x6DFB;&#x52A0;&#x6216;&#x79FB;&#x9664;&#x64CD;&#x4F5C;&#x3002;&#x8FD8;&#x4F1A;&#x6D89;&#x53CA;&#x9501;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x4EE5;&#x4E0A;4&#x4E2A;&#x51FD;&#x6570;&#x66F4;&#x591A;&#x7684;&#x4E0E;futex&#x7684;&#x5B9E;&#x73B0;&#x76F8;&#x5173;&#xFF0C;&#x4E0E;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#x5E76;&#x65E0;&#x5173;&#x7CFB;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x7565;&#x8FC7;&#x3002;</p>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">futex_lock_pi_atomic</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">\n        <img class=\"enMedia\" src=\"/images/PIP&#x5728;Linux+glibc&#x4E2D;&#x7684;&#x5B9E;&#x73B0;/1549076735129.png\" hash=\"8f64be7a14c9e36fb86aff8b54e61062\" align alt longdesc width=\"783\" height=\"523\" border hspace vspace usemap style title lang xml:lang dir>\n      </p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x505A;&#x7684;&#x5C31;&#x662F;&#x539F;&#x5B50;&#x64CD;&#x4F5C;&#x6765;&#x8BF7;&#x6C42;&#x9501;&#xFF0C;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x5982;&#x679C;futex&#x6CA1;&#x6709;waiter&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x83B7;&#x5F97;&#x9501;&#x5E76;&#x8FD4;&#x56DE;1&#xFF0C;&#x8868;&#x793A;&#x6210;&#x529F;&#x83B7;&#x5F97;&#x9501;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x5982;&#x679C;&#x6709;waiter&#xFF0C;&#x5C31;&#x8FD4;&#x56DE;0&#xFF0C;&#x8868;&#x793A;ready to wait</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E0D;&#x540C;&#x7684;&#x662F;&#x4F1A;&#x505A;&#x4E00;&#x4E9B;&#x4E0E;PI&#x76F8;&#x5173;&#x7684;&#x5904;&#x7406;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x6709;waiter&#x7684;&#x60C5;&#x51B5;&#xFF1A;\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x8C03;&#x7528;attach_to_pi_state&#x6765;&#x83B7;&#x5F97;&#x8BE5;top_waiter&#x7684;pi_state</li>\n</ul>\n</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x6CA1;&#x6709;waiter&#x7684;&#x60C5;&#x51B5;\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x8C03;&#x7528;attach_to_pi_owner&#x6765;&#x53D6;&#x7528;&#x672C;&#x7EBF;&#x7A0B;&#x91CC;&#x5206;&#x914D;&#x7684;pi_state&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5E76;&#x66F4;&#x65B0;&#x6570;&#x636E;&#x3002;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x88AB;queue&#x5230;hash_bucket&#x7684;&#x961F;&#x5217;&#x4E2D;&#x3002;</li>\n</ul>\n</li>\n</ul>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">rt_mutex&#x63A5;&#x53E3;</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">futex_lock_pi&#x4E2D;&#x4F7F;&#x7528;&#x5230;&#x5982;&#x4E0B;&#x8FD9;&#x4E9B;rt_mutex&#x63A5;&#x53E3;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">rt_mutex_init_waiter&#xFF1A;&#x521D;&#x59CB;&#x5316;waiter&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x5B9E;&#x4E3A;&#x4E00;&#x4E2A;&#x7EA2;&#x9ED1;&#x6811;&#x7684;&#x8282;&#x70B9;&#x3002;&#x8FD9;&#x4E2A;waiter&#x5BF9;&#x5E94;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#xFF0C;&#x5E76;&#x53CD;&#x6620;&#x7EBF;&#x7A0B;&#x5728;&#x67D0;&#x4E2A;&#x9501;&#x4E0A;&#x7684;&#x7B49;&#x5F85;&#x5173;&#x7CFB;&#x3002;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">__rt_mutex_start_proxy_lock&#xFF1A;&#x8FD9;&#x4E2A;&#x662F;PI&#x7684;&#x6838;&#x5FC3;&#x51FD;&#x6570;&#xFF0C;&#x7528;&#x6765;&#x5BF9;&#x5404;waiters&#x6570;&#x636E;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#xFF0C;&#x4EE5;&#x53CA;&#x904D;&#x5386;lock&#x94FE;&#x6765;&#x68C0;&#x67E5;&#x6B7B;&#x9501;&#x3002;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E0E;&#x4E4B;&#x524D;&#x7684;&#x539F;&#x5B50;&#x68C0;&#x67E5;&#x7C7B;&#x4F3C;&#xFF0C;&#x5982;&#x679C;&#x8FD4;&#x56DE;1&#x8868;&#x793A;&#x5DF2;&#x7ECF;&#x83B7;&#x5F97;&#x9501;&#xFF0C;&#x5982;&#x679C;&#x8FD4;&#x56DE;0&#xFF0C;&#x5219;ready to wait&#x3002;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">rt_mutex_wait_proxy_lock&#xFF1A;&#x901A;&#x8FC7;__rt_mutex_start_proxy_lock&#x5904;&#x7406;&#x4E4B;&#x540E;&#xFF0C;&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x6709;&#x83B7;&#x5F97;&#x9501;&#xFF0C;&#x90A3;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x7B49;&#x5F85;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5C06;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#x4E3A;TASK_INTERRUPTIBLE&#x72B6;&#x6001;&#xFF0C;&#x5E76;&#x5F00;&#x59CB;&#x7B49;&#x5F85;&#x3002;&#x8FD9;&#x5176;&#x95F4;&#x4F1A;&#x5904;&#x7406;&#x57FA;&#x4E8E;&#x65F6;&#x95F4;&#x7684;&#x7B49;&#x5F85;&#xFF0C;&#x4E14;&#x4F1A;&#x89E6;&#x53D1;&#x8C03;&#x5EA6;&#x3002;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">rt_mutex_cleanup_proxy_lock&#xFF1A;&#x73B0;&#x5728;&#x5DF2;&#x7ECF;&#x963B;&#x585E;&#x7ED3;&#x675F;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x83B7;&#x5F97;&#x9501;&#xFF0C;&#x8981;&#x4E48;&#x662F;&#x8D85;&#x65F6;&#xFF0C;&#x8981;&#x4E48;&#x662F;&#x51FA;&#x9519;&#xFF0C;&#x603B;&#x4E4B;&#x8981;&#x5C06;&#x672C;&#x7EBF;&#x7A0B;&#x4ECE;waiters&#x4E2D;&#x79FB;&#x9664;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5C31;&#x662F;&#x8D77;&#x8FD9;&#x4E2A;&#x4F5C;&#x7528;&#x3002;</li>\n</ul>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">fixup_owner</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x4ECE;&#x6CE8;&#x91CA;&#x4E0A;&#x770B;&#xFF0C;&#x662F;&#x4E3A;&#x4E86;&#x5904;&#x7406;lock steal&#x3002;&#x800C;lock steal&#x4F3C;&#x4E4E;&#x591A;&#x53D1;&#x751F;&#x5728;futex requeue&#x64CD;&#x4F5C;&#x4E0A;&#xFF0C;&#x76EE;&#x524D;&#x5C1A;&#x672A;&#x4ED4;&#x7EC6;&#x7814;&#x7A76;&#x3002;</p>\n<h3 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;\">futex_unlock_pi</h3>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">futex_unlock_pi&#x91CA;&#x653E;futex&#x4EE5;&#x53CA;&#x66F4;&#x65B0;&#x76F8;&#x5E94;&#x7684;pi_state&#x548C;rt_mutex&#x7684;owner&#x5B57;&#x6BB5;&#x3002;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x5C42;&#x6B21;&#x6BD4;&#x8F83;&#x6DF1;&#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x90FD;&#x662F;&#x6BCF;&#x4E00;&#x5C42;&#x505A;&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x7684;&#x66F4;&#x65B0;&#x5DE5;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5230;__rt_mutex_futex_unlock&#x6765;&#x91CD;&#x65B0;&#x8C03;&#x6574;&#x672C;&#x7EBF;&#x7A0B;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x5E76;&#x5C06;top waiter&#x653E;&#x5230;wake queue&#x4E0A;&#x3002;&#x5728;rt_mutex_postunlock&#x8C03;&#x7528;&#x7684;rt_mutex_postunlock&#x5C06;&#x65B0;&#x7EBF;&#x7A0B;&#x5524;&#x9192;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5982;&#x679C;&#x6CA1;&#x6709;waiter&#xFF0C;&#x5219;&#x4F7F;&#x7528;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">cmpxchg_futex_value_locked</code>&#x6765;&#x5C06;&#x7528;&#x6237;&#x6001;&#x5730;&#x5740;uaddr&#x4E0A;&#x7684;&#x503C;&#x8BBE;&#x4E3A;0&#x3002;&#x56E0;&#x4E3A;&#x9501;&#x6CA1;&#x6709;waiter&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x4F18;&#x5148;&#x7EA7;&#x4E5F;&#x4E0D;&#x9700;&#x8981;&#x6062;&#x590D;&#x4E86;&#xFF0C;&#x6216;&#x8005;&#x5DF2;&#x7ECF;&#x6062;&#x590D;&#x8FC7;&#x4E86;&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5982;&#x679C;&#x6709;waiter&#xFF0C;&#x5C31;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x6765;&#x5207;&#x6362;lock owner&#xFF0C;&#x5E76;&#x6062;&#x590D;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x3002;</p>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">wake_futex_pi</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x505A;&#x4E86;&#x4E0B;&#x9762;&#x51E0;&#x4EF6;&#x4E8B;&#xFF1A;</p>\n<ol style=\"line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;\">\n<li style=\"line-height: 160%; box-sizing: content-box;\">&#x7528;cmpxchg_futex_value_locked&#x5C06;&#x7528;&#x6237;&#x6001;&#x4F20;&#x5165;&#x7684;uaddr&#x5904;&#x7684;&#x6570;&#x503C;&#x66F4;&#x65B0;&#x4E3A;&#x65B0;&#x7684;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">rt_mutex_next_owner() | FUTEX_WAITERS</code></li>\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">list_del_init(&amp;pi_state-&gt;list)</code>&#xFF1A;&#x5C06;list&#x4ECE;&#x539F;&#x5148;&#x7684;&#x8868;&#x4E0A;&#x5220;&#x9664;&#xFF0C;&#x5E76;&#x91CD;&#x65B0;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x51C6;&#x5907;&#x79FB;&#x5230;&#x5176;&#x4ED6;&#x7684;&#x8868;&#x4E0A;&#x3002;</li>\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">list_add(&amp;pi_state-&gt;list, &amp;new_owner-&gt;pi_state_list)</code></li>\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">pi_state-&gt;owner = new_owner</code></li>\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">__rt_mutex_futex_unlock</code></li>\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">rt_mutex_postunlock</code></li>\n</ol>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">mark_wakeup_next_waiter</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x6CE8;&#x610F;&#xFF1A;&#x6B64;&#x65F6;pi_state-&gt;owner&#x5DF2;&#x7ECF;&#x8BBE;&#x7F6E;&#x8FC7;&#x4E86;&#xFF0C;&#x4F46;&#x662F;pi_state-&gt;pi_mutex-&gt;owner&#x8FD8;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x3002;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x4E0B;&#x9762;&#x51E0;&#x4EF6;&#x4E8B;&#x60C5;&#xFF1A;</p>\n<ol style=\"line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;\">\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">rt_mutex_dequeue_pi(current, waiter);</code></li>\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">rt_mutex_adjust_prio(current)</code>:&#x5728;&#x8FD9;&#x91CC;&#x8C03;&#x6574;&#x4E86;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x5B8C;&#x6210;&#x4E86;&#x6574;&#x4E2A;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#x534F;&#x8BAE;&#x3002;</li>\n<li style=\"line-height: 160%; box-sizing: content-box;\"><code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">wake_q_add(wake_q, waiter-&gt;task)</code></li>\n</ol>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">put_pi_state</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x66F4;&#x591A;&#x7684;&#x662F;&#x6E05;&#x7406;&#x5DE5;&#x4F5C;:</p>\n<ol style=\"line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;\">\n<li style=\"line-height: 160%; box-sizing: content-box;\">&#x8C03;&#x7528;&#x4E86;<code style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;\">rt_mutex_proxy_unlock</code>&#x6765;&#x91CA;&#x653E;pi_state-&gt;pi_mutex.</li>\n<li style=\"line-height: 160%; box-sizing: content-box;\">&#x91CA;&#x653E;&#x4E86;current-&gt;pi_state_cache&#x7A7A;&#x95F4;</li>\n</ol>\n<blockquote style=\"line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;\">\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;\"><strong style=\"line-height: 160%; box-sizing: content-box; font-weight: 700;\">cmpxchg_futex_value_locked&#x539F;&#x5B50;&#x64CD;&#x4F5C;</strong></p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8; margin-bottom: 0;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"><span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">static</span> <span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> <span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">cmpxchg_futex_value_locked</span><span style=\"color: #dcdcdc; line-height: 160%; box-sizing: content-box;\">(u32 *uval, u32 __user *uaddr,\n&#x203A;   &#x203A;   &#x203A;   &#x203A;         u32 oldval, u32 newval)</span>\n</span>&#123;\nATOMIC();\n<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">int</span> val = *uaddr;\n<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">if</span> (val == oldval) &#123;\n*uaddr = newval;\n&#125;\n*uval = val;\nEND_ATOMIC();\n<span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">return</span> <span style=\"color: #b8d7a3; line-height: 160%; box-sizing: content-box;\">0</span>;\n&#125;\n\n&#x5176;&#x4E2D;ATOMIC&#x64CD;&#x4F5C;&#x901A;&#x8FC7;page_disable()&#x548C;preempt_disable()&#x4FDD;&#x8BC1;&#x3002;\n</code></pre>\n</blockquote>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">__rt_mutex_start_proxy_lock</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x4ECE;&#x4E0A;&#x9762;futex_lock_pi&#x7528;&#x5230;&#x7684;rt_mutex&#x63A5;&#x53E3;&#x4ECB;&#x7ECD;&#x4E2D;&#x53EF;&#x77E5;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;&#x6574;&#x4E2A;PI&#x5904;&#x7406;&#x7684;&#x6838;&#x5FC3;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x53C8;&#x4E3B;&#x8981;&#x8C03;&#x7528;task_blocks_on_rt_mutex&#x6765;&#x5904;&#x7406;PI&#x3002;</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">\n        <img class=\"enMedia\" src=\"/images/PIP&#x5728;Linux+glibc&#x4E2D;&#x7684;&#x5B9E;&#x73B0;/1549078599538.png\" hash=\"692787b6adf4be8b04b3aa57c3612c37\" align alt longdesc width=\"840\" height=\"712\" border hspace vspace usemap style title lang xml:lang dir>\n      </p>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">rt_mutex_adjust_prio(owner)</h4>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5C31;&#x662F;&#x8C03;&#x6574;&#x963B;&#x585E;&#x7EBF;&#x7A0B;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#x7684;&#x3002;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF1A;</p>\n<pre style=\"line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;\"><code style=\"display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;\"><span style=\"color: #569cd6; line-height: 160%; box-sizing: content-box;\">if</span> (task_has_pi_waiters(p))\n&#x203A;   pi_task = task_top_pi_waiter(p)-&gt;task;\n\nrt_mutex_setprio(p, pi_task);\n</code></pre>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x628A;owner&#x7EBF;&#x7A0B;&#x8BBE;&#x7F6E;&#x4E3A;owner&#x7EBF;&#x7A0B;&#x6240;&#x6709;waiter(&#x53EF;&#x80FD;&#x6765;&#x81EA;&#x591A;&#x4E2A;&#x9501;)&#x7684;&#x6700;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x3002;</p>\n<h4 style=\"line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;\">rt_mutex_adjust_prio_chain</h4>\n<h5 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;\">&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x8FD9;&#x4E2A;&#x94FE;&#x5F0F;&#x8C03;&#x6574;&#xFF1F;</h5>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">\n        <img class=\"enMedia\" src=\"/images/PIP&#x5728;Linux+glibc&#x4E2D;&#x7684;&#x5B9E;&#x73B0;/1549078908946.png\" hash=\"c4badef8862a4db7fb98b88635d31ecb\" align alt longdesc width=\"1021\" height=\"358\" border hspace vspace usemap style title lang xml:lang dir>\n      </p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x5F20;&#x8868;&#x683C;&#xFF1A;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">&#x6BCF;&#x4E2A;rt_mutex&#x6709;&#x5F20;waiters&#x8868;&#x683C;&#xFF0C;&#x8868;&#x793A;&#x6240;&#x6709;&#x7B49;&#x5F85;&#x7684;&#x7EBF;&#x7A0B;</p>\n</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">&#x6BCF;&#x4E2A;task&#x4E5F;&#x6709;&#x5F20;&#x8868;&#x683C;&#xFF0C;&#x8868;&#x683C;&#x91CC;&#x7684;&#x6BCF;&#x4E00;&#x9879;&#x5BF9;&#x5E94;owner&#x7EBF;&#x7A0B;&#x5360;&#x6709;&#x7684;&#x9501;&#xFF0C;&#x6BCF;&#x4E00;&#x9879;&#x662F;&#x4E00;&#x4E2A;rt_mutex_waiter&#xFF0C;&#x8868;&#x793A;&#x7533;&#x8BF7;&#x8BE5;&#x9501;&#x7684;&#x6700;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;waiter</p>\n</li>\n</ul>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x5047;&#x8BBE;Task1&#x5C31;&#x662F;owner&#xFF0C;Task0&#x5BF9;Lock0&#x7684;&#x7533;&#x8BF7;&#x5BFC;&#x81F4;Task1&#x63D0;&#x5347;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x5982;&#x679C;Task1&#x540C;&#x65F6;&#x88AB;Task2&#x6301;&#x6709;&#x7684;&#x67D0;&#x4E2A;&#x9501;&#x963B;&#x585E;&#xFF0C;&#x5219;Task1&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x6539;&#x53D8;&#xFF0C;&#x6709;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;Task2 pi_waiters&#x5217;&#x8868;&#x6539;&#x53D8;&#xFF0C;&#x540C;&#x65F6;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;Task2&#x4F18;&#x5148;&#x7EA7;&#x6539;&#x53D8;&#x3002;&#x4F9D;&#x6B64;&#x7C7B;&#x63A8;&#xFF0C;&#x5C31;&#x4F1A;&#x5BFC;&#x81F4;&#x4E0A;&#x9762;&#x7684;&#x8FD9;&#x79CD;&#x94FE;&#x5F0F;&#x53CD;&#x5E94;&#x3002;</p>\n<h5 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;\">&#x94FE;&#x5904;&#x7406;&#x6D41;&#x7A0B;</h5>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x6574;&#x4E2A;chain&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;&#x5927;&#x81F4;&#x5982;&#x4E0B;&#xFF1A;</p>\n<ol style=\"line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;\">\n<li style=\"line-height: 160%; box-sizing: content-box;\">&#x5982;&#x679C;Task0&#x662F;Lock0&#x7684;top waiter&#xFF0C;&#x5219;&#x6FC0;&#x53D1;&#x8BE5;&#x94FE;&#x5F0F;&#x8C03;&#x6574;&#x3002;</li>\n<li style=\"line-height: 160%; box-sizing: content-box;\">&#x56E0;&#x4E3A;Task0&#x6210;&#x4E3A;Lock0&#x7684;topwaiter&#xFF0C;&#x5219;Task1&#x7684;pi_waiters&#x9700;&#x8981;&#x8C03;&#x6574;&#xFF0C;&#x5219;Task1&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x8C03;&#x6574;&#x3002;&#x9000;&#x51FA;&#x53EF;&#x80FD;&#xFF1A;\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">&#x8D77;&#x70B9;&#x9501;&#x91CA;&#x653E;&#x4E86;</p>\n</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">&#x94FE;&#x7684;&#x5F53;&#x524D;&#x73AF;&#x8282;&#x88AB;&#x66F4;&#x6539;( next_lock &#x2260;waiter-&gt;lock)</p>\n</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">\n<p style=\"line-height: 160%; box-sizing: content-box; color: #333; margin: 0;\">Task1&#x6CA1;&#x6709;&#x5360;&#x9501;</p>\n</li>\n</ul>\n</li>\n<li style=\"line-height: 160%; box-sizing: content-box;\">&#x5982;&#x679C;Task1&#x4E5F;wait&#x5728;&#x67D0;&#x4E2A;lock&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5219;&#x8BE5;lock&#x7684;waiters&#x9700;&#x8981;&#x8C03;&#x6574;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x82E5;&#x5E72;&#x79CD;&#x9000;&#x51FA;&#x53EF;&#x80FD;&#x3002;</li>\n</ol>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">Task1&#x6CA1;&#x6709;&#x88AB;block</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">Task1 pi_waiters&#x4E2D;&#x6709;&#x4F18;&#x5148;&#x7EA7;&#x9AD8;&#x4E8E;Task0&#x7684;waiter&#xFF0C;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;lock0&#x7684;top_waiter&#x4E0D;&#x662F;Task1&#x7684;top pi_waiter&#xFF0C;&#x4F18;&#x5148;&#x7EA7;&#x7EE7;&#x627F;&#x4E0D;&#x9700;&#x8981;&#x7EE7;&#x7EED;&#x4F20;&#x9012;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x5982;&#x679C;Task1&#x5728;&#x7533;&#x8BF7;Lock1 &#x7684;&#x65F6;&#x5019;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#xFF08;&#x8FD9;&#x4E2A;&#x8BB0;&#x5F55;&#x5728;waiter-&gt;prio&#x91CC;&#xFF09;&#x4E0E;&#x5F53;&#x524D;&#x8C03;&#x6574;&#x540E;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x76F8;&#x7B49;&#xFF0C;&#x5219;&#x540E;&#x7EED;&#x6CA1;&#x5FC5;&#x8981;&#x5728;&#x7EE7;&#x7EED;&#x8C03;&#x6574;&#x4F18;&#x5148;&#x7EA7;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x68C0;&#x6D4B;&#x5230;DEADLOCK</li>\n</ul>\n<ol start=\"4\" style=\"line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;\">\n<li style=\"line-height: 160%; box-sizing: content-box;\">&#x56DE;&#x5230;1&#x7EE7;&#x7EED;&#x6267;&#x884C;&#xFF0C;&#x76F4;&#x5230;&#x9000;&#x51FA;&#x94FE;&#x5F0F;&#x5904;&#x7406;</li>\n</ol>\n<h5 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;\">&#x6B7B;&#x9501;</h5>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">&#x6709;3&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x51FD;&#x6570;&#x4F1A;&#x8FD4;&#x56DE;&#x6B7B;&#x9501;</p>\n<ul style=\"line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;\">\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x94FE;&#x4E0A;&#x8D85;&#x8FC7;1024&#x4E2A;&#x9501;&#x8282;&#x70B9;</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x94FE;&#x4E0A;&#x4EFB;&#x610F;Task&#x8282;&#x70B9;&#x7533;&#x8BF7;&#x7B2C;&#x4E00;&#x4E2A;&#x9501;&#x8282;&#x70B9;&#xFF0C;&#x5373;Lock0</li>\n<li style=\"line-height: 160%; box-sizing: content-box; position: relative;\">&#x94FE;&#x4E0A;&#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x9501;owner&#x662F;&#x7B2C;&#x4E00;&#x4E2A;Task&#x8282;&#x70B9;&#xFF0C;&#x5373;Task0</li>\n</ul>\n<h2 style=\"line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;\">&#x53C2;&#x8003;&#x6587;&#x732E;</h2>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">[1] [Mutex mutandis: understanding mutex types and attributes]. (http://2net.co.uk/tutorial/mutex_mutandis)</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">[2] <a href=\"http://pubs.opengroup.org/onlinepubs/9699919799/functions/contents.html\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">POSIX Revision of IEEE Std 1003.1-2008</a></p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">[3] <a href=\"https://zihan.me/2018/08/15/source-code-analysis-pthread-mutex-lock/\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">Source code analysis of pthread_mutex_lock</a></p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">[4] <a href=\"https://yq.aliyun.com/articles/6044\" style=\"line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;\">linux pi_futex&#x6D45;&#x6790;</a></p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">[5] Linux 4.20-rc3 source code</p>\n<p style=\"line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;\">[6] glibc 2.28 source code</p>\n</div><center style=\"display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden\">%23%23%20%E4%BC%98%E5%85%88%E7%BA%A7%E5%8F%8D%E8%BD%AC%0A%0A%E4%BC%98%E5%85%88%E7%BA%A7%E5%8F%8D%E8%BD%AC%E6%8C%87%E4%B8%80%E4%B8%AA%E9%AB%98%E4%BC%98%E5%85%88%E7%BA%A7%E4%BB%BB%E5%8A%A1%E5%9B%A0%E4%B8%BA%E8%B5%84%E6%BA%90%E8%A2%AB%E4%BD%8E%E4%BC%98%E5%85%88%E7%BA%A7%E4%BB%BB%E5%8A%A1%E5%8D%A0%E7%94%A8%EF%BC%8C%E8%80%8C%E4%B8%8D%E5%BE%97%E4%B8%8D%E7%AD%89%E5%BE%85%E3%80%82%E8%BF%99%E4%B8%AA%E9%80%BB%E8%BE%91%E6%9C%AC%E8%BA%AB%E6%B2%A1%E6%9C%89%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%E3%80%82%E4%BC%98%E5%85%88%E7%BA%A7%E5%8F%8D%E8%BD%AC%E5%B8%A6%E6%9D%A5%E6%9C%80%E7%9B%B4%E6%8E%A5%E7%9A%84%E9%97%AE%E9%A2%98%E5%B0%B1%E6%98%AF%E9%AB%98%E4%BC%98%E5%85%88%E7%BA%A7%E5%8F%AF%E8%83%BD%E5%9B%A0%E4%B8%BA%E8%BF%99%E6%AC%A1%E9%98%BB%E5%A1%9E%EF%BC%8C%E8%80%8C%E6%97%A0%E6%B3%95%E7%A1%AE%E5%AE%9A%E9%98%BB%E5%A1%9E%E6%97%B6%E5%BB%B6%E3%80%82%E5%A6%82%E4%B8%8B%E5%9B%BE%E6%89%80%E7%A4%BA%E3%80%82%0A!%5B8df099f053cbeaee4881a9d6ffc8963f.png%5D(evernotecid%3A%2F%2F22617523-9521-4D00-B771-5F27B85F00EB%2Fappyinxiangcom%2F161681%2FENResource%2Fp5789)%0A%0ATask%209%E4%BC%98%E5%85%88%E7%BA%A7%E8%BE%83%E4%BD%8E%EF%BC%8C%E6%89%80%E4%BB%A5%E5%BE%88%E5%AE%B9%E6%98%93%E8%A2%AB%E5%85%B6%E4%BB%96%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%8A%A2%E5%8D%A0%E8%BF%90%E8%A1%8C%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%AF%B9%E8%B5%84%E6%BA%90S%E7%9A%84%E9%94%81%E6%97%A0%E6%B3%95%E9%87%8A%E6%94%BE%EF%BC%8C%E8%80%8C%E9%AB%98%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%9B%A0%E4%B8%BA%E8%A6%81%E6%8C%81%E6%9C%89%E8%AF%A5%E9%94%81%EF%BC%8C%E4%B8%8D%E5%BE%97%E4%B8%8D%E7%AD%89%E5%BE%85%E3%80%82%0A%0A%23%23%20%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%0A%0APriority%20Inheritance%20Protocol%E7%BF%BB%E8%AF%91%E4%B8%BA%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%EF%BC%8C%E7%AE%80%E7%A7%B0PIP%E3%80%82%E8%BF%99%E6%98%AF%E8%A7%A3%E5%86%B3%E4%B8%8A%E8%BF%B0Unbounded%20inversion%E6%9C%80%E7%9B%B4%E6%8E%A5%E7%9A%84%E5%8A%9E%E6%B3%95%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%B0%86%E5%8D%A0%E6%9C%89%E9%94%81%E7%9A%84%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7%E8%B0%83%E6%95%B4%E5%88%B0%E5%9C%A8%E7%AD%89%E5%BE%85%E7%9A%84%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%9C%80%E9%AB%98%E5%80%BC%E3%80%82%E8%BF%99%E4%B8%AA%E7%AE%97%E6%B3%95%E6%98%AF%E8%B4%AA%E5%A9%AA%E7%9A%84%EF%BC%8C%E5%B1%80%E9%83%A8%E6%9C%80%E4%BC%98%EF%BC%8C%E4%BD%86%E4%B8%8D%E6%98%AF%E6%95%B4%E4%BD%93%E6%9C%80%E4%BC%98%E8%A7%A3%EF%BC%8C%E5%9C%A8%E6%AD%A4%E4%B9%8B%E4%B8%8A%E5%8F%88%E6%9C%89PCP(%E4%BC%98%E5%85%88%E7%BA%A7%E5%A4%A9%E8%8A%B1%E6%9D%BF)%E5%92%8CSRP(%E5%9F%BA%E4%BA%8E%E6%A0%88%E7%9A%84%E8%B5%84%E6%BA%90%E7%AD%96%E7%95%A5)%E3%80%82%E6%9C%AC%E6%96%87%E4%B8%8D%E5%81%9A%E8%AE%A8%E8%AE%BA%E3%80%82%E6%9C%AC%E6%96%87%E4%B8%BB%E8%A6%81%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9A%84%E8%A7%92%E5%BA%A6%EF%BC%8C%E9%98%90%E8%BF%B0PIP%E5%9C%A8Linux%E5%92%8Cglibc%E4%B8%AD%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E3%80%82%0A%0A%23%23%20Overview%0A!%5Bb16f478e9d2cf9485b4b8bba9e81e3b0.png%5D(evernotecid%3A%2F%2F22617523-9521-4D00-B771-5F27B85F00EB%2Fappyinxiangcom%2F161681%2FENResource%2Fp5790)%0A%0ALinux%E4%B8%8B%E7%9A%84PIP%E5%AE%9E%E7%8E%B0%E5%88%86%E6%88%90%E4%BB%A5%E4%B8%8A3%E4%B8%AA%E9%83%A8%E5%88%86%EF%BC%9A%0A%0A-%20glibc%E4%B8%AD%E7%9A%84pthread_mutex_lock%E6%8F%90%E4%BE%9B%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3%EF%BC%8C%E9%80%9A%E8%BF%87FUTEX_LOCK_PI%E5%AE%9E%E7%8E%B0%E4%BC%98%E5%85%88%E7%BA%A7%E8%B0%83%E6%95%B4%0A-%20Linux%E7%9A%84futex%E9%83%A8%E5%88%86%E6%8F%90%E4%BE%9BFUTEX_LOCK_PI%E7%9A%84%E5%AE%9E%E7%8E%B0%0A-%20%E6%9C%80%E7%BB%88%E7%9A%84%E9%94%81%E6%9C%BA%E5%88%B6%E9%80%9A%E8%BF%87rt_mutex%E6%9D%A5%E5%AE%9E%E7%8E%B0%0A%0A%23%23%20pthread_mutex%0A%0A%23%23%23%20Types%0A%0Apthread%20mutex%E6%98%AFPOSIX%20pthread%E5%BA%93%E4%B8%AD%E5%AE%9A%E4%B9%89%E7%9A%84%E4%B8%80%E7%A7%8D%E9%94%81%E6%9C%BA%E5%88%B6%EF%BC%8C%E4%B8%8E%E4%BF%A1%E5%8F%B7%E9%87%8F%E4%B8%8D%E5%90%8C%E7%9A%84%E6%98%AF%EF%BC%8C%E8%BF%99%E4%B8%AA%E9%94%81%E5%8F%AA%E6%9C%89%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81%EF%BC%9Alocked%E6%88%96unlocked%E3%80%82%E4%B8%8Ebinary%20semaphore%E4%B8%8D%E5%90%8C%E7%9A%84%E6%98%AF%EF%BC%8Cmutex%E5%8F%AA%E8%83%BD%E8%A2%ABlock%E7%9A%84%E7%BA%BF%E7%A8%8Bunlock%EF%BC%8C%E5%8D%B3%E5%8F%AA%E8%83%BD%E8%A2%ABmutex%20owner%20unlock%E3%80%82%0A%0A%E7%9B%AE%E5%89%8D%5BPOSIX%E6%A0%87%E5%87%86(1003.1-2008)%5D(http%3A%2F%2Fpubs.opengroup.org%2Fonlinepubs%2F9699919799%2Ffunctions%2Fcontents.html)%E4%B8%AD%E5%AE%9A%E4%B9%89%E4%BA%864%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84mutex%3A%0A%0A-%20PTHREAD_MUTEX_NORMAL%0A-%20PTHREAD_MUTEX_ERRORCHECK%0A-%20PTHREAD_MUTEX_RECURSIVE%0A-%20PTHREAD_MUTEX_DEFAULT%0A%0A%E8%BF%994%E7%A7%8Dmutex%E4%B8%8D%E5%90%8C%E4%B9%8B%E5%A4%84%E5%A6%82%E4%B8%8B%0A%0A%7C%20%20%20%20%20%20%20%20%20%20%20%20%7C%20attempting%20to%20relock%20this%20mutex%20without%20first%20unlocking%20%7C%20Attempting%20to%20unlock%20a%20mutex%20locked%20by%20a%20different%20thread%20%7C%0A%7C%20----------%20%7C%20-------------------------------------------------------%20%7C%20---------------------------------------------------------%20%7C%0A%7C%20NORMAL%20%20%20%20%20%7C%20deadlock%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20undefined%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%7C%20ERRORCHECK%20%7C%20return%20error%20-EDEADLOCK%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20return%20error%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%7C%20RECURSIVE%20%20%7C%20succeed%20in%20locking%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20return%20error%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%7C%20DEFAULT%20%20%20%20%7C%20undefined%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20undefined%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%0Aglibc%E5%AF%B9%E4%B8%8A%E8%BF%B04%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84mutex%E8%BF%9B%E8%A1%8C%E4%BA%86%E6%89%A9%E5%B1%95%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%0A%0A%60%60%60c%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_RECURSIVE_NP%3A%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_ERRORCHECK_NP%3A%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_NORMAL_NP%3A%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_ADAPTIVE_NP%3A%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_ROBUST_RECURSIVE_NP%3A%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_ROBUST_ERRORCHECK_NP%3A%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_ROBUST_NORMAL_NP%3A%0A%20%20%20%20case%20PTHREAD_MUTEX_PI_ROBUST_ADAPTIVE_NP%3A%0A%60%60%60%0A%0A%E4%B8%BB%E8%A6%81%E5%A4%9A%E4%BA%86%E8%BF%993%E7%A7%8D%E5%B1%9E%E6%80%A7%EF%BC%9A%0A%0A-%20ADAPTIVE%EF%BC%9A%E5%9C%A8SMP%E6%9E%B6%E6%9E%84%E4%B8%8B%EF%BC%8C%E5%B9%B6%E4%B8%8D%E7%9B%B4%E6%8E%A5%E8%BF%9B%E5%85%A5wait%EF%BC%8C%E8%80%8C%E6%98%AF%E5%85%88%E8%B0%83%E7%94%A8spinlock%E7%AD%89%E5%BE%85%E4%B8%80%E5%B0%8F%E6%AE%B5%E6%97%B6%E9%97%B4%E3%80%82musl%E9%87%8C%E9%BB%98%E8%AE%A4%E9%83%BD%E9%87%87%E7%94%A8%E4%BA%86%E8%BF%99%E7%A7%8D%E5%AE%9E%E7%8E%B0%0A%0A-%20PI%EF%BC%9A%E5%8C%85%E5%90%AB%E8%AF%A5%E5%B1%9E%E6%80%A7%E7%9A%84mutex%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%BA%86%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF(Priority%20Inheritance%2C%20PI)%0A%0A-%20ROBUST%EF%BC%9A%E8%8B%A5%E7%BA%BF%E7%A8%8B%E9%80%80%E5%87%BA%E6%97%B6%E6%9C%AA%E9%87%8A%E6%94%BE%E9%94%81%EF%BC%8C%E5%88%99%E4%BB%A5%E5%90%8E%E5%AF%B9%E8%AF%A5%E9%94%81%E6%93%8D%E4%BD%9C%E9%83%BD%E4%BC%9A%E8%BF%94%E5%9B%9E-EOWNERDEAD%EF%BC%8C%E4%B8%8E%E4%B9%8B%E5%AF%B9%E5%BA%94%E7%9A%84%E6%98%AFPTHREAD_MUTEX_STALLED(%E8%BF%99%E6%98%AF%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE)%EF%BC%8C%E5%AF%B9%E8%AF%A5%E5%BC%82%E5%B8%B8%E9%94%81%E7%9A%84%E6%93%8D%E4%BD%9C%E4%BC%9A%E5%87%BA%E7%8E%B0undefined%E8%A1%8C%E4%B8%BA%E3%80%82%0A%0A%E5%86%8D%E4%B8%8E%E5%8E%9F%E5%85%88%E7%9A%844%E7%A7%8D%E5%B1%9E%E6%80%A7%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%88%97%E7%BB%84%E5%90%88%E3%80%82%0A%0A%3E%20**%22_NP%22%20suffix**%0A%3E%0A%3E%20Note%3A%20the%20_NP%20suffix%20indicates%20a%20non-portable%20extension%20to%20the%20POSIX%20specification.%20In%20fact%20the%20latest%20specification%2C%201003.1-2008%20%5B%5B2%5C%5D%5D(http%3A%2F%2F2net.co.uk%2Ftutorial%2Fmutex_mutandis%23ref_2)%2C%20includes%20most%20of%20the%20Linux%20additions%20so%20you%20can%20leave%20the%20_NP%20ending%20off.%20I%20have%20chosen%20not%20to%20because%20some%20older%20versions%20of%20the%20header%20files%20only%20have%20the%20_NP%20variants.%0A%3E%0A%3E%20%E6%A0%B9%E6%8D%AE%E6%9C%80%E6%96%B0%E7%9A%84POSIX%E6%A0%87%E5%87%861003.1-2008%EF%BC%8C%E8%BF%99%E4%BA%9B%E6%89%A9%E5%B1%95%E5%B9%B6%E6%B2%A1%E6%9C%89%E5%8A%A0%E5%85%A5%E3%80%82%0A%0A%E6%9C%AC%E6%96%87%E5%8F%AA%E5%85%B3%E6%B3%A8MUTEX_PI%E5%AE%9E%E7%8E%B0%E3%80%82%0A%0A%23%23%23%20PTHREAD_MUTEX_PI%0A%0A%23%23%23%23%20pthread_mutex_lock%0A%0A%E9%87%8D%E8%A6%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60C%0Atypedef%20union%0A%7B%0A%20%20struct%20__pthread_mutex_s%20__data%3B%0A%20%20char%20__size%5B__SIZEOF_PTHREAD_MUTEX_T%5D%3B%0A%20%20long%20int%20__align%3B%0A%7D%20pthread_mutex_t%3B%0Astruct%20__pthread_mutex_s%0A%7B%0A%20%20int%20__lock%20__LOCK_ALIGNMENT%3B%0A%20%20unsigned%20int%20__count%3B%0A%20%20int%20__owner%3B%0A%20%20...%0A%7D%0A%60%60%60%0A%0A%E5%A6%82%E6%9E%9C%E4%B8%8D%E8%80%83%E8%99%91ROBUST%E6%83%85%E5%86%B5%E7%9A%84%E5%A4%84%E7%90%86%EF%BC%8C%E4%B8%80%E6%AC%A1%E9%92%88%E5%AF%B9%E5%AE%9E%E7%8E%B0%E4%BA%86PI%E5%B1%9E%E6%80%A7%E7%9A%84pthread_mutex_lock%E6%93%8D%E4%BD%9C%E5%A6%82%E4%B8%8B%EF%BC%9A%0A!%5B36c67b688ae44843223a576d9cc0be30.png%5D(evernotecid%3A%2F%2F22617523-9521-4D00-B771-5F27B85F00EB%2Fappyinxiangcom%2F161681%2FENResource%2Fp5791)%0A%0A%0A%3E%20**atomic_compare_and_exchange_val_acq**%0A%3E%0A%3E%20%E8%BF%99%E6%98%AF%E4%B8%80%E7%A7%8D%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%85%88%E6%AF%94%E8%BE%83%E5%86%8D%E8%B5%8B%E5%80%BC%EF%BC%8C%E4%BC%AA%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%3E%0A%3E%20%60%60%60C%0A%3E%20int%20compare_and_swap(int*%20reg%2C%20int%20oldval%2C%20int%20newval)%0A%3E%20%7B%0A%3E%20%20%20%20%20ATOMIC()%3B%0A%3E%20%20%20%20%20int%20old_reg_val%20%3D%20*reg%3B%0A%3E%20%20%20%20%20if%20(old_reg_val%20%3D%3D%20oldval)%0A%3E%20%20%20%20%20%20%20*reg%20%3D%20newval%3B%0A%3E%20%20%20%20%20END_ATOMIC()%3B%0A%3E%20%20%20%20%20return%20old_reg_val%3B%0A%3E%20%7D%0A%3E%20%60%60%60%0A%3E%0A%3E%20%E9%92%88%E5%AF%B9%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%85%B7%E4%BD%93%E6%83%85%E5%86%B5%EF%BC%9A%0A%3E%0A%3E%20-%20%60oldval%20%3D%3D%200%60%3A%20%E8%A1%A8%E7%A4%BA%60mutex-%3E__data.__lock%20%3D%3D%200%60%EF%BC%8C%E5%8D%B3%E8%AF%A5lock%E6%97%A0owner%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%BE%97%E3%80%82%0A%3E%20-%20%60oldval%20!%3D%200%60%3A%20%E8%A1%A8%E7%A4%BA%E8%AF%A5mutex%E8%A2%ABlock%E4%BA%86%EF%BC%8C%E4%BB%8E%E8%80%8C%E8%BF%9B%E5%85%A5kernel%E6%9D%A5%E5%A4%84%E7%90%86%E9%94%81%E7%9A%84%E6%83%85%E5%86%B5%E3%80%82%0A%0Apthread_mutex_lock%E7%9A%84%E9%80%BB%E8%BE%91%E6%AF%94%E8%BE%83%E7%AE%80%E5%8D%95%EF%BC%8C%E5%B0%B1%E6%98%AF%E9%80%9A%E8%BF%87%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E5%88%A4%E6%96%AD%E9%94%81%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E9%94%81%E4%BD%8F%E3%80%82%E5%A6%82%E6%9E%9C%E6%B2%A1%E9%94%81%E4%BD%8F%E5%B0%B1%E6%9B%B4%E6%96%B0owner%EF%BC%8C%E4%BB%A5%E5%8F%8Auser%E8%AE%A1%E6%95%B0%E3%80%82%E5%A6%82%E6%9E%9C%E5%B7%B2%E7%BB%8F%E8%A2%AB%E9%94%81%E4%BD%8F%EF%BC%8C%E5%88%99%E9%99%B7%E5%85%A5%E5%86%85%E6%A0%B8%E8%B0%83%E7%94%A8FUTEX_LOCK_PI%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%AE%8C%E6%88%90%E4%B8%8A%E9%94%81%E7%9A%84%E6%93%8D%E4%BD%9C%E3%80%82%0A%0A%23%23%23%23%20pthread_mutex_unlock%0A%0A%E8%BF%99%E4%B8%AA%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%B8%8A%E5%B0%B1%E6%98%AF%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8futex_unlock_pi%20SYSCALL%E6%9D%A5%E5%AE%8C%E6%88%90%E5%B7%A5%E4%BD%9C%EF%BC%9A%0A%0A%60%60%60c%0A%20%20%20%20%20%20%2F*%20Unlock%20the%20mutex%20using%20a%20CAS%20unless%20there%20are%20futex%20waiters%20or%20our%0A%E2%80%BA%20%20%20%20TID%20is%20not%20the%20value%20of%20__lock%20anymore%2C%20in%20which%20case%20we%20let%20the%0A%E2%80%BA%20%20%20%20kernel%20take%20care%20of%20the%20situation.%20%20Use%20release%20MO%20in%20the%20CAS%20to%0A%E2%80%BA%20%20%20%20synchronize%20with%20acquire%20MO%20in%20lock%20acquisitions.%20%20*%2F%0A%20%20%20%20%20%20int%20l%20%3D%20atomic_load_relaxed%20(%26mutex-%3E__data.__lock)%3B%0A%20%20%20%20%20%20do%0A%E2%80%BA%20%20%20%7B%0A%E2%80%BA%20%20%20%20%20if%20(((l%20%26%20FUTEX_WAITERS)%20!%3D%200)%0A%E2%80%BA%20%20%20%20%20%20%20%20%20%7C%7C%20(l%20!%3D%20THREAD_GETMEM%20(THREAD_SELF%2C%20tid)))%0A%E2%80%BA%20%20%20%20%20%20%20%7B%0A%E2%80%BA%20%20%20%20%20%20%20%20%20INTERNAL_SYSCALL_DECL%20(__err)%3B%0A%E2%80%BA%20%20%20%20%20%20%20%20%20INTERNAL_SYSCALL%20(futex%2C%20__err%2C%202%2C%20%26mutex-%3E__data.__lock%2C%0A%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20__lll_private_flag%20(FUTEX_UNLOCK_PI%2C%20private))%3B%0A%E2%80%BA%20%20%20%20%20%20%20%20%20break%3B%0A%E2%80%BA%20%20%20%20%20%20%20%7D%0A%E2%80%BA%20%20%20%7D%0A%20%20%20%20%20%20while%20(!atomic_compare_exchange_weak_release%20(%26mutex-%3E__data.__lock%2C%0A%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%20%20%20%20%26l%2C%200))%3B%0A%60%60%60%0A%0A%0A%0A%23%23%20futex%0A%0Afutex%E6%98%AF%E4%B8%80%E7%A7%8D%E5%86%85%E6%A0%B8%E7%9A%84%E7%AD%89%E5%BE%85%E6%9C%BA%E5%88%B6%EF%BC%8C%E7%AD%89%E5%BE%85%E6%9F%90%E4%B8%AA%E7%94%A8%E6%88%B7%E6%80%81%E6%95%B0%E6%8D%AE%E8%A2%AB%E8%AE%BE%E7%BD%AE%E6%88%90%E6%9F%90%E4%B8%AA%E5%80%BC%E3%80%82%E9%92%88%E5%AF%B9%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%E7%9A%84futex%E7%95%A5%E6%9C%89%E4%B8%8D%E5%90%8C%E3%80%82%E5%AE%83%E4%B8%8D%E5%86%8D%E7%AD%89%E5%BE%85%E7%94%A8%E6%88%B7%E4%BC%A0%E5%85%A5%E7%9A%84%E5%9C%B0%E5%9D%80%E4%B8%8A%E7%9A%84%E5%80%BC%EF%BC%8C%E8%80%8C%E6%98%AF%E5%9F%BA%E4%BA%8E%E5%86%85%E6%A0%B8rt_mutex%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E7%AD%89%E5%BE%85%EF%BC%8C%E4%B8%8A%E9%94%81%E5%92%8C%E8%A7%A3%E9%94%81%E7%9A%84%E5%8A%9F%E8%83%BD%E3%80%82%E7%9C%8B%E4%B8%8B%E9%9D%A2glibc%E5%92%8CLinux%E7%9A%84%E6%8E%A5%E5%8F%A3%E5%AF%B9%E6%8E%A5%EF%BC%9A%0A%0A%60%60%60c%0A%2F%2F%20glibc%3A%20pthread_mutex_lock.c%0Aint%20e%20%3D%20INTERNAL_SYSCALL%20(futex%2C%20__err%2C%204%2C%20%26mutex-%3E__data.__lock%2C%0A%E2%80%BA%20%20%20%E2%80%BA%20%20%20%20%20%20%20%20%20__lll_private_flag%20(FUTEX_LOCK_PI%2C%0A%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%20%20private)%2C%201%2C%200)%3B%0A%0A%2F%2F%20Linux%3A%20futex.c%0Along%20do_futex(u32%20__user%20*uaddr%2C%20int%20op%2C%20u32%20val%2C%20ktime_t%20*timeout%2C%0A%E2%80%BA%20%20%20%E2%80%BA%20%20%20u32%20__user%20*uaddr2%2C%20u32%20val2%2C%20u32%20val3)%0A%7B%0A...%0A%09case%20FUTEX_LOCK_PI%3A%0A%E2%80%BA%20%20%20%09return%20futex_lock_pi(uaddr%2C%20flags%2C%20NULL%2C%201)%3B%20%20%20%20%0A...%20%0A%7D%0A%60%60%60%0A%0A%E5%8F%AF%E8%A7%81%EF%BC%9A%0A%0A-%20%60uaddr%20%3D%20%26mutex-%3E__data.__lock%60%0A-%20%60flags%20%3D%20__lll_private_flag%20(FUTEX_LOCK_PI%2C%20private)%60%0A-%20%60val%20%3D%201%2C%20timeout%20%3D%20NULL%60%0A%0A%3E%20%E5%85%B3%E4%BA%8Elock%2Funlock%E7%9A%84%E5%8F%99%E8%BF%B0%E4%BC%9A%E7%AE%80%E5%8C%96%E6%8E%89time%E7%9B%B8%E5%85%B3%E9%83%A8%E5%88%86%EF%BC%8C%E4%BB%A5%E5%8F%8API%E6%97%A0%E5%85%B3%E7%9A%84ROBUST%E7%AD%89%E7%89%B9%E6%80%A7%E3%80%82%0A%0A%23%23%23%20%E9%87%8D%E8%A6%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%0A%0A%60%60%60c%0A%2F*%0A%20*%20Hash%20buckets%20are%20shared%20by%20all%20the%20futex_keys%20that%20hash%20to%20the%20same%0A%20*%20location.%20%20Each%20key%20may%20have%20multiple%20futex_q%20structures%2C%20one%20for%20each%20task%0A%20*%20waiting%20on%20a%20futex.%0A%20*%2F%0Astruct%20futex_hash_bucket%20%7B%0A%E2%80%BA%20%20%20atomic_t%20waiters%3B%0A%E2%80%BA%20%20%20spinlock_t%20lock%3B%0A%E2%80%BA%20%20%20struct%20plist_head%20chain%3B%0A%7D%20____cacheline_aligned_in_smp%3B%0A%0A%2F**%0A%20*%20struct%20futex_q%20-%20The%20hashed%20futex%20queue%20entry%2C%20one%20per%20waiting%20task%0A%20*%20%40list%3A%E2%80%BA%20%20%E2%80%BA%20%20%20priority-sorted%20list%20of%20tasks%20waiting%20on%20this%20futex%0A%20*%20%40task%3A%E2%80%BA%20%20%E2%80%BA%20%20%20the%20task%20waiting%20on%20the%20futex%0A%20*%20%40lock_ptr%3A%E2%80%BA%20%20%E2%80%BA%20%20%20the%20hash%20bucket%20lock%0A%20*%20%40key%3A%E2%80%BA%20%20%20%E2%80%BA%20%20%20the%20key%20the%20futex%20is%20hashed%20on%0A%20*%20%40pi_state%3A%E2%80%BA%20%20%E2%80%BA%20%20%20optional%20priority%20inheritance%20state%0A%20*%20%40rt_waiter%3A%E2%80%BA%20%E2%80%BA%20%20%20rt_waiter%20storage%20for%20use%20with%20requeue_pi%0A%20*%20%40requeue_pi_key%3A%E2%80%BAthe%20requeue_pi%20target%20futex%20key%0A%20*%20%40bitset%3A%E2%80%BA%E2%80%BA%20%20%20bitset%20for%20the%20optional%20bitmasked%20wakeup%0A%20*%0A%20*%20We%20use%20this%20hashed%20waitqueue%2C%20instead%20of%20a%20normal%20wait_queue_entry_t%2C%20so%0A%20*%20we%20can%20wake%20only%20the%20relevant%20ones%20(hashed%20queues%20may%20be%20shared).%0A%20*%0A%20*%20A%20futex_q%20has%20a%20woken%20state%2C%20just%20like%20tasks%20have%20TASK_RUNNING.%0A%20*%20It%20is%20considered%20woken%20when%20plist_node_empty(%26q-%3Elist)%20%7C%7C%20q-%3Elock_ptr%20%3D%3D%200.%0A%20*%20The%20order%20of%20wakeup%20is%20always%20to%20make%20the%20first%20condition%20true%2C%20then%0A%20*%20the%20second.%0A%20*%0A%20*%20PI%20futexes%20are%20typically%20woken%20before%20they%20are%20removed%20from%20the%20hash%20list%20via%0A%20*%20the%20rt_mutex%20code.%20See%20unqueue_me_pi().%0A%20*%2F%0Astruct%20futex_q%20%7B%0A%E2%80%BA%20%20%20struct%20plist_node%20list%3B%0A%0A%E2%80%BA%20%20%20struct%20task_struct%20*task%3B%0A%E2%80%BA%20%20%20spinlock_t%20*lock_ptr%3B%0A%E2%80%BA%20%20%20union%20futex_key%20key%3B%0A%E2%80%BA%20%20%20struct%20futex_pi_state%20*pi_state%3B%0A%E2%80%BA%20%20%20struct%20rt_mutex_waiter%20*rt_waiter%3B%0A%E2%80%BA%20%20%20union%20futex_key%20*requeue_pi_key%3B%0A%E2%80%BA%20%20%20u32%20bitset%3B%0A%7D%20__randomize_layout%3B%0A%0A%2F*%0A%20*%20Priority%20Inheritance%20state%3A%0A%20*%2F%0Astruct%20futex_pi_state%20%7B%0A%E2%80%BA%20%20%20%2F*%0A%E2%80%BA%20%20%20%20*%20list%20of%20&apos;owned&apos;%20pi_state%20instances%20-%20these%20have%20to%20be%0A%E2%80%BA%20%20%20%20*%20cleaned%20up%20in%20do_exit()%20if%20the%20task%20exits%20prematurely%3A%0A%E2%80%BA%20%20%20%20*%2F%0A%E2%80%BA%20%20%20struct%20list_head%20list%3B%0A%0A%E2%80%BA%20%20%20%2F*%0A%E2%80%BA%20%20%20%20*%20The%20PI%20object%3A%0A%E2%80%BA%20%20%20%20*%2F%0A%E2%80%BA%20%20%20struct%20rt_mutex%20pi_mutex%3B%0A%0A%E2%80%BA%20%20%20struct%20task_struct%20*owner%3B%0A%E2%80%BA%20%20%20atomic_t%20refcount%3B%0A%0A%E2%80%BA%20%20%20union%20futex_key%20key%3B%0A%7D%20__randomize_layout%3B%0A%60%60%60%0A%0A%60futex_hash_bucket%60%E5%AF%B9%E5%BA%94%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E6%80%81%E7%9A%84%60uaddr%60%E3%80%82%E9%80%9A%E8%BF%87%E7%94%A8%E6%88%B7%E6%80%81%E4%BC%A0%E5%85%A5%E7%9A%84uaddr%E5%9C%B0%E5%9D%80%EF%BC%8C%E6%9D%A5%E8%8E%B7%E5%BE%97%E5%AF%B9%E5%BA%94%E7%9A%84futex%E7%BB%93%E6%9E%84%E4%BD%93%E3%80%82%E7%94%A8hash%E7%9A%84%E5%8E%9F%E5%9B%A0%E6%98%AF%E4%BC%A0%E5%85%A5%E7%9A%84%E6%98%AFuaddr%E5%9C%B0%E5%9D%80%E5%80%BC%EF%BC%8C%E6%95%B0%E5%AD%97%E5%BE%88%E5%A4%A7%EF%BC%8C%E5%88%86%E5%B8%83%E5%BE%88%E6%95%A3%EF%BC%8C%E6%89%80%E4%BB%A5%E7%94%A8hash%E5%8F%AF%E4%BB%A5%E6%9C%89%E6%95%88%E7%B4%A2%E5%BC%95%E3%80%82%0A%0A%60futex_q%20%60%E6%98%AF%E4%B8%80%E4%B8%AA%E4%B8%B4%E6%97%B6%E5%8F%98%E9%87%8F%EF%BC%8C%E5%AF%B9%E5%BA%94%E4%BA%86%E4%B8%80%E4%B8%AAfutex%E7%9A%84waiter%E7%BA%BF%E7%A8%8B%E3%80%82%E5%AE%83%E9%80%9A%E5%B8%B8%E8%A2%AB%E7%94%A8%E6%9D%A5%E4%BC%A0%E9%80%92%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%82%0A%0A%60pi_state%60%E6%98%AF%60task_struct%60%E5%86%85%E9%83%A8%E7%9A%84%E4%B8%80%E4%B8%AA%E5%8F%98%E9%87%8F%EF%BC%8C%E5%9C%A8%60futex_lock_pi%60%E8%B0%83%E7%94%A8%60refill_pi_state_cache%60%E9%87%8C%E9%9D%A2%E5%81%9A%E5%88%86%E9%85%8D%E3%80%82%0A%0A%0A%60%60%60c%0Astatic%20int%20refill_pi_state_cache(void)%0A%7B%0A...%0A%09pi_state%20%3D%20kzalloc(sizeof(*pi_state)%2C%20GFP_KERNEL)%3B%0A%20%20%20%20current-%3Epi_state_cache%20%3D%20pi_state%3B%0A...%0A%7D%0A%60%60%60%0A%23%23%23%20futex_lock_pi%0A%0A%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84%E9%80%BB%E8%BE%91%E8%BF%98%E6%98%AF%E6%AF%94%E8%BE%83%E7%9B%B4%E7%BA%BF%E7%9A%84%EF%BC%8C%E5%90%8C%E5%A4%A7%E5%A4%9A%E6%95%B0%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%85%88%E5%B0%9D%E8%AF%95%E5%8E%9F%E5%AD%90%E9%94%81%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E8%A1%8C%EF%BC%8C%E5%88%99%E8%B0%83%E7%94%A8rt_mutex%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9D%A5%E5%A4%84%E7%90%86%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%E7%9A%84%E6%9C%BA%E5%88%B6%E3%80%82%E4%BB%A5%E4%B8%8B%E6%8D%A1%E5%8F%96%E6%AF%94%E8%BE%83%E9%87%8D%E8%A6%81%E7%9A%84%E5%87%BD%E6%95%B0%E5%81%9A%E9%98%90%E8%BF%B0%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%5C%5B3%5D%2C%20%5C%5B4%5D%E4%B8%AD%E7%9A%84%E6%8F%8F%E8%BF%B0%E3%80%82%0A%0A%23%23%23%23%20queue_lock%2C%20queue_unlock%0A%0A%E5%AF%B9hash_bucket%E8%BF%9B%E8%A1%8C%E9%94%81%E6%93%8D%E4%BD%9C%E3%80%82%E4%BB%96%E4%BB%AC%E6%93%8D%E4%BD%9C%E7%9A%84%E6%98%AF%60hash_bucket%60%E4%B8%8B%E7%9A%84%60lock%60%EF%BC%8C%E5%90%8C%E6%97%B6%E4%B9%9F%E6%98%AF%60futex_q%60%E4%B8%8B%E7%9A%84%60lock_ptr%60%E3%80%82%E8%BF%99%E9%87%8C%E9%94%81%E7%9A%84%E5%87%BA%E7%8E%B0%E6%AF%94%E8%BE%83%E6%B7%B7%E4%B9%B1%EF%BC%8C%E6%9C%89%E6%97%B6%E8%B0%83%E7%94%A8%E4%B8%8A%E9%9D%A2%E7%9A%84%E8%BF%99%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%E6%9C%89%E6%97%B6%E7%9B%B4%E6%8E%A5%E5%AF%B9lock%E6%8C%87%E9%92%88%E6%93%8D%E4%BD%9C%E3%80%82%E9%9C%80%E8%A6%81%E5%B0%8F%E5%BF%83%E3%80%82%0A%0A%23%23%23%23%20__queue_me%2C%20unqueue_me%0A%0A%E8%BF%99%E9%87%8C%E5%B0%86%E7%94%B3%E8%AF%B7futex%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%9C%A8hash_bucket%E7%9A%84chain%E4%B8%8A%E5%81%9A%E6%B7%BB%E5%8A%A0%E6%88%96%E7%A7%BB%E9%99%A4%E6%93%8D%E4%BD%9C%E3%80%82%E8%BF%98%E4%BC%9A%E6%B6%89%E5%8F%8A%E9%94%81%E7%9A%84%E6%93%8D%E4%BD%9C%E3%80%82%0A%0A%E4%BB%A5%E4%B8%8A4%E4%B8%AA%E5%87%BD%E6%95%B0%E6%9B%B4%E5%A4%9A%E7%9A%84%E4%B8%8Efutex%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%9B%B8%E5%85%B3%EF%BC%8C%E4%B8%8E%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%E5%B9%B6%E6%97%A0%E5%85%B3%E7%B3%BB%EF%BC%8C%E6%89%80%E4%BB%A5%E5%8F%AF%E4%BB%A5%E7%95%A5%E8%BF%87%E3%80%82%0A%0A%23%23%23%23%20futex_lock_pi_atomic%0A!%5B8f64be7a14c9e36fb86aff8b54e61062.png%5D(evernotecid%3A%2F%2F22617523-9521-4D00-B771-5F27B85F00EB%2Fappyinxiangcom%2F161681%2FENResource%2Fp5792)%0A%0A%0A%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%81%9A%E7%9A%84%E5%B0%B1%E6%98%AF%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E6%9D%A5%E8%AF%B7%E6%B1%82%E9%94%81%EF%BC%8C%0A%0A-%20%E5%A6%82%E6%9E%9Cfutex%E6%B2%A1%E6%9C%89waiter%EF%BC%8C%E5%88%99%E7%9B%B4%E6%8E%A5%E8%8E%B7%E5%BE%97%E9%94%81%E5%B9%B6%E8%BF%94%E5%9B%9E1%EF%BC%8C%E8%A1%A8%E7%A4%BA%E6%88%90%E5%8A%9F%E8%8E%B7%E5%BE%97%E9%94%81%0A-%20%E5%A6%82%E6%9E%9C%E6%9C%89waiter%EF%BC%8C%E5%B0%B1%E8%BF%94%E5%9B%9E0%EF%BC%8C%E8%A1%A8%E7%A4%BAready%20to%20wait%0A%0A%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%8D%E5%90%8C%E7%9A%84%E6%98%AF%E4%BC%9A%E5%81%9A%E4%B8%80%E4%BA%9B%E4%B8%8EPI%E7%9B%B8%E5%85%B3%E7%9A%84%E5%A4%84%E7%90%86%EF%BC%9A%0A%0A-%20%E6%9C%89waiter%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%9A%0A%20%20-%20%E8%B0%83%E7%94%A8attach_to_pi_state%E6%9D%A5%E8%8E%B7%E5%BE%97%E8%AF%A5top_waiter%E7%9A%84pi_state%0A-%20%E6%B2%A1%E6%9C%89waiter%E7%9A%84%E6%83%85%E5%86%B5%0A%20%20-%20%E8%B0%83%E7%94%A8attach_to_pi_owner%E6%9D%A5%E5%8F%96%E7%94%A8%E6%9C%AC%E7%BA%BF%E7%A8%8B%E9%87%8C%E5%88%86%E9%85%8D%E7%9A%84pi_state%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%8C%E5%B9%B6%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E3%80%82%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BC%9A%E8%A2%ABqueue%E5%88%B0hash_bucket%E7%9A%84%E9%98%9F%E5%88%97%E4%B8%AD%E3%80%82%0A%0A%23%23%23%23%20rt_mutex%E6%8E%A5%E5%8F%A3%0A%0Afutex_lock_pi%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%88%B0%E5%A6%82%E4%B8%8B%E8%BF%99%E4%BA%9Brt_mutex%E6%8E%A5%E5%8F%A3%EF%BC%9A%0A%0A-%20rt_mutex_init_waiter%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96waiter%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E5%85%B6%E5%AE%9E%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%BA%A2%E9%BB%91%E6%A0%91%E7%9A%84%E8%8A%82%E7%82%B9%E3%80%82%E8%BF%99%E4%B8%AAwaiter%E5%AF%B9%E5%BA%94%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B%EF%BC%8C%E5%B9%B6%E5%8F%8D%E6%98%A0%E7%BA%BF%E7%A8%8B%E5%9C%A8%E6%9F%90%E4%B8%AA%E9%94%81%E4%B8%8A%E7%9A%84%E7%AD%89%E5%BE%85%E5%85%B3%E7%B3%BB%E3%80%82%0A-%20__rt_mutex_start_proxy_lock%EF%BC%9A%E8%BF%99%E4%B8%AA%E6%98%AFPI%E7%9A%84%E6%A0%B8%E5%BF%83%E5%87%BD%E6%95%B0%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%AF%B9%E5%90%84waiters%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BB%A5%E5%8F%8A%E9%81%8D%E5%8E%86lock%E9%93%BE%E6%9D%A5%E6%A3%80%E6%9F%A5%E6%AD%BB%E9%94%81%E3%80%82%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%8E%E4%B9%8B%E5%89%8D%E7%9A%84%E5%8E%9F%E5%AD%90%E6%A3%80%E6%9F%A5%E7%B1%BB%E4%BC%BC%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%94%E5%9B%9E1%E8%A1%A8%E7%A4%BA%E5%B7%B2%E7%BB%8F%E8%8E%B7%E5%BE%97%E9%94%81%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%94%E5%9B%9E0%EF%BC%8C%E5%88%99ready%20to%20wait%E3%80%82%0A-%20rt_mutex_wait_proxy_lock%EF%BC%9A%E9%80%9A%E8%BF%87__rt_mutex_start_proxy_lock%E5%A4%84%E7%90%86%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%98%E6%B2%A1%E6%9C%89%E8%8E%B7%E5%BE%97%E9%94%81%EF%BC%8C%E9%82%A3%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%BC%80%E5%A7%8B%E7%AD%89%E5%BE%85%E4%BA%86%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%B0%86%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E4%B8%BATASK_INTERRUPTIBLE%E7%8A%B6%E6%80%81%EF%BC%8C%E5%B9%B6%E5%BC%80%E5%A7%8B%E7%AD%89%E5%BE%85%E3%80%82%E8%BF%99%E5%85%B6%E9%97%B4%E4%BC%9A%E5%A4%84%E7%90%86%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E7%AD%89%E5%BE%85%EF%BC%8C%E4%B8%94%E4%BC%9A%E8%A7%A6%E5%8F%91%E8%B0%83%E5%BA%A6%E3%80%82%0A-%20rt_mutex_cleanup_proxy_lock%EF%BC%9A%E7%8E%B0%E5%9C%A8%E5%B7%B2%E7%BB%8F%E9%98%BB%E5%A1%9E%E7%BB%93%E6%9D%9F%E4%BA%86%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%98%E6%B2%A1%E8%8E%B7%E5%BE%97%E9%94%81%EF%BC%8C%E8%A6%81%E4%B9%88%E6%98%AF%E8%B6%85%E6%97%B6%EF%BC%8C%E8%A6%81%E4%B9%88%E6%98%AF%E5%87%BA%E9%94%99%EF%BC%8C%E6%80%BB%E4%B9%8B%E8%A6%81%E5%B0%86%E6%9C%AC%E7%BA%BF%E7%A8%8B%E4%BB%8Ewaiters%E4%B8%AD%E7%A7%BB%E9%99%A4%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%B0%B1%E6%98%AF%E8%B5%B7%E8%BF%99%E4%B8%AA%E4%BD%9C%E7%94%A8%E3%80%82%0A%0A%23%23%23%23%20fixup_owner%0A%0A%E4%BB%8E%E6%B3%A8%E9%87%8A%E4%B8%8A%E7%9C%8B%EF%BC%8C%E6%98%AF%E4%B8%BA%E4%BA%86%E5%A4%84%E7%90%86lock%20steal%E3%80%82%E8%80%8Clock%20steal%E4%BC%BC%E4%B9%8E%E5%A4%9A%E5%8F%91%E7%94%9F%E5%9C%A8futex%20requeue%E6%93%8D%E4%BD%9C%E4%B8%8A%EF%BC%8C%E7%9B%AE%E5%89%8D%E5%B0%9A%E6%9C%AA%E4%BB%94%E7%BB%86%E7%A0%94%E7%A9%B6%E3%80%82%0A%0A%23%23%23%20futex_unlock_pi%0A%0Afutex_unlock_pi%E9%87%8A%E6%94%BEfutex%E4%BB%A5%E5%8F%8A%E6%9B%B4%E6%96%B0%E7%9B%B8%E5%BA%94%E7%9A%84pi_state%E5%92%8Crt_mutex%E7%9A%84owner%E5%AD%97%E6%AE%B5%E3%80%82%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%B1%82%E6%AC%A1%E6%AF%94%E8%BE%83%E6%B7%B1%EF%BC%8C%E5%9F%BA%E6%9C%AC%E4%B8%8A%E9%83%BD%E6%98%AF%E6%AF%8F%E4%B8%80%E5%B1%82%E5%81%9A%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E7%9A%84%E6%9B%B4%E6%96%B0%E5%B7%A5%E4%BD%9C%EF%BC%8C%E6%9C%80%E7%BB%88%E8%B0%83%E7%94%A8%E5%88%B0__rt_mutex_futex_unlock%E6%9D%A5%E9%87%8D%E6%96%B0%E8%B0%83%E6%95%B4%E6%9C%AC%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%8C%E5%B9%B6%E5%B0%86top%20waiter%E6%94%BE%E5%88%B0wake%20queue%E4%B8%8A%E3%80%82%E5%9C%A8rt_mutex_postunlock%E8%B0%83%E7%94%A8%E7%9A%84rt_mutex_postunlock%E5%B0%86%E6%96%B0%E7%BA%BF%E7%A8%8B%E5%94%A4%E9%86%92%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89waiter%EF%BC%8C%E5%88%99%E4%BD%BF%E7%94%A8%60cmpxchg_futex_value_locked%60%E6%9D%A5%E5%B0%86%E7%94%A8%E6%88%B7%E6%80%81%E5%9C%B0%E5%9D%80uaddr%E4%B8%8A%E7%9A%84%E5%80%BC%E8%AE%BE%E4%B8%BA0%E3%80%82%E5%9B%A0%E4%B8%BA%E9%94%81%E6%B2%A1%E6%9C%89waiter%E4%BA%86%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BC%98%E5%85%88%E7%BA%A7%E4%B9%9F%E4%B8%8D%E9%9C%80%E8%A6%81%E6%81%A2%E5%A4%8D%E4%BA%86%EF%BC%8C%E6%88%96%E8%80%85%E5%B7%B2%E7%BB%8F%E6%81%A2%E5%A4%8D%E8%BF%87%E4%BA%86%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E6%9C%89waiter%EF%BC%8C%E5%B0%B1%E4%BD%BF%E7%94%A8%E4%B8%8B%E9%9D%A2%E5%87%A0%E4%B8%AA%E5%87%BD%E6%95%B0%E6%9D%A5%E5%88%87%E6%8D%A2lock%20owner%EF%BC%8C%E5%B9%B6%E6%81%A2%E5%A4%8D%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E3%80%82%0A%0A%23%23%23%23%20wake_futex_pi%0A%0A%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%81%9A%E4%BA%86%E4%B8%8B%E9%9D%A2%E5%87%A0%E4%BB%B6%E4%BA%8B%EF%BC%9A%0A%0A1.%20%E7%94%A8cmpxchg_futex_value_locked%E5%B0%86%E7%94%A8%E6%88%B7%E6%80%81%E4%BC%A0%E5%85%A5%E7%9A%84uaddr%E5%A4%84%E7%9A%84%E6%95%B0%E5%80%BC%E6%9B%B4%E6%96%B0%E4%B8%BA%E6%96%B0%E7%9A%84%60rt_mutex_next_owner()%20%7C%20FUTEX_WAITERS%60%0A2.%20%60list_del_init(%26pi_state-%3Elist)%60%EF%BC%9A%E5%B0%86list%E4%BB%8E%E5%8E%9F%E5%85%88%E7%9A%84%E8%A1%A8%E4%B8%8A%E5%88%A0%E9%99%A4%EF%BC%8C%E5%B9%B6%E9%87%8D%E6%96%B0%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%8C%E5%87%86%E5%A4%87%E7%A7%BB%E5%88%B0%E5%85%B6%E4%BB%96%E7%9A%84%E8%A1%A8%E4%B8%8A%E3%80%82%0A3.%20%60list_add(%26pi_state-%3Elist%2C%20%26new_owner-%3Epi_state_list)%60%0A4.%20%60pi_state-%3Eowner%20%3D%20new_owner%60%0A5.%20%60__rt_mutex_futex_unlock%60%0A6.%20%60rt_mutex_postunlock%60%0A%0A%23%23%23%23%20mark_wakeup_next_waiter%0A%0A%E6%B3%A8%E6%84%8F%EF%BC%9A%E6%AD%A4%E6%97%B6pi_state-%3Eowner%E5%B7%B2%E7%BB%8F%E8%AE%BE%E7%BD%AE%E8%BF%87%E4%BA%86%EF%BC%8C%E4%BD%86%E6%98%AFpi_state-%3Epi_mutex-%3Eowner%E8%BF%98%E6%B2%A1%E6%9C%89%E8%AE%BE%E7%BD%AE%E3%80%82%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%BB%E8%A6%81%E5%81%9A%E4%BA%86%E4%B8%8B%E9%9D%A2%E5%87%A0%E4%BB%B6%E4%BA%8B%E6%83%85%EF%BC%9A%0A%0A1.%20%60rt_mutex_dequeue_pi(current%2C%20waiter)%3B%60%0A2.%20%60rt_mutex_adjust_prio(current)%60%3A%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E6%95%B4%E4%BA%86%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%8C%E5%AE%8C%E6%88%90%E4%BA%86%E6%95%B4%E4%B8%AA%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%E5%8D%8F%E8%AE%AE%E3%80%82%0A3.%20%60wake_q_add(wake_q%2C%20waiter-%3Etask)%60%0A%0A%23%23%23%23%20put_pi_state%0A%0A%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E6%9B%B4%E5%A4%9A%E7%9A%84%E6%98%AF%E6%B8%85%E7%90%86%E5%B7%A5%E4%BD%9C%3A%0A%0A1.%20%E8%B0%83%E7%94%A8%E4%BA%86%60rt_mutex_proxy_unlock%60%E6%9D%A5%E9%87%8A%E6%94%BEpi_state-%3Epi_mutex.%0A2.%20%E9%87%8A%E6%94%BE%E4%BA%86current-%3Epi_state_cache%E7%A9%BA%E9%97%B4%0A%0A%3E**cmpxchg_futex_value_locked%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C**%0A%3E%0A%3E%60%60%60c%0A%3Estatic%20int%20cmpxchg_futex_value_locked(u32%20*uval%2C%20u32%20__user%20*uaddr%2C%0A%3E%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%E2%80%BA%20%20%20%20%20%20%20%20%20u32%20oldval%2C%20u32%20newval)%0A%3E%7B%0A%3EATOMIC()%3B%0A%3Eint%20val%20%3D%20*uaddr%3B%0A%3Eif%20(val%20%3D%3D%20oldval)%20%7B%0A%3E*uaddr%20%3D%20newval%3B%0A%3E%7D%0A%3E*uval%20%3D%20val%3B%0A%3EEND_ATOMIC()%3B%0A%3Ereturn%200%3B%0A%3E%7D%0A%3E%0A%3E%E5%85%B6%E4%B8%ADATOMIC%E6%93%8D%E4%BD%9C%E9%80%9A%E8%BF%87page_disable()%E5%92%8Cpreempt_disable()%E4%BF%9D%E8%AF%81%E3%80%82%0A%3E%60%60%60%0A%0A%23%23%20__rt_mutex_start_proxy_lock%0A%0A%E4%BB%8E%E4%B8%8A%E9%9D%A2futex_lock_pi%E7%94%A8%E5%88%B0%E7%9A%84rt_mutex%E6%8E%A5%E5%8F%A3%E4%BB%8B%E7%BB%8D%E4%B8%AD%E5%8F%AF%E7%9F%A5%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E6%98%AF%E6%95%B4%E4%B8%AAPI%E5%A4%84%E7%90%86%E7%9A%84%E6%A0%B8%E5%BF%83%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%8F%88%E4%B8%BB%E8%A6%81%E8%B0%83%E7%94%A8task_blocks_on_rt_mutex%E6%9D%A5%E5%A4%84%E7%90%86PI%E3%80%82%0A%0A!%5B692787b6adf4be8b04b3aa57c3612c37.png%5D(evernotecid%3A%2F%2F22617523-9521-4D00-B771-5F27B85F00EB%2Fappyinxiangcom%2F161681%2FENResource%2Fp5793)%0A%0A%0A%23%23%23%23%20rt_mutex_adjust_prio(owner)%0A%0A%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%B0%B1%E6%98%AF%E8%B0%83%E6%95%B4%E9%98%BB%E5%A1%9E%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%8C%E4%BB%8E%E8%80%8C%E5%AE%9E%E7%8E%B0%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%E7%9A%84%E3%80%82%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E4%B9%9F%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%9A%0A%0A%60%60%60c%0Aif%20(task_has_pi_waiters(p))%0A%E2%80%BA%20%20%20pi_task%20%3D%20task_top_pi_waiter(p)-%3Etask%3B%0A%0Art_mutex_setprio(p%2C%20pi_task)%3B%0A%60%60%60%0A%0A%E6%8A%8Aowner%E7%BA%BF%E7%A8%8B%E8%AE%BE%E7%BD%AE%E4%B8%BAowner%E7%BA%BF%E7%A8%8B%E6%89%80%E6%9C%89waiter(%E5%8F%AF%E8%83%BD%E6%9D%A5%E8%87%AA%E5%A4%9A%E4%B8%AA%E9%94%81)%E7%9A%84%E6%9C%80%E9%AB%98%E4%BC%98%E5%85%88%E7%BA%A7%E3%80%82%0A%0A%23%23%23%23%20rt_mutex_adjust_prio_chain%0A%0A%23%23%23%23%23%20%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B8%AA%E9%93%BE%E5%BC%8F%E8%B0%83%E6%95%B4%EF%BC%9F%0A!%5Bc4badef8862a4db7fb98b88635d31ecb.png%5D(evernotecid%3A%2F%2F22617523-9521-4D00-B771-5F27B85F00EB%2Fappyinxiangcom%2F161681%2FENResource%2Fp5794)%0A%0A%E8%BF%99%E9%87%8C%E6%9C%89%E4%B8%A4%E5%BC%A0%E8%A1%A8%E6%A0%BC%EF%BC%9A%0A%0A-%20%E6%AF%8F%E4%B8%AArt_mutex%E6%9C%89%E5%BC%A0waiters%E8%A1%A8%E6%A0%BC%EF%BC%8C%E8%A1%A8%E7%A4%BA%E6%89%80%E6%9C%89%E7%AD%89%E5%BE%85%E7%9A%84%E7%BA%BF%E7%A8%8B%0A%0A-%20%E6%AF%8F%E4%B8%AAtask%E4%B9%9F%E6%9C%89%E5%BC%A0%E8%A1%A8%E6%A0%BC%EF%BC%8C%E8%A1%A8%E6%A0%BC%E9%87%8C%E7%9A%84%E6%AF%8F%E4%B8%80%E9%A1%B9%E5%AF%B9%E5%BA%94owner%E7%BA%BF%E7%A8%8B%E5%8D%A0%E6%9C%89%E7%9A%84%E9%94%81%EF%BC%8C%E6%AF%8F%E4%B8%80%E9%A1%B9%E6%98%AF%E4%B8%80%E4%B8%AArt_mutex_waiter%EF%BC%8C%E8%A1%A8%E7%A4%BA%E7%94%B3%E8%AF%B7%E8%AF%A5%E9%94%81%E7%9A%84%E6%9C%80%E9%AB%98%E4%BC%98%E5%85%88%E7%BA%A7waiter%0A%0A%E5%81%87%E8%AE%BETask1%E5%B0%B1%E6%98%AFowner%EF%BC%8CTask0%E5%AF%B9Lock0%E7%9A%84%E7%94%B3%E8%AF%B7%E5%AF%BC%E8%87%B4Task1%E6%8F%90%E5%8D%87%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%8C%E5%A6%82%E6%9E%9CTask1%E5%90%8C%E6%97%B6%E8%A2%ABTask2%E6%8C%81%E6%9C%89%E7%9A%84%E6%9F%90%E4%B8%AA%E9%94%81%E9%98%BB%E5%A1%9E%EF%BC%8C%E5%88%99Task1%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E6%94%B9%E5%8F%98%EF%BC%8C%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%AF%BC%E8%87%B4Task2%20pi_waiters%E5%88%97%E8%A1%A8%E6%94%B9%E5%8F%98%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8F%AF%E8%83%BD%E5%AF%BC%E8%87%B4Task2%E4%BC%98%E5%85%88%E7%BA%A7%E6%94%B9%E5%8F%98%E3%80%82%E4%BE%9D%E6%AD%A4%E7%B1%BB%E6%8E%A8%EF%BC%8C%E5%B0%B1%E4%BC%9A%E5%AF%BC%E8%87%B4%E4%B8%8A%E9%9D%A2%E7%9A%84%E8%BF%99%E7%A7%8D%E9%93%BE%E5%BC%8F%E5%8F%8D%E5%BA%94%E3%80%82%0A%0A%0A%0A%23%23%23%23%23%20%E9%93%BE%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%0A%E6%95%B4%E4%B8%AAchain%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%A4%A7%E8%87%B4%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0A1.%20%E5%A6%82%E6%9E%9CTask0%E6%98%AFLock0%E7%9A%84top%20waiter%EF%BC%8C%E5%88%99%E6%BF%80%E5%8F%91%E8%AF%A5%E9%93%BE%E5%BC%8F%E8%B0%83%E6%95%B4%E3%80%82%0A2.%20%E5%9B%A0%E4%B8%BATask0%E6%88%90%E4%B8%BALock0%E7%9A%84topwaiter%EF%BC%8C%E5%88%99Task1%E7%9A%84pi_waiters%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4%EF%BC%8C%E5%88%99Task1%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4%E3%80%82%E9%80%80%E5%87%BA%E5%8F%AF%E8%83%BD%EF%BC%9A%0A%20%20%20%20-%20%E8%B5%B7%E7%82%B9%E9%94%81%E9%87%8A%E6%94%BE%E4%BA%86%0A%0A%20%20%20%20-%20%E9%93%BE%E7%9A%84%E5%BD%93%E5%89%8D%E7%8E%AF%E8%8A%82%E8%A2%AB%E6%9B%B4%E6%94%B9(%20next_lock%20%E2%89%A0waiter-%3Elock)%0A%0A%20%20%20%20-%20Task1%E6%B2%A1%E6%9C%89%E5%8D%A0%E9%94%81%0A3.%20%E5%A6%82%E6%9E%9CTask1%E4%B9%9Fwait%E5%9C%A8%E6%9F%90%E4%B8%AAlock%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%88%99%E8%AF%A5lock%E7%9A%84waiters%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4%EF%BC%8C%E8%BF%99%E9%87%8C%E6%9C%89%E8%8B%A5%E5%B9%B2%E7%A7%8D%E9%80%80%E5%87%BA%E5%8F%AF%E8%83%BD%E3%80%82%0A%0A%20%20-%20Task1%E6%B2%A1%E6%9C%89%E8%A2%ABblock%0A%20%20-%20Task1%20pi_waiters%E4%B8%AD%E6%9C%89%E4%BC%98%E5%85%88%E7%BA%A7%E9%AB%98%E4%BA%8ETask0%E7%9A%84waiter%EF%BC%8C%E6%8D%A2%E5%8F%A5%E8%AF%9D%E8%AF%B4%EF%BC%8Clock0%E7%9A%84top_waiter%E4%B8%8D%E6%98%AFTask1%E7%9A%84top%20pi_waiter%EF%BC%8C%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%A7%E6%89%BF%E4%B8%8D%E9%9C%80%E8%A6%81%E7%BB%A7%E7%BB%AD%E4%BC%A0%E9%80%92%20%0A%20%20-%20%E5%A6%82%E6%9E%9CTask1%E5%9C%A8%E7%94%B3%E8%AF%B7Lock1%20%E7%9A%84%E6%97%B6%E5%80%99%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%88%E8%BF%99%E4%B8%AA%E8%AE%B0%E5%BD%95%E5%9C%A8waiter-%3Eprio%E9%87%8C%EF%BC%89%E4%B8%8E%E5%BD%93%E5%89%8D%E8%B0%83%E6%95%B4%E5%90%8E%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E7%9B%B8%E7%AD%89%EF%BC%8C%E5%88%99%E5%90%8E%E7%BB%AD%E6%B2%A1%E5%BF%85%E8%A6%81%E5%9C%A8%E7%BB%A7%E7%BB%AD%E8%B0%83%E6%95%B4%E4%BC%98%E5%85%88%E7%BA%A7%0A%20%20-%20%E6%A3%80%E6%B5%8B%E5%88%B0DEADLOCK%0A4.%20%E5%9B%9E%E5%88%B01%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C%EF%BC%8C%E7%9B%B4%E5%88%B0%E9%80%80%E5%87%BA%E9%93%BE%E5%BC%8F%E5%A4%84%E7%90%86%0A%0A%23%23%23%23%23%20%E6%AD%BB%E9%94%81%0A%0A%E6%9C%893%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%8C%E5%87%BD%E6%95%B0%E4%BC%9A%E8%BF%94%E5%9B%9E%E6%AD%BB%E9%94%81%0A%0A-%20%E9%93%BE%E4%B8%8A%E8%B6%85%E8%BF%871024%E4%B8%AA%E9%94%81%E8%8A%82%E7%82%B9%0A-%20%E9%93%BE%E4%B8%8A%E4%BB%BB%E6%84%8FTask%E8%8A%82%E7%82%B9%E7%94%B3%E8%AF%B7%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%94%81%E8%8A%82%E7%82%B9%EF%BC%8C%E5%8D%B3Lock0%0A-%20%E9%93%BE%E4%B8%8A%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E9%94%81owner%E6%98%AF%E7%AC%AC%E4%B8%80%E4%B8%AATask%E8%8A%82%E7%82%B9%EF%BC%8C%E5%8D%B3Task0%0A%0A%0A%23%23%20%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%0A%0A%5C%5B1%5D%20%5BMutex%20mutandis%3A%20understanding%20mutex%20types%20and%20attributes%5D.%20(http%3A%2F%2F2net.co.uk%2Ftutorial%2Fmutex_mutandis)%0A%0A%5C%5B2%5D%20%5BPOSIX%20Revision%20of%20IEEE%20Std%201003.1-2008%5D(http%3A%2F%2Fpubs.opengroup.org%2Fonlinepubs%2F9699919799%2Ffunctions%2Fcontents.html)%0A%0A%5C%5B3%5D%20%5BSource%20code%20analysis%20of%20pthread_mutex_lock%5D(https%3A%2F%2Fzihan.me%2F2018%2F08%2F15%2Fsource-code-analysis-pthread-mutex-lock%2F)%0A%0A%5C%5B4%5D%20%5Blinux%20pi_futex%E6%B5%85%E6%9E%90%5D(https%3A%2F%2Fyq.aliyun.com%2Farticles%2F6044)%0A%0A%5C%5B5%5D%20Linux%204.20-rc3%20source%20code%0A%0A%5C%5B6%5D%20glibc%202.28%20source%20code%0A</center>",
            "tags": [
                "Linux",
                "schedule algorithm",
                "glibc"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2013/02/16/swap_cache/",
            "url": "https://blog.zhougy.top/2013/02/16/swap_cache/",
            "title": "swap cache",
            "date_published": "2013-02-16T04:14:01.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir><span style=\"line-height: 22.390625px; background-color: rgb(255, 255, 255);\">1.&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F1A;&#x7528;&#x5230;swap&#xFF1F;</span><div>&#xA0; &#xA0; &#xA0;1&#xFF09;&#x6362;&#x51FA;<span style=\"line-height: 22px;\"><br></span><div>&#xA0; &#xA0; &#xA0;&#x5F53;&#x5185;&#x6838;&#x5728;&#x5206;&#x914D;&#x5185;&#x5B58;&#x65F6;&#xFF0C;&#x8C03;&#x7528;__alloc_pages&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7A7A;&#x95F2;&#x9875;&#xFF0C;&#x5185;&#x6838;&#x4F1A;&#x542F;&#x52A8;&#x9875;&#x9762;&#x4EA4;&#x6362;&#x673A;&#x5236;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;try_to_free_pages&#x3002;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1293 &#xA0; &#xA0;page = get_page_from_freelist(gfp_mask, order,</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1294&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; zonelist, ALLOC_NO_WATERMARKS);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1295&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (page)</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1296&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto got_pg;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1306 &#xA0; &#xA0;if (!w ait)</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1307&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto nopage;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1316</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1317&#xA0;&#xA0;&#xA0;&#xA0; did_some_progress = try_to_free_pages(zonelist-&gt;zones, gfp_mask);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div></blockquote>&#xA0; &#xA0; &#xA0;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5982;&#x679C;&#x5206;&#x914D;&#x8005;&#x5141;&#x8BB8;&#x7B49;&#x5F85;&#xFF0C;&#x5219;&#x4F1A;&#x5F00;&#x59CB;&#x56DE;&#x6536;&#x9875;&#x9762;&#x3002;&#x518D;&#x5F80;&#x4E0B;&#x7684;&#x8C03;&#x7528;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#xFF1A;<div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">try_to_free_pages-&gt;shrink_zones-&gt;shrink_zone-&gt;shrink_inactive_list-&gt;add_to_swap-&gt;pageout-&gt;(swapper_space.a_ops-&gt;writepage)</span></div><div>&#xA0; &#xA0; &#xA0;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5757;&#x8BBE;&#x5907;&#x63A5;&#x53E3;&#xFF0C;&#x5C06;page&#x5199;&#x5230;&#x78C1;&#x76D8;&#x4EA4;&#x6362;&#x5206;&#x533A;&#x7684;swap file&#x4E0A;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;&#x6362;&#x5165;</div><div>&#xA0; &#xA0; &#xA0;&#x5F53;&#x5F15;&#x53D1;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x5185;&#x6838;&#x8C03;&#x7528;handle_pte_fault&#xFF0C;&#x5F53;&#x68C0;&#x6D4B;&#x5230;</div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;!pte_present(entry) &lt;=&gt; (pte_val(pte) &amp; L_PTE_PRESENT == 0)</div><div>&#xA0; &#xA0; &#xA0;&#x6B64;&#x65F6;&#x4F1A;&#x8C03;&#x7528;do_swap_page-&gt;read_swap_cache_async-&gt;swap_readpage&#x6765;&#x8BFB;&#x5165;&#x6362;&#x51FA;&#x7684;&#x9875;&#x6570;&#x636E;&#x5230;&#x65B0;&#x7684;&#x4E00;&#x9875;&#xFF0C;&#x539F;&#x5148;&#x7684;&#x9875;&#x9762;&#x4F1A;&#x91CA;&#x653E;&#x6210;hot page&#x5230;&#x4F19;&#x4F34;&#x7CFB;&#x7EDF;&#x3002;</div><div><br></div><div>2.swap&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;</div><div>&#xA0; &#xA0; &#xA0;swap&#x5C31;&#x662F;&#x4EA4;&#x6362;&#xFF0C;&#x6BCF;&#x6B21;&#x9700;&#x8981;&#x4EA4;&#x6362;&#x54EA;&#x4E9B;&#xFF0C;&#x548C;linux&#x7684;&#x9875;&#x56DE;&#x6536;&#x673A;&#x5236;&#x4E5F;&#x5C31;&#x662F;&#x8457;&#x540D;&#x7684;LRU&#x7B97;&#x6CD5;&#xFF0C;&#x6709;&#x4E9B;&#x76F8;&#x4F3C;&#x3002;&#x5F7C;&#x662F;&#x51B3;&#x5B9A;&#x8981;&#x56DE;&#x6536;&#x54EA;&#x4E9B;&#x3002;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x4E5F;&#x63D0;&#x5230;&#x8FC7;LRU&#x8FD9;&#x4E2A;&#x540D;&#x8BCD;&#x3002;&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x4ED6;&#x5230;&#x5E95;&#x662F;&#x4E00;&#x4E2A;&#x4EC0;&#x4E48;&#x6837;&#x7684;&#x7B97;&#x6CD5;&#x4E86;&#x3002;LRU = Least Recently Used&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;<a href=\"http://blog.csdn.net/antfang/article/details/5751786\">LRU&#x7B97;&#x6CD5;</a>&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#x5BF9;&#x4E8E;&#x4EA4;&#x6362;&#x7B97;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x9875;&#x9762;&#x7684;&#x65B0;&#x65E7;&#x7A0B;&#x5EA6;&#x4E0D;&#x9700;&#x8981;&#x5F04;&#x7684;&#x90A3;&#x4E48;&#x6E05;&#x695A;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x77E5;&#x9053;&#x6709;&#x4E24;&#x4E2A;list&#xFF1A;active_list &amp; inactive_list&#x3002;&#x6BCF;&#x6B21;try_to_free_pages&#x5728;&#x4EA4;&#x6362;&#x65F6;&#xFF0C;&#x5C06;active page&#x653E;&#x4E00;&#x90E8;&#x5206;&#x5230;inactive list&#xFF0C;&#x518D;&#x5C06;inactive page&#x91CA;&#x653E;&#x4E00;&#x90E8;&#x5206;&#x5230;&#x78C1;&#x76D8;&#x4E0A;&#x3002;&#x5176;&#x6838;&#x5FC3;&#x51FD;&#x6570;&#x5C31;&#x662F;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x7684;shrink_zone&#x3002;</div><div>&#xA0; &#xA0; &#xA0;1&#xFF09;&#x9996;&#x5148;&#x6765;&#x770B;try_to_free_pages</div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;for (priority = DEF_PRIORITY; priority &gt;= 0; priority--) {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x2026;&#x2026;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;nr_reclaimed += shrink_zones(priority, zones, &amp;sc);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;shrink_slab(sc.nr_scanned, gfp_mask, lru_pages);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x2026;&#x2026;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; }</font></div><div>&#xA0; &#xA0; &#xA0;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;priority&#x7684;&#x673A;&#x5236;&#x3002;&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x4F18;&#x5148;&#x7EA7;&#x673A;&#x5236;&#xFF0C;&#x53EA;&#x662F;&#x6BCF;&#x6B21;&#x5C3D;&#x91CF;&#x5C11;&#x7684;&#x626B;&#x63CF;&#x9875;&#x9762;&#xFF0C;&#x4EE5;&#x4FDD;&#x8BC1;&#x901F;&#x7387;&#x3002;&#x5230;shrink_zone&#x91CC;&#x9762;&#x6709;&#xFF1A;</div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <font color=\"#2D4FC9\">zone-&gt;nr_scan_active +=</font></font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;(zone_page_state(zone, NR_ACTIVE) &gt;&gt; priority) + 1;</font></div><div>&#xA0; &#xA0; &#xA0;&#x8FD9;&#x4E00;&#x6BB5;&#x6211;&#x4E00;&#x5EA6;&#x770B;&#x4E86;&#x597D;&#x4E45;&#xFF0C;&#x5176;&#x5B9E;&#x4E0D;&#x8981;&#x8003;&#x8651;&#x7684;&#x90A3;&#x4E48;&#x6B7B;&#x3002;&#x4ED6;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x4E00;&#x6B65;&#x6B65;&#x589E;&#x52A0;&#x626B;&#x63CF;&#x9875;&#x9762;&#x7684;&#x6570;&#x91CF;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x5F53;<span style=\"font-family: &apos;Courier New&apos;;\">priority</span><span style=\"font-family: &apos;Courier New&apos;;\">&#xA0;= 12~1&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x626B;&#x63CF;&#x6570;&#x91CF;&#x6BCF;&#x6B21;&#x589E;&#x52A0;zone-&gt;nr_active/(2^priority)&#x4E2A;&#x9875;&#x9762;&#x3002;&#x5982;&#x679C;&#x5230;</span><span style=\"font-family: &apos;Courier New&apos;;\">priority</span><span style=\"font-family: &apos;Courier New&apos;;\">&#xA0;=1&#x7684;&#x65F6;&#x5019;&#xFF0C;</span>nr_scan_active&#x4ECD;&#x7136;&#x6CA1;&#x8FBE;&#x5230;sc-&gt;swap_cluster_max&#xFF08;32&#xFF09;&#x7684;&#x8BDD;&#xFF0C;&#x5373;scan&#x7684;&#x603B;&#x6570;&#x7684;&#x7406;&#x8BBA;&#x503C;&#x4E3A;zone-&gt;nr_active*(1-1/(2^12))&#xFF0C;&#x5219;priority=0&#xFF0C;&#x6B64;&#x65F6;scan&#x603B;&#x6570;&#x5C06;&#x8D85;&#x8FC7;zone-&gt;nr_active&#x7684;&#x603B;&#x6570;&#x3002;&#x90A3;&#x662F;&#x4E0D;&#x662F;&#x5C31;&#x6709;&#x95EE;&#x9898;&#x4E86;&#x5462;&#xFF1F;&#x5F53;&#x7136;&#x4E0D;&#x662F;&#xFF0C;&#x56E0;&#x4E3A;&#x540E;&#x9762;&#x518D;&#x505A;&#x9875;&#x9762;&#x8F6C;&#x79FB;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x68C0;&#x6D4B;&#x6807;&#x51C6;&#x662F;list_empty&#xFF0C;&#x4E0D;&#x4F1A;&#x64CD;&#x4F5C;&#x8D85;&#x8FC7;&#x5217;&#x8868;&#x8303;&#x56F4;&#x7684;&#x9875;&#x9762;&#x7684;&#x3002;</div><div><br></div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;shrink_zone</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<font color=\"#41AD1C\" face=\"Courier New\">/* &#x6839;&#x636E;priority&#x6765;&#x51B3;&#x5B9A;&#x626B;&#x63CF;&#x9875;&#x9762;&#x7684;&#x6570;&#x91CF;&#xFF0C;inactive&#x7684;&#x6570;&#x91CF;&#x91C7;&#x7528;&#x540C;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x83B7;&#x5F97;</font></div><div><font color=\"#41AD1C\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0;* &#x81F3;&#x5C11;&#x8981;&#x4FDD;&#x8BC1;sc-&gt;swap_cluster_max&#x4E2A;&#x9875;&#x9762;&#xFF0C;&#x5373;32&#x4E2A;&#x9875;&#x9762;</font></div><div><font color=\"#41AD1C\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0;*/</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">918&#xA0;&#xA0;&#xA0;&#xA0; zone-&gt;nr_scan_active +=<br>919&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; (zone_page_state(zone, NR_ACTIVE) &gt;&gt; priority) + 1;<br>920&#xA0;&#xA0;&#xA0;&#xA0; nr_active = zone-&gt;nr_scan_active;<br>921&#xA0;&#xA0;&#xA0;&#xA0; if (nr_active &gt;= sc-&gt;swap_cluster_max)<br>922&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; zone-&gt;nr_scan_active = 0;<br>923&#xA0;&#xA0;&#xA0;&#xA0; else<br>924&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; nr_active = 0;<br>925<br></font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font color=\"#2D4FC9\" face=\"Courier New\">&#x2026;&#x2026;<br>933</font>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<font color=\"#41AD1C\"><span style=\"font-family: &apos;Courier New&apos;;\">//&#xA0;</span><span style=\"font-family: &apos;Courier New&apos;;\">nr_active: &#x4ECE;active&#x8F6C;&#x5230;inactive&#x5217;&#x8868;&#x4E0A;&#x7684;&#x9875;&#x9762;&#x6570;</span></font></div><div><font color=\"#41AD1C\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &apos;Courier New&apos;;\">//&#xA0;</span><span style=\"font-family: &apos;Courier New&apos;;\">nr_inactive: &#x4ECE;inactive&#x5217;&#x8868;&#x6362;&#x51FA;&#x5230;&#x78C1;&#x76D8;&#x7684;&#x9875;&#x9762;&#x6570;</span></font><br><font color=\"#2D4FC9\" face=\"Courier New\">934&#xA0;&#xA0;&#xA0;&#xA0; while (nr_active || nr_inactive) {<br>935&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (nr_active) {<br>936&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; nr_to_scan = min(nr_active,<br>937&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; (unsigned long)sc-&gt;swap_cluster_max);<br>938&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; nr_active -= nr_to_scan;<br></font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">939&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; shrink_active_list(nr_to_scan, zone, sc, priority);<br>940&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }<br>941<br>942&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (nr_inactive) {<br>943&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; nr_to_scan = min(nr_inactive,<br>944&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; (unsigned long)sc-&gt;swap_cluster_max);<br>945&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; nr_inactive -= nr_to_scan;<br>946&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; nr_reclaimed += shrink_inactive_list(nr_to_scan, zone,<br>947&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; sc);<br>948&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }<br>949&#xA0;&#xA0;&#xA0;&#xA0; }</font><br></div><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div>&#xA0; &#xA0; &#xA0;3&#xFF09;shrink_inactive_list</div><div>&#xA0; &#xA0; &#xA0;&#x7ECF;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x5176;&#x5B9E;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;shrink_inactive_list&#x8981;&#x505A;&#x7684;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#xFF0C;&#x626B;&#x63CF;&#x4F20;&#x5165;&#x7684;nr_to_scan&#x9875;&#x9762;&#xFF0C;&#x518D;&#x5C06;&#x5408;&#x9002;&#x7684;&#x9875;&#x9762;&#x6362;&#x51FA;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x6362;&#x51FA;&#x7684;&#x9875;&#x9762;&#x6570;&#x3002;&#x5176;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</div><div><img class=\"enMedia\" src=\"/images/swap cache/1537085027008\" hash=\"0d7d10ac0843681ee240a2949d8e2eef\" align alt longdesc width=\"768\" height=\"306\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;&#x662F;&#x4E0D;&#x662F;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x6CA1;&#x9519;&#xFF0C;&#x5C31;&#x662F;&#x8FD9;&#x4E48;&#x7B80;&#x5355;&#x3002;isolate_lru_pages&#x8D1F;&#x8D23;&#x626B;&#x63CF;&#x9875;&#x9762;&#x7684;struct page&#x7ED3;&#x6784;&#xFF0C;&#x6839;&#x636E;&#x5176;flags&#x6765;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x6362;&#x51FA;&#xFF0C;&#x53EF;&#x4EE5;&#x6362;&#x51FA;&#x7684;&#x653E;&#x5230;&#x8F93;&#x51FA;&#x5217;&#x8868;&#x4E0A;&#xFF0C;&#x4EE5;&#x5907;shrink_page_list&#x6765;&#x505A;&#x771F;&#x6B63;&#x7684;&#x6362;&#x51FA;&#x3002;</div><div><br></div><div>&#xA0; &#xA0; &#xA0;4&#xFF09;shrink_page_list</div><div>&#xA0; &#xA0; &#xA0;&#x5176;&#x4E3B;&#x7EBF;&#x5982;&#x4E0B;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;<img class=\"enMedia\" src=\"/images/swap cache/1537085027018\" hash=\"16f5dc62bc972f71ccf3912bd9d6bff5\" align alt longdesc width=\"584\" height=\"782\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;&#x7ECF;&#x8FC7;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x5224;&#x65AD;&#x540E;&#xFF0C;&#x5C06;&#x9875;&#x9762;&#x6362;&#x51FA;&#xFF0C;&#x5E76;&#x4E14;&#x7528;__pagevec_release_nonlru(&amp;freed_pvec)&#x5C06;&#x9875;&#x9762;&#x91CA;&#x653E;&#x56DE;buddy system&#xFF0C;&#x6CE8;&#x610F;&#x5728;&#x521B;&#x5EFA;freed_pvec&#x65F6;&#xFF0C;&#x6307;&#x5B9A;&#x4E86;&#x9875;&#x9762;&#x7684;&#x5C5E;&#x6027;&#x4E3A;cold&#x3002;&#x6574;&#x4E2A;&#x7B97;&#x6CD5;&#x7684;&#x7CBE;&#x9AD3;&#xFF0C;&#x5728;&#x4E8E;&#x54EA;&#x4E9B;inactive&#x7684;&#x9875;&#x9762;&#x4E0D;&#x53EF;&#x4EE5;&#x6362;&#x51FA;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#x5148;&#x770B;&#xFF0C;shrink_page_list&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x6807;&#x53F7;</div><div>keep&#xFF1A;&#x76F4;&#x63A5;&#x5C06;&#x9875;&#x9762;add&#x56DE;page_list</div><div>keep_locked&#xFF1A;&#x6307;&#x8BE5;&#x9875;&#x9762;&#x5DF2;&#x7ECF;&#x88AB;lock&#x4E86;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x89E3;&#x9501;&#x518D;&#x8FDB;&#x5165;keep&#x6807;&#x53F7;</div><div>activate_locked&#xFF1A;&#x5C06;&#x9875;&#x9762;&#x6FC0;&#x6D3B;&#xFF0C;&#x518D;&#x653E;&#x56DE;page_list&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;&#x540E;&#x7EED;&#xFF0C;&#x8BE5;&#x9875;&#x9762;&#x4F1A;&#x88AB;&#x653E;&#x5165;active list</div><div>free_it&#xFF1A;&#x8FD9;&#x4E2A;&#x662F;&#x6B63;&#x5E38;&#x6D41;&#x7A0B;&#xFF0C;&#x9875;&#x9762;&#x4F1A;&#x88AB;&#x91CA;&#x653E;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;&#x626B;&#x63CF;&#x4E0B;&#x4E00;&#x4E2A;&#x9875;&#x9762;</div><div>&#xA0; &#xA0; &#xA0;&#x6240;&#x4EE5;&#x4EE3;&#x7801;&#x4E2D;&#xFF0C;&#x51E1;&#x662F;&#x7ECF;&#x8FC7;&#x5224;&#x65AD;&#x540E;&#xFF0C;&#x8981;&#x8C03;&#x8F6C;&#x5230;&#x4EE5;&#x4E0A;&#x524D;&#x4E09;&#x4E2A;&#x6807;&#x53F7;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x90A3;&#x4E9B;&#x9875;&#x9762;&#x90FD;&#x662F;&#x4E0D;&#x4F1A;&#x88AB;&#x6362;&#x51FA;&#x91CA;&#x653E;&#x7684;&#x3002;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;&#x6709;&#x4EE5;&#x4E0B;&#x8FD9;&#x4E9B;&#x60C5;&#x51B5;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;a.&#xA0;!sc-&gt;may_swap &amp;&amp; page_mapped(page)</div><div>&#xA0; &#xA0; &#xA0;b.&#xA0;PageWriteback(page)</div><div>&#xA0; &#xA0; &#xA0;c.&#xA0;PageDirty(page) &amp;&amp;&#xA0;page_referenced(page, 1)</div><div>&#xA0; &#xA0; &#xA0;d.&#xA0;PageDirty(page) &amp;&amp;&#xA0;!may_enter_fs</div><div>&#xA0; &#xA0; &#xA0;e.&#xA0;PageDirty(page) &amp;&amp;&#xA0;!sc-&gt;may_writepage</div><div>&#xA0; &#xA0; &#xA0;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x8FD9;&#x4E2A;&#x94FE;&#x63A5;<a href=\"https://www.google.com.hk/url?sa=t&amp;amp;rct=j&amp;amp;q=&amp;amp;esrc=s&amp;amp;source=web&amp;amp;cd=2&amp;amp;ved=0CD4QFjAB&amp;amp;url=%68%74%74%70%3a%2f%2f%77%77%77%2e%34%75%63%6f%64%65%2e%63%6f%6d%2f%53%74%75%64%79%2f%54%6f%70%69%63%2f%31%34%37%33%37%35%34&amp;amp;ei=uoIkUcrgKIiuiQeZ8YDoCA&amp;amp;usg=AFQjCNEOl8IlmiO6gZG3632d58gOlDaxkA&amp;amp;sig2=7PgH7HVDHgF5OF-ko0qESA\" target=\"_blank\">Linux&#x8FDB;&#x7A0B;&#x8C03;&#x5EA6;&#x5207;&#x6362;&#x548C;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#x7BA1;&#x7406;&#x6DF1;&#x5165;&#x5206;&#x6790;</a></div><div>&#xA0; &#xA0; &#xA0;&#x4EE3;&#x7801;&#x4E2D;&#x591A;&#x4E2A;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x6D89;&#x53CA;&#x5230;page-&gt;mapping&#x6210;&#x5458;&#xFF0C;&#x4F8B;&#x5982;page_mapping, page_mapped&#x3002;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x6210;&#x5458;&#xFF0C;&#x5176;&#x53D6;&#x503C;&#x6709;&#x4EE5;&#x4E0B;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x8FD9;&#x4E2A;&#x94FE;&#x63A5;<a href=\"http://blog.chinaunix.net/uid-24517893-id-404640.html\">Linux&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x4E2D;address_space&#x7591;&#x60D1;&#x53CA;&#x89E3;&#x7B54;</a><span>&#xA0;</span></div><div><span>&#xFF08;1&#xFF09;swapper_space&#xFF1A;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span>&#x5982;&#x679C;page-&gt;mapping&#x7B49;&#x4E8E;0&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;&#x9875;&#x5C5E;&#x4E8E;&#x4EA4;&#x6362;&#x544A;&#x8BC9;&#x7F13;&#x5B58;swap cache</span><br><span>&#xFF08;2&#xFF09;anon_vma&#xFF1A;&#xA0;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span>&#x5982;&#x679C;page-&gt;mapping&#x4E0D;&#x7B49;&#x4E8E;0&#xFF0C;&#x4F46;&#x7B2C;0&#x4F4D;&#x4E3A;0&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;&#x9875;&#x4E3A;&#x533F;&#x540D;&#x4E5F;&#xFF0C;&#x6B64;&#x65F6;mapping&#x6307;&#x5411;&#x4E00;&#x4E2A;struct anon_vma&#x7ED3;&#x6784;&#x53D8;&#x91CF;&#xFF1B;</span><br><span>&#xFF08;3&#xFF09;address_space&#xFF1A;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span>&#x5982;&#x679C;page-&gt;mapping&#x4E0D;&#x7B49;&#x4E8E;0&#xFF0C;&#x4F46;&#x7B2C;0&#x4F4D;&#x4E0D;&#x4E3A;0&#xFF0C;&#x5219;mapping&#x6307;&#x5411;&#x4E00;&#x4E2A;struct address_space&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x7ED3;&#x6784;&#x53D8;&#x91CF;&#xFF1B;</span></div><div><span><br></span></div><div>&#xA0; &#xA0; &#xA0;5&#xFF09;swap cache</div><div>&#xA0; &#xA0; &#xA0;&#x4E0A;&#x9762;&#x7B80;&#x8FF0;&#x4E86;linux&#x9875;&#x7F13;&#x51B2;&#x4EA4;&#x6362;&#x673A;&#x5236;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF0C;&#x6700;&#x540E;&#x56DE;&#x5230;swap cache&#x8FD9;&#x4E00;&#x57FA;&#x672C;&#x7ED3;&#x6784;&#x4E0A;&#x6765;&#x3002;gorman&#x7684;&#x4E66;&#x91CC;&#x9762;&#x8BB2;&#x5F97;&#x5F88;&#x6E05;&#x695A;&#x4E86;&#x3002;&#x4E0B;&#x9762;&#x505A;&#x4E00;&#x4E9B;&#x7B14;&#x8BB0;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;</div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-size: 15px;\"><i><font color=\"#FA7A00\">&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;swap cache&#x8FD9;&#x4E2A;&#x4E1C;&#x897F;&#xFF1F;</font></i></span></div><div>&#xA0; &#xA0; &#xA0;&#x56E0;&#x4E3A;A signi&#xFB01;cant number of the&#xA0;pages referenced by a process early in its life may only be used for initialization and&#xA0;then never used again. It is better to swap out those pages and create more disk</div>bu&#xFB00;ers than leave them resident and unused.<div><br></div><div>&#xA0; &#xA0; <span style=\"font-size: 15px;\"><i><font color=\"#FA7A00\">&#xA0;swap cache vs. page cache</font></i></span></div><div>&#xA0; &#xA0; &#xA0;The swap cache is purely&#xA0;conceptual because it is simply a specialization of the page cache.</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 1.&#xA0;in the swap cache rather than the page cache is&#xA0;that pages in the swap cache always use swapper space as their address space in&#xA0;page&#x2192;mapping.</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 2.&#xA0;pages are added to the swap cache&#xA0;with add_to_swap_cache(),shown in Figure 11.3, instead of add_to_page_cache().</div><div><span style=\"color: rgb(250, 122, 0); font-size: 15px;\"><font color=\"#000000\" size=\"3\"><br></font></span></div><div>&#xA0; &#xA0; &#xA0;&#x6240;&#x6709;&#x7684;swap file&#x4FE1;&#x606F;&#x90FD;&#x4FDD;&#x5B58;&#x5728;&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x4E2D;</div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;static struct swap_info_struct swap_info[MAX_SWAPFILES];</div><div>&#xA0; &#xA0; &#xA0;&#x53EF;&#x89C1;swap file&#x6700;&#x591A;&#x53EF;&#x4EE5;&#x6709;MAX_SWAPFILES&#x4E2A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;32&#x4E2A;&#x3002;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">64 struct swap_info_struct {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">65 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unsigned int flags;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">66 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kdev_t swap_device;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">67 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;spinlock_t sdev_lock;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">68 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;struct dentry * swap_file;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">69 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;struct vfsmount *swap_vfsmnt;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">70 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unsigned short * swap_map;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">71 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unsigned int lowest_bit;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">72 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unsigned int highest_bit;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">73 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unsigned int cluster_next;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">74 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unsigned int cluster_nr;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">75 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;int prio;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">76 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;int pages;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">77 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;unsigned long max;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">78 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;int next;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">79 };</font></div></blockquote>&#xA0; &#xA0; &#xA0;swap_info&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x865A;&#x62DF;&#x94FE;&#x8868;&#xFF0C;&#x6BCF;&#x4E2A;&#x6210;&#x5458;&#x7528;next&#x6307;&#x5411;&#x4E86;&#x4E0B;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#x6210;&#x5458;&#x7684;&#x7D22;&#x5F15;&#x53F7;&#x3002;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x540C;&#x65F6;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x63CF;&#x8FF0;&#x3002;&#x8FD9;&#x91CC;&#x6307;&#x660E;&#x4E86;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x7684;&#x5934;&#x5728;&#x54EA;&#x91CC;&#xFF0C;&#x5176;&#x8868;&#x5C3E;&#x6210;&#x5458;&#x7684;next = -1&#x3002;<blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">153 struct swap_list_t {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">154 &#xA0; &#xA0;&#xA0;</font><span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">int head; /* head of priority-ordered swapfile list */</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">155 &#xA0; &#xA0; int next; /* swapfile to be used next */</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">156 };</font></div></blockquote><div>&#xA0; &#xA0; &#xA0;swap area&#x7531;<span style=\"font-family: &apos;Courier New&apos;;\">swap_info_struct&#x63CF;&#x8FF0;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x52A8;&#x6001;&#x7684;&#x589E;&#x52A0;&#x3002;&#x6BCF;&#x4E00;&#x4E2A;swap area&#x6307;&#x5411;&#x4E00;&#x4E2A;swap file&#xFF0C;&#x8BE5;file&#x88AB;&#x5206;&#x5272;&#x6210;&#x82E5;&#x5E72;&#x4E2A;page size&#x7684;slot&#xFF0C;&#x7B2C;0&#x4E2A;slot&#x88AB;&#x7528;&#x6765;&#x5B58;&#x50A8;swap_header&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</span></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">25 union swap_header {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">26&#xA0;</font>&#xA0; &#xA0; &#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">struct</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">27&#xA0;</font>&#xA0; &#xA0; &#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">{</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">28&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">char reserved[PAGE_SIZE - 10];</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">29&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">char magic[10];</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">30&#xA0;</font>&#xA0; &#xA0; &#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">} magic;</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">31&#xA0;</font>&#xA0; &#xA0; &#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">struct</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">32&#xA0;</font>&#xA0; &#xA0; &#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">{</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">33&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">char bootbits[1024];</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">34&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">unsigned int version;</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">35&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">unsigned int last_page;</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">36&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">unsigned int nr_badpages;</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">37&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">unsigned int padding[125];</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">38&#xA0;</font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">unsigned int badpages[1];</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">39&#xA0;</font>&#xA0; &#xA0; &#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">} info;</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">40 };</font></div></blockquote><div>&#xA0; &#xA0; &#xA0;&#x6DFB;&#x52A0;<span style=\"font-family: &apos;Courier New&apos;;\">padding&#x662F;&#x4E3A;&#x4E86;&#x80FD;&#x548C;&#x78C1;&#x76D8;&#x7684;cluster&#x5BF9;&#x9F50;&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">badpages&#x6570;&#x7EC4;&#x9650;&#x5236;&#x4E86;&#x4E00;&#x4E2A;swap area&#x7684;&#x9875;&#x6570;&#xFF0C;&#x5176;&#x5C3A;&#x5BF8;&#x7531;&#x4E0B;&#x9762;&#x7684;&#x516C;&#x5F0F;&#x5F97;&#x5230;&#x3002;&#x6BCF;&#x4E2A;&#x6210;&#x5458;&#x6307;&#x5411;&#x4E86;&#x4E00;&#x4E2A;page&#x7ED3;&#x6784;&#x4F53;&#x3002;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/swap cache/1537085027013\" hash=\"14fe0b7c21d8c7aa9f25c571de57b141\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;swap cache&#x6700;&#x6838;&#x5FC3;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x662F;&#x4E00;&#x4E2A;&#x53EB;&#x505A;swp_entry_t&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x5B9E;&#x4ED6;&#x5C31;&#x662F;&#x4E00;&#x4E2A;unsigned long&#x3002;&#x5F53;&#x9875;&#x9762;&#x88AB;&#x6362;&#x51FA;&#x65F6;&#xFF0C;&#x5176;&#x539F;&#x5148;&#x7684;&#x9875;&#x8868;&#x9879;pte&#x88AB;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x8FD9;&#x4E2A;&#x503C;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;swp_entry_t&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B9A;&#x4F4D;&#x5230;&#x8BE5;&#x9875;&#x6570;&#x636E;&#x88AB;&#x5199;&#x5230;&#x54EA;&#x4E2A;swap area&#x7684;&#x54EA;&#x4E2A;&#x4F4D;&#x7F6E;&#x3002;&#x5176;&#x7EC4;&#x6210;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</div><div><img class=\"enMedia\" src=\"/images/swap cache/1537085027021\" hash=\"bf705025623bd89201ec33f566eb4063\" align alt longdesc width=\"701\" height=\"306\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;Type&#x6307;&#x5F15;&#x4E86;&#x54EA;&#x4E2A;swap area&#xFF0C;offset&#x6307;&#x5F15;&#x4E86;&#x8BE5;&#x9875;&#x5728;swap_map&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6539;offset&#x7B97;&#x5F97;swap file&#x4E2D;&#x7684;sector&#x4F4D;&#x7F6E;&#x3002;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x4E0B;&#x9762;&#x7684;&#x51FD;&#x6570;</div><div>&#xA0; &#xA0; &#xA0;(swapper_space.a_ops-&gt;swap_writepage) -&gt;&#xA0;get_swap_bio -&gt;&#xA0;map_swap_page</div><div><br></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">938&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;for ( ; ; ) {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">939&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; struct list_head *lh;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">940</font>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <font color=\"#41AD1C\" face=\"Courier New\">/*&#x4E00;&#x76F4;&#x5FAA;&#x73AF;&#x5230;offset&#x843D;&#x5728;&#x8BE5;sector&#x4E2D;*/</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">941&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (se-&gt;start_page &lt;= offset &amp;&amp;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">942&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; offset &lt; (se-&gt;start_page + se-&gt;nr_pages)) {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">943&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return se-&gt;start_block + (offset - se-&gt;start_page);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">944&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">945&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; lh = se-&gt;list.next;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">946&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (lh == &amp;sis-&gt;extent_list)</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">947&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; lh = lh-&gt;next;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">948&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; se = list_entry(lh, struct swap_extent, list);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">949&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; sis-&gt;curr_swap_extent = se;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">951&#xA0;&#xA0;&#xA0;&#xA0; }</font></div></blockquote><div><font color=\"#2D4FC9\" face=\"Courier New\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></font></div>&#xA0; &#xA0; &#xA0;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;swap_entry_t&#x662F;&#x600E;&#x4E48;&#x6765;&#x7684;&#xFF1F;&#x5176;&#x5B9E;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x5728;swap_map&#x6570;&#x7EC4;&#x4E2D;&#x6328;&#x4E2A;&#x627E;&#xFF0C;first fit&#x6CD5;&#x3002;&#x5F53;&#x7136;&#x5177;&#x4F53;&#x8FD8;&#x6709;&#x4E9B;&#x6280;&#x5DE7;&#xFF0C;&#x5176;&#x5B9E;&#x5728;&#x641C;&#x7D22;&#x65F6;&#xFF0C;&#x662F;&#x6309;&#x7167;cluster&#x7684;&#x8303;&#x56F4;&#x5BFB;&#x627E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5FAA;&#x73AF;&#x76F4;&#x5230;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;cluster&#xFF08;256&#x4E2A;&#x7B49;&#x4E8E;0&#x7684;swap_map&#x6210;&#x5458;&#xFF09;&#x4E3A;&#x6B62;&#xFF0C;&#x76EE;&#x7684;&#x662F;to have pages swapped out at the same time close together on the premise that&#xA0;pages swapped out together are related&#xA0;&#x3002;<div><span style=\"font-family: song, Verdana; font-size: 14px; line-height: 22.390625px; background-color: rgb(255, 255, 255);\"><br></span></div><div><font face=\"song, Verdana\"><span style=\"font-size: 14px; line-height: 22px;\"><br></span></font></div></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%882%EF%BC%89%E2%80%94%E2%80%94_kmem_cache_create/",
            "url": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%882%EF%BC%89%E2%80%94%E2%80%94_kmem_cache_create/",
            "title": "slab allocator （2）—— kmem_cache_create",
            "date_published": "2012-12-18T12:54:16.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;slab&#x7CFB;&#x7EDF;&#x7684;&#x6838;&#x5FC3;&#x51FD;&#x6570;&#x4E4B;&#x4E00;&#xFF0C;&#x4ED6;&#x662F;kmalloc&#x7684;&#x540E;&#x76FE;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F5C;&#x4E3A;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x4F9B;&#x9A71;&#x52A8;&#x8C03;&#x7528;&#x3002;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x770B;ldd3&#x7684;chp 8&#x7684;&#x540E;&#x5907;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x4E00;&#x8282;&#xFF08;P217&#xFF09;&#x3002;&#x4ED6;&#x5176;&#x5B9E;&#x548C;&#x6211;&#x4EEC;CPU&#x7684;L1&#xFF0C;L2&#x7F13;&#x5B58;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#x3002;&#x4ED6;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E;&#x5185;&#x5B58;&#x6C60;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x4E2D;&#x5206;&#x914D;&#x82E5;&#x5E72;&#x4E2A;size&#x76F8;&#x540C;&#x7684;&#x5185;&#x5B58;&#x5757;&#x4F7F;&#x7528;&#x3002;<div><br></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5176;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x4E3B;&#x7EBF;&#x5982;&#x4E0B;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1537085030569\" hash=\"7c2730c8cad130f3604736abf0582ab5\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x4E3B;&#x7EBF;&#x8FD8;&#x662F;&#x5F88;&#x6E05;&#x695A;&#x7684;&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7;kmem_cache_zalloc&#x5206;&#x914D;kmem_cache&#xFF0C;&#x7136;&#x540E;&#x5404;&#x79CD;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x6700;&#x540E;&#x52A0;&#x5165;cache_chain&#x4E2D;&#x3002;&#x4E4B;&#x524D;&#x4E0D;&#x6E05;&#x695A;&#x7684;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x2014;&#x2014;cache_chain&#x662F;&#x505A;&#x4EC0;&#x4E48;&#x7528;&#x7684;&#xFF0C;&#x73B0;&#x5728;&#x770B;&#x8D77;&#x6765;&#x5E94;&#x8BE5;&#x662F;&#x6709;&#x7B54;&#x6848;&#x4E86;&#x3002;&#x4ED6;&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x4FDD;&#x5B58;&#x5DF2;&#x5206;&#x914D;&#x7684;kmem_cache&#x8BB0;&#x5F55;&#xFF0C;&#x9632;&#x6B62;&#x91CD;&#x540D;&#x7684;cache&#x4EA7;&#x751F;&#xFF0C;&#x65B9;&#x4FBF;proc&#x7CFB;&#x7EDF;&#x663E;&#x793A;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x5730;&#x65B9;</div><div><br></div><div>1. kmem_cache&#x7684;&#x521D;&#x59CB;&#x5316;</div><div>&#xA0; &#xA0; &#xA0;1&#xFF09;&#x5F53;size &gt;= (PAGE_SIZE &gt;&gt; 3 = 512KB&#x65F6;&#xFF0C;flags |= CFLGS_OFF_SLAB</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;calculate_slab_order(cachep, size, align, flags)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1537085030564\" hash=\"10a4a7586d7d29b19d2e2a600adc2ef0\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x6240;&#x8C13;&#x7684;num&#x4E0E;offslab_limit&#x5C31;&#x662F;&#x4E0B;&#x9762;off-slab&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7531;&#x6574;&#x5757;2^order&#x4E2A;&#x9875;&#x9762;&#x51B3;&#x5B9A;&#x7684;object&#x6570;(num)&#xFF0C;&#x548C;&#x53F3;&#x8FB9;kmem_bufctl_t&#x6570;&#x7EC4;&#x51B3;&#x5B9A;&#x7684;object&#x6570;(offslab_limit)&#x3002;&#x53EF;&#x89C1;&#x6709;&#x4E00;&#x4E2A;&#x7EA6;&#x675F;&#x5C31;&#x662F;&#xFF0C;num&#x8981;&#x5C0F;&#x4E8E;offslab_limit&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5DE6;&#x8FB9;&#x5C0F;&#x4E8E;&#x53F3;&#x8FB9;&#x3002;&#x5F88;&#x597D;&#x7406;&#x89E3;&#xFF0C;&#x56E0;&#x4E3A;&#x53F3;&#x8FB9;&#x662F;&#x5DE6;&#x8FB9;&#x7684;&#x7BA1;&#x63A7;&#x3002;</div><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1537085030571\" hash=\"a6edb8ef026079cb61b86575d2695089\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 3&#xFF09;&#x5982;&#x679C;left_over&#x592A;&#x591A;&#xFF0C;&#x8DB3;&#x591F;&#x653E;&#x5F97;&#x4E0B;slab_size&#xFF0C;&#x4F1A;&#x5C06;off-slab&#x8F6C;&#x53D8;&#x4E3A;on-slab</div><div>2. off-slab&#x65F6;&#xFF0C;slab mngmt&#x653E;&#x5728;&#x54EA;</div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x8C03;&#x7528;cachep-&gt;slabp_cache = kmem_find_general_cachep(slab_size, 0u)&#xFF0C;&#x53BB;&#x5BFB;&#x627E;&#x8FD9;&#x4E2A;size cache&#x6765;&#x5B58;&#x653E;slab mngmt&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kmem_find_general_cachep -&gt;&#xA0;__find_general_cachep -&gt; (return malloc_sizes[n]-&gt;cs_cachep)</div><div><br></div><div>3. CPU cache&#x7684;&#x521D;&#x59CB;&#x5316;</div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;setup_cpu_cache(cachep, gfp)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x590D;&#x6742;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5148;&#x770B;&#x8C03;&#x7528;&#x6D41;&#x7A0B;</div><div><br></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1537085030566\" hash=\"5fac5be0e836af7f4e8bf4ff71375b8d\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x6839;&#x636E;g_cpucache_up&#x5206;&#x6210;&#x4E09;&#x4E2A;&#x90E8;&#x5206;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 1&#xFF09;FULL&#x72B6;&#x6001;&#xFF0C;&#x6B64;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x7684;cache&#x521D;&#x59CB;&#x5316;&#x90FD;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;setup_cpu_cache&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;enable_cpucache&#x3002;&#x8FD9;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x590D;&#x6742;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x518D;&#x53E6;&#x5F00;&#x65B0;&#x7BC7;&#x4ECB;&#x7ECD;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 2&#xFF09;PARTIAL_AC/L3&#x72B6;&#x6001;&#xFF0C;&#x6B64;&#x65F6;&#x8C03;&#x7528;&#x6B64;&#x51FD;&#x6570;&#x7684;kmem_cache_create&#x4ECD;&#x5728;kmem_cache_init&#x4E2D;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x624D;&#x521A;&#x5F00;&#x59CB;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x5BF9;struct arracy_cache&#x548C;kmem_list3s&#x7528;&#x5230;&#x7684;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x5426;&#x5219;&#x5176;&#x4ED6;cache&#x5728;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x65E0;&#x6CD5;&#x52A8;&#x6001;&#x5730;&#x4E3A;&#x8FD9;&#x4E24;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x5206;&#x914D;&#x5185;&#x5B58;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 3&#xFF09;&#x5269;&#x4E0B;&#x7684;&#x5C31;&#x662F;&#xFF0C;AC&#x548C;L3&#x90FD;&#x5206;&#x914D;&#x597D;&#x4E86;&#xFF0C;&#x5176;&#x4ED6;&#x7684;cache&#x518D;create&#x5C31;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x7684;&#x8C03;&#x7528;kmalloc&#x4E86;</div><div><br></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; INDEX_AC&#x7684;array_cache&#x521D;&#x59CB;&#x5316;&#x662F;initarray_generic.cache</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; INDEX_AC / L3&#x7684;kmem_list3&#x521D;&#x59CB;&#x5316;&#x662F;initkmem_list3[SIZE_AC / L3]</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; cache_cache&#x7684;array_cache&#x521D;&#x59CB;&#x5316;&#x662F;initarray_cache&#xFF0C;kmem_list3&#x521D;&#x59CB;&#x5316;&#x662F;initkmem_list3[CACHE_CACHE]</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x4E9B;&#x5728;kmem_cache_init&#x7684;step 4,5&#x90FD;&#x4F1A;&#x88AB;&#x91CD;&#x65B0;&#x7528;kmalloc&#x8FDB;&#x884C;&#x52A8;&#x6001;&#x5206;&#x914D;&#xFF0C;&#x5E76;&#x4E14;array_cache&#x4F1A;&#x7528;memcpy&#x5C06;&#x539F;&#x5148;&#x503C;&#x8D4B;&#x5165;&#xFF0C;list&#x4F1A;&#x7528;splice&#x8FDB;&#x884C;&#x5408;&#x5E76;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%882%EF%BC%89-_kmem_cache_create/",
            "url": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%882%EF%BC%89-_kmem_cache_create/",
            "title": "slab allocator （2）—— kmem_cache_create",
            "date_published": "2012-12-18T12:54:16.000Z",
            "content_html": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE en-note SYSTEM \"http://xml.evernote.com/pub/enml2.dtd\"><div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; display: block;\" title lang xml:lang dir>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;slab&#x7CFB;&#x7EDF;&#x7684;&#x6838;&#x5FC3;&#x51FD;&#x6570;&#x4E4B;&#x4E00;&#xFF0C;&#x4ED6;&#x662F;kmalloc&#x7684;&#x540E;&#x76FE;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F5C;&#x4E3A;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x4F9B;&#x9A71;&#x52A8;&#x8C03;&#x7528;&#x3002;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x770B;ldd3&#x7684;chp 8&#x7684;&#x540E;&#x5907;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x4E00;&#x8282;&#xFF08;P217&#xFF09;&#x3002;&#x4ED6;&#x5176;&#x5B9E;&#x548C;&#x6211;&#x4EEC;CPU&#x7684;L1&#xFF0C;L2&#x7F13;&#x5B58;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#x3002;&#x4ED6;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E;&#x5185;&#x5B58;&#x6C60;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x4E2D;&#x5206;&#x914D;&#x82E5;&#x5E72;&#x4E2A;size&#x76F8;&#x540C;&#x7684;&#x5185;&#x5B58;&#x5757;&#x4F7F;&#x7528;&#x3002;<div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5176;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x4E3B;&#x7EBF;&#x5982;&#x4E0B;&#xFF1A;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1499486796586\" hash=\"7c2730c8cad130f3604736abf0582ab5\" align alt longdesc width=\"687\" height=\"362\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x4E3B;&#x7EBF;&#x8FD8;&#x662F;&#x5F88;&#x6E05;&#x695A;&#x7684;&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7;kmem_cache_zalloc&#x5206;&#x914D;kmem_cache&#xFF0C;&#x7136;&#x540E;&#x5404;&#x79CD;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x6700;&#x540E;&#x52A0;&#x5165;cache_chain&#x4E2D;&#x3002;&#x4E4B;&#x524D;&#x4E0D;&#x6E05;&#x695A;&#x7684;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x2014;&#x2014;cache_chain&#x662F;&#x505A;&#x4EC0;&#x4E48;&#x7528;&#x7684;&#xFF0C;&#x73B0;&#x5728;&#x770B;&#x8D77;&#x6765;&#x5E94;&#x8BE5;&#x662F;&#x6709;&#x7B54;&#x6848;&#x4E86;&#x3002;&#x4ED6;&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x4FDD;&#x5B58;&#x5DF2;&#x5206;&#x914D;&#x7684;kmem_cache&#x8BB0;&#x5F55;&#xFF0C;&#x9632;&#x6B62;&#x91CD;&#x540D;&#x7684;cache&#x4EA7;&#x751F;&#xFF0C;&#x65B9;&#x4FBF;proc&#x7CFB;&#x7EDF;&#x663E;&#x793A;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x5730;&#x65B9;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">1. kmem_cache&#x7684;&#x521D;&#x59CB;&#x5316;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;1&#xFF09;&#x5F53;size &gt;= (PAGE_SIZE &gt;&gt; 3 = 512KB&#x65F6;&#xFF0C;flags |= CFLGS_OFF_SLAB</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;2&#xFF09;calculate_slab_order(cachep, size, align, flags)</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1499486796244\" hash=\"10a4a7586d7d29b19d2e2a600adc2ef0\" align alt longdesc width=\"482\" height=\"512\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x6240;&#x8C13;&#x7684;num&#x4E0E;offslab_limit&#x5C31;&#x662F;&#x4E0B;&#x9762;off-slab&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7531;&#x6574;&#x5757;2^order&#x4E2A;&#x9875;&#x9762;&#x51B3;&#x5B9A;&#x7684;object&#x6570;(num)&#xFF0C;&#x548C;&#x53F3;&#x8FB9;kmem_bufctl_t&#x6570;&#x7EC4;&#x51B3;&#x5B9A;&#x7684;object&#x6570;(offslab_limit)&#x3002;&#x53EF;&#x89C1;&#x6709;&#x4E00;&#x4E2A;&#x7EA6;&#x675F;&#x5C31;&#x662F;&#xFF0C;num&#x8981;&#x5C0F;&#x4E8E;offslab_limit&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5DE6;&#x8FB9;&#x5C0F;&#x4E8E;&#x53F3;&#x8FB9;&#x3002;&#x5F88;&#x597D;&#x7406;&#x89E3;&#xFF0C;&#x56E0;&#x4E3A;&#x53F3;&#x8FB9;&#x662F;&#x5DE6;&#x8FB9;&#x7684;&#x7BA1;&#x63A7;&#x3002;</div><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1499486796738\" hash=\"a6edb8ef026079cb61b86575d2695089\" align alt longdesc width=\"429\" height=\"212\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 3&#xFF09;&#x5982;&#x679C;left_over&#x592A;&#x591A;&#xFF0C;&#x8DB3;&#x591F;&#x653E;&#x5F97;&#x4E0B;slab_size&#xFF0C;&#x4F1A;&#x5C06;off-slab&#x8F6C;&#x53D8;&#x4E3A;on-slab</div><div style=\"display: block;\">2. off-slab&#x65F6;&#xFF0C;slab mngmt&#x653E;&#x5728;&#x54EA;</div><div style=\"display: block;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x8C03;&#x7528;cachep-&gt;slabp_cache = kmem_find_general_cachep(slab_size, 0u)&#xFF0C;&#x53BB;&#x5BFB;&#x627E;&#x8FD9;&#x4E2A;size cache&#x6765;&#x5B58;&#x653E;slab mngmt&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kmem_find_general_cachep -&gt;&#xA0;__find_general_cachep -&gt; (return malloc_sizes[n]-&gt;cs_cachep)</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">3. CPU cache&#x7684;&#x521D;&#x59CB;&#x5316;</div><div style=\"display: block;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;setup_cpu_cache(cachep, gfp)</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x590D;&#x6742;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5148;&#x770B;&#x8C03;&#x7528;&#x6D41;&#x7A0B;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create/1499486796416\" hash=\"5fac5be0e836af7f4e8bf4ff71375b8d\" align alt longdesc width=\"902\" height=\"682\" border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x6839;&#x636E;g_cpucache_up&#x5206;&#x6210;&#x4E09;&#x4E2A;&#x90E8;&#x5206;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 1&#xFF09;FULL&#x72B6;&#x6001;&#xFF0C;&#x6B64;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x7684;cache&#x521D;&#x59CB;&#x5316;&#x90FD;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;setup_cpu_cache&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;enable_cpucache&#x3002;&#x8FD9;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x590D;&#x6742;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x518D;&#x53E6;&#x5F00;&#x65B0;&#x7BC7;&#x4ECB;&#x7ECD;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 2&#xFF09;PARTIAL_AC/L3&#x72B6;&#x6001;&#xFF0C;&#x6B64;&#x65F6;&#x8C03;&#x7528;&#x6B64;&#x51FD;&#x6570;&#x7684;kmem_cache_create&#x4ECD;&#x5728;kmem_cache_init&#x4E2D;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x624D;&#x521A;&#x5F00;&#x59CB;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x5BF9;struct arracy_cache&#x548C;kmem_list3s&#x7528;&#x5230;&#x7684;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x5426;&#x5219;&#x5176;&#x4ED6;cache&#x5728;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x65E0;&#x6CD5;&#x52A8;&#x6001;&#x5730;&#x4E3A;&#x8FD9;&#x4E24;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x5206;&#x914D;&#x5185;&#x5B58;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 3&#xFF09;&#x5269;&#x4E0B;&#x7684;&#x5C31;&#x662F;&#xFF0C;AC&#x548C;L3&#x90FD;&#x5206;&#x914D;&#x597D;&#x4E86;&#xFF0C;&#x5176;&#x4ED6;&#x7684;cache&#x518D;create&#x5C31;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x7684;&#x8C03;&#x7528;kmalloc&#x4E86;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; INDEX_AC&#x7684;array_cache&#x521D;&#x59CB;&#x5316;&#x662F;initarray_generic.cache</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; INDEX_AC / L3&#x7684;kmem_list3&#x521D;&#x59CB;&#x5316;&#x662F;initkmem_list3[SIZE_AC / L3]</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; cache_cache&#x7684;array_cache&#x521D;&#x59CB;&#x5316;&#x662F;initarray_cache&#xFF0C;kmem_list3&#x521D;&#x59CB;&#x5316;&#x662F;initkmem_list3[CACHE_CACHE]</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x4E9B;&#x5728;kmem_cache_init&#x7684;step 4,5&#x90FD;&#x4F1A;&#x88AB;&#x91CD;&#x65B0;&#x7528;kmalloc&#x8FDB;&#x884C;&#x52A8;&#x6001;&#x5206;&#x914D;&#xFF0C;&#x5E76;&#x4E14;array_cache&#x4F1A;&#x7528;memcpy&#x5C06;&#x539F;&#x5148;&#x503C;&#x8D4B;&#x5165;&#xFF0C;list&#x4F1A;&#x7528;splice&#x8FDB;&#x884C;&#x5408;&#x5E76;&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%883%EF%BC%89-_array_cache/",
            "url": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%883%EF%BC%89-_array_cache/",
            "title": "slab allocator （3）—— array_cache",
            "date_published": "2012-12-18T00:39:28.000Z",
            "content_html": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE en-note SYSTEM \"http://xml.evernote.com/pub/enml2.dtd\"><div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; display: block;\" title lang xml:lang dir>array_cache&#x4E5F;&#x5C31;&#x662F;Gorman&#x4E66;&#x4E2D;&#x7684;per-CPU cache&#x3002;&#x4E66;&#x4E2D;&#x63D0;&#x5230;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x6709;&#x4E24;&#x70B9;&#x539F;&#x56E0;&#xFF1A;<div style=\"display: block;\">&#xA0; &#xA0; &#xA0;1&#xFF09;This way the&#xA0;hardware cache will be used for as long as possible on the same CPU.</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;2&#xFF09;The second major bene&#xFB01;t of this method is that spinlocks do not have to be held</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#x5148;&#x770B;&#x4E0B;kmem_cache&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;</div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">struct kmem_cache {<br>/* 1) per-cpu data, touched during every alloc/free */<br>&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache *array[NR_CPUS];<br>/* 2) Cache tunables. Protected by cache_chain_mutex */<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int batchcount;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int limit;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int shared;<br><br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int buffer_size;<br>&#xA0;&#xA0;&#xA0;&#xA0; u32 reciprocal_buffer_size;</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#x2026;&#x2026;</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;<font face=\"Courier New\">array_cache&#x662F;kmem_cache&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#xFF0C;&#x800C;&#x4E14;&#x662F;&#x9488;&#x5BF9;&#x6BCF;&#x4E2A;CPU&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x7ED3;&#x6784;&#x4E0E;&#x4E4B;&#x5BF9;&#x5E94;&#xFF0C;&#x8FD9;&#x4E5F;&#x5370;&#x8BC1;&#x4E86;&#x4E0A;&#x9762;Gorman&#x63D0;&#x5230;&#x7684;&#x4E24;&#x70B9;&#x539F;&#x56E0;&#x3002;&#x5728;&#x6BCF;&#x4E2A;kmem_cache&#x88AB;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x53BB;&#x521D;&#x59CB;&#x5316;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#xFF1A;</font></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;setup_cpu_cache -&gt; enable_cpucache -&gt;&#xA0;<span style=\"font-size: 10pt; font-family: Arial; text-indent: 0mm;\">do_tune_cpucache</span></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#x5177;&#x4F53;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;3&#xFF09;&#x2014;&#x2014; array_cache/1499486792698\" hash=\"049b0a76d483a641fc99b8981d3f1d3a\" align alt longdesc width=\"902\" height=\"536\" border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#x53EF;&#x89C1;do_tune_cpucache&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x5206;&#x914D;&#x8FD9;&#x4E2A;array_cache&#xFF0C;&#x5E76;&#x4ED8;&#x7ED9;&#x5BF9;&#x5E94;&#x7684;CPU&#x7684;&#x53D8;&#x91CF;&#x3002;&#x8FD9;&#x91CC;&#x4E0D;&#x6E05;&#x695A;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6240;&#x6709;&#x7684;online CPU&#x90FD;&#x8981;&#x5206;&#x914D;&#x4E00;&#x904D;&#xFF0C;&#x7136;&#x540E;&#x53EA;&#x53D6;&#x7528;&#x4E00;&#x4E2A;&#x5F53;&#x524D;CPU&#x7684;&#x503C;&#x3002;&#x90A3;&#x4E48;&#x600E;&#x4E48;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;array_cache&#xFF0C;&#x4F1A;&#x5728;&#x8BB2;&#x5206;&#x914D;&#x7684;&#x7B14;&#x8BB0;&#x4E2D;&#x518D;&#x505A;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x3002;&#x4E0D;&#x8FC7;&#x8FD9;&#x91CC;&#x6709;&#x4E2A;free_block&#x51FD;&#x6570;&#xFF0C;&#x9605;&#x8BFB;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x5BF9;array_cache&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x5927;&#x4F53;&#x7684;&#x4E86;&#x89E3;&#x3002;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#x5148;&#x770B;&#x6574;&#x4E2A;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#xFF1A;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;3&#xFF09;&#x2014;&#x2014; array_cache/1499486792860\" hash=\"2bff79d1ec9cde7eaa6122d0bccbeefe\" align alt longdesc width=\"999\" height=\"753\" border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;array_cache&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6B63;&#x5982;&#x4E0A;&#x56FE;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x6240;&#x663E;&#x793A;&#xFF0C;&#x9664;&#x4E86;touched&#x4E0D;&#x77E5;&#x9053;&#x6709;&#x4EC0;&#x4E48;&#x7528;&#x4E4B;&#x5916;&#xFF0C;&#x5176;&#x4ED6;&#x51E0;&#x4E2A;&#x53D8;&#x91CF;&#x7684;&#x4F5C;&#x7528;&#x8FD8;&#x662F;&#x5F88;&#x6E05;&#x6670;&#x7684;&#xFF0C;&#x4ECE;&#x540D;&#x5B57;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5F97;&#x51FA;&#x6765;&#xFF1A;</div><div style=\"display: block;\"><ul><li>avail&#xFF0C;&#x5F53;&#x524D;&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x7A7A;&#x95F2;&#x7684;&#x4F4D;&#x5B50;&#x53EF;&#x4EE5;&#x5206;&#x914D;</li><li>limit&#xFF0C;&#x81EA;&#x7136;&#x5C31;&#x662F;&#x5206;&#x914D;&#x7684;&#x4E0A;&#x9650;&#xFF0C;&#x4E4B;&#x524D;&#x4E5F;&#x8BF4;&#x8FC7;&#xFF0C;&#x5728;enable_cpucache&#x4E2D;&#x4E5F;&#x6709;&#x5B9A;&#x4E49;</li><li>batchcount&#xFF0C;linux&#x4E2D;&#x4E00;&#x822C;&#xFF0C;&#x4E00;&#x6B21;&#x64CD;&#x4F5C;&#x7684;&#x6570;&#x91CF;&#x90FD;&#x662F;&#x7528;batch&#x6765;&#x8868;&#x793A;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5C31;&#x662F;array_cache&#x5728;&#x589E;&#x957F;&#x6216;&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x4E00;&#x6B21;&#x64CD;&#x4F5C;&#x7684;object&#x6570;</li><li>entry&#xFF0C;&#x5C31;&#x662F;array_cache&#x7684;&#x6838;&#x5FC3;&#x6210;&#x5458;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;object&#x6570;&#x7EC4;</li></ul>&#xA0; &#xA0; &#xA0;&#x8FD9;&#x91CC;&#x9762;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;free_block&#x91CA;&#x653E;&#x7684;&#x662F;ccold-&gt;avail&#x4E2A;object&#xFF0C;avail&#x4E0D;&#x5E94;&#x8BE5;&#x662F;&#x672C;&#x8EAB;&#x5C31;&#x662F;free&#x7684;object&#x5417;&#xFF1F;</div><div style=\"display: block;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x7ECF;&#x8FC7;&#x9605;&#x8BFB;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x56DE;&#x7B54;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x4E86;&#xFF0C;&#x9996;&#x5148;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x90FD;&#x662F;&#x4ECE;array_cache-&gt;entry&#x6570;&#x7EC4;&#x4E2D;&#x53D6;object&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x8C03;&#x7528;&#x8005;&#xFF0C;&#x6B64;&#x65F6;avail&#x7684;object&#x4F1A;&#x88AB;&#x5206;&#x914D;&#x51FA;&#x53BB;&#xFF0C;avail&#x53D8;&#x5C11;&#x3002;&#x5F53;avail&#x4E3A;0&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4ECE;kmem_cache&#x4E2D;&#x53BB;&#x53D6;object&#xFF0C;&#x8D4B;&#x7ED9;array_cache&#xFF0C;&#x4E00;&#x6B21;&#x53D6;batchcount&#x4E2A;object&#xFF0C;&#x8FD9;&#x65F6;avail&#x5C31;&#x4F1A;&#x589E;&#x52A0;&#xFF0C;&#x800C;kmem_list3-&gt;free_objects&#x5C31;&#x4F1A;&#x51CF;&#x5C11;&#x76F8;&#x5E94;&#x7684;&#x6570;&#x76EE;&#x3002;&#x800C;kmem_list3-&gt;free_objects&#x4F1A;&#x5728;cache_grow&#x65F6;&#x9012;&#x589E;cachep-&gt;num&#x3002;</div><div style=\"display: block;\"><br></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%883%EF%BC%89%E2%80%94%E2%80%94_array_cache/",
            "url": "https://blog.zhougy.top/2012/12/18/slab_allocator_%EF%BC%883%EF%BC%89%E2%80%94%E2%80%94_array_cache/",
            "title": "slab allocator （3）—— array_cache",
            "date_published": "2012-12-18T00:39:28.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir>array_cache&#x4E5F;&#x5C31;&#x662F;Gorman&#x4E66;&#x4E2D;&#x7684;per-CPU cache&#x3002;&#x4E66;&#x4E2D;&#x63D0;&#x5230;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x6709;&#x4E24;&#x70B9;&#x539F;&#x56E0;&#xFF1A;<div>&#xA0; &#xA0; &#xA0;1&#xFF09;This way the&#xA0;hardware cache will be used for as long as possible on the same CPU.</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;The second major bene&#xFB01;t of this method is that spinlocks do not have to be held</div><div><br></div><div>&#x5148;&#x770B;&#x4E0B;kmem_cache&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;</div><div><font color=\"#2D4FC9\" face=\"Courier New\">struct kmem_cache {<br>/* 1) per-cpu data, touched during every alloc/free */<br>&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache *array[NR_CPUS];<br>/* 2) Cache tunables. Protected by cache_chain_mutex */<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int batchcount;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int limit;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int shared;<br><br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned int buffer_size;<br>&#xA0;&#xA0;&#xA0;&#xA0; u32 reciprocal_buffer_size;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#x2026;&#x2026;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">}</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div>&#xA0; &#xA0; &#xA0;<font face=\"Courier New\">array_cache&#x662F;kmem_cache&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#xFF0C;&#x800C;&#x4E14;&#x662F;&#x9488;&#x5BF9;&#x6BCF;&#x4E2A;CPU&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x7ED3;&#x6784;&#x4E0E;&#x4E4B;&#x5BF9;&#x5E94;&#xFF0C;&#x8FD9;&#x4E5F;&#x5370;&#x8BC1;&#x4E86;&#x4E0A;&#x9762;Gorman&#x63D0;&#x5230;&#x7684;&#x4E24;&#x70B9;&#x539F;&#x56E0;&#x3002;&#x5728;&#x6BCF;&#x4E2A;kmem_cache&#x88AB;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x53BB;&#x521D;&#x59CB;&#x5316;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#xFF1A;</font></div><div>&#xA0; &#xA0; &#xA0;setup_cpu_cache -&gt; enable_cpucache -&gt;&#xA0;<span style=\"font-size: 10pt; font-family: Arial; text-indent: 0mm;\">do_tune_cpucache</span></div><div>&#xA0; &#xA0; &#xA0;&#x5177;&#x4F53;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</div><div><br></div><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;3&#xFF09;&#x2014;&#x2014; array_cache/1537085030103\" hash=\"049b0a76d483a641fc99b8981d3f1d3a\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#x53EF;&#x89C1;do_tune_cpucache&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x5206;&#x914D;&#x8FD9;&#x4E2A;array_cache&#xFF0C;&#x5E76;&#x4ED8;&#x7ED9;&#x5BF9;&#x5E94;&#x7684;CPU&#x7684;&#x53D8;&#x91CF;&#x3002;&#x8FD9;&#x91CC;&#x4E0D;&#x6E05;&#x695A;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6240;&#x6709;&#x7684;online CPU&#x90FD;&#x8981;&#x5206;&#x914D;&#x4E00;&#x904D;&#xFF0C;&#x7136;&#x540E;&#x53EA;&#x53D6;&#x7528;&#x4E00;&#x4E2A;&#x5F53;&#x524D;CPU&#x7684;&#x503C;&#x3002;&#x90A3;&#x4E48;&#x600E;&#x4E48;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;array_cache&#xFF0C;&#x4F1A;&#x5728;&#x8BB2;&#x5206;&#x914D;&#x7684;&#x7B14;&#x8BB0;&#x4E2D;&#x518D;&#x505A;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x3002;&#x4E0D;&#x8FC7;&#x8FD9;&#x91CC;&#x6709;&#x4E2A;free_block&#x51FD;&#x6570;&#xFF0C;&#x9605;&#x8BFB;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x5BF9;array_cache&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x5927;&#x4F53;&#x7684;&#x4E86;&#x89E3;&#x3002;</div><div><br></div><div>&#xA0; &#xA0; &#xA0;&#x5148;&#x770B;&#x6574;&#x4E2A;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#xFF1A;</div><div><br></div><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;3&#xFF09;&#x2014;&#x2014; array_cache/1537085030106\" hash=\"2bff79d1ec9cde7eaa6122d0bccbeefe\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;array_cache&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6B63;&#x5982;&#x4E0A;&#x56FE;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x6240;&#x663E;&#x793A;&#xFF0C;&#x9664;&#x4E86;touched&#x4E0D;&#x77E5;&#x9053;&#x6709;&#x4EC0;&#x4E48;&#x7528;&#x4E4B;&#x5916;&#xFF0C;&#x5176;&#x4ED6;&#x51E0;&#x4E2A;&#x53D8;&#x91CF;&#x7684;&#x4F5C;&#x7528;&#x8FD8;&#x662F;&#x5F88;&#x6E05;&#x6670;&#x7684;&#xFF0C;&#x4ECE;&#x540D;&#x5B57;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5F97;&#x51FA;&#x6765;&#xFF1A;</div><div><ul><li>avail&#xFF0C;&#x5F53;&#x524D;&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x7A7A;&#x95F2;&#x7684;&#x4F4D;&#x5B50;&#x53EF;&#x4EE5;&#x5206;&#x914D;</li><li>limit&#xFF0C;&#x81EA;&#x7136;&#x5C31;&#x662F;&#x5206;&#x914D;&#x7684;&#x4E0A;&#x9650;&#xFF0C;&#x4E4B;&#x524D;&#x4E5F;&#x8BF4;&#x8FC7;&#xFF0C;&#x5728;enable_cpucache&#x4E2D;&#x4E5F;&#x6709;&#x5B9A;&#x4E49;</li><li>batchcount&#xFF0C;linux&#x4E2D;&#x4E00;&#x822C;&#xFF0C;&#x4E00;&#x6B21;&#x64CD;&#x4F5C;&#x7684;&#x6570;&#x91CF;&#x90FD;&#x662F;&#x7528;batch&#x6765;&#x8868;&#x793A;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5C31;&#x662F;array_cache&#x5728;&#x589E;&#x957F;&#x6216;&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x4E00;&#x6B21;&#x64CD;&#x4F5C;&#x7684;object&#x6570;</li><li>entry&#xFF0C;&#x5C31;&#x662F;array_cache&#x7684;&#x6838;&#x5FC3;&#x6210;&#x5458;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;object&#x6570;&#x7EC4;</li></ul>&#xA0; &#xA0; &#xA0;&#x8FD9;&#x91CC;&#x9762;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;free_block&#x91CA;&#x653E;&#x7684;&#x662F;ccold-&gt;avail&#x4E2A;object&#xFF0C;avail&#x4E0D;&#x5E94;&#x8BE5;&#x662F;&#x672C;&#x8EAB;&#x5C31;&#x662F;free&#x7684;object&#x5417;&#xFF1F;</div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x7ECF;&#x8FC7;&#x9605;&#x8BFB;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x56DE;&#x7B54;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x4E86;&#xFF0C;&#x9996;&#x5148;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x90FD;&#x662F;&#x4ECE;array_cache-&gt;entry&#x6570;&#x7EC4;&#x4E2D;&#x53D6;object&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x8C03;&#x7528;&#x8005;&#xFF0C;&#x6B64;&#x65F6;avail&#x7684;object&#x4F1A;&#x88AB;&#x5206;&#x914D;&#x51FA;&#x53BB;&#xFF0C;avail&#x53D8;&#x5C11;&#x3002;&#x5F53;avail&#x4E3A;0&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4ECE;kmem_cache&#x4E2D;&#x53BB;&#x53D6;object&#xFF0C;&#x8D4B;&#x7ED9;array_cache&#xFF0C;&#x4E00;&#x6B21;&#x53D6;batchcount&#x4E2A;object&#xFF0C;&#x8FD9;&#x65F6;avail&#x5C31;&#x4F1A;&#x589E;&#x52A0;&#xFF0C;&#x800C;kmem_list3-&gt;free_objects&#x5C31;&#x4F1A;&#x51CF;&#x5C11;&#x76F8;&#x5E94;&#x7684;&#x6570;&#x76EE;&#x3002;&#x800C;kmem_list3-&gt;free_objects&#x4F1A;&#x5728;cache_grow&#x65F6;&#x9012;&#x589E;cachep-&gt;num&#x3002;</div><div><br></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/16/slab_allocator_%EF%BC%881%EF%BC%89_-_%E5%88%9D%E5%A7%8B%E5%8C%96/",
            "url": "https://blog.zhougy.top/2012/12/16/slab_allocator_%EF%BC%881%EF%BC%89_-_%E5%88%9D%E5%A7%8B%E5%8C%96/",
            "title": "slab allocator （1） —— 初始化",
            "date_published": "2012-12-16T14:33:56.000Z",
            "content_html": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE en-note SYSTEM \"http://xml.evernote.com/pub/enml2.dtd\"><div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; display: block;\" title lang xml:lang dir>&#x524D;&#x9762;&#x63D0;&#x5230;&#x8FC7;&#x7684;buddy allocator&#x901A;&#x8FC7;&#x7528;order&#x5217;&#x8868;&#x6765;&#x7BA1;&#x7406;&#x9875;&#x9762;&#xFF0C;&#x4ECE;&#x800C;&#x8FBE;&#x5230;&#x51CF;&#x5C11;&#x5916;&#x90E8;&#x788E;&#x7247;&#x7684;&#x6548;&#x679C;&#x3002;&#x4F46;&#x662F;&#x4E0D;&#x53EF;&#x80FD;&#x6BCF;&#x6B21;&#x5206;&#x914D;&#x90FD;&#x5206;&#x914D;&#x4E00;&#x9875;&#x6216;&#x8005;&#x51E0;&#x9875;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x90A3;&#x6837;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x592A;&#x4F4E;&#xFF0C;&#x7CFB;&#x7EDF;&#x4E2D;&#x5C06;&#x5145;&#x6EE1;&#x4E86;&#x5185;&#x90E8;&#x788E;&#x7247;&#x3002;&#x6240;&#x4EE5;&#xFF0C;slab&#x5206;&#x914D;&#x5668;&#x4E5F;&#x5C31;&#x5E94;&#x8FD0;&#x800C;&#x751F;&#x4E86;&#xFF0C;&#x5176;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x51CF;&#x5C11;&#x5185;&#x90E8;&#x788E;&#x7247;&#x800C;&#x751F;&#x7684;&#x3002;&#x5177;&#x4F53;&#x4E3A;&#x4EC0;&#x4E48;&#x5F15;&#x5165;&#xFF0C;&#x4EE5;&#x53CA;slab&#x7684;&#x4E00;&#x4E9B;&#x7B80;&#x4ECB;&#x53EF;&#x4EE5;&#x53C2;&#x8003; <a href=\"evernote:///view/161681/s10/1c5db3a9-e828-4651-85a8-865b4b31c896/1c5db3a9-e828-4651-85a8-865b4b31c896/\" style=\"color:#69aa35\">Linux slab &#x5206;&#x914D;&#x5668;&#x5256;&#x6790;</a>&#xFF0C; <a href=\"evernote:///view/161681/s10/dd5a8455-ae17-4640-9ab3-318029b5b27a/dd5a8455-ae17-4640-9ab3-318029b5b27a/\" style=\"color:#69aa35\">Fred&apos;s blog: &#x4E09;&#x6708; 2009</a>&#x3002;<div style=\"display: block;\"><br><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1499486800011\" hash=\"f9aa13f5720f81622ea03ff22545aa90\" align alt longdesc width=\"402\" height=\"216\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#x6240;&#x8C13;&#x7684;slab&#x5C31;&#x662F;&#x57FA;&#x4E8E;&#x8FD9;&#x4E48;&#x4E00;&#x5F20;&#x56FE;&#x7684;&#x7CFB;&#x7EDF;&#x3002;&#x7B80;&#x5316;&#x4E4B;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E00;&#x79CD;&#x57FA;&#x4E8E;&#x540E;&#x5907;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x5185;&#x5B58;&#x5206;&#x914D;&#xFF08;&#x53C2;&#x8003;ldd3&#xFF0C;page247 ch 8&#xFF09;&#x65B9;&#x5F0F;&#x7684;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#x3002;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x4ED6;&#x7684;&#x521D;&#x59CB;&#x5316;&#x7531;&#x4E0B;&#x56FE;&#x4E2D;&#x7684;g_cpucache_up&#x6765;&#x6807;&#x5FD7;&#xFF0C;&#x5171;&#x6709;5&#x4E2A;&#x72B6;&#x6001;&#xFF0C;&#x6309;&#x987A;&#x5E8F;&#x4F9D;&#x6B21;&#x8FC1;&#x79FB;&#xFF0C;&#x5728;start_kernel -&gt; mm_init -&gt; kmem_cache_init&#x4E2D;&#x5230;&#x8FBE;EARLY&#x72B6;&#x6001;&#x3002;&#x6B64;&#x65F6;slab_is_availabe()&#x51FD;&#x6570;&#x5C31;&#x8FD4;&#x56DE;&#x771F;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6B64;&#x65F6;slab&#x7CFB;&#x7EDF;&#x5DF2;&#x7ECF;&#x5C31;&#x7EEA;&#x4E86;&#x3002;&#x800C;&#x6700;&#x7EC8;&#x7684;FULL&#x72B6;&#x6001;&#x662F;&#x5728;kmem_cache_init_late&#x4E2D;&#x5B8C;&#x6210;&#x7684;&#x3002;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1499486799339\" hash=\"03ce74377056ed29ac4d864ca09a0238\" align alt longdesc width=\"990\" height=\"382\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#x4E0A;&#x9762;&#x8FD9;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x6838;&#x5FC3;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#xA0;kmem_cache_init&#x3002;&#x4E0B;&#x9762;&#x5C06;&#x91CD;&#x70B9;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x3002;</div><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1499486799878\" hash=\"f81d2f1faf6a6fe1e338c67903cec92c\" align alt longdesc width=\"920\" height=\"733\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5F88;&#x5927;&#xFF0C;&#x800C;&#x4E14;&#x5305;&#x542B;&#x4E86;&#x5F88;&#x591A;&#x77E5;&#x8BC6;&#x70B9;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x300A;Understanding the Linux&#xAE;&#xA0;Virtual Memory Manager&#x300B;chapter 8&#x3002;&#x5173;&#x4E8E;slab&#x7CFB;&#x7EDF;&#x7684;&#x5185;&#x5BB9;&#x5F88;&#x591A;&#xFF0C;&#x800C;&#x4E14;&#x4E0D;&#x662F;&#x5F88;&#x597D;&#x7406;&#x89E3;&#x3002;&#x5148;&#x5217;&#x4E3E;&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;&#x5F53;&#x7136;&#x6700;&#x6838;&#x5FC3;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5C31;&#x662F;kmem_cache&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x5DE8;&#x5927;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x4E0D;&#x5728;&#x6B64;&#x5217;&#x4E3E;&#x4E86;&#x3002;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; 1.&#xA0;kmem_list3</div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;struct kmem_list3 {</font></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct list_head slabs_partial;&#xA0;&#xA0;&#xA0;&#xA0; /* partial list first, better asm code */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct list_head slabs_full;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct list_head slabs_free;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long free_objects;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int free_limit;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int colour_next;&#xA0;&#xA0;&#xA0;&#xA0; /* Per-node cache coloring */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; spinlock_t list_lock;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache *shared;&#xA0;&#xA0;&#xA0;&#xA0; /* shared per node */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache **alien;&#xA0;&#xA0;&#xA0;&#xA0; /* on other nodes */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long next_reap;&#xA0;&#xA0;&#xA0;&#xA0; /* updated without locking */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; int free_touched;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; /* updated without locking */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">};</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">&#x6700;&#x91CD;&#x8981;&#x7684;&#x5C31;&#x662F;&#x524D;3&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5728;&#x56FE;1&#x4E2D;&#x63D0;&#x5230;&#x7684;&#x4E09;&#x4E2A;list&#xFF1A;slab_full, slab_partial, slab_empty&#x3002;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\"><br></font></blockquote>&#xA0; &#xA0; &#xA0;2. array_cache<blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">struct array_cache {</font></div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int avail;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int limit;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int batchcount;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int touched;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; spinlock_t lock;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; void *entry[];&#xA0;&#xA0;&#xA0;&#xA0; /*<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * Must have this definition in here for the proper<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * alignment of array_cache. Also simplifies accessing<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * the entries.<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">};</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">struct kmem_cache {<br>/* 1) per-cpu data, touched during every alloc/free */<br>&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache *array[NR_CPUS];</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font color=\"#2D4FC9\" face=\"Courier New\">&#x2026;&#x2026;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></blockquote><div style=\"display: block;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array_cache&#x662F;per CPU&#x53D8;&#x91CF;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x53C2;&#x8003;&#x300A;Understanding the Linux&#xAE;&#xA0;Virtual Memory Manager&#x300B;chp 8.5: Per-CPU Object Cache&#x3002;&#x6BCF;&#x4E00;&#x4E2A;cache&#xFF0C;&#x5728;create&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x4F1A;&#x88AB;&#x5206;&#x914D;&#x4E00;&#x4E2A;array_cache&#xFF08;enable_cpucache&#xFF09;&#x6765;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#x3002;&#x5F53;&#x7136;&#x6211;&#x4EEC;&#x7684;&#x603B;cache&#x2014;&#x2014;cache_cache&#xFF08;&#x4ECE;&#x540D;&#x5B57;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x5B83;&#x662F;cache&#x7684;cache&#xFF09;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x5728;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x88AB;&#x586B;&#x4E86;&#x4E00;&#x4E2A;__init_data&#xA0;initarray_cache.cache&#x3002;&#x4E4B;&#x540E;&#x5728;kmem_cache_init&#x4E2D;&#x518D;&#x901A;&#x8FC7;kmalloc&#x6765;&#x5206;&#x914D;&#x3002;arraycache&#x4E0E;kmem_cache&#x7684;&#x5173;&#x7CFB;&#x5927;&#x4F53;&#x5982;&#x4E0B;&#x56FE;</div><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1499486799641\" hash=\"4daa9a20e6abdf0bb5ff45cff476683c\" align alt longdesc width=\"490\" height=\"402\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#x5173;&#x4E8E;array_cache&#x5177;&#x4F53;&#x7684;&#x5185;&#x5BB9;&#x4F1A;&#x5728;&#x53E6;&#x4E00;&#x7BC7;&#x7B14;&#x8BB0;&#x4E2D;&#x4F5C;&#x4ECB;&#x7ECD;<a href=\"evernote:///view/161681/s10/e6125cc1-29d9-4e51-b0d7-1e44806f5491/e6125cc1-29d9-4e51-b0d7-1e44806f5491/\" style=\"color: rgb(105, 170, 53);\">slab allocator &#xFF08;3&#xFF09;&#x2014;&#x2014; arraycache</a>&#x3002;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;3. cache_sizes</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;Gorman&#x7684;&#x4E66;&#x4E2D;&#x5C06;&#x5176;&#x79F0;&#x4E4B;&#x4E3A;sizes cache&#x3002;&#x5176;&#x5B9E;&#x4ED6;&#x5C31;&#x662F;&#x4E00;&#x7EC4;&#x5B9A;&#x4E49;&#x4E86;size&#x7684;cache&#x3002;&#x5728;slab&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x7ECF;&#x5E38;&#x770B;&#x5230;malloc_sizes&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x5176;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">struct cache_sizes malloc_sizes[] = {</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">#define CACHE(x) { .cs_size = (x) },</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">#include &lt;linux/kmalloc_sizes.h&gt;</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; CACHE(ULONG_MAX)</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">#undef CACHE</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">};</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">struct cache_sizes {<br>&#xA0;&#xA0;&#xA0;&#xA0; size_t&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0;&#xA0; cs_size;<br>&#xA0;&#xA0;&#xA0;&#xA0; struct kmem_cache&#xA0;&#xA0;&#xA0;&#xA0; *cs_cachep;<br>#ifdef CONFIG_ZONE_DMA<br>&#xA0;&#xA0;&#xA0;&#xA0; struct kmem_cache&#xA0;&#xA0;&#xA0;&#xA0; *cs_dmacachep;<br>#endif<br>};</font></div><div style=\"display: block;\"><font face=\"Courier New\">&#x518D;&#x770B;</font><span style=\"font-family: &apos;Courier New&apos;;\">linux/kmalloc_sizes.h</span></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">#if (PAGE_SIZE == 4096)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(32)<br>#endif<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(64)<br>#if L1_CACHE_BYTES &lt; 64<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(96)<br>#endif<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(128)<br>#if L1_CACHE_BYTES &lt; 128<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(192)<br>#endif<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(256)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(512)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(1024)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(2048)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(4096)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(8192)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(16384)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(32768)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(65536)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(131072)</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#x2026;&#x2026;</font></div></blockquote>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">&#x7A0D;&#x52A0;&#x5206;&#x6790;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x5728;</font><span style=\"font-family: &apos;Courier New&apos;;\">kmalloc_sizes.h&#x4E2D;&#x5DF2;&#x7ECF;&#x5B9A;&#x4E49;&#x597D;&#x4E86;&#x4E00;&#x7EC4;&#x56FA;&#x5B9A;size&#x7684;cache&#x4E86;&#xFF0C;&#x53EA;&#x662F;&#x4ED6;&#x4EEC;&#x5BF9;&#x5E94;&#x7684;&#x4E24;&#x7EC4;cache&#x5217;&#x8868;&#xFF08;cs_cachep, cs_dmacachep&#xFF09;&#x8FD8;&#x6CA1;&#x5206;&#x914D;&#x3002;&#x4E4B;&#x540E;&#x5728;&#x6211;&#x4EEC;&#x7684;kmem_cache_init&#x4E2D;&#x5BF9;INDEX_AC&#x548C;INDEX_L3&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x90FD;&#x662F;&#x5728;&#x4E3A;&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x7684;&#x6210;&#x5458;&#x521D;&#x59CB;&#x5316;&#x3002;</span><br><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><span style=\"font-family: &apos;Courier New&apos;;\">INDEX_AC&#xFF1A;</span>sizeof(struct arraycache_init)&#x5BF9;&#x5E94;&#x7684;malloc_sizes&#x4E2D;&#x7684;&#x7D22;&#x5F15;&#x3002;</div><div style=\"display: block;\"><span style=\"font-family: &apos;Courier New&apos;;\">INDEX_L3&#xFF1A;</span>sizeof(struct kmem_list3)&#x5BF9;&#x5E94;&#x7684;malloc_sizes&#x4E2D;&#x7684;&#x7D22;&#x5F15;&#x3002;</div></blockquote>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x628A;&#x8FD9;&#x4E24;&#x4E2A;size&#x5355;&#x72EC;&#x63D0;&#x51FA;&#x6765;&#x505A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x6211;&#x63A8;&#x6D4B;&#x662F;&#x56E0;&#x4E3A;&#x5728;kmem_cache_create&#x5230;&#x65F6;&#x5019;&#x9700;&#x8981;&#x9891;&#x7E41;&#x7684;&#x5206;&#x914D;arraycache_init&#x548C;kmem_list3&#xFF0C;&#x800C;&#x4E14;&#x5BF9;&#x4E8E;kmem_cache&#x6765;&#x8BF4;&#x4E5F;&#x5C31;&#x8FD9;&#x4E24;&#x4E2A;struct&#x662F;&#x9700;&#x8981;&#x52A8;&#x6001;&#x5206;&#x914D;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x5148;&#x5BF9;&#x8FD9;&#x4E24;&#x4E2A;size&#x7684;cache&#x5148;&#x505A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x521D;&#x59CB;&#x5316;&#x5176;&#x4ED6;malloc_sizes&#x6570;&#x7EC4;&#x6210;&#x5458;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E24;&#x4E2A;cache&#x6765;&#x4E3A;&#x4E4B;&#x5206;&#x914D;arraycache_init&#x548C;kmem_list3&#x3002;<div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8BF4;&#x5B8C;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E86;&#xFF0C;&#x518D;&#x56DE;&#x5934;&#x770B;&#x770B;kmem_cache_init&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x5176;&#x5B9E;&#x65E0;&#x975E;&#x5C31;&#x662F;&#x5BF9;cache_cache&#xFF0C;malloc_sizes&#x505A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x4E0B;&#x9762;&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x70B9;&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;1. cache_chain</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x5728;kmem_cache_init&#x7684;&#x4E00;&#x5F00;&#x59CB;&#x5904;&#xFF0C;&#x6709;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">INIT_LIST_HEAD(&amp;cache_chain);</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">list_add(&amp;cache_cache.next, &amp;cache_chain);</font></div><div style=\"display: block;\"><font face=\"Courier New\">&#x5C1A;&#x4E0D;&#x77E5;&#x8FD9;&#x4E2A;</font><span style=\"font-family: &apos;Courier New&apos;;\">cache_chain&#x662F;&#x4F5C;&#x4F55;&#x7528;&#x7684;&#xFF0C;&#x5148;&#x6682;&#x4E14;&#x5217;&#x5728;&#x8FD9;&#x91CC;</span></div></blockquote><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;2. cache_estimate</div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;1504&#xA0;&#xA0;&#xA0;&#xA0; for (order = 0; order &lt; MAX_ORDER; order++) {<br></font></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1505&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; cache_estimate(order, cache_cache.buffer_size,</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1506&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; cache_line_size(), 0, &amp;left_over, &amp;cache_cache.num);</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1507&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (cache_cache.num)</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1508&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; break;</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1509&#xA0;&#xA0;&#xA0;&#xA0; }</font></div></blockquote>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4F5C;&#x7528;&#x5176;&#x5B9E;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x51B3;&#x5B9A;&#xFF1A;(1)<span style=\"font-family: &apos;Courier New&apos;;\">cache_cache.buffer_size&#xFF0C;&#x4E5F;&#x5C31;&#x662F;cache_cache&#x7684;object size&#xFF0C;&#x4EE5;&#x53CA;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x591A;&#x5C11;&#x4E2A;object&#xA0;</span>(2)<span style=\"font-family: &apos;Courier New&apos;;\">slab manager&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#xFF08;on-slab/off-slab&#xFF1A;&#x770B;&#x770B;flags&#x662F;&#x5426;&#x5305;&#x542B;</span>CFLGS_OFF_SLAB<span style=\"font-family: &apos;Courier New&apos;;\">&#xFF09;</span>(3)<span style=\"font-family: &apos;Courier New&apos;;\">&#x5229;&#x7528;slab&#x4E0A;&#x5269;&#x4F59;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x521D;&#x59CB;&#x5316;coloring&#x673A;&#x5236;&#x3002;</span><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x4E00;&#x4E2A;cache_cache&#x7684;slab&#x7A7A;&#x95F4;&#x5206;&#x5272;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</div><div style=\"display: block;\"><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1499486799475\" hash=\"4303d9fccee1ae4e2d8a4614f64d90ca\" align alt longdesc width=\"425\" height=\"242\" border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5176;&#x4E2D;object&#x7684;size&#x5982;&#x4E0B;&#xFF1A;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font color=\"#2D4FC9\" face=\"Courier New\">offsetof(struct kmem_cache, nodelists) +&#xA0;nr_node_ids * sizeof(struct kmem_list3 *);</font></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5176;&#x5B9E;&#x5C31;&#x662F;sizeof(kmem_cache)&#x3002;&#x53EF;&#x89C1;cache_cache&#x7684;slab&#x8981;&#x5206;&#x914D;&#x7684;&#x5C31;&#x662F;kmem_cache&#x3002;&#x6700;&#x540E;cache_cache-&gt;slab_size =&#xA0;slab_mgmt_size&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; coloring scheme&#x7684;&#x521D;&#x59CB;&#x5316;&#x4E3A;&#xFF1A;</div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;cache_cache.colour_off = cache_line_size();</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;cache_cache.colour = left_over / cache_cache.colour_off;</font></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;3. init_list</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5728;kmem_cache_init&#x7684;&#x6700;&#x540E;&#xFF0C;&#x6709;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1604&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; for_each_online_node(nid) {</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1605&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; init_list(&amp;cache_cache, &amp;initkmem_list3[CACHE_CACHE + nid], nid);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1606</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1607&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; init_list(malloc_sizes[INDEX_AC].cs_cachep,</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1608&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &amp;initkmem_list3[SIZE_AC + nid], nid);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1609</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1610&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (INDEX_AC != INDEX_L3) {</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1611&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; init_list(malloc_sizes[INDEX_L3].cs_cachep,</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1612&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &amp;initkmem_list3[SIZE_L3 + nid], nid);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1613&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">1614&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }</font></div></blockquote></blockquote>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">init_list&#x5199;&#x7684;&#x5F88;&#x590D;&#x6742;&#xFF0C;&#x5176;&#x5B9E;&#x4ED4;&#x7EC6;&#x7406;&#x89E3;&#x4E4B;&#x540E;&#xFF0C;&#x5B9E;&#x73B0;&#x7684;&#x5185;&#x5BB9;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x4E3A;cache_cache&#x4EE5;&#x53CA;&#x4E24;&#x4E2A;size cache &#xFF08;INDEX_AC, INDEX_L3&#xFF09;&#x5206;&#x914D;kmem_list3&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5E76;&#x7528;memcpy&#x5C06;</font>initkmem_list3&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x62F7;&#x8D1D;&#x8FC7;&#x6765;&#xFF0C;&#x53E6;&#x5916;&#x518D;&#x7528;MAKE_ALL_LISTS -&gt;&#xA0;MAKE_LIST -&gt;&#xA0;list_splice &#x6765;&#x5408;&#x5E76;initkmem_list3&#x5217;&#x8868;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x3002;<br><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#x53EF;&#x89C1;&#x6709;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x8981;&#x628A;&#x590D;&#x6742;&#x7684;&#x95EE;&#x9898;&#x60F3;&#x7B80;&#x5355;&#x4E86;&#xFF0C;&#x8BE5;&#x4ED4;&#x7EC6;&#x5904;&#x7406;&#x7684;&#x8FD8;&#x662F;&#x8981;&#x4ED4;&#x7EC6;&#x5904;&#x7406;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x9488;&#x5BF9;&#x8FD9;&#x79CD;&#x5217;&#x8868;&#x7ED3;&#x6784;&#x4F53;&#x3002;</blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">kmem_cache_init&#x4E2D;&#x4E5F;&#x8FD0;&#x7528;kmem_cache_create&#x6765;&#x5206;&#x914D;cache&#x4E86;&#xFF0C;&#x4F46;&#x8FD9;&#x4E2A;&#x8FC7;&#x4E8E;&#x590D;&#x6742;&#xFF0C;&#x5C06;&#x5728;&#x53E6;&#x4E00;&#x7BC7;&#x7B14;&#x8BB0;&#x4E2D;&#x52A0;&#x4EE5;&#x9610;&#x8FF0;<a href=\"evernote:///view/161681/s10/e3b971bf-908b-4dda-8c29-d37666e83f1c/e3b971bf-908b-4dda-8c29-d37666e83f1c/\" style=\"color: rgb(105, 170, 53);\">slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create</a>&#x3002;</blockquote><div style=\"display: block;\"><br></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/16/slab_allocator_%EF%BC%881%EF%BC%89_%E2%80%94%E2%80%94_%E5%88%9D%E5%A7%8B%E5%8C%96/",
            "url": "https://blog.zhougy.top/2012/12/16/slab_allocator_%EF%BC%881%EF%BC%89_%E2%80%94%E2%80%94_%E5%88%9D%E5%A7%8B%E5%8C%96/",
            "title": "slab allocator （1） —— 初始化",
            "date_published": "2012-12-16T14:33:56.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir>&#x524D;&#x9762;&#x63D0;&#x5230;&#x8FC7;&#x7684;buddy allocator&#x901A;&#x8FC7;&#x7528;order&#x5217;&#x8868;&#x6765;&#x7BA1;&#x7406;&#x9875;&#x9762;&#xFF0C;&#x4ECE;&#x800C;&#x8FBE;&#x5230;&#x51CF;&#x5C11;&#x5916;&#x90E8;&#x788E;&#x7247;&#x7684;&#x6548;&#x679C;&#x3002;&#x4F46;&#x662F;&#x4E0D;&#x53EF;&#x80FD;&#x6BCF;&#x6B21;&#x5206;&#x914D;&#x90FD;&#x5206;&#x914D;&#x4E00;&#x9875;&#x6216;&#x8005;&#x51E0;&#x9875;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x90A3;&#x6837;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x592A;&#x4F4E;&#xFF0C;&#x7CFB;&#x7EDF;&#x4E2D;&#x5C06;&#x5145;&#x6EE1;&#x4E86;&#x5185;&#x90E8;&#x788E;&#x7247;&#x3002;&#x6240;&#x4EE5;&#xFF0C;slab&#x5206;&#x914D;&#x5668;&#x4E5F;&#x5C31;&#x5E94;&#x8FD0;&#x800C;&#x751F;&#x4E86;&#xFF0C;&#x5176;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x51CF;&#x5C11;&#x5185;&#x90E8;&#x788E;&#x7247;&#x800C;&#x751F;&#x7684;&#x3002;&#x5177;&#x4F53;&#x4E3A;&#x4EC0;&#x4E48;&#x5F15;&#x5165;&#xFF0C;&#x4EE5;&#x53CA;slab&#x7684;&#x4E00;&#x4E9B;&#x7B80;&#x4ECB;&#x53EF;&#x4EE5;&#x53C2;&#x8003; <a href=\"evernote:///view/161681/s10/1c5db3a9-e828-4651-85a8-865b4b31c896/1c5db3a9-e828-4651-85a8-865b4b31c896/\" style=\"color:#69aa35\">Linux slab &#x5206;&#x914D;&#x5668;&#x5256;&#x6790;</a>&#xFF0C; <a href=\"evernote:///view/161681/s10/dd5a8455-ae17-4640-9ab3-318029b5b27a/dd5a8455-ae17-4640-9ab3-318029b5b27a/\" style=\"color:#69aa35\">Fred&apos;s blog: &#x4E09;&#x6708; 2009</a>&#x3002;<div><br><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1537085031252\" hash=\"f9aa13f5720f81622ea03ff22545aa90\" align alt longdesc width=\"402\" height=\"216\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div></div><div>&#xA0; &#xA0; &#xA0;</div><div>&#xA0; &#xA0; &#xA0;&#x6240;&#x8C13;&#x7684;slab&#x5C31;&#x662F;&#x57FA;&#x4E8E;&#x8FD9;&#x4E48;&#x4E00;&#x5F20;&#x56FE;&#x7684;&#x7CFB;&#x7EDF;&#x3002;&#x7B80;&#x5316;&#x4E4B;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E00;&#x79CD;&#x57FA;&#x4E8E;&#x540E;&#x5907;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x5185;&#x5B58;&#x5206;&#x914D;&#xFF08;&#x53C2;&#x8003;ldd3&#xFF0C;page247 ch 8&#xFF09;&#x65B9;&#x5F0F;&#x7684;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#x3002;</div><div><br></div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x4ED6;&#x7684;&#x521D;&#x59CB;&#x5316;&#x7531;&#x4E0B;&#x56FE;&#x4E2D;&#x7684;g_cpucache_up&#x6765;&#x6807;&#x5FD7;&#xFF0C;&#x5171;&#x6709;5&#x4E2A;&#x72B6;&#x6001;&#xFF0C;&#x6309;&#x987A;&#x5E8F;&#x4F9D;&#x6B21;&#x8FC1;&#x79FB;&#xFF0C;&#x5728;start_kernel -&gt; mm_init -&gt; kmem_cache_init&#x4E2D;&#x5230;&#x8FBE;EARLY&#x72B6;&#x6001;&#x3002;&#x6B64;&#x65F6;slab_is_availabe()&#x51FD;&#x6570;&#x5C31;&#x8FD4;&#x56DE;&#x771F;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6B64;&#x65F6;slab&#x7CFB;&#x7EDF;&#x5DF2;&#x7ECF;&#x5C31;&#x7EEA;&#x4E86;&#x3002;&#x800C;&#x6700;&#x7EC8;&#x7684;FULL&#x72B6;&#x6001;&#x662F;&#x5728;kmem_cache_init_late&#x4E2D;&#x5B8C;&#x6210;&#x7684;&#x3002;</div><div><br></div><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1537085031241\" hash=\"03ce74377056ed29ac4d864ca09a0238\" align alt longdesc width=\"990\" height=\"382\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div><br></div><div>&#x4E0A;&#x9762;&#x8FD9;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x6838;&#x5FC3;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#xA0;kmem_cache_init&#x3002;&#x4E0B;&#x9762;&#x5C06;&#x91CD;&#x70B9;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x3002;</div><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1537085031250\" hash=\"f81d2f1faf6a6fe1e338c67903cec92c\" align alt longdesc width=\"920\" height=\"733\" border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5F88;&#x5927;&#xFF0C;&#x800C;&#x4E14;&#x5305;&#x542B;&#x4E86;&#x5F88;&#x591A;&#x77E5;&#x8BC6;&#x70B9;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x300A;Understanding the Linux&#xAE;&#xA0;Virtual Memory Manager&#x300B;chapter 8&#x3002;&#x5173;&#x4E8E;slab&#x7CFB;&#x7EDF;&#x7684;&#x5185;&#x5BB9;&#x5F88;&#x591A;&#xFF0C;&#x800C;&#x4E14;&#x4E0D;&#x662F;&#x5F88;&#x597D;&#x7406;&#x89E3;&#x3002;&#x5148;&#x5217;&#x4E3E;&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;&#x5F53;&#x7136;&#x6700;&#x6838;&#x5FC3;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5C31;&#x662F;kmem_cache&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x5DE8;&#x5927;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x4E0D;&#x5728;&#x6B64;&#x5217;&#x4E3E;&#x4E86;&#x3002;</div><div><br></div><div>&#xA0; &#xA0; 1.&#xA0;kmem_list3</div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;struct kmem_list3 {</font></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct list_head slabs_partial;&#xA0;&#xA0;&#xA0;&#xA0; /* partial list first, better asm code */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct list_head slabs_full;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct list_head slabs_free;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long free_objects;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int free_limit;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int colour_next;&#xA0;&#xA0;&#xA0;&#xA0; /* Per-node cache coloring */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; spinlock_t list_lock;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache *shared;&#xA0;&#xA0;&#xA0;&#xA0; /* shared per node */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache **alien;&#xA0;&#xA0;&#xA0;&#xA0; /* on other nodes */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long next_reap;&#xA0;&#xA0;&#xA0;&#xA0; /* updated without locking */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; int free_touched;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; /* updated without locking */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">};</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">&#x6700;&#x91CD;&#x8981;&#x7684;&#x5C31;&#x662F;&#x524D;3&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5728;&#x56FE;1&#x4E2D;&#x63D0;&#x5230;&#x7684;&#x4E09;&#x4E2A;list&#xFF1A;slab_full, slab_partial, slab_empty&#x3002;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\"><br></font></blockquote>&#xA0; &#xA0; &#xA0;2. array_cache<blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">struct array_cache {</font></div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int avail;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int limit;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int batchcount;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned int touched;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; spinlock_t lock;<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; void *entry[];&#xA0;&#xA0;&#xA0;&#xA0; /*<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * Must have this definition in here for the proper<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * alignment of array_cache. Also simplifies accessing<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * the entries.<br></font><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; */<br></font><font color=\"#2D4FC9\" face=\"Courier New\">};</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">struct kmem_cache {<br>/* 1) per-cpu data, touched during every alloc/free */<br>&#xA0;&#xA0;&#xA0;&#xA0; struct array_cache *array[NR_CPUS];</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font color=\"#2D4FC9\" face=\"Courier New\">&#x2026;&#x2026;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></blockquote><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;array_cache&#x662F;per CPU&#x53D8;&#x91CF;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x53C2;&#x8003;&#x300A;Understanding the Linux&#xAE;&#xA0;Virtual Memory Manager&#x300B;chp 8.5: Per-CPU Object Cache&#x3002;&#x6BCF;&#x4E00;&#x4E2A;cache&#xFF0C;&#x5728;create&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x4F1A;&#x88AB;&#x5206;&#x914D;&#x4E00;&#x4E2A;array_cache&#xFF08;enable_cpucache&#xFF09;&#x6765;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#x3002;&#x5F53;&#x7136;&#x6211;&#x4EEC;&#x7684;&#x603B;cache&#x2014;&#x2014;cache_cache&#xFF08;&#x4ECE;&#x540D;&#x5B57;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x5B83;&#x662F;cache&#x7684;cache&#xFF09;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x5728;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x88AB;&#x586B;&#x4E86;&#x4E00;&#x4E2A;__init_data&#xA0;initarray_cache.cache&#x3002;&#x4E4B;&#x540E;&#x5728;kmem_cache_init&#x4E2D;&#x518D;&#x901A;&#x8FC7;kmalloc&#x6765;&#x5206;&#x914D;&#x3002;arraycache&#x4E0E;kmem_cache&#x7684;&#x5173;&#x7CFB;&#x5927;&#x4F53;&#x5982;&#x4E0B;&#x56FE;</div><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1537085031247\" hash=\"4daa9a20e6abdf0bb5ff45cff476683c\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;&#x5173;&#x4E8E;array_cache&#x5177;&#x4F53;&#x7684;&#x5185;&#x5BB9;&#x4F1A;&#x5728;&#x53E6;&#x4E00;&#x7BC7;&#x7B14;&#x8BB0;&#x4E2D;&#x4F5C;&#x4ECB;&#x7ECD;<a href=\"evernote:///view/161681/s10/e6125cc1-29d9-4e51-b0d7-1e44806f5491/e6125cc1-29d9-4e51-b0d7-1e44806f5491/\" style=\"color: rgb(105, 170, 53);\">slab allocator &#xFF08;3&#xFF09;&#x2014;&#x2014; arraycache</a>&#x3002;</div><div><br></div><div>&#xA0; &#xA0; &#xA0;3. cache_sizes</div><div>&#xA0; &#xA0; &#xA0;Gorman&#x7684;&#x4E66;&#x4E2D;&#x5C06;&#x5176;&#x79F0;&#x4E4B;&#x4E3A;sizes cache&#x3002;&#x5176;&#x5B9E;&#x4ED6;&#x5C31;&#x662F;&#x4E00;&#x7EC4;&#x5B9A;&#x4E49;&#x4E86;size&#x7684;cache&#x3002;&#x5728;slab&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x7ECF;&#x5E38;&#x770B;&#x5230;malloc_sizes&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x5176;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">struct cache_sizes malloc_sizes[] = {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">#define CACHE(x) { .cs_size = (x) },</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">#include &lt;linux/kmalloc_sizes.h&gt;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; CACHE(ULONG_MAX)</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">#undef CACHE</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">};</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">struct cache_sizes {<br>&#xA0;&#xA0;&#xA0;&#xA0; size_t&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0;&#xA0; cs_size;<br>&#xA0;&#xA0;&#xA0;&#xA0; struct kmem_cache&#xA0;&#xA0;&#xA0;&#xA0; *cs_cachep;<br>#ifdef CONFIG_ZONE_DMA<br>&#xA0;&#xA0;&#xA0;&#xA0; struct kmem_cache&#xA0;&#xA0;&#xA0;&#xA0; *cs_dmacachep;<br>#endif<br>};</font></div><div><font face=\"Courier New\">&#x518D;&#x770B;</font><span style=\"font-family: &apos;Courier New&apos;;\">linux/kmalloc_sizes.h</span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">#if (PAGE_SIZE == 4096)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(32)<br>#endif<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(64)<br>#if L1_CACHE_BYTES &lt; 64<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(96)<br>#endif<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(128)<br>#if L1_CACHE_BYTES &lt; 128<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(192)<br>#endif<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(256)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(512)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(1024)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(2048)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(4096)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(8192)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(16384)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(32768)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(65536)<br>&#xA0;&#xA0;&#xA0;&#xA0; CACHE(131072)</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#x2026;&#x2026;</font></div></blockquote>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">&#x7A0D;&#x52A0;&#x5206;&#x6790;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x5728;</font><span style=\"font-family: &apos;Courier New&apos;;\">kmalloc_sizes.h&#x4E2D;&#x5DF2;&#x7ECF;&#x5B9A;&#x4E49;&#x597D;&#x4E86;&#x4E00;&#x7EC4;&#x56FA;&#x5B9A;size&#x7684;cache&#x4E86;&#xFF0C;&#x53EA;&#x662F;&#x4ED6;&#x4EEC;&#x5BF9;&#x5E94;&#x7684;&#x4E24;&#x7EC4;cache&#x5217;&#x8868;&#xFF08;cs_cachep, cs_dmacachep&#xFF09;&#x8FD8;&#x6CA1;&#x5206;&#x914D;&#x3002;&#x4E4B;&#x540E;&#x5728;&#x6211;&#x4EEC;&#x7684;kmem_cache_init&#x4E2D;&#x5BF9;INDEX_AC&#x548C;INDEX_L3&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x90FD;&#x662F;&#x5728;&#x4E3A;&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x7684;&#x6210;&#x5458;&#x521D;&#x59CB;&#x5316;&#x3002;</span><br><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><span style=\"font-family: &apos;Courier New&apos;;\">INDEX_AC&#xFF1A;</span>sizeof(struct arraycache_init)&#x5BF9;&#x5E94;&#x7684;malloc_sizes&#x4E2D;&#x7684;&#x7D22;&#x5F15;&#x3002;</div><div><span style=\"font-family: &apos;Courier New&apos;;\">INDEX_L3&#xFF1A;</span>sizeof(struct kmem_list3)&#x5BF9;&#x5E94;&#x7684;malloc_sizes&#x4E2D;&#x7684;&#x7D22;&#x5F15;&#x3002;</div></blockquote>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x628A;&#x8FD9;&#x4E24;&#x4E2A;size&#x5355;&#x72EC;&#x63D0;&#x51FA;&#x6765;&#x505A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x6211;&#x63A8;&#x6D4B;&#x662F;&#x56E0;&#x4E3A;&#x5728;kmem_cache_create&#x5230;&#x65F6;&#x5019;&#x9700;&#x8981;&#x9891;&#x7E41;&#x7684;&#x5206;&#x914D;arraycache_init&#x548C;kmem_list3&#xFF0C;&#x800C;&#x4E14;&#x5BF9;&#x4E8E;kmem_cache&#x6765;&#x8BF4;&#x4E5F;&#x5C31;&#x8FD9;&#x4E24;&#x4E2A;struct&#x662F;&#x9700;&#x8981;&#x52A8;&#x6001;&#x5206;&#x914D;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x5148;&#x5BF9;&#x8FD9;&#x4E24;&#x4E2A;size&#x7684;cache&#x5148;&#x505A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x521D;&#x59CB;&#x5316;&#x5176;&#x4ED6;malloc_sizes&#x6570;&#x7EC4;&#x6210;&#x5458;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E24;&#x4E2A;cache&#x6765;&#x4E3A;&#x4E4B;&#x5206;&#x914D;arraycache_init&#x548C;kmem_list3&#x3002;<div><br></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8BF4;&#x5B8C;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E86;&#xFF0C;&#x518D;&#x56DE;&#x5934;&#x770B;&#x770B;kmem_cache_init&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x5176;&#x5B9E;&#x65E0;&#x975E;&#x5C31;&#x662F;&#x5BF9;cache_cache&#xFF0C;malloc_sizes&#x505A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x4E0B;&#x9762;&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x70B9;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;1. cache_chain</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x5728;kmem_cache_init&#x7684;&#x4E00;&#x5F00;&#x59CB;&#x5904;&#xFF0C;&#x6709;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">INIT_LIST_HEAD(&amp;cache_chain);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">list_add(&amp;cache_cache.next, &amp;cache_chain);</font></div><div><font face=\"Courier New\">&#x5C1A;&#x4E0D;&#x77E5;&#x8FD9;&#x4E2A;</font><span style=\"font-family: &apos;Courier New&apos;;\">cache_chain&#x662F;&#x4F5C;&#x4F55;&#x7528;&#x7684;&#xFF0C;&#x5148;&#x6682;&#x4E14;&#x5217;&#x5728;&#x8FD9;&#x91CC;</span></div></blockquote><div><br></div><div>&#xA0; &#xA0; &#xA0;2. cache_estimate</div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;1504&#xA0;&#xA0;&#xA0;&#xA0; for (order = 0; order &lt; MAX_ORDER; order++) {<br></font></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1505&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; cache_estimate(order, cache_cache.buffer_size,</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1506&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; cache_line_size(), 0, &amp;left_over, &amp;cache_cache.num);</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1507&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (cache_cache.num)</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1508&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; break;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">1509&#xA0;&#xA0;&#xA0;&#xA0; }</font></div></blockquote>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4F5C;&#x7528;&#x5176;&#x5B9E;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x51B3;&#x5B9A;&#xFF1A;(1)<span style=\"font-family: &apos;Courier New&apos;;\">cache_cache.buffer_size&#xFF0C;&#x4E5F;&#x5C31;&#x662F;cache_cache&#x7684;object size&#xFF0C;&#x4EE5;&#x53CA;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x591A;&#x5C11;&#x4E2A;object&#xA0;</span>(2)<span style=\"font-family: &apos;Courier New&apos;;\">slab manager&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#xFF08;on-slab/off-slab&#xFF1A;&#x770B;&#x770B;flags&#x662F;&#x5426;&#x5305;&#x542B;</span>CFLGS_OFF_SLAB<span style=\"font-family: &apos;Courier New&apos;;\">&#xFF09;</span>(3)<span style=\"font-family: &apos;Courier New&apos;;\">&#x5229;&#x7528;slab&#x4E0A;&#x5269;&#x4F59;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x521D;&#x59CB;&#x5316;coloring&#x673A;&#x5236;&#x3002;</span><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x4E00;&#x4E2A;cache_cache&#x7684;slab&#x7A7A;&#x95F4;&#x5206;&#x5272;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</div><div><img class=\"enMedia\" src=\"/images/slab allocator &#xFF08;1&#xFF09; &#x2014;&#x2014; &#x521D;&#x59CB;&#x5316;/1537085031245\" hash=\"4303d9fccee1ae4e2d8a4614f64d90ca\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5176;&#x4E2D;object&#x7684;size&#x5982;&#x4E0B;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font color=\"#2D4FC9\" face=\"Courier New\">offsetof(struct kmem_cache, nodelists) +&#xA0;nr_node_ids * sizeof(struct kmem_list3 *);</font></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5176;&#x5B9E;&#x5C31;&#x662F;sizeof(kmem_cache)&#x3002;&#x53EF;&#x89C1;cache_cache&#x7684;slab&#x8981;&#x5206;&#x914D;&#x7684;&#x5C31;&#x662F;kmem_cache&#x3002;&#x6700;&#x540E;cache_cache-&gt;slab_size =&#xA0;slab_mgmt_size&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; coloring scheme&#x7684;&#x521D;&#x59CB;&#x5316;&#x4E3A;&#xFF1A;</div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;cache_cache.colour_off = cache_line_size();</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;cache_cache.colour = left_over / cache_cache.colour_off;</font></div><div>&#xA0; &#xA0; &#xA0;</div><div>&#xA0; &#xA0; &#xA0;3. init_list</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5728;kmem_cache_init&#x7684;&#x6700;&#x540E;&#xFF0C;&#x6709;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1604&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; for_each_online_node(nid) {</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1605&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; init_list(&amp;cache_cache, &amp;initkmem_list3[CACHE_CACHE + nid], nid);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1606</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1607&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; init_list(malloc_sizes[INDEX_AC].cs_cachep,</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1608&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &amp;initkmem_list3[SIZE_AC + nid], nid);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1609</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1610&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (INDEX_AC != INDEX_L3) {</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1611&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; init_list(malloc_sizes[INDEX_L3].cs_cachep,</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1612&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &amp;initkmem_list3[SIZE_L3 + nid], nid);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1613&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">1614&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }</font></div></blockquote></blockquote>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">init_list&#x5199;&#x7684;&#x5F88;&#x590D;&#x6742;&#xFF0C;&#x5176;&#x5B9E;&#x4ED4;&#x7EC6;&#x7406;&#x89E3;&#x4E4B;&#x540E;&#xFF0C;&#x5B9E;&#x73B0;&#x7684;&#x5185;&#x5BB9;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x4E3A;cache_cache&#x4EE5;&#x53CA;&#x4E24;&#x4E2A;size cache &#xFF08;INDEX_AC, INDEX_L3&#xFF09;&#x5206;&#x914D;kmem_list3&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5E76;&#x7528;memcpy&#x5C06;</font>initkmem_list3&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x62F7;&#x8D1D;&#x8FC7;&#x6765;&#xFF0C;&#x53E6;&#x5916;&#x518D;&#x7528;MAKE_ALL_LISTS -&gt;&#xA0;MAKE_LIST -&gt;&#xA0;list_splice &#x6765;&#x5408;&#x5E76;initkmem_list3&#x5217;&#x8868;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x3002;<br><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#x53EF;&#x89C1;&#x6709;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x8981;&#x628A;&#x590D;&#x6742;&#x7684;&#x95EE;&#x9898;&#x60F3;&#x7B80;&#x5355;&#x4E86;&#xFF0C;&#x8BE5;&#x4ED4;&#x7EC6;&#x5904;&#x7406;&#x7684;&#x8FD8;&#x662F;&#x8981;&#x4ED4;&#x7EC6;&#x5904;&#x7406;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x9488;&#x5BF9;&#x8FD9;&#x79CD;&#x5217;&#x8868;&#x7ED3;&#x6784;&#x4F53;&#x3002;</blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">kmem_cache_init&#x4E2D;&#x4E5F;&#x8FD0;&#x7528;kmem_cache_create&#x6765;&#x5206;&#x914D;cache&#x4E86;&#xFF0C;&#x4F46;&#x8FD9;&#x4E2A;&#x8FC7;&#x4E8E;&#x590D;&#x6742;&#xFF0C;&#x5C06;&#x5728;&#x53E6;&#x4E00;&#x7BC7;&#x7B14;&#x8BB0;&#x4E2D;&#x52A0;&#x4EE5;&#x9610;&#x8FF0;<a href=\"evernote:///view/161681/s10/e3b971bf-908b-4dda-8c29-d37666e83f1c/e3b971bf-908b-4dda-8c29-d37666e83f1c/\" style=\"color: rgb(105, 170, 53);\">slab allocator &#xFF08;2&#xFF09;&#x2014;&#x2014; kmem_cache_create</a>&#x3002;</blockquote><div><br></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/12/migrate_type%E2%80%94%E2%80%94buddy_system%E7%9A%84%E5%A5%BD%E6%90%AD%E6%A1%A3/",
            "url": "https://blog.zhougy.top/2012/12/12/migrate_type%E2%80%94%E2%80%94buddy_system%E7%9A%84%E5%A5%BD%E6%90%AD%E6%A1%A3/",
            "title": "migrate type——buddy system的好搭档",
            "date_published": "2012-12-12T13:49:24.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;Linux&#x4E00;&#x5171;&#x5B9A;&#x4E49;5&#x4E2D;migrate type&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;<div><br><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_UNMOVABLE&#xA0;&#xA0;&#xA0;&#xA0; 0</font></div><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_RECLAIMABLE&#xA0;&#xA0; 1<br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_MOVABLE&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 2</font>&#xA0;&#xA0;<font color=\"#41AD1C\" face=\"Courier New\">/* &#x672A;&#x89C1;&#x6709;&#x4F7F;&#x7528;&#x8BE5;&#x6807;&#x5FD7;&#x4F4D;&#x7684;&#x4EE3;&#x7801;*/</font><font color=\"#2D4FC9\" face=\"Courier New\"><br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_PCPTYPES&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 3</font> <font face=\"Courier New\"><font color=\"#41AD1C\">/* the number of types on the pcp lists */</font><br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_RESERVE&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 3<br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_ISOLATE&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 4</font> <font face=\"Courier New\"><font color=\"#41AD1C\">/* can&apos;t allocate from here */</font><br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_TYPES&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 5</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x5B9A;&#x4E49;migrate type&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;</font><a href=\"evernote:///view/161681/s10/47ce963e-2a46-4097-ab3b-85b5e8c113bd/47ce963e-2a46-4097-ab3b-85b5e8c113bd/\" style=\"color: rgb(105, 170, 53);\">linux&#x5185;&#x6838;&#x5BF9;&#x4F19;&#x4F34;&#x7CFB;&#x7EDF;&#x7684;&#x6539;&#x8FDB;--migrate_type</a>&#x3002;&#x7B80;&#x8981;&#x6765;&#x8BF4;&#x5C31;&#x662F;Linux&#x5C06;&#x53EF;&#x79FB;&#x52A8;&#x6216;&#x4E0D;&#x53EF;&#x79FB;&#x52A8;&#x7684;&#x5185;&#x5B58;&#x5206;&#x5F00;&#x5206;&#x914D;&#xFF0C;&#x4EE5;&#x4FBF;&#x6700;&#x5927;&#x7A0B;&#x5EA6;&#x7684;&#x51CF;&#x5C11;&#x788E;&#x7247;&#xFF0C;&#x63D0;&#x5347;&#x5206;&#x914D;&#x5927;&#x5757;&#x5185;&#x5B58;&#x7684;&#x80FD;&#x529B;&#x3002;&#x57FA;&#x4E8E;&#x8FD9;&#x79CD;&#x601D;&#x8DEF;&#xFF0C;&#x53EF;&#x89C1;&#x4E0A;&#x8FF0;5&#x79CD;migrate type&#x6700;&#x91CD;&#x8981;&#x7684;&#x5C31;&#x662F;<span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_UNMOVABLE&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_MOVABLE&#x3002;</span><span style=\"font-family: &apos;Courier New&apos;;\">&#x53E6;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;type&#x5C31;&#x662F;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_RESERVE&#xFF0C;&#x8FD9;&#x8868;&#x793A;page&#x88AB;reserve&#xFF0C;&#x4E0D;&#x63A5;&#x53D7;buddy system&#x7BA1;&#x7406;&#xFF0C;&#x53EF;&#x53C2;&#x89C1;&#x51FD;&#x6570;</span>setup_zone_migrate_reserve&#x3002;&#x5728;&#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x4F1A;&#x4F9D;&#x636E;water mark min&#x6765;reserve&#x4E00;&#x4E9B;page&#x505A;&#x5907;&#x7528;&#x3002;<blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#x8FD9;&#x4E09;&#x4E2A;type&#x662F;&#x7528;&#x5230;&#x6700;&#x591A;&#x7684;&#x4E09;&#x79CD;&#xFF0C;&#x4E0B;&#x9762;&#x7684;fallback&#x673A;&#x5236;&#x4E5F;&#x7528;&#x5230;&#x4E86;</blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">static int fallbacks[MIGRATE_TYPES][MIGRATE_TYPES-1] = {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_UNMOVABLE]&#xA0;&#xA0; = { MIGRATE_RECLAIMABLE, MIGRATE_MOVABLE,&#xA0;&#xA0; MIGRATE_RESERVE },</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_RECLAIMABLE] = { MIGRATE_UNMOVABLE,&#xA0;&#xA0; MIGRATE_MOVABLE,&#xA0;&#xA0; MIGRATE_RESERVE },</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_MOVABLE]&#xA0;&#xA0;&#xA0;&#xA0; = { MIGRATE_RECLAIMABLE, MIGRATE_UNMOVABLE, MIGRATE_RESERVE },</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_RESERVE]&#xA0;&#xA0;&#xA0;&#xA0; = { MIGRATE_RESERVE,&#xA0;&#xA0;&#xA0;&#xA0; MIGRATE_RESERVE,&#xA0;&#xA0; MIGRATE_RESERVE }, /* Never used */</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">};</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div><font face=\"Courier New\">migrate type&#x5728;memmap_init&#x4E2D;&#x521D;&#x59CB;&#x5316;&#x4E3A;MIGRATE_MOVABLE&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">void __meminit memmap_init_zone(unsigned long size, int nid, unsigned long zone,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long start_pfn, enum memmap_context context)<br>{<br>&#xA0;&#xA0;&#xA0;&#xA0; struct page *page;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned long end_pfn = start_pfn + size;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned long pfn;<br>&#xA0;&#xA0;&#xA0;&#xA0; struct zone *z;<br><br>&#xA0;&#xA0;&#xA0;&#xA0; if (highest_memmap_pfn &lt; end_pfn - 1)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; highest_memmap_pfn = end_pfn - 1;<br><br>&#xA0;&#xA0;&#xA0;&#xA0; z = &amp;NODE_DATA(nid)-&gt;node_zones[zone];<br>&#xA0;&#xA0;&#xA0;&#xA0; for (pfn = start_pfn; pfn &lt; end_pfn; pfn++) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; page = pfn_to_page(pfn);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; SetPageReserved(page);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</font> <font face=\"Courier New\"><font color=\"#328712\">/*<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * Mark the block movable so that blocks are reserved for<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * movable at startup. This will force kernel allocations<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * to reserve their blocks rather than leaking throughout<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * the address space during boot when many long-lived<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * kernel allocations are made. Later some blocks near<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * the start are marked MIGRATE_RESERVE by<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * setup_zone_migrate_reserve()<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; *<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * bitmap is created for zone&apos;s valid pfn range. but memmap<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * can be created for invalid pages (for alignment)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * check here not to call set_pageblock_migratetype() against<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * pfn out of zone.<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; */</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if ((z-&gt;zone_start_pfn &lt;= pfn)</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0; &amp;&amp; (pfn &lt; z-&gt;zone_start_pfn + z-&gt;spanned_pages)</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0; &amp;&amp; !(pfn &amp; (pageblock_nr_pages - 1)))</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; set_pageblock_migratetype(page, MIGRATE_MOVABLE);</font><br><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; INIT_LIST_HEAD(&amp;page-&gt;lru);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0;&#xA0; }</font><br><font color=\"#2D4FC9\">}</font></font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\"><font color=\"#2D4FC9\"><br></font></font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">&#x4E0A;&#x9762;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x904D;&#x5386;memmap&#x6570;&#x7EC4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BE5;zone&#x6240;&#x6709;&#x9875;&#x9762;&#x7684;page&#x7ED3;&#x6784;&#x4F53;&#xFF0C;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">1&#xFF09;&#x9996;&#x5148;</font><span style=\"font-family: &apos;Courier New&apos;;\">&#x8BBE;&#x7F6E;</span><span style=\"font-family: &apos;Courier New&apos;;\">page-&gt;flags&#x7684;PG_reserved&#x4F4D;&#xFF0C;&#x610F;&#x601D;&#x662F;&#x4E0D;&#x53D7;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#x63A7;&#x5236;&#x3002;&#x6CA1;&#x9519;&#xFF0C;&#x6B64;&#x65F6;&#x4ECD;&#x5728;bootmem&#x63A7;&#x5236;&#x4E0B;&#xFF0C;&#x4E4B;&#x540E;&#x518D;__free_pages_bootmem&#x65F6;&#xFF0C;&#x4F1A;&#x6E05;&#x9664;&#x8BE5;&#x4F4D;&#xFF0C;&#x5C06;&#x5176;&#x7EB3;&#x5165;buddy&#x7CFB;&#x7EDF;&#x3002;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><span style=\"font-family: &apos;Courier New&apos;;\">2&#xFF09;&#x4E4B;&#x540E;</span><span style=\"font-family: &apos;Courier New&apos;;\">set_pageblock_migratetype&#x5C06;&#x6240;&#x6709;page&#x7684;migrate type&#x8BBE;&#x4E3A;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_MOVABLE&#x3002;&#x4E4B;&#x524D;&#x63D0;&#x5230;&#x7684;&#x6309;&#x7167;water mark min&#x6765;reserve&#x4E00;&#x4E9B;&#x9875;&#x9762;&#xFF0C;&#x987A;&#x5E8F;&#x4E0A;&#x5728;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x540E;&#x9762;&#x624D;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">3&#xFF09;&#x518D;&#x770B;&#x4E00;&#x4E0B;migrate type&#x7684;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;&#xFF0C;set_pageblock_migratetype -&gt;&#xA0;set_pageblock_flags_group</blockquote></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">void set_pageblock_flags_group(struct page *page, unsigned long flags,</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; int start_bitidx, int end_bitidx)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">{</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct zone *zone;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long *bitmap;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long pfn, bitidx;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long value = 1;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; zone = page_zone(page);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; pfn = page_to_pfn(page);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; bitmap = get_pageblock_bitmap(zone, pfn);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; bitidx = pfn_to_bitidx(zone, pfn);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; for (; start_bitidx &lt;= end_bitidx; start_bitidx++, value &lt;&lt;= 1)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (flags &amp; value)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; __set_bit(bitidx + start_bitidx, bitmap);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; __clear_bit(bitidx + start_bitidx, bitmap);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">}</font></div></blockquote>&#xA0; &#xA0; &#xA0;&#x6CA1;&#x6709;&#x60F3;&#x8C61;&#x7684;&#x90A3;&#x4E48;&#x7B80;&#x5355;&#x5427;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;bitmap&#xFF0C;&#x4ED6;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x5982;&#x4E0B;&#xFF1A;</blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">static unsigned long __init usemap_size(unsigned long zonesize)</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">{</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long usemapsize;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize = roundup(zonesize, pageblock_nr_pages);</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize = usemapsize &gt;&gt; pageblock_order;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize *= NR_PAGEBLOCK_BITS;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize = roundup(usemapsize, 8 * sizeof(unsigned long));</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; return usemapsize / 8;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">static void __init setup_usemap(struct pglist_data *pgdat,</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; struct zone *zone, unsigned long zonesize)</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">{</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long usemapsize = usemap_size(zonesize);</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; zone-&gt;pageblock_flags = NULL;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; if (usemapsize)</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; zone-&gt;pageblock_flags = alloc_bootmem_node(pgdat, usemapsize);</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></blockquote></blockquote></blockquote>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x6240;&#x8C13;&#x7684;bitmap&#x5C31;&#x662F;<span style=\"font-family: &apos;Courier New&apos;;\">zone-&gt;pageblock_flags&#x3002;&#x6BCF;&#x4E2A;zone&#x88AB;&#x5206;&#x5272;&#x6210;&#x82E5;&#x5E72;&#x4E2A;pageblock&#xFF0C;&#x6BCF;&#x4E2A;pageblock&#x5206;&#x914D;3&#x4F4D;&#x6765;&#x8868;&#x793A;migrate type&#x3002;pageblock&#x5176;&#x5B9E;&#x5C31;&#x662F;freearea&#x4E2D;order&#x6700;&#x5927;&#x7684;&#x4E00;&#x5757;&#x5185;&#x5B58;&#xFF0C;&#x4ECE;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;&#xFF1A;</span><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">free_area_init_core -&gt;&#xA0;set_pageblock_order(pageblock_default_order())</font></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">static inline int pageblock_default_order(void)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">{</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; if (HPAGE_SHIFT &gt; PAGE_SHIFT)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return HUGETLB_PAGE_ORDER;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; return MAX_ORDER-1;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">}</font></div></blockquote></blockquote><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7528;get_pageblock_migratetype(page)&#x6765;&#x83B7;&#x5F97;&#x672C;page&#x7684;migrate type&#x3002;&#x56E0;&#x4E3A;&#x53EA;&#x8981;&#x6CA1;&#x6709;&#x505A;migrate type&#x7684;&#x8FC1;&#x79FB;&#xFF0C;&#x6BCF;&#x4E2A;page&#x7684;migrate type&#x603B;&#x662F;&#x548C;&#x4ED6;&#x6240;&#x5728;&#x7684;pageblock&#x662F;&#x4E00;&#x81F4;&#x7684;&#x3002;migrate type&#x53EA;&#x4F1A;&#x5728;fallback&#x673A;&#x5236;&#x4E2D;&#x6539;&#x53D8;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x672C;migrate type&#x4E2D;&#x65E0;&#x5185;&#x5B58;&#x53EF;&#x5206;&#x914D;&#xFF0C;&#x5C31;&#x8981;&#x53BB;&#x5907;&#x7528;&#x7684;migrate type&#x5217;&#x8868;&#x4E2D;&#x627E;&#x6700;&#x5927;&#x5757;&#x5185;&#x5B58;&#xFF0C;&#x8FC1;&#x79FB;&#x8FC7;&#x6765;&#xFF0C;&#x518D;&#x4E0D;&#x6D4E;&#x8FD8;&#x6709;reserved&#x7684;&#x9875;&#x9762;&#x3002;</div><div><br></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x4E0B;&#x9762;&#x5206;&#x6790;&#x4E00;&#x4E0B;migrate type&#x662F;&#x5982;&#x4F55;&#x6539;&#x53D8;&#x7684;&#x3002;&#x8FD8;&#x662F;&#x6709;&#x70B9;&#x5C0F;&#x590D;&#x6742;&#x7684;&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;<img class=\"enMedia\" src=\"/images/migrate type&#x2014;&#x2014;buddy system&#x7684;&#x597D;&#x642D;&#x6863;/1537085032358\" hash=\"78d55e4b7bcdd406f2bf0b19ceba585b\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 1&#xFF09;&#x9996;&#x5148;&#x6240;&#x6709;&#x8BB2;&#x5230;fallback&#x673A;&#x5236;&#x7684;&#x8D44;&#x6599;&#x4E0A;&#x90FD;&#x4F1A;&#x63D0;&#x9192;&#x6211;&#x4EEC;&#x6CE8;&#x610F;&#xFF0C;&#x5728;&#x4ECE;backup migratetype&#x4E2D;&#x53D6;&#x5185;&#x5B58;&#x65F6;&#xFF0C;&#x662F;&#x4ECE;&#x5927;&#x7684;order&#x5F80;&#x5C0F;order&#x9012;&#x51CF;&#xFF0C;&#x76F4;&#x5230;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;order&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5C31;&#x8FD4;&#x56DE;NULL</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 2&#xFF09;&#x7B2C;&#x4E8C;&#x70B9;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;fallback&#x673A;&#x5236;&#x4E00;&#x8D77;&#x4F5C;&#x7528;&#xFF0C;page&#x7684;migratetype&#x5C31;&#x4F1A;&#x6539;&#x53D8;&#x3002;&#x800C;&#x662F;&#x5728;&#x6EE1;&#x8DB3;&#x4E00;&#x5B9A;&#x7684;&#x6761;&#x4EF6;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x624D;&#x4F1A;&#x53D1;&#x751F;&#x3002;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#x7EA2;&#x5708;&#x4E2D;&#x7684;&#xFF0C;&#x4EE5;&#x53CA;&#x4E0B;&#x9762;&#x7684;page moved &gt;= pageblock / 2&#x3002;&#x4EC0;&#x4E48;&#x610F;&#x601D;&#x5462;&#xFF1F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5F53;&#x627E;&#x5230;&#x7684;&#x8FD9;&#x5757;&#x5927;&#x5185;&#x5B58;&#x7684;order&#x8D85;&#x8FC7;pageblock_order&#x7684;&#x4E00;&#x534A;&#xFF0C;&#x4EE5;7800&#x4E3A;&#x4F8B;&#xFF0C;default pageblock_order&#x662F;MAX_ORDER-1 = 10&#xFF0C;&#x5219;&#x8FD9;&#x5757;&#x5185;&#x5B58;order&#x8981;&#x8D85;&#x8FC7;5&#xFF0C;&#x5C31;&#x662F;32&#x4E2A;page&#x3002;&#x7B2C;&#x4E8C;&#x4E2A;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#xFF0C;&#x8FD9;&#x5757;&#x5927;&#x5185;&#x5B58;&#x6240;&#x5728;&#x7684;pageblock&#x4E0A;&#x6709;&#x8D85;&#x8FC7;&#x4E00;&#x534A;&#x7684;&#x7A7A;&#x95F2;buddy&#x3002;&#x82E5;&#x6EE1;&#x8DB3;&#x8FD9;&#x4E24;&#x70B9;&#xFF0C;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x6240;&#x5728;&#x7684;pageblock&#x7684;migratetype&#x4F1A;&#x88AB;&#x4FEE;&#x6539;&#xFF0C;&#x90A3;&#x4E48;&#x5C5E;&#x4E8E;&#x4ED6;&#x4E14;&#x5DF2;&#x5206;&#x914D;&#x51FA;&#x53BB;&#x7684;buddy&#x5728;&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x4F1A;&#x88AB;&#x5408;&#x5E76;&#x5230;&#x65B0;&#x7684;migratetype&#x4E2D;&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 3&#xFF09;&#x6211;&#x4EEC;&#x5728;&#x6D4B;&#x8BD5;&#x4E0A;&#x9762;&#x6240;&#x8BF4;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x4F1A;&#x5148;&#x5C06;pageblock&#x4E2D;&#x7A7A;&#x95F2;&#x7684;buddy&#x79FB;&#x5230;&#x65B0;&#x7684;migratetype&#x4E2D;&#xFF0C;&#x4F46;&#x5E76;&#x4E0D;&#x771F;&#x6B63;&#x7684;&#x6539;&#x53D8;&#x5176;migratetype&#x3002;&#x56E0;&#x4E3A;&#x6D89;&#x53CA;&#x5230;&#x83B7;&#x53D6;migratetype&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x662F;&#x901A;&#x8FC7;&#x51FD;&#x6570;get_pageblock_migratetype&#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x53EA;&#x8981;&#x4E0D;&#x4FEE;&#x6539;&#x6574;&#x5757;pageblock&#x7684;migratetype&#x5C31;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x5176;&#x4E0B;&#x6240;&#x6709;buddy&#x7684;migratetype&#x5C5E;&#x6027;&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 4&#xFF09;&#x5F53;&#x627E;&#x5230;&#x7684;&#x8FD9;&#x5757;&#x5927;&#x5185;&#x5B58;&#x8D85;&#x8FC7;pageblock&#x65F6;&#xFF0C;&#x4F1A;&#x5C06;&#x5176;&#x4E0B;&#x6240;&#x6709;&#x7684;pageblock&#x7684;migratetype&#x90FD;&#x4FEE;&#x6539;&#x6210;&#x6211;&#x4EEC;&#x6240;&#x9700;&#x8981;&#x7684;migratetype&#x3002;&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x53CD;&#x6620;&#x51FA;&#x7684;&#x601D;&#x60F3;&#x548C;&#x4E0A;&#x9762;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x5C31;&#x662F;&#x627E;&#x5230;&#x7684;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x8DB3;&#x591F;&#x5927;&#xFF0C;&#x5C31;&#x8FC1;&#x79FB;migratetype&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 5&#xFF09;&#x6700;&#x540E;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x4E00;&#x70B9;&#x5C31;&#x662F;&#xFF0C;&#x7EA2;&#x5708;&#x4E2D;&#x7684;&#x6761;&#x4EF6;&#x5224;&#x65AD;&#x5176;&#x5B9E;&#x4E0D;&#x5B8C;&#x6574;&#xFF0C;&#x771F;&#x5B9E;&#x4EE3;&#x7801;&#x4E2D;&#x7684;&#x5224;&#x65AD;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">if (unlikely(current_order &gt;= (pageblock_order &gt;&gt; 1)) ||</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; start_migratetype == MIGRATE_RECLAIMABLE ||</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;page_group_by_mobility_disabled) { &#x2026;&#x2026; }&#xA0;</font></div></blockquote>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &apos;Courier New&apos;;\">page_group_by_mobility_disabled&#x8868;&#x793A;&#x8FC1;&#x79FB;&#x7279;&#x6027;&#x5173;&#x95ED;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x9875;&#x9762;&#x5E76;&#x4E0D;&#x53D7;migratetype&#x6240;&#x9650;&#x5236;&#xFF0C;&#x90A3;&#x9875;&#x9762;&#x5E94;&#x8BE5;&#x53EF;&#x4EE5;&#x968F;&#x5FC3;&#x6240;&#x6B32;&#x7684;&#x8FC1;&#x79FB;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x786E;&#x5B9E;&#x5982;&#x6B64;&#xFF0C;&#x540E;&#x9762;&#x5982;&#x679C;</span><span style=\"font-family: &apos;Courier New&apos;;\">page_group_by_mobility_disabled&#xFF0C;&#x4E5F;&#x5E76;&#x4E0D;&#x9700;&#x8981;&#x5224;&#x65AD;&#x6709;&#x591A;&#x5C11;free buddy&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8FC1;&#x79FB;&#x9875;&#x9762;&#x4E86;&#x3002;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#xFF0C;<span style=\"font-family: &apos;Courier New&apos;;\">start_migratetype == MIGRATE_RECLAIMABLE&#x5C31;&#x503C;&#x5F97;&#x63A8;&#x6572;&#x4E86;&#x3002;&#x6240;&#x6709;&#x4EE3;&#x7801;&#x4E2D;&#x90FD;&#x6CA1;&#x6709;&#x770B;&#x5230;&#x5BF9;&#x5176;&#x7684;&#x4F7F;&#x7528;&#x3002;&#x7F51;&#x7EDC;&#x4E0A;&#x5BF9;&#x5176;&#x7684;&#x89E3;&#x91CA;&#x662F;&#xFF1A;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<i><span style=\"box-sizing: inherit !important; padding: 0px; margin: 0px; cursor: default; font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;, Verdana, sans-serif, &#x5B8B;&#x4F53;; text-align: left; background-color: rgb(255, 255, 255);\">&#x53EF;&#x56DE;&#x6536;&#x9875;&#xFF1A;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x79FB;&#x52A8;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x5220;&#x9664;&#xFF0C;&#x5176;&#x5185;&#x5BB9;&#x53EF;&#x4EE5;&#x4ECE;&#x67D0;&#x4E9B;&#x6E90;&#x91CD;&#x65B0;&#x751F;&#x6210;</span><span style=\"box-sizing: inherit !important; padding: 0px; margin: 0px; cursor: default; font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;, Verdana, sans-serif, &#x5B8B;&#x4F53;; text-align: left; background-color: rgb(255, 255, 255);\">&#xA0;&#xA0;</span></i></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0;&#x6240;&#x4EE5;&#x6211;&#x8BA4;&#x4E3A;<span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_RECLAIMABLE&#x56E0;&#x4E3A;&#x5F88;&#x5BB9;&#x6613;&#x88AB;&#x91CA;&#x653E;&#xFF08;&#x6216;&#x53EB;&#x56DE;&#x6536;&#xFF09;&#xFF0C;&#x4ED6;&#x4E5F;&#x662F;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_UNMOVABLE&#x548C;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_MOVABLE&#x7684;&#x7B2C;&#x4E00;&#x66FF;&#x8865;</span><span style=\"font-family: &apos;Courier New&apos;;\">&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">&#x6240;&#x4EE5;&#x4E0D;&#x7BA1;&#x627E;&#x5230;&#x7684;&#x7A7A;&#x95F2;&#x9875;&#x9762;&#x6709;&#x591A;&#x5927;&#xFF0C;&#x90FD;&#x5E94;&#x8BE5;&#x5C3D;&#x53EF;&#x80FD;&#x7684;&#x8FC1;&#x79FB;&#x7ED9;&#x4ED6;&#x3002;</span></blockquote><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<br><div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote></div></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/12/12/migrate_type-buddy_system%E7%9A%84%E5%A5%BD%E6%90%AD%E6%A1%A3/",
            "url": "https://blog.zhougy.top/2012/12/12/migrate_type-buddy_system%E7%9A%84%E5%A5%BD%E6%90%AD%E6%A1%A3/",
            "title": "migrate type——buddy system的好搭档",
            "date_published": "2012-12-12T13:49:24.000Z",
            "content_html": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE en-note SYSTEM \"http://xml.evernote.com/pub/enml2.dtd\"><div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; display: block;\" title lang xml:lang dir>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;Linux&#x4E00;&#x5171;&#x5B9A;&#x4E49;5&#x4E2D;migrate type&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;<div style=\"display: block;\"><br><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_UNMOVABLE&#xA0;&#xA0;&#xA0;&#xA0; 0</font></div><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_RECLAIMABLE&#xA0;&#xA0; 1<br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_MOVABLE&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 2</font>&#xA0;&#xA0;<font color=\"#41AD1C\" face=\"Courier New\">/* &#x672A;&#x89C1;&#x6709;&#x4F7F;&#x7528;&#x8BE5;&#x6807;&#x5FD7;&#x4F4D;&#x7684;&#x4EE3;&#x7801;*/</font><font color=\"#2D4FC9\" face=\"Courier New\"><br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_PCPTYPES&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 3</font> <font face=\"Courier New\"><font color=\"#41AD1C\">/* the number of types on the pcp lists */</font><br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_RESERVE&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 3<br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_ISOLATE&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 4</font> <font face=\"Courier New\"><font color=\"#41AD1C\">/* can&apos;t allocate from here */</font><br></font><font color=\"#2D4FC9\" face=\"Courier New\">#define MIGRATE_TYPES&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 5</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x5B9A;&#x4E49;migrate type&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;</font><a href=\"evernote:///view/161681/s10/47ce963e-2a46-4097-ab3b-85b5e8c113bd/47ce963e-2a46-4097-ab3b-85b5e8c113bd/\" style=\"color: rgb(105, 170, 53);\">linux&#x5185;&#x6838;&#x5BF9;&#x4F19;&#x4F34;&#x7CFB;&#x7EDF;&#x7684;&#x6539;&#x8FDB;--migrate_type</a>&#x3002;&#x7B80;&#x8981;&#x6765;&#x8BF4;&#x5C31;&#x662F;Linux&#x5C06;&#x53EF;&#x79FB;&#x52A8;&#x6216;&#x4E0D;&#x53EF;&#x79FB;&#x52A8;&#x7684;&#x5185;&#x5B58;&#x5206;&#x5F00;&#x5206;&#x914D;&#xFF0C;&#x4EE5;&#x4FBF;&#x6700;&#x5927;&#x7A0B;&#x5EA6;&#x7684;&#x51CF;&#x5C11;&#x788E;&#x7247;&#xFF0C;&#x63D0;&#x5347;&#x5206;&#x914D;&#x5927;&#x5757;&#x5185;&#x5B58;&#x7684;&#x80FD;&#x529B;&#x3002;&#x57FA;&#x4E8E;&#x8FD9;&#x79CD;&#x601D;&#x8DEF;&#xFF0C;&#x53EF;&#x89C1;&#x4E0A;&#x8FF0;5&#x79CD;migrate type&#x6700;&#x91CD;&#x8981;&#x7684;&#x5C31;&#x662F;<span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_UNMOVABLE&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_MOVABLE&#x3002;</span><span style=\"font-family: &apos;Courier New&apos;;\">&#x53E6;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;type&#x5C31;&#x662F;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_RESERVE&#xFF0C;&#x8FD9;&#x8868;&#x793A;page&#x88AB;reserve&#xFF0C;&#x4E0D;&#x63A5;&#x53D7;buddy system&#x7BA1;&#x7406;&#xFF0C;&#x53EF;&#x53C2;&#x89C1;&#x51FD;&#x6570;</span>setup_zone_migrate_reserve&#x3002;&#x5728;&#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x4F1A;&#x4F9D;&#x636E;water mark min&#x6765;reserve&#x4E00;&#x4E9B;page&#x505A;&#x5907;&#x7528;&#x3002;<blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#x8FD9;&#x4E09;&#x4E2A;type&#x662F;&#x7528;&#x5230;&#x6700;&#x591A;&#x7684;&#x4E09;&#x79CD;&#xFF0C;&#x4E0B;&#x9762;&#x7684;fallback&#x673A;&#x5236;&#x4E5F;&#x7528;&#x5230;&#x4E86;</blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">static int fallbacks[MIGRATE_TYPES][MIGRATE_TYPES-1] = {</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_UNMOVABLE]&#xA0;&#xA0; = { MIGRATE_RECLAIMABLE, MIGRATE_MOVABLE,&#xA0;&#xA0; MIGRATE_RESERVE },</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_RECLAIMABLE] = { MIGRATE_UNMOVABLE,&#xA0;&#xA0; MIGRATE_MOVABLE,&#xA0;&#xA0; MIGRATE_RESERVE },</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_MOVABLE]&#xA0;&#xA0;&#xA0;&#xA0; = { MIGRATE_RECLAIMABLE, MIGRATE_UNMOVABLE, MIGRATE_RESERVE },</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; [MIGRATE_RESERVE]&#xA0;&#xA0;&#xA0;&#xA0; = { MIGRATE_RESERVE,&#xA0;&#xA0;&#xA0;&#xA0; MIGRATE_RESERVE,&#xA0;&#xA0; MIGRATE_RESERVE }, /* Never used */</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">};</font></div><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div style=\"display: block;\"><font face=\"Courier New\">migrate type&#x5728;memmap_init&#x4E2D;&#x521D;&#x59CB;&#x5316;&#x4E3A;MIGRATE_MOVABLE&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">void __meminit memmap_init_zone(unsigned long size, int nid, unsigned long zone,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long start_pfn, enum memmap_context context)<br>{<br>&#xA0;&#xA0;&#xA0;&#xA0; struct page *page;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned long end_pfn = start_pfn + size;<br>&#xA0;&#xA0;&#xA0;&#xA0; unsigned long pfn;<br>&#xA0;&#xA0;&#xA0;&#xA0; struct zone *z;<br><br>&#xA0;&#xA0;&#xA0;&#xA0; if (highest_memmap_pfn &lt; end_pfn - 1)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; highest_memmap_pfn = end_pfn - 1;<br><br>&#xA0;&#xA0;&#xA0;&#xA0; z = &amp;NODE_DATA(nid)-&gt;node_zones[zone];<br>&#xA0;&#xA0;&#xA0;&#xA0; for (pfn = start_pfn; pfn &lt; end_pfn; pfn++) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; page = pfn_to_page(pfn);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; SetPageReserved(page);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</font> <font face=\"Courier New\"><font color=\"#328712\">/*<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * Mark the block movable so that blocks are reserved for<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * movable at startup. This will force kernel allocations<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * to reserve their blocks rather than leaking throughout<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * the address space during boot when many long-lived<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * kernel allocations are made. Later some blocks near<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * the start are marked MIGRATE_RESERVE by<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * setup_zone_migrate_reserve()<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; *<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * bitmap is created for zone&apos;s valid pfn range. but memmap<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * can be created for invalid pages (for alignment)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * check here not to call set_pageblock_migratetype() against<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * pfn out of zone.<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; */</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if ((z-&gt;zone_start_pfn &lt;= pfn)</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0; &amp;&amp; (pfn &lt; z-&gt;zone_start_pfn + z-&gt;spanned_pages)</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0; &amp;&amp; !(pfn &amp; (pageblock_nr_pages - 1)))</font><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; set_pageblock_migratetype(page, MIGRATE_MOVABLE);</font><br><br><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; INIT_LIST_HEAD(&amp;page-&gt;lru);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0;&#xA0; }</font><br><font color=\"#2D4FC9\">}</font></font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\"><font color=\"#2D4FC9\"><br></font></font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">&#x4E0A;&#x9762;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x904D;&#x5386;memmap&#x6570;&#x7EC4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BE5;zone&#x6240;&#x6709;&#x9875;&#x9762;&#x7684;page&#x7ED3;&#x6784;&#x4F53;&#xFF0C;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">1&#xFF09;&#x9996;&#x5148;</font><span style=\"font-family: &apos;Courier New&apos;;\">&#x8BBE;&#x7F6E;</span><span style=\"font-family: &apos;Courier New&apos;;\">page-&gt;flags&#x7684;PG_reserved&#x4F4D;&#xFF0C;&#x610F;&#x601D;&#x662F;&#x4E0D;&#x53D7;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#x63A7;&#x5236;&#x3002;&#x6CA1;&#x9519;&#xFF0C;&#x6B64;&#x65F6;&#x4ECD;&#x5728;bootmem&#x63A7;&#x5236;&#x4E0B;&#xFF0C;&#x4E4B;&#x540E;&#x518D;__free_pages_bootmem&#x65F6;&#xFF0C;&#x4F1A;&#x6E05;&#x9664;&#x8BE5;&#x4F4D;&#xFF0C;&#x5C06;&#x5176;&#x7EB3;&#x5165;buddy&#x7CFB;&#x7EDF;&#x3002;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><span style=\"font-family: &apos;Courier New&apos;;\">2&#xFF09;&#x4E4B;&#x540E;</span><span style=\"font-family: &apos;Courier New&apos;;\">set_pageblock_migratetype&#x5C06;&#x6240;&#x6709;page&#x7684;migrate type&#x8BBE;&#x4E3A;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_MOVABLE&#x3002;&#x4E4B;&#x524D;&#x63D0;&#x5230;&#x7684;&#x6309;&#x7167;water mark min&#x6765;reserve&#x4E00;&#x4E9B;&#x9875;&#x9762;&#xFF0C;&#x987A;&#x5E8F;&#x4E0A;&#x5728;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x540E;&#x9762;&#x624D;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">3&#xFF09;&#x518D;&#x770B;&#x4E00;&#x4E0B;migrate type&#x7684;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;&#xFF0C;set_pageblock_migratetype -&gt;&#xA0;set_pageblock_flags_group</blockquote></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">void set_pageblock_flags_group(struct page *page, unsigned long flags,</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; int start_bitidx, int end_bitidx)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">{</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; struct zone *zone;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long *bitmap;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long pfn, bitidx;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long value = 1;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; zone = page_zone(page);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; pfn = page_to_pfn(page);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; bitmap = get_pageblock_bitmap(zone, pfn);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; bitidx = pfn_to_bitidx(zone, pfn);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; for (; start_bitidx &lt;= end_bitidx; start_bitidx++, value &lt;&lt;= 1)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (flags &amp; value)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; __set_bit(bitidx + start_bitidx, bitmap);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; __clear_bit(bitidx + start_bitidx, bitmap);</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></div></blockquote>&#xA0; &#xA0; &#xA0;&#x6CA1;&#x6709;&#x60F3;&#x8C61;&#x7684;&#x90A3;&#x4E48;&#x7B80;&#x5355;&#x5427;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;bitmap&#xFF0C;&#x4ED6;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x5982;&#x4E0B;&#xFF1A;</blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">static unsigned long __init usemap_size(unsigned long zonesize)</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">{</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long usemapsize;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize = roundup(zonesize, pageblock_nr_pages);</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize = usemapsize &gt;&gt; pageblock_order;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize *= NR_PAGEBLOCK_BITS;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; usemapsize = roundup(usemapsize, 8 * sizeof(unsigned long));</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; return usemapsize / 8;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">static void __init setup_usemap(struct pglist_data *pgdat,</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; struct zone *zone, unsigned long zonesize)</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">{</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; unsigned long usemapsize = usemap_size(zonesize);</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; zone-&gt;pageblock_flags = NULL;</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; if (usemapsize)</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; zone-&gt;pageblock_flags = alloc_bootmem_node(pgdat, usemapsize);</font></blockquote></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></blockquote></blockquote></blockquote>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x6240;&#x8C13;&#x7684;bitmap&#x5C31;&#x662F;<span style=\"font-family: &apos;Courier New&apos;;\">zone-&gt;pageblock_flags&#x3002;&#x6BCF;&#x4E2A;zone&#x88AB;&#x5206;&#x5272;&#x6210;&#x82E5;&#x5E72;&#x4E2A;pageblock&#xFF0C;&#x6BCF;&#x4E2A;pageblock&#x5206;&#x914D;3&#x4F4D;&#x6765;&#x8868;&#x793A;migrate type&#x3002;pageblock&#x5176;&#x5B9E;&#x5C31;&#x662F;freearea&#x4E2D;order&#x6700;&#x5927;&#x7684;&#x4E00;&#x5757;&#x5185;&#x5B58;&#xFF0C;&#x4ECE;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;&#xFF1A;</span><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">free_area_init_core -&gt;&#xA0;set_pageblock_order(pageblock_default_order())</font></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">static inline int pageblock_default_order(void)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">{</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; if (HPAGE_SHIFT &gt; PAGE_SHIFT)</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return HUGETLB_PAGE_ORDER;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0; return MAX_ORDER-1;</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">}</font></div></blockquote></blockquote><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7528;get_pageblock_migratetype(page)&#x6765;&#x83B7;&#x5F97;&#x672C;page&#x7684;migrate type&#x3002;&#x56E0;&#x4E3A;&#x53EA;&#x8981;&#x6CA1;&#x6709;&#x505A;migrate type&#x7684;&#x8FC1;&#x79FB;&#xFF0C;&#x6BCF;&#x4E2A;page&#x7684;migrate type&#x603B;&#x662F;&#x548C;&#x4ED6;&#x6240;&#x5728;&#x7684;pageblock&#x662F;&#x4E00;&#x81F4;&#x7684;&#x3002;migrate type&#x53EA;&#x4F1A;&#x5728;fallback&#x673A;&#x5236;&#x4E2D;&#x6539;&#x53D8;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x672C;migrate type&#x4E2D;&#x65E0;&#x5185;&#x5B58;&#x53EF;&#x5206;&#x914D;&#xFF0C;&#x5C31;&#x8981;&#x53BB;&#x5907;&#x7528;&#x7684;migrate type&#x5217;&#x8868;&#x4E2D;&#x627E;&#x6700;&#x5927;&#x5757;&#x5185;&#x5B58;&#xFF0C;&#x8FC1;&#x79FB;&#x8FC7;&#x6765;&#xFF0C;&#x518D;&#x4E0D;&#x6D4E;&#x8FD8;&#x6709;reserved&#x7684;&#x9875;&#x9762;&#x3002;</div><div style=\"display: block;\"><br></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x4E0B;&#x9762;&#x5206;&#x6790;&#x4E00;&#x4E0B;migrate type&#x662F;&#x5982;&#x4F55;&#x6539;&#x53D8;&#x7684;&#x3002;&#x8FD8;&#x662F;&#x6709;&#x70B9;&#x5C0F;&#x590D;&#x6742;&#x7684;&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;<img class=\"enMedia\" src=\"/images/migrate type&#x2014;&#x2014;buddy system&#x7684;&#x597D;&#x642D;&#x6863;/1499486799151\" hash=\"78d55e4b7bcdd406f2bf0b19ceba585b\" align alt longdesc width=\"910\" height=\"657\" border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 1&#xFF09;&#x9996;&#x5148;&#x6240;&#x6709;&#x8BB2;&#x5230;fallback&#x673A;&#x5236;&#x7684;&#x8D44;&#x6599;&#x4E0A;&#x90FD;&#x4F1A;&#x63D0;&#x9192;&#x6211;&#x4EEC;&#x6CE8;&#x610F;&#xFF0C;&#x5728;&#x4ECE;backup migratetype&#x4E2D;&#x53D6;&#x5185;&#x5B58;&#x65F6;&#xFF0C;&#x662F;&#x4ECE;&#x5927;&#x7684;order&#x5F80;&#x5C0F;order&#x9012;&#x51CF;&#xFF0C;&#x76F4;&#x5230;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;order&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5C31;&#x8FD4;&#x56DE;NULL</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 2&#xFF09;&#x7B2C;&#x4E8C;&#x70B9;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;fallback&#x673A;&#x5236;&#x4E00;&#x8D77;&#x4F5C;&#x7528;&#xFF0C;page&#x7684;migratetype&#x5C31;&#x4F1A;&#x6539;&#x53D8;&#x3002;&#x800C;&#x662F;&#x5728;&#x6EE1;&#x8DB3;&#x4E00;&#x5B9A;&#x7684;&#x6761;&#x4EF6;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x624D;&#x4F1A;&#x53D1;&#x751F;&#x3002;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#x7EA2;&#x5708;&#x4E2D;&#x7684;&#xFF0C;&#x4EE5;&#x53CA;&#x4E0B;&#x9762;&#x7684;page moved &gt;= pageblock / 2&#x3002;&#x4EC0;&#x4E48;&#x610F;&#x601D;&#x5462;&#xFF1F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5F53;&#x627E;&#x5230;&#x7684;&#x8FD9;&#x5757;&#x5927;&#x5185;&#x5B58;&#x7684;order&#x8D85;&#x8FC7;pageblock_order&#x7684;&#x4E00;&#x534A;&#xFF0C;&#x4EE5;7800&#x4E3A;&#x4F8B;&#xFF0C;default pageblock_order&#x662F;MAX_ORDER-1 = 10&#xFF0C;&#x5219;&#x8FD9;&#x5757;&#x5185;&#x5B58;order&#x8981;&#x8D85;&#x8FC7;5&#xFF0C;&#x5C31;&#x662F;32&#x4E2A;page&#x3002;&#x7B2C;&#x4E8C;&#x4E2A;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#xFF0C;&#x8FD9;&#x5757;&#x5927;&#x5185;&#x5B58;&#x6240;&#x5728;&#x7684;pageblock&#x4E0A;&#x6709;&#x8D85;&#x8FC7;&#x4E00;&#x534A;&#x7684;&#x7A7A;&#x95F2;buddy&#x3002;&#x82E5;&#x6EE1;&#x8DB3;&#x8FD9;&#x4E24;&#x70B9;&#xFF0C;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x6240;&#x5728;&#x7684;pageblock&#x7684;migratetype&#x4F1A;&#x88AB;&#x4FEE;&#x6539;&#xFF0C;&#x90A3;&#x4E48;&#x5C5E;&#x4E8E;&#x4ED6;&#x4E14;&#x5DF2;&#x5206;&#x914D;&#x51FA;&#x53BB;&#x7684;buddy&#x5728;&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x4F1A;&#x88AB;&#x5408;&#x5E76;&#x5230;&#x65B0;&#x7684;migratetype&#x4E2D;&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 3&#xFF09;&#x6211;&#x4EEC;&#x5728;&#x6D4B;&#x8BD5;&#x4E0A;&#x9762;&#x6240;&#x8BF4;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x4F1A;&#x5148;&#x5C06;pageblock&#x4E2D;&#x7A7A;&#x95F2;&#x7684;buddy&#x79FB;&#x5230;&#x65B0;&#x7684;migratetype&#x4E2D;&#xFF0C;&#x4F46;&#x5E76;&#x4E0D;&#x771F;&#x6B63;&#x7684;&#x6539;&#x53D8;&#x5176;migratetype&#x3002;&#x56E0;&#x4E3A;&#x6D89;&#x53CA;&#x5230;&#x83B7;&#x53D6;migratetype&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x662F;&#x901A;&#x8FC7;&#x51FD;&#x6570;get_pageblock_migratetype&#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x53EA;&#x8981;&#x4E0D;&#x4FEE;&#x6539;&#x6574;&#x5757;pageblock&#x7684;migratetype&#x5C31;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x5176;&#x4E0B;&#x6240;&#x6709;buddy&#x7684;migratetype&#x5C5E;&#x6027;&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 4&#xFF09;&#x5F53;&#x627E;&#x5230;&#x7684;&#x8FD9;&#x5757;&#x5927;&#x5185;&#x5B58;&#x8D85;&#x8FC7;pageblock&#x65F6;&#xFF0C;&#x4F1A;&#x5C06;&#x5176;&#x4E0B;&#x6240;&#x6709;&#x7684;pageblock&#x7684;migratetype&#x90FD;&#x4FEE;&#x6539;&#x6210;&#x6211;&#x4EEC;&#x6240;&#x9700;&#x8981;&#x7684;migratetype&#x3002;&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x53CD;&#x6620;&#x51FA;&#x7684;&#x601D;&#x60F3;&#x548C;&#x4E0A;&#x9762;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x5C31;&#x662F;&#x627E;&#x5230;&#x7684;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x8DB3;&#x591F;&#x5927;&#xFF0C;&#x5C31;&#x8FC1;&#x79FB;migratetype&#x3002;</div><div style=\"display: block;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 5&#xFF09;&#x6700;&#x540E;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x4E00;&#x70B9;&#x5C31;&#x662F;&#xFF0C;&#x7EA2;&#x5708;&#x4E2D;&#x7684;&#x6761;&#x4EF6;&#x5224;&#x65AD;&#x5176;&#x5B9E;&#x4E0D;&#x5B8C;&#x6574;&#xFF0C;&#x771F;&#x5B9E;&#x4EE3;&#x7801;&#x4E2D;&#x7684;&#x5224;&#x65AD;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">if (unlikely(current_order &gt;= (pageblock_order &gt;&gt; 1)) ||</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; start_migratetype == MIGRATE_RECLAIMABLE ||</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div style=\"display: block;\"><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;page_group_by_mobility_disabled) { &#x2026;&#x2026; }&#xA0;</font></div></blockquote>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &apos;Courier New&apos;;\">page_group_by_mobility_disabled&#x8868;&#x793A;&#x8FC1;&#x79FB;&#x7279;&#x6027;&#x5173;&#x95ED;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x9875;&#x9762;&#x5E76;&#x4E0D;&#x53D7;migratetype&#x6240;&#x9650;&#x5236;&#xFF0C;&#x90A3;&#x9875;&#x9762;&#x5E94;&#x8BE5;&#x53EF;&#x4EE5;&#x968F;&#x5FC3;&#x6240;&#x6B32;&#x7684;&#x8FC1;&#x79FB;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x786E;&#x5B9E;&#x5982;&#x6B64;&#xFF0C;&#x540E;&#x9762;&#x5982;&#x679C;</span><span style=\"font-family: &apos;Courier New&apos;;\">page_group_by_mobility_disabled&#xFF0C;&#x4E5F;&#x5E76;&#x4E0D;&#x9700;&#x8981;&#x5224;&#x65AD;&#x6709;&#x591A;&#x5C11;free buddy&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8FC1;&#x79FB;&#x9875;&#x9762;&#x4E86;&#x3002;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#xFF0C;<span style=\"font-family: &apos;Courier New&apos;;\">start_migratetype == MIGRATE_RECLAIMABLE&#x5C31;&#x503C;&#x5F97;&#x63A8;&#x6572;&#x4E86;&#x3002;&#x6240;&#x6709;&#x4EE3;&#x7801;&#x4E2D;&#x90FD;&#x6CA1;&#x6709;&#x770B;&#x5230;&#x5BF9;&#x5176;&#x7684;&#x4F7F;&#x7528;&#x3002;&#x7F51;&#x7EDC;&#x4E0A;&#x5BF9;&#x5176;&#x7684;&#x89E3;&#x91CA;&#x662F;&#xFF1A;</span></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<i><span style=\"box-sizing: inherit !important; padding: 0px; margin: 0px; cursor: default; font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;, Verdana, sans-serif, &#x5B8B;&#x4F53;; text-align: left; background-color: rgb(255, 255, 255);\">&#x53EF;&#x56DE;&#x6536;&#x9875;&#xFF1A;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x79FB;&#x52A8;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x5220;&#x9664;&#xFF0C;&#x5176;&#x5185;&#x5BB9;&#x53EF;&#x4EE5;&#x4ECE;&#x67D0;&#x4E9B;&#x6E90;&#x91CD;&#x65B0;&#x751F;&#x6210;</span><span style=\"box-sizing: inherit !important; padding: 0px; margin: 0px; cursor: default; font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;, Verdana, sans-serif, &#x5B8B;&#x4F53;; text-align: left; background-color: rgb(255, 255, 255);\">&#xA0;&#xA0;</span></i></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0;&#x6240;&#x4EE5;&#x6211;&#x8BA4;&#x4E3A;<span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_RECLAIMABLE&#x56E0;&#x4E3A;&#x5F88;&#x5BB9;&#x6613;&#x88AB;&#x91CA;&#x653E;&#xFF08;&#x6216;&#x53EB;&#x56DE;&#x6536;&#xFF09;&#xFF0C;&#x4ED6;&#x4E5F;&#x662F;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_UNMOVABLE&#x548C;</span><span style=\"font-family: &apos;Courier New&apos;;\">MIGRATE_MOVABLE&#x7684;&#x7B2C;&#x4E00;&#x66FF;&#x8865;</span><span style=\"font-family: &apos;Courier New&apos;;\">&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">&#x6240;&#x4EE5;&#x4E0D;&#x7BA1;&#x627E;&#x5230;&#x7684;&#x7A7A;&#x95F2;&#x9875;&#x9762;&#x6709;&#x591A;&#x5927;&#xFF0C;&#x90FD;&#x5E94;&#x8BE5;&#x5C3D;&#x53EF;&#x80FD;&#x7684;&#x8FC1;&#x79FB;&#x7ED9;&#x4ED6;&#x3002;</span></blockquote><div style=\"display: block;\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<br><div style=\"display: block;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><br></blockquote></div></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/11/23/Linux%E5%86%85%E5%AD%98%E4%B9%8B%E9%A1%B5%E8%A1%A8/",
            "url": "https://blog.zhougy.top/2012/11/23/Linux%E5%86%85%E5%AD%98%E4%B9%8B%E9%A1%B5%E8%A1%A8/",
            "title": "Linux内存之页表",
            "date_published": "2012-11-23T05:58:08.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir>Linux&#x7684;&#x76F8;&#x5173;&#x9875;&#x8868;&#x7684;&#x6846;&#x67B6;&#x5728; <a href=\"evernote:///view/161681/s10/58f22e85-f865-455a-ad12-948ff6c02459/58f22e85-f865-455a-ad12-948ff6c02459/\" style=\"color:#69aa35\">vmalloc&#x5206;&#x6790;</a>&#x4E2D;&#xFF0C;__vmalloc_area_node&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x4E0E;&#x5206;&#x914D;&#x9875;&#x8868;&#x9879;&#x4E24;&#x8282;&#x4E2D;&#x5DF2;&#x7ECF;&#x6709;&#x6240;&#x9610;&#x8FF0;&#x3002;&#x672C;&#x6587;&#x518D;&#x505A;&#x4E00;&#x4E9B;&#x603B;&#x4F53;&#x4E0A;&#x7684;&#x628A;&#x63E1;&#x3002;&#x6587;&#x4E2D;&#x4F1A;&#x501F;&#x7528;&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x56FE;&#x3002;<div><br></div><div>&#x6240;&#x8C13;&#x7684;&#x9875;&#x8868;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x3002;&#x9488;&#x5BF9;&#x73B0;&#x5728;&#x7684;64&#x4F4D;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#xFF0C;Linux&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x652F;&#x6301;4&#x7EA7;&#x9875;&#x8868;&#x64CD;&#x4F5C;&#xFF0C;&#x5373;pgd&#xFF0C;pud&#xFF0C;pmd&#x548C;pte&#x3002;&#x4F46;&#x76EE;&#x524D;&#x4E00;&#x822C;&#x5D4C;&#x5165;&#x5F0F;&#x7684;&#x5E94;&#x7528;&#x5E76;&#x4E0D;&#x4F1A;&#x4F7F;&#x80FD;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x6D89;&#x53CA;&#x5230;pud&#x548C;pmd&#x7684;&#x6307;&#x9488;&#xFF0C;&#x5B9E;&#x9645;&#x90FD;&#x662F;&#x6307;&#x5411;pgd&#x8868;&#x9879;&#x7684;&#x3002;</div><div><img class=\"enMedia\" src=\"/images/Linux&#x5185;&#x5B58;&#x4E4B;&#x9875;&#x8868;/1537085034090\" hash=\"3e44ac2386ec1722d0f7d00bcbd8748b\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E0B;&#x8FD9;&#x5E45;&#x56FE;</div><div>&#xA0; &#xA0; &#xA0;1. &#x6240;&#x6709;Linux&#x90FD;&#x662F;4G&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF0C;&#x6BCF;&#x4E2A;&#x8868;&#x9879;&#x4EE3;&#x8868;2MB&#x7A7A;&#x95F4;&#xFF0C;&#x5171;2K&#x8868;&#x9879;&#xFF0C;&#x5360;2&#x4E2A;page</div><div>&#xA0; &#xA0; &#xA0;2. &#x6240;&#x6709;&#x7684;&#x5185;&#x5B58;&#x5728;&#x8868;&#x4E2D;&#x90FD;&#x662F;&#x6709;&#x5E8F;&#x7684;&#xFF0C;&#x5373;&#x7269;&#x7406;&#x5730;&#x5740;&#x5728;&#x8FD9;&#x4E2A;&#x7A7A;&#x95F4;&#x4E2D;&#x4E5F;&#x662F;&#x6709;&#x4F4E;&#x5230;&#x9AD8;&#x7684;</div><div>&#xA0; &#xA0; &#xA0;2. &#x6BCF;&#x4E2A;pgd&#x8868;&#x9879;&#x6307;&#x5411;&#x4E00;&#x4E2A;page&#xFF0C;4KB&#xFF0C;&#x5206;&#x6210;4&#x4E2A;&#x5B50;&#x8868;&#x5982;&#x4E0A;&#x56FE;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;3. &#x4E0B;&#x9762;&#x7684;&#x4E24;&#x4E2A;&#x5B50;&#x8868;2KB&#xFF0C;&#x5305;&#x542B;512&#x4E2A;&#x8868;&#x9879;&#xFF0C;&#x6B63;&#x597D;2MB&#x7A7A;&#x95F4;&#xFF0C;&#x89C6;&#x4E3A;&#x4E00;&#x4E2A;pte&#xFF0C;&#x5176;&#x4E2D;&#x6BCF;&#x4E2A;&#x8868;&#x9879;&#x6307;&#x5411;&#x4E00;&#x4E2A;page</div><div><br></div><div>&#xA0; &#xA0; &#xA0;pgd&#x8868;&#x4FDD;&#x5B58;&#x5728;&#x8FDB;&#x7A0B;&#x7684;mm_struct&#x4E2D;</div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;struct mm_struct {</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x2026;&#x2026;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;pgd_t * pgd;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;}</font></div><div>&#xA0; &#xA0; &#xA0;pte_alloc_map /&#xA0;pte_alloc_map_lock /&#xA0;pte_alloc_kernel&#x8FD9;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x4E3A;pgd&#x7684;&#x6BCF;&#x4E2A;&#x8868;&#x9879;&#x5206;&#x914D;&#x4ED6;&#x6240;&#x6307;&#x5411;&#x7684;&#x90A3;&#x4E00;&#x9875;&#x6570;&#x636E;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;pte&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#x56E0;&#x4E3A;&#x5185;&#x5B58;&#x4F1A;&#x4E0D;&#x65AD;&#x7684;&#x5206;&#x914D;&#xFF0C;&#x4E0D;&#x53EF;&#x80FD;&#x6BCF;&#x6B21;&#x5206;&#x914D;&#x4E00;&#x4E2A;page&#x90FD;&#x4F1A;&#x65B0;&#x5EFA;&#x8FD9;&#x6837;&#x7684;&#x4E00;&#x5F20;&#x8868;&#x683C;&#xFF0C;&#x6240;&#x4EE5;Linux&#x4E3A;&#x6BCF;&#x4E2A;pgd&#x8868;&#x9879;&#xFF08;&#x4EE3;&#x7801;&#x4E2D;&#x4E3A;&#x4E86;&#x517C;&#x5BB9;&#xFF0C;&#x8FD8;&#x662F;&#x5C06;&#x4E4B;&#x79F0;&#x4E3A;pmd&#xFF09;&#x52A0;&#x5165;&#x4E86;&#x4E00;&#x4E9B;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x5E76;&#x5728;&#x6BCF;&#x6B21;&#x5206;&#x914D;&#x4E4B;&#x524D;&#xFF0C;&#x7528;&#x5B8F;pmd_present(*(pmd))&#x6765;&#x68C0;&#x9A8C;&#x6B64;pte&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x5C31;&#x4E0D;&#x4F1A;&#x518D;&#x5206;&#x914D;&#x4E86;&#x3002;&#x8FD9;&#x4E2A;&#x6807;&#x5FD7;&#x4F4D;&#x662F;&#x600E;&#x4E48;&#x5206;&#x914D;&#x7684;&#x5462;&#xFF1F;<a href=\"evernote:///view/161681/s10/58f22e85-f865-455a-ad12-948ff6c02459/58f22e85-f865-455a-ad12-948ff6c02459/\" style=\"color: rgb(105, 170, 53);\">vmalloc&#x5206;&#x6790;</a>&#x4E5F;&#x6709;&#x6240;&#x5206;&#x6790;&#x3002;&#x5373;&#x51FD;&#x6570;<span style=\"font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;\">pmd_populate_kernel&#xFF0C;&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x51FD;&#x6570;&#xFF0C;&#x4F8B;&#x5982;</span>pmd_populate&#x3002;&#x4ED6;&#x4EEC;&#x8C03;&#x7528;&#x8FD9;&#x7684;&#x6700;&#x7EC8;&#x51FD;&#x6570;&#x90FD;&#x540C;&#x662F;__pmd_populate&#x3002;&#x5373;</div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;pmdp[0] = __pmd(pmdval) ; &#xA0;</font><font color=\"#41AD1C\" face=\"Courier New\">// =&#xA0;pmdval</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;pmdp[1] = __pmd(pmdval + 256 * sizeof(pte_t));</font> <font color=\"#41AD1C\" face=\"Courier New\">// = &#xA0;pmdval + 256 * sizeof(pte_t)</font></div><div><br></div><div>&#xA0; &#xA0; &#xA0;<img class=\"enMedia\" src=\"/images/Linux&#x5185;&#x5B58;&#x4E4B;&#x9875;&#x8868;/1537085034093\" hash=\"8b0618db320f080d0cdad5ed8b11f8a9\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;\" title lang xml:lang dir></div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</div><div>pmd_populate&#x662F;&#x5728;&#x4E3A;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x7684;&#x5730;&#x5740;&#x5EFA;&#x7ACB;&#x9875;&#x8868;&#xFF0C;&#x800C;<span style=\"font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;\">pmd_populate_kernel&#x662F;&#x5728;&#x4E3A;&#x5185;&#x6838;&#x5730;&#x5740;&#x5EFA;&#x7ACB;&#x9875;&#x8868;&#x3002;&#x6240;&#x4EE5;&#x4ED6;&#x4EEC;&#x4E4B;&#x95F4;</span>&#x7684;&#x5DEE;&#x522B;&#x4FBF;&#x6C34;&#x5230;&#x6E20;&#x6210;&#x4E86;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;1. &#x4E24;&#x8005;&#x4E3A;pmd&#x586B;&#x5145;&#x7684;&#x5185;&#x5BB9;&#x4E0D;&#x4E00;&#x6837;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;\">pmd_populate_kernel&#xFF1A;</span>__pa(pte_ptr) | _PAGE_KERNEL_TABLE</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;\">pmd_populate&#xFF1A;</span>page_to_pfn(ptep) &lt;&lt; PAGE_SHIFT | _PAGE_USER_TABLE</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x53EF;&#x89C1;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x7269;&#x7406;&#x5730;&#x5740;+kernel&#x6807;&#x5FD7;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x662F;&#x5185;&#x6838;&#x903B;&#x8F91;&#x5730;&#x5740;+user&#x6807;&#x5FD7;</div><div>&#xA0; &#xA0; &#xA0;2. &#x4E24;&#x8005;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x4E5F;&#x4E0D;&#x540C;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;\">pmd_populate_kernel&#x4F20;&#x5165;&#x7684;&#x662F;&#x5185;&#x6838;&#x903B;&#x8F91;&#x5730;&#x5740;</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;\">pmd_populate&#x4F20;&#x5165;&#x7684;&#x5219;&#x662F;page&#x7ED3;&#x6784;&#x6307;&#x9488;</span></div><div><span style=\"font-family: &#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;\"><br></span></div><div>&#xA0; &#xA0; &#xA0;&#x4E0D;&#x7BA1;&#x600E;&#x4E48;&#x6837;&#xFF0C;&#x5176;&#x5B9E;&#x4ED6;&#x4EEC;&#x7684;&#x5B9E;&#x8D28;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;pmd&#x7684;&#x5185;&#x5BB9;&#x90FD;&#x662F;&#x8FD9;&#x4E00;&#x4E2A;page&#x8868;&#x683C;&#x6240;&#x5728;&#x7684;&#x5177;&#x4F53;&#x4F4D;&#x7F6E;&#xFF08;&#x7269;&#x7406;&#x5730;&#x5740;&#xFF0C;&#x6216;&#x8005;&#x7269;&#x7406;&#x5730;&#x5740;&#x504F;&#x79FB;PAGE_SHIFT&#x7684;&#x5185;&#x6838;&#x903B;&#x8F91;&#x5730;&#x5740;&#xFF09;+&#x4E00;&#x4E2A;&#x6807;&#x5FD7;&#x5185;&#x6838;&#x8FDB;&#x7A0B;&#x8FD8;&#x662F;&#x7528;&#x6237;&#x8FDB;&#x7A0B; &#x7684;&#x6807;&#x5FD7;&#x4F4D;&#x3002;</div><div><br></div><div>&#xA0; &#xA0; &#xA0;&#x81F3;&#x6B64;&#xFF0C;pte&#xFF08;&#x6216;&#x8005;pmd&#xFF09;&#x7684;&#x5185;&#x5BB9;&#x5C31;&#x8BB2;&#x6E05;&#x695A;&#x4E86;&#xFF0C;&#x90A3;&#x6709;&#x4E86;&#x8FD9;&#x9875;&#x8868;&#x683C;&#x540E;&#xFF0C;&#x5C31;&#x987A;&#x5229;&#x6210;&#x7AE0;&#x7684;&#x8BE5;&#x5F80;&#x91CC;&#x9762;&#x586B;pte&#x8868;&#x9879;&#x4E86;&#x3002;&#x9996;&#x5148;&#x7528;pte_offset_map / pte_offset_kernel&#x627E;&#x5230;&#x8868;&#x683C;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x8868;&#x9879;&#xFF0C;&#x7136;&#x540E;&#x7528;&#x51FD;&#x6570;set_pte_at&#x771F;&#x6B63;&#x7684;&#x505A;&#x586B;&#x5145;&#x3002;set_pte_at&#x6700;&#x7EC8;&#x4F1A;&#x8C03;&#x7528;&#x5230;&#x4E00;&#x4E2A;&#x6C47;&#x7F16;&#x51FD;&#x6570;set_pte_ext&#x3002;&#x5982;&#x679C;&#x4E0D;&#x8003;&#x8651;&#x9AD8;&#x7AEF;&#x5185;&#x5B58;&#x7684;&#x8BDD;&#xFF0C;pte_offset_map&#x548C;pte_offset_kernel&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x90FD;</div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;=&#xA0;pmd_page_vaddr(*(dir)) + __pte_index(addr)</div><div>&#x524D;&#x534A;&#x90E8;&#x5206;&#x662F;pmd&#x7684;&#x903B;&#x8F91;&#x5730;&#x5740;&#xFF0C;&#x540E;&#x534A;&#x90E8;&#x5206;&#x662F;&#x672C;page&#x5728;pmd&#x4E2D;&#x7684;&#x504F;&#x79FB;&#x91CF;&#x3002;</div><div><br></div><div>=========================&#x5206;&#x5272;&#x7EBF;===================================</div><div><br></div><div>&#xA0; &#xA0; &#xA0;&#x8BF4;&#x4E86;&#x8FD9;&#x4E48;&#x591A;&#xFF0C;&#x9875;&#x8868;&#x7684;&#x5EFA;&#x7ACB;&#x5C31;&#x662F;&#x8FD9;&#x4E48;&#x4E9B;&#x4E8B;&#x60C5;&#x4E86;&#x3002;&#x4E0B;&#x9762;&#x518D;&#x4E3E;&#x4E2A;&#x5C0F;&#x5C0F;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x662F;mmap&#x5B9E;&#x73B0;&#x7684;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;remap_pfn_range&#x3002;mmap&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x662F;&#x628A;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#xFF08;&#x5305;&#x62EC;&#x8BBE;&#x5907;&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x8BBE;&#x5907;&#x6587;&#x4EF6;&#xFF0C;&#x5219;&#x8981;&#x9A71;&#x52A8;&#x6765;&#x652F;&#x6301;&#xFF09;&#x6620;&#x5C04;&#x5230;&#x4E00;&#x6B3E;&#x5185;&#x5B58;&#x5730;&#x5740;&#x4E0A;&#xFF0C;&#x90A3;remap_pfn_range&#x5C31;&#x662F;&#x8981;&#x4E3A;&#x4E00;&#x6BB5;&#x7269;&#x7406;page&#x5EFA;&#x7ACB;&#x9875;&#x8868;&#x9879;&#x3002;&#x5148;&#x770B;&#x4ED6;&#x4EEC;&#x7684;&#x539F;&#x578B;&#xFF1A;</div><div><font color=\"#2D4FC9\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"font-family: &apos;Courier New&apos;;\">mmap (caddr_t addr, size_t len, int prot, int flags, int fd, off_t offset)</span></font></div><div><span style=\"font-family: &apos;Courier New&apos;;\"><font color=\"#2D4FC9\"><br></font></span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;int remap_pfn_range(struct vm_area_struct *vma,</font></div><font face=\"Courier New\"><font color=\"#2D4FC9\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long virt_addr, unsigned long pfn,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long size, pgprot_t prot);</font></font><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0;</font></div><div>&#xA0; &#xA0; &#xA0;</div><div>&#xA0; &#xA0; &#xA0;&#x4E0A;&#x9762;&#x7684;mmap&#x662F;Linux&#x7684;API&#xFF0C;&#x53EF;&#x4EE5;&#x9488;&#x5BF9;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x548C;&#x8BBE;&#x5907;&#x6587;&#x4EF6;&#xFF0C;&#x6240;&#x4EE5;&#x6BD4;&#x8F83;&#x6709;&#x666E;&#x904D;&#x6027;&#xFF0C;&#x4E0B;&#x9762;&#x662F;&#x9A71;&#x52A8;&#x4E2D;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;mmap&#x7ECF;&#x5E38;&#x4F1A;&#x7528;&#x5230;&#x7684;remap_pfn_range&#x51FD;&#x6570;&#x3002;&#x7406;&#x4E00;&#x4E0B;&#x4ED6;&#x4EEC;&#x7684;&#x53C2;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<b><span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">mmap</span><span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">&#xA0;</span>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;</b><span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\"><b>remap_pfn_range</b></span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">addr</span>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &lt;=&gt; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">vma,&#xA0;</span>&#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">virt_addr</span></div><div><font face=\"Courier New\"><span style=\"color: rgb(45, 79, 201);\">fd</span><font color=\"#2D4FC9\">,</font><span style=\"color: rgb(45, 79, 201);\">offset,len</span></font>&#xA0; &lt;=&gt; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">pfn,&#xA0;</span><span style=\"color: rgb(45, 79, 201); font-family: &apos;Courier New&apos;;\">size</span></div><div>&#xA0; &#xA0; &#xA0;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x5C31;&#x662F;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;1. &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;mmap&#x6765;&#x6620;&#x5C04;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;fd&#x4E2D;offset~offset+len&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;2. &#x5185;&#x6838;&#x6309;&#x7167;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x6765;&#xFF0C;&#x5206;&#x914D;&#x4E00;&#x4E2A;vma_area_struct&#xFF0C;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x5305;&#x542B;&#x4E86;&#x6240;&#x6709;&#x8981;&#x5206;&#x914D;&#x7684;&#x5730;&#x5740;&#x6620;&#x5C04;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5305;&#x62EC;&#x7269;&#x7406;&#x5730;&#x5740;&#xFF08;fd, offset,len&#xFF09;&#x548C;&#x865A;&#x62DF;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF08;addr&#xFF09;&#xFF0C;&#x6240;&#x4EE5;<span style=\"font-family: &apos;Courier New&apos;;\">remap_pfn_range&#x7684;&#x53C2;&#x6570;</span><span style=\"font-family: &apos;Courier New&apos;;\">virt_addr&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">pfn&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">size&#xFF0C;&#x90FD;&#x5728;vma&#x4E2D;&#x6709;&#x6240;&#x63CF;&#x8FF0;&#x4E86;&#x3002;&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8FD9;&#x6837;&#x505A;&#xFF0C;&#x6211;&#x731C;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x4F9B;&#x7075;&#x6D3B;&#x6027;&#xFF0C;&#x6BD5;&#x7ADF;vma&#x53EF;&#x4EE5;&#x8D85;&#x8FC7;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6620;&#x5C04;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF0C;&#x6BD4;&#x5982;&#x5185;&#x6838;&#x5728;&#x5206;&#x914D;vma&#x65F6;&#x53D1;&#x73B0;&#x6709;&#x4E24;&#x4E2A;vma&#x53EF;&#x4EE5;&#x5408;&#x5E76;&#xFF0C;&#x5219;&#x4F20;&#x5165;&#x7684;vma&#x5C31;&#x5927;&#x4E8E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x7528;</span><span style=\"font-family: &apos;Courier New&apos;;\">virt_addr&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">pfn&#xFF0C;</span><span style=\"font-family: &apos;Courier New&apos;;\">size&#x6765;&#x8BF4;&#x660E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x6620;&#x5C04;&#x3002;</span></div><div>&#xA0; &#xA0; &#xA0;remap_pfn_range&#x6700;&#x6838;&#x5FC3;&#x7684;&#x90E8;&#x5206;&#x5C31;&#x662F;&#x4E3A;<span style=\"font-family: &apos;Courier New&apos;;\">virt_addr~</span><span style=\"font-family: &apos;Courier New&apos;;\">virt_addr+PAGE_ALIGN(size)&#x7684;&#x533A;&#x95F4;&#x5EFA;&#x7ACB;&#x9875;&#x8868;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</span></div><div><span style=\"font-family: &apos;Courier New&apos;;\"><br></span></div><div><font color=\"#2D4FC9\" face=\"Courier New\">int remap_pfn_range(struct vm_area_struct *vma, unsigned long addr,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long pfn, unsigned long size, pgprot_t prot)<br>{</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#x2026;&#x2026;</font></div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;do {</font></div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; next = pgd_addr_end(addr, end);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; err = remap_pud_range(mm, pgd, addr, next,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; pfn + (addr &gt;&gt; PAGE_SHIFT), prot);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (err)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; break;<br>&#xA0;&#xA0;&#xA0; } while (pgd++, addr = next, addr != end);</font><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;&#x2026;&#x2026;<br></font><div><font color=\"#2D4FC9\" face=\"Courier New\">}</font></div></div><div><font color=\"#2D4FC9\" face=\"Courier New\"><br></font></div><div>&#xA0; &#xA0; &#xA0;<font color=\"#2D4FC9\" face=\"Courier New\">remap_pud_range -&gt;&#xA0;remap_pmd_range -&gt;&#xA0;remap_pte_range</font></div><div>&#xA0; &#xA0; &#xA0;&#x524D;&#x9762;&#x4E24;&#x4E2A;&#x662F;&#x865A;&#x7684;&#xFF0C;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5C31;&#x662F;&#x5EFA;&#x7ACB;&#x9875;&#x8868;&#x4E86;</div><div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0; &#xA0; &#xA0;static int remap_pte_range(struct mm_struct *mm, pmd_t *pmd,</font></div><font color=\"#2D4FC9\" face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long addr, unsigned long end,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long pfn, pgprot_t prot)<br></font><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font color=\"#2D4FC9\" face=\"Courier New\">{<br>&#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0; pte = pte_alloc_map_lock(mm, pmd, addr, &amp;ptl);<br>&#xA0; &#xA0; &#x2026;&#x2026;<br>&#xA0;&#xA0;&#xA0; do {<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; set_pte_at(mm, addr, pte, pte_mkspecial(pfn_pte(pfn, prot)));<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; pfn++;<br>&#xA0;&#xA0;&#xA0; } while (pte++, addr += PAGE_SIZE, addr != end);<br>&#xA0; &#xA0; &#x2026;&#x2026;<br>}</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\"><br></font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">1. pmd&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x63D0;&#x5230;&#x7684;pgd&#x8868;&#x9879;&#x6307;&#x5411;&#x7684;&#x90A3;1&#x4E2A;page</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">2. addr~end&#x662F;&#x8981;&#x5EFA;&#x7ACB;&#x9875;&#x8868;&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8303;&#x56F4;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">3. pfn&#x662F;&#x8FD9;&#x5757;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8303;&#x56F4;&#x9996;&#x5730;&#x5740;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x5E27;&#x53F7;</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">4. prot&#x662F;&#x4E00;&#x4E9B;&#x6807;&#x5FD7;&#x4F4D;</font></blockquote></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/11/13/%E5%86%85%E5%AD%98%E9%A1%B5%E7%9A%84wait-wake%E6%9C%BA%E5%88%B6/",
            "url": "https://blog.zhougy.top/2012/11/13/%E5%86%85%E5%AD%98%E9%A1%B5%E7%9A%84wait-wake%E6%9C%BA%E5%88%B6/",
            "title": "内存页的wait-wake机制",
            "date_published": "2012-11-13T11:48:06.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir>&#x5173;&#x4E8E;&#x5185;&#x5B58;&#x4E5F;&#x5728;&#x5206;&#x914D;&#x65F6;&#x7684;&#x7B49;&#x5F85;&#x5524;&#x9192;&#x673A;&#x5236;&#xFF0C;include/linux/mmzone.h 389&#x884C;&#x7684;&#x6CE8;&#x91CA;&#x4E3A;&#x6211;&#x4EEC;&#x6307;&#x51FA;&#x4E86;&#x7528;&#x6237;&#x53EF;&#x7528; &#x7684;&#x6700;&#x57FA;&#x672C;&#x7684;&#x4E24;&#x4E2A;&#x63A5;&#x53E3;&#x51FD;&#x6570;&#xFF0C;__wait_on_page_locked / &#xA0;unlock_page&#xFF0C;&#x5B9A;&#x4E49;&#x5728;<span style=\"font-family: &apos;Courier New&apos;;\">mm/filemap.c&#x4E2D;</span>&#x3002;&#x4F46;&#x7ECF;&#x8FC7;&#x68C0;&#x67E5;&#x53D1;&#x73B0;&#xFF0C;&#x771F;&#x6B63;&#x80FD;&#x63D0;&#x4F9B;&#x4F7F;&#x7528;&#x7684;&#x5176;&#x5B9E;&#x662F;wait_on_page_locked&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;__wait_on_page_locked&#xA0;&#x7684;&#x5B9E;&#x73B0;&#x3002;&#x5176;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x5B9A;&#x4E49;&#x5728;&#x5934;&#x6587;&#x4EF6;&#x4E2D;&#x7684;inline&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x88AB;&#x5305;&#x542B;&#x6B64;&#x5934;&#x6587;&#x4EF6;&#x7684;c&#x6587;&#x4EF6;&#x8C03;&#x7528;&#xFF0C;&#x5176;&#x5B9E;&#x73B0;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;wait_on_page_bit&#x51FD;&#x6570;&#x3002;<blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#41AD1C\" face=\"Courier New\">* __wait_on_page_locked() and unlock_page() in mm/filemap.c, are the</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#41AD1C\" face=\"Courier New\">* primary users of these fields, and in mm/page_alloc.c</font></div></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#41AD1C\" face=\"Courier New\">* free_area_init_core() performs the initialization of them.</font></div><div><font color=\"#41AD1C\" face=\"Courier New\"><br></font></div></blockquote></blockquote><div>wait_on_page_bit&#x7684;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</div><div><br></div><div><img class=\"enMedia\" src=\"/images/&#x5185;&#x5B58;&#x9875;&#x7684;wait-wake&#x673A;&#x5236;/1537085035448\" hash=\"fd66b201ad743e32ad690549b2114dfa\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;&#x770B;&#x8D77;&#x6765;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x4E0D;&#x8FC7;&#x91CC;&#x9762;&#x6697;&#x85CF;&#x7384;&#x673A;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;1&#xFF09;<span style=\"font-size: 10pt; font-family: Arial; text-indent: 0mm;\">DEFINE_WAIT_BIT&#x505A;&#x4E86;&#x5F88;&#x591A;&#x4E8B;&#x60C5;</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x5B83;&#x662F;&#x6807;&#x51C6;&#x7684;Linux&#x7B49;&#x5F85;&#x673A;&#x5236;&#x4E2D;DEFINE_WAIT&#x7684;&#x53D8;&#x79CD;&#x3002;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E86;&#x6807;&#x51C6;&#x7684;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;wait_queue_t&#x3002;&#x53E6;&#x5916;&#x5305;&#x542B;&#x4E86;&#x4E00;&#x4E2A;bit&#xFF0C;&#x901A;&#x8FC7;word&#x548C;bit_nr&#x6307;&#x5B9A;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;__wait_on_bit&#x901A;&#x8FC7;page_waitqueue&#x6765;&#x627E;&#x5230;&#x961F;&#x5217;&#x5934;&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x5C31;&#x7275;&#x6D89;&#x5230;&#x54C8;&#x5E0C;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;<a href=\"evernote:///view/161681/s10/60762aee-84ce-441b-b046-d79f9b9fc0da/60762aee-84ce-441b-b046-d79f9b9fc0da/\" style=\"color: rgb(105, 170, 53);\">linux&#x5185;&#x6838;&#x54C8;&#x5E0C;&#x67E5;&#x627E;&#xFF08;1&#xFF09;_zhe_wang-ChinaUnix&#x535A;&#x5BA2;</a>&#xFF0C;&#x8FD9;&#x91CC;&#x7B80;&#x8981;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x54C8;&#x5E0C;&#x8868;&#x5171;&#x6709;&#x8868;&#x9879;size&#x4E2A;&#xFF0C;2^size &gt;= pages / PAGES_PER_WAITQUEUE = pages/256</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x7528;&#x6765;&#x8BA1;&#x7B97;&#x54C8;&#x5E0C;&#x503C;&#x7684;wait_table_bits&#xFF0C;&#x662F;size&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;1&#x4F4D;&#x7684;&#x7D22;&#x5F15;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x54C8;&#x5E0C;&#x503C;&#x7684;&#x8BA1;&#x7B97;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#xFF0C;&#x8BE5;&#x9875;&#x7684;page&#x7ED3;&#x6784;&#x6307;&#x9488;&#xFF08;&#x5728;mem_map&#x6570;&#x7EC4;&#x4E2D;&#xFF09;&#xFF0C;wait_table_bits</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x6240;&#x8C13;&#x7684;&#x54C8;&#x5E0C;&#x8BA1;&#x7B97;&#x5C31;&#x662F;&#x5C06;&#x8FD9;&#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#xFF0C;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x5DE7;&#x5999;&#x7684;&#x8BA1;&#x7B97;&#xFF0C;&#x751F;&#x6210;&#x67D0;&#x4E2A;&#x533A;&#x95F4;&#x5185;&#x7684;&#x968F;&#x673A;&#x503C;&#xFF0C;&#x7136;&#x540E;&#x6563;&#x5217;&#x5230;&#x54C8;&#x5E0C;&#x8868;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x54C8;&#x5E0C;&#x51B2;&#x7A81;&#xFF0C;&#x5219;&#x540C;&#x4E00;&#x4E2A;&#x8868;&#x9879;&#x91C7;&#x7528;&#x94FE;&#x8868;&#x7684;&#x5F62;&#x5F0F;&#x8868;&#x793A;&#x82E5;&#x5E72;&#x4E2A;&#x6210;&#x5458;&#x3002;&#x6240;&#x4EE5;&#x54C8;&#x5E0C;&#x503C;&#x53C8;&#x53EB;&#x6563;&#x5217;&#x503C;&#x3002;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x91CC;&#x7684;&#x54C8;&#x5E0C;&#x8BA1;&#x7B97;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;(val * GOLDEN_RATIO_PRIME_32) &#xA0;&gt;&gt;(32 - bits)&#xFF0C;GOLDEN_RATIO_PRIME_32&#x662F;&#x4E2A;&#x5F88;&#x7279;&#x522B;&#x7684;&#x503C;&#xFF0C;&#x7ECF;&#x8FC7;&#x7814;&#x7A76;&#xFF0C;&#x56FA;&#x5B9A;&#x4E0B;&#x6765;&#x7684;&#xFF0C;&#x7528;&#x5B83;&#x4E58;&#x8FC7;&#x4E4B;&#x540E;&#xFF0C;&#x6EA2;&#x51FA;&#x540E;&#x5269;&#x4E0B;&#x6765;&#x7684;&#x503C;&#xFF0C;&#x968F;&#x673A;&#x6027;&#x6BD4;&#x8F83;&#x5927;&#x3002;&#x56E0;&#x4E3A;bits&#x662F;size&#x7684;&#x7B2C;&#x4E00;&#x4E2A;1&#xFF0C;&#x6240;&#x4EE5;&#x53F3;&#x79FB;&#x540E;&#x7684;&#x503C;&#x4E00;&#x5B9A;&lt;size&#xFF0C;&#x6B63;&#x597D;&#x7B26;&#x5408;&#x6211;&#x4EEC;&#x7684;&#x8981;&#x6C42;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;3&#xFF09;&#x5728;__wait_on_bit&#x4E2D;&#x4F1A;&#x4E0D;&#x65AD;&#x6D4B;&#x8BD5;page-&gt;flags&#x7684;PageLocked&#x4F4D;&#xFF0C;&#x5373;&#x7B2C;0&#x4F4D;&#x3002;&#x7136;&#x540E;&#x4F1A;&#x5728;&#x771F;&#x6B63;&#x8981;&#x4F11;&#x7720;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x4F20;&#x5165;&#x7684;sync_page&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E0D;&#x590D;&#x6742;&#xFF0C;&#x4F46;&#x7275;&#x6D89;&#x5F88;&#x5E7F;&#xFF0C;&#x548C;address_space&#x7ED3;&#x6784;&#x6709;&#x5173;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;4&#xFF09;&#x5728;&#x505A;&#x5B8C;&#x4E00;&#x7CFB;&#x5217;&#x7684;sync&#x4E4B;&#x540E;&#xFF0C;&#x6700;&#x540E;&#x8C03;&#x7528;io_schedule&#xFF0C;&#x8BA9;&#x51FA;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x8FDB;&#x884C;&#x7B49;&#x5F85;&#x3002;</div><div><br></div><div><br></div><div>unlock_page&#x4E00;&#x6837;&#x901A;&#x8FC7;page&#x7ED3;&#x6784;&#x6307;&#x9488;&#x548C;PageLocked&#x4F4D;&#xFF0C;&#x627E;&#x5230;&#x54C8;&#x5E0C;&#x8868;&#x4E2D;&#x7684;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x3002;&#x4F46;&#x4E00;&#x4E2A;&#x54C8;&#x5E0C;&#x8868;&#x9879;&#x53EF;&#x4EE5;&#x6709;256&#x4E2A;page&#x7B49;&#x5728;&#x5176;&#x4E2D;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x786E;&#x5B9A;&#x662F;&#x600E;&#x4E48;&#x5524;&#x9192;&#x60F3;&#x8981;&#x7684;&#x90A3;&#x4E2A;page&#x7684;&#x3002;&#x53EF;&#x80FD;&#x548C;wait-&gt;func=wake_bit_function&#x6709;&#x5173;&#x3002;&#x7275;&#x626F;&#x5230;wait queue&#x673A;&#x5236;&#x3002;</div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font color=\"#41AD1C\" face=\"Courier New\"><br></font></div></blockquote></blockquote><font color=\"#41AD1C\" face=\"Courier New\"><br></font></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/11/12/find_next_zero_bit/",
            "url": "https://blog.zhougy.top/2012/11/12/find_next_zero_bit/",
            "title": "find_next_zero_bit",
            "date_published": "2012-11-12T06:10:34.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir><font face=\"Courier New\">unsigned long find_next_zero_bit(const unsigned long *addr,&#xA0;<br></font><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">unsigned long size,<br></font>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">unsigned long offset)</font></div><div><font face=\"Courier New\">&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x7528;&#x610F;&#x662F;&#x5728;addr&#x5F00;&#x59CB;&#x7684;&#x5730;&#x5740;&#x6BB5;&#x4E2D;&#xFF0C;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x4E3A;0&#x7684;&#x4F4D;&#xFF0C;</font><span style=\"font-family: &apos;Courier New&apos;;\">&#x51FD;&#x6570;&#x8C03;&#x7528;&#x6210;&#x529F;&#x5219;&#x8FD4;&#x56DE;&#x8BE5;&#x4F4D;&#x7684;&#x7D22;&#x5F15;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x627E;&#x5230;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;size&#x3002;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x641C;&#x7D22;&#x8303;&#x56F4;&#x5E76;&#x4E0D;&#x5305;&#x542B;size&#x8FD9;&#x4E2A;&#x70B9;&#xFF0C;&#x56E0;&#x4E3A;&#x5373;&#x4FBF;size&#x8FD9;&#x4E2A;&#x70B9;&#x4E3A;0&#xFF0C;&#x6EE1;&#x8DB3;&#x8981;&#x6C42;&#xFF0C;&#x4F46;&#x5176;&#x8FD4;&#x56DE;&#x503C;&#x548C;&#x5931;&#x8D25;&#x65F6;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x76F8;&#x540C;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x4E5F;&#x770B;&#x4F5C;&#x662F;&#x5931;&#x8D25;&#x3002;</span></div><div><span style=\"font-family: &apos;Courier New&apos;;\"><br></span></div><div><span style=\"font-family: &apos;Courier New&apos;;\">&#x641C;&#x7D22;&#x793A;&#x610F;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</span></div><div><img class=\"enMedia\" src=\"/images/find_next_zero_bit/1537085035761\" hash=\"eb1531c519cf2458b9144f798a8647b2\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;\" title lang xml:lang dir></div><div><img class=\"enMedia\" src=\"/images/find_next_zero_bit/1537085035759\" hash=\"18c03589a58345add8371d7feb79093a\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;\" title lang xml:lang dir></div><div>&#x518D;&#x5206;&#x6790;&#x4EE3;&#x7801;&#xFF1A;</div><div><font face=\"Courier New\">unsigned long find_next_zero_bit(const unsigned long *addr, unsigned long size,<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; unsigned long offset)<br>{<br>&#xA0;&#xA0;&#xA0; const unsigned long *p = addr + BITOP_WORD(offset);<br>&#xA0;&#xA0;&#xA0; unsigned long result = offset &amp; ~(BITS_PER_LONG-1); <font color=\"#41AD1C\">// result&#x5982;&#x4E0A;&#x56FE;&#xFF0C;&#x641C;&#x7D22;&#x8D77;&#x59CB;&#x70B9;&#x6240;&#x5728;ULONG&#x4E4B;&#x524D;&#x6240;&#x6709;&#x7684;bit</font><br>&#xA0;&#xA0;&#xA0; unsigned long tmp;<br><br>&#xA0;&#xA0;&#xA0; if (offset &gt;= size)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return size;<br>&#xA0;&#xA0;&#xA0; size -= result; <font color=\"#41AD1C\">// &#x6263;&#x6389;result&#xFF0C;&#x5373;size_new</font><br>&#xA0;&#xA0;&#xA0; offset %= BITS_PER_LONG; <font color=\"#41AD1C\">// &#x53D6;&#x5F97;&#x6240;&#x5728;ULONG&#x4E2D;&#x7684;&#x504F;&#x79FB;&#x91CF;&#xFF0C;&#x5373;offset_new</font><br>&#xA0;&#xA0;&#xA0; if (offset) {<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; tmp = *(p++);<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; tmp |= ~0UL &gt;&gt; (BITS_PER_LONG - offset); <font color=\"#41AD1C\">// &#x5C06;offset&#x4E4B;&#x5185;&#x7684;bit&#x5168;&#x90E8;&#x7F6E;1&#xFF0C;&#x53C2;&#x770B;&#x56FE;1</font><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (size &lt; BITS_PER_LONG) <font color=\"#41AD1C\">// &#x8FD9;&#x8868;&#x793A;&#x641C;&#x7D22;&#x8303;&#x56F4;&#x5728;&#x4E00;&#x4E2A;ULONG&#x8303;&#x56F4;&#x4E4B;&#x5185;&#xFF0C;&#x53C2;&#x770B;&#x56FE;2</font><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto found_first;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (~tmp) <font color=\"#41AD1C\">// tmp&#x81F3;&#x5C11;&#x6709;&#x4E00;&#x4E2A;0&#x4F4D;&#xFF0C;&#x5373;tmp&#x7684;</font></font><span style=\"color: rgb(65, 173, 28); font-family: &apos;Courier New&apos;;\">BPL - offset&#x8FD9;&#x4E00;&#x6BB5;&#x4E2D;&#x81F3;&#x5C11;&#x6709;&#x4E00;&#x4E2A;0&#x3002;</span></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto found_middle;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; size -= BITS_PER_LONG;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; result += BITS_PER_LONG;<br>&#xA0;&#xA0;&#xA0; }<br>&#xA0;&#xA0;&#xA0; while (size &amp; ~(BITS_PER_LONG-1)) { <font color=\"#41AD1C\">// &#x4E0D;&#x65AD;&#x904D;&#x5386;size&#x524D;&#x7684;ULONG</font><br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (~(tmp = *(p++)))<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto found_middle;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; result += BITS_PER_LONG;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; size -= BITS_PER_LONG;<br>&#xA0;&#xA0;&#xA0; }<br>&#xA0;&#xA0;&#xA0; if (!size) <font color=\"#41AD1C\">// &#x5F53;size&#x6B63;&#x597D;&#x662F;&#x6574;&#x6570;&#x4E2A;ULONG&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x627E;&#x7740;&#xFF0C;&#x8FD4;&#x56DE;&#x503C;&#x5C31;&#x662F;&#x539F;&#x59CB;&#x7684;size&#xFF0C;&#x82E5;&#x4E0D;&#x662F;&#xFF0C;&#x4F1A;&#x4F9D;&#x6B21;&#x8FDB;</font></font><font color=\"#41AD1C\"><span style=\"font-family: &apos;Courier New&apos;;\">found_first&#xFF0C;&#x7136;&#x540E;</span><span style=\"font-family: &apos;Courier New&apos;;\">found_middle</span></font><span style=\"font-family: &apos;Courier New&apos;;\"><br></span><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return result;<br>&#xA0;&#xA0;&#xA0; tmp = *p;<br><br>found_first:<br>&#xA0;&#xA0;&#xA0; tmp |= ~0UL &lt;&lt; size; <font color=\"#41AD1C\">// &#x5C06;size&#x4EE5;&#x4E0A;&#x90E8;&#x5206;&#x5168;&#x90E8;&#x7F6E;1</font></font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0; if (tmp == ~0UL)&#xA0;&#xA0;&#xA0; <font color=\"#41AD1C\">//&#xA0;</font></font><span style=\"font-family: &apos;Courier New&apos;;\"><font color=\"#41AD1C\">offset~size&#x6216;head~size&#x4E4B;&#x95F4;&#x6CA1;&#x6709;0</font></span><font face=\"Courier New\"><br></font><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return result + size;&#xA0;&#xA0; <font color=\"#41AD1C\">// &#x8FD4;&#x56DE;&#x503C;&#x5373;&#x4E3A;&#x4F20;&#x5165;&#x7684;size</font><br>found_middle:<br>&#xA0;&#xA0;&#xA0; return result + ffz(tmp); <font color=\"#41AD1C\">//&#xA0;</font></font><span style=\"font-family: &apos;Courier New&apos;;\"><font color=\"#41AD1C\">ffz&#x5C31;&#x662F;&#x5BFB;&#x627E;unsigned long&#x53D8;&#x91CF;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;0&#x4F4D;&#x7D22;&#x5F15;&#x7684;&#x5B8F;</font></span><font face=\"Courier New\"><br></font><font face=\"Courier New\">}</font><br></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/11/06/bootmem%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/",
            "url": "https://blog.zhougy.top/2012/11/06/bootmem%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/",
            "title": "bootmem工作原理",
            "date_published": "2012-11-06T04:07:20.000Z",
            "content_html": "<div class=\"enNote\" style title lang xml:lang dir><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (test_bit(i, bdata-&gt;node_bootmem_map)) {</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x5982;&#x679C;&#x8FDE;&#x7EED;&#x7A7A;&#x95F4;&#x4E0D;&#x8DB3;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x91CD;&#x65B0;&#x641C;&#x7D22;&#x672A;&#x5206;&#x914D;&#x533A;</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; sidx = align_idx(bdata, i, step);</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (sidx == i)</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; sidx += step;</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto find_block;</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }</span></span></div><div><br></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (bdata-&gt;last_end_off &amp; (PAGE_SIZE - 1) &amp;&amp;</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x4E0A;&#x4E00;&#x6B21;&#x5206;&#x914D;&#x7684;&#x7A7A;&#x95F4;&#x672B;&#x5730;&#x5740;&#x5728;&#x9875;&#x8FB9;&#x754C;</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PFN_DOWN(bdata-&gt;last_end_off) + 1 == sidx) &#xA0;</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; start_off = align_off(bdata, bdata-&gt;last_end_off, align);</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// align = 64&#xFF0C;&#x5C06;</span><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">start_off&#x63D0;&#x5347;&#x5230;</span><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">last_end_off&#x9644;&#x8FD1;&#xFF0C;&#x8981;&#x6309;align&#x5411;&#x4E0B;&#x5BF9;&#x9F50;</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else</span></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\">1.&#x521D;&#x59CB;&#x5316;</span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\">1)arm_bootmem_init</span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960777\" hash=\"8978309953a6dd59d6856df76150bb5f\" align alt longdesc width=\"1032\" height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\">&#xA0; &#xA0; &#xA0;&#x6709;&#x4E00;&#x70B9;&#xFF0C;&#x5148;&#x7406;&#x6E05;&#x695A;&#xFF0C;Linux&#x652F;&#x6301;NUMA&#x67B6;&#x6784;&#x7684;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF0C;&#x4F46;NUMA&#x4E00;&#x822C;&#x5E94;&#x7528;&#x4E8E;&#x4E2D;&#x5927;&#x578B;&#x7CFB;&#x7EDF;&#xFF0C;&#x6765;&#x7075;&#x6D3B;&#x5904;&#x7406;&#x672C;&#x5730;&#x5185;&#x5B58;&#x4E0E;&#x8FDC;&#x7AEF;&#x5185;&#x5B58;&#xFF0C;&#x4EE5;&#x63D0;&#x9AD8;&#x5E73;&#x5747;&#x5185;&#x5B58;&#x8BFB;&#x5199;&#x901F;&#x5EA6;&#xFF0C;&#x5373;&#x4F18;&#x5148;&#x4F7F;&#x7528;&#x672C;&#x5730;&#x5185;&#x5B58;&#x6216;&#x8005;&#x8BBF;&#x95EE;&#x901F;&#x5EA6;&#x8F83;&#x5FEB;&#x7684;&#x5185;&#x5B58;&#x3002;&#x4F46;&#x5D4C;&#x5165;&#x5F0F;&#x8BBE;&#x5907;&#x6216;&#x8005;&#x6211;&#x4EEC;&#x7684;D7800&#x5E76;&#x6CA1;&#x6709;&#x4F7F;&#x7528;Linux&#x7684;NUMA&#x67B6;&#x6784;&#x6765;&#x7BA1;&#x7406;&#x5185;&#x5B58;&#x3002;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#x53EA;&#x6709;node 0&#xFF0C;&#x5373;&#x5176;&#x4E0A;&#x53EA;&#x6709;&#x672C;&#x5730;&#x5185;&#x5B58;&#x3002;</span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\">&#xA0; &#xA0; &#xA0;&#x4E0A;&#x56FE;&#x4E2D;bdata_list&#x5728;NUMA&#x67B6;&#x6784;&#x4E2D;&#x5305;&#x542B;&#x4E86;&#x6240;&#x6709;node&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#xFF0C;&#x4F46;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x8BE5;list&#x4E0A;&#x53EA;&#x6709;node 0&#x7684;&#xFF1A;min~max_low&#x4F4E;&#x7AEF;&#x5185;&#x5B58;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x3002;&#x518D;&#x770B;memblock&#xFF0C;&#x5177;&#x4F53;&#x53C2;&#x8003;<a href=\"evernote:///view/161681/s10/84e5d565-822f-4ae2-adce-56fb6ced4c88/84e5d565-822f-4ae2-adce-56fb6ced4c88/\" style=\"color: rgb(105, 170, 53);\">memblock&#x5DE5;&#x4F5C;&#x539F;&#x7406;</a>&#xFF0C;&#x5176;&#x4E2D;memblock.memory&#x8868;&#x683C;&#x4E2D;&#xFF0C;&#x5305;&#x542B;&#x4E86;meminfo&#x4E2D;&#x6240;&#x6709;bank&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x533A;&#x95F4;&#x3002;&#x5BF9;&#x5E94;&#x5230;&#x4E00;&#x5F20;&#x56FE;&#x4E0A;&#xFF0C;&#x5C31;&#x5982;&#x4E0A;&#x56FE;&#x5DE6;&#x534A;&#x90E8;&#x5206;&#x7684;&#x793A;&#x610F;&#x56FE;&#x6240;&#x793A;&#xFF0C;bdata_list&#x4E0A;node 0&#x7684;min~max_low&#x533A;&#x6BB5;&#x4E0A;&#xFF0C;&#x6709;&#x7740;nrbanks&#x4E2A;region_start~region_end&#x5185;&#x5B58;&#x533A;&#x95F4;&#x3002;</span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\">&#xA0; &#xA0; &#xA0;&#x4E8E;&#x662F;&#xFF0C;&#x5BF9;&#x5E94;&#x5230;&#x4EE3;&#x7801;&#x91CC;&#x5C31;&#x5F88;&#x597D;&#x7406;&#x89E3;&#x4E86;&#x3002;&#x5728;&#x51FD;&#x6570;mark_bootmem&#x4E2D;&#xFF0C;&#x904D;&#x5386;bdata_list&#x5217;&#x8868;&#xFF0C;&#x5224;&#x65AD;&#x533A;&#x6BB5;&#x662F;&#x5426;&#x7B26;&#x5408;&#x7684;&#x6761;&#x4EF6;&#x5982;&#x4E0B;&#x3002;</span></div><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0;</span><span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201);\">if (pos &lt; bdata-&gt;node_min_pfn ||&#xA0;</span></span></div><div><span style=\"color: rgb(45, 79, 201); font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; pos &gt;= bdata-&gt;node_low_pfn) {</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x8868;&#x793A;&#x8D85;&#x8FC7;&#x4E86;&#x6B64;node&#x5BF9;&#x5E94;&#x7684;&#x533A;&#x6BB5;&#xFF0C;</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; BUG_ON(pos != start);</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; continue;</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201);\">&#xA0; &#xA0; &#xA0;}</span></div><div><span style=\"color: rgb(45, 79, 201);\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;</span></div><div><span style=\"color: rgb(45, 79, 201);\">&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201);\">if (max == end)</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// end&#x4F1A;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;max_low&#xFF0C;&#x5373;end&#x662F;&#x9AD8;&#x7AEF;&#x5730;&#x5740;&#xFF1F;&#x6211;&#x7684;&#x7406;&#x89E3;&#xFF0C;end&#x53EF;&#x4EE5;&#x8D85;&#x8FC7;low mem&#x7684;&#x9650;&#x5236;&#xFF0C;&#x4E0D;&#x8FC7;&#x5728;bootmem&#x4E2D;&#x6211;&#x4EEC;&#x53EA;&#x8003;&#x8651;low mem&#x7684;&#x90E8;&#x5206;</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return 0;</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201);\">&#xA0; &#xA0; &#xA0;pos = bdata-&gt;node_low_pfn;</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x8FD0;&#x884C;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x8868;&#x793A;start~end&#x7684;region&#x5DF2;&#x7ECF;&#x5904;&#x7406;&#x8FC7;&#x4E86;&#xFF0C;&#x53EA;&#x662F;max!=end&#xFF0C;&#x4E4B;&#x540E;&#x4F1A;&#x7A7A;&#x8DD1;&#x5B8C;&#x5269;&#x4E0B;&#x7684;&#x5FAA;&#x73AF;</span></div><div><br></div><div><img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960791\" hash=\"fd01a1a831a3b7caf3fc5ad38f42a341\" align alt longdesc width=\"1032\" height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div><br></div><div>&#xA0; &#xA0; &#xA0;&#x603B;&#x4F53;&#x6765;&#x8BF4;&#x6240;&#x8C13;&#x7684;bootmem&#xFF0C;&#x5373;&#x662F;&#x4E3A;meminfo&#x4E2D;&#x6240;&#x6709;nrbanks&#x5185;&#x5B58;&#x7684;min~maxlow&#xFF0C;&#x6765;&#x5206;&#x914D;&#x4E00;&#x5F20;bitmap&#xFF0C;&#x6BCF;&#x4E00;&#x4F4D;&#x4EE3;&#x8868;&#x4E00;&#x4E2A;page&#x662F;&#x5426;&#x5206;&#x914D;&#x3002;&#x4ED6;&#x548C;memblock&#x4E24;&#x5957;&#x4E0D;&#x540C;&#x7684;&#x673A;&#x5236;&#x3002;bootmem&#x7684;bitmap&#x88AB;memblock&#x7BA1;&#x7406;&#xFF0C;memblock&#x53D8;&#x91CF;&#xFF0C;&#x4EE5;&#x53CA;memblock&#x7684;&#x4E24;&#x5F20;&#x8868;&#x683C;memblock_memory_init_regions&#x548C;memblock_reserved_init_regions&#xFF0C;&#x90FD;&#x662F;&#x5B58;&#x5728;.init.data section&#x4E2D;&#xFF0C;&#x5373;&#x5728;kernel image&#x91CC;&#x3002;</div><div><br></div><div>2)arm_bootmem_free</div><div><img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960780\" hash=\"955e31194526ddb9bc3e379df1887a51\" align alt longdesc width=\"814\" height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#x5176;&#x4E2D;&#x672C;node&#x5185;&#x5B58;&#x6307;&#x6807;&#x793A;&#x610F;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</div><div><img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960784\" hash=\"cc4b0f88b4f266a8c7c70bd14c7867ad\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>alloc_node_mem_map&#x5728;&#x540E;&#x9762;&#x7684;&#x7AE0;&#x8282;&#x8BA8;&#x8BBA;&#x3002;</div><div><br></div><div>&#x8FD8;&#x6709;&#x4E00;&#x70B9;&#x9700;&#x8981;&#x8865;&#x5145;&#x4E00;&#x4E0B;&#xFF0C;pgdat&#x4E00;&#x822C;&#x6307;&#x5411;NODE_DATA(i)&#xFF0C;&#x5373;node_data[i]&#x6210;&#x5458;&#x3002;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x53EA;&#x8003;&#x8651;node 0&#xFF0C;&#x6240;&#x4EE5;pgdat&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x7684;&#x770B;&#x6210;&#x662F;&#x6307;&#x5411;node 0&#x7684;&#x6570;&#x636E;&#x3002;&#x5728;init_bootmem_node&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x8BE5;node&#x7684;bootmem&#x90E8;&#x5206;&#x52A0;&#x4EE5;&#x521D;&#x59CB;&#x5316;&#x3002;&#x5176;&#x4ED6;&#x90E8;&#x5206;&#x5728;&#x5176;&#x4ED6;&#x90E8;&#x5206;&#x521D;&#x59CB;&#x5316;&#x3002;</div><div><br></div><div>3)<span style=\"font-size: 10pt; text-indent: 0mm;\"><span style=\"font-size: 10pt; font-family: Arial;\">free_area_init_core</span></span></div><div><img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960775\" hash=\"48dde7c38e2eabd99a09151cd51ce4ba\" align alt longdesc width=\"816\" height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;a) &#x6BCF;&#x4E2A;zone&#x7684;page&#x6309;&#x7167;page block&#x7EC4;&#x7EC7;&#xFF0C;&#x6BCF;&#x4E2A;page block&#x5305;&#x542B;MAX_ORDER-1 = 10&#xFF0C;&#x5373;1024&#x9875;</div><div>&#xA0; &#xA0; &#xA0;b) &#x4EE3;&#x7801;&#x4E2D;&#x51E0;&#x4E2A;&#x6307;&#x6807;&#x5907;&#x6CE8;&#x5982;&#x4E0B;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;size: &#x7B2C;j&#x4E2A;zone&#x7684;total_size&#xFF0C;&#x5355;&#x4F4D;page</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;memmap_pages: &#x672C;zone&#x7684;memmap&#x6570;&#x7EC4;&#x9700;&#x8981;&#x7684;page&#x6570;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;realsize: totalsize - zhole_size[j] -&#xA0;memmap_pages -&#xA0;dma_reserve(&#x5982;&#x679C;&#x662F;zone[0])</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;nr_kernel_pages += realsize; <span style=\"color: rgb(65, 173, 28);\">// &#x5982;&#x679C;&#x662F;HIGHMEM zone&#xFF0C;&#x66F4;&#x65B0;nr_kernel_pages</span></div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;nr_all_pages += realsize;</div><div>&#xA0; &#xA0; &#xA0;c)&#xA0;init_currently_empty_zone,&#xA0;memmap_init&#x5728;&#x540E;&#x9762;&#x7AE0;&#x8282;&#x8BA8;&#x8BBA;</div><div><br></div><div>4)&#xA0;memmap_init</div><div>memmap&#x6570;&#x7EC4;&#x5728;arm_bootmem_free-&gt;<span style=\"font-size: 13px; font-family: Arial;\">free_area_init_node&#x4E2D;&#x901A;&#x8FC7;alloc_node_mem_map-&gt; alloc_bootmem_node&#x6765;&#x5206;&#x914D;&#x4E00;&#x6BB5;bootmem&#x5185;&#x5B58;&#xFF0C;&#x5E76;&#x8D4B;&#x7ED9;pgdat-&gt;node_mem_map&#x3002;memmap_init&#x51FD;&#x6570;&#x8D1F;&#x8D23;&#x521D;&#x59CB;&#x5316;&#x8FD9;&#x5757;&#x533A;&#x57DF;&#xFF08;&#x6570;&#x7EC4;&#xFF09;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x6210;&#x5458;&#x3002;</span></div><div><img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960789\" hash=\"e61973da74d343ba813529c9abd473ca\" align alt longdesc width=\"596\" height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;a)&#x5173;&#x4E8E;SetPageReserved&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4E0D;&#x77E5;&#x4F55;&#x7528;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"background-color: rgb(255, 255, 255); font-size: 14px; color: rgb(69, 69, 69); font-family: Tahoma, Helvetica, Arial, STHeiti; line-height: 21px;\">&#x5185;&#x6838;&#x4E2D;&#x7533;&#x8BF7;&#x5230;&#x9875;&#x9762;&#x4E4B;&#x540E;&#xFF0C;&#x8981;&#x8C03;&#x7528;&#x4E00;&#x4E0B;SetPageReserved&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x544A;&#x8BC9;&#x7CFB;&#x7EDF;&#xFF0C;&#x8FD9;&#x4E2A;&#x9875;&#x9762;&#x6211;&#x5DF2;&#x7ECF;&#x5360;&#x4E86;&#x3002;&#x5BF9;&#x4E8E;&#x6BCF;&#x4E00;&#x4E2A;&#x7533;&#x8BF7;&#x5230;&#x7684;&#x9875;&#x9762;&#xFF0C;&#x5E94;&#x8BE5;&#x90FD;&#x8981;&#x8FD9;&#x6837;&#x505A;&#x3002;</span></div><div>&#xA0; &#xA0; &#xA0;b)&#x4E3A;&#x6BCF;&#x4E2A;&#x9875;&#x9762;&#x8BBE;&#x7F6E;miagrate type&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x5916;&#x90E8;&#x788E;&#x7247;&#xFF0C;&#x5176;&#x4E2D;&#x7684;&#x673A;&#x5236;&#x4E5F;&#x7565;&#x6709;&#x4E9B;&#x590D;&#x6742;</div><div>&#xA0; &#xA0; &#xA0;c)lru list&#x662F;&#x4E3A;&#x4E86;&#x56DE;&#x6536;&#x673A;&#x5236;&#x8BBE;&#x8BA1;&#x7684;&#xFF0C;&#x5168;&#x79F0;&#x662F;Least Recently Used</div><div>&#xA0; &#xA0; &#xA0;d)&#x5173;&#x4E8E;struct page&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;Mel Gorman&#x7684;&#x300A;Understanding the Linux&#xAE;&#xA0;Virtual Memory Manager&#x300B;&#x7684;P41&#xFF1A;Pages&#x4E00;&#x8282;&#x3002;</div><div><br></div><div>5)&#xA0;alloc_bootmem_node</div><div>&#xA0; &#xA0; &#xA0;alloc_bootmem_node -&gt;&#xA0;__alloc_bootmem_node -&gt;&#xA0;___alloc_bootmem_node -&gt;&#xA0;alloc_arch_preferred_bootmem / alloc_bootmem_core / ___alloc_bootmem</div><div>&#xA0; &#xA0; &#xA0;&#x6700;&#x540E;&#x843D;&#x5B9E;&#x5230;&#x4E09;&#x4E2A;&#x51FD;&#x6570;alloc_arch_preferred_bootmem / alloc_bootmem_core / ___alloc_bootmem&#x3002;</div><div>&#xA0; &#xA0; &#xA0;alloc_arch_preferred_bootmem&#xA0;&#x548C;___alloc_bootmem&#x5728;&#x672A;&#x5B9A;&#x4E49;CONFIG_NO_BOOTMEM&#x65F6;&#xFF0C;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x7684;&#x90FD;&#x662F;alloc_bootmem_core&#xA0;&#x3002;&#x6240;&#x4EE5;alloc_bootmem_core&#xA0;&#x662F;&#x6838;&#x5FC3;&#x51FD;&#x6570;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#x90A3;&#x4E48;&#x6765;&#x770B;alloc_bootmem_core&#x3002;</div><div>&#xA0; &#xA0; &#xA0;<img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960786\" hash=\"ccb96de4575061c281c7fcd12baae0ff\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div><br></div><div>&#xA0; &#xA0; &#xA0;&#x8FD9;&#x5176;&#x4E2D;&#x6709;&#x5F88;&#x591A;&#x4E2A;&#x6307;&#x6807;&#xFF0C;&#x5927;&#x4F53;&#x603B;&#x7ED3;&#x5982;&#x4E0B;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201); font-weight: bold;\">sidx / midx</span><span style=\"font-family: &quot;Courier New&quot;;\">:&#xA0;start - bdata-&gt;node_min_pfn /&#xA0;max - bdata-&gt;node_min_pfn</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x8FD9;&#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#x4E5F;&#x4F1A;&#x6709;&#x4E00;&#x4E9B;&#x5904;&#x7406;&#xFF0C;&#x4F46;&#x5927;&#x4F53;&#x4E0A;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#x662F;&#x672C;node&#x4F4E;&#x7AEF;&#x5185;&#x5B58;&#x7684;&#x9996;&#x672B;&#x5730;&#x5740;&#x9875;&#x7D22;&#x5F15;&#x3002;</span></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201); font-weight: bold;\">eidx</span><span style=\"font-family: &quot;Courier New&quot;;\">: sidx + PFN_UP(size)</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x9700;&#x8981;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#x672B;&#x5730;&#x5740;&#x6309;&#x9875;&#x5411;&#x4E0B;&#xFF08;&#x589E;&#x957F;&#x65B9;&#x5411;&#xFF09;&#x5BF9;&#x9F50;&#x540E;&#x7684;&#x9875;&#x7D22;&#x5F15;</span></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201); font-weight: bold;\">start_off / end_off</span><span style=\"font-family: &quot;Courier New&quot;;\">:</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#x5206;&#x914D;&#x7A7A;&#x95F4;&#x59CB;&#x672B;&#x5730;&#x5740;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;</span></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201); font-weight: bold;\">merge</span><span style=\"font-family: &quot;Courier New&quot;;\">:&#xA0;PFN_DOWN(start_off) &lt; sidx</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x6B64;&#x65F6;start_off&#x662F;&#x7ECF;&#x8FC7;&#x5904;&#x7406;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x524D;&#x6B21;&#x5206;&#x914D;&#x7684;&#x672B;&#x5730;&#x5740;&#xFF08;last_end_off&#xFF09;&#x6240;&#x5728;&#x9875;&#x8FD8;&#x6709;&#x7A7A;&#x95F2;&#xFF0C;&#x5219;&#x5C06;start_off&#x5411;&#x4E0A;&#x63D0;&#x5347;&#x5230;&#x8BE5;&#x9875;&#xFF0C;&#x5E76;&#x4E0E;last_end_off&#x9694;&#x5F00;&#x4E00;&#x5B9A;&#x7684;&#x8DDD;&#x79BB;</span></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201); font-weight: bold;\">bdata-&gt;last_end_off</span><span style=\"font-family: &quot;Courier New&quot;;\">:</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#x8BB0;&#x5F55;&#x4E0A;&#x4E00;&#x6B21;&#x5206;&#x914D;&#x672B;&#x5730;&#x5740;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x4E0D;&#x6309;&#x9875;&#x5BF9;&#x9F50;&#xFF0C;&#x6B64;&#x53D8;&#x91CF;&#x53EA;&#x5728;alloc_bootmem_core&#x4E2D;&#x66F4;&#x65B0;</span></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;; color: rgb(45, 79, 201); font-weight: bold;\">bdata-&gt;hint_idx</span><span style=\"font-family: &quot;Courier New&quot;;\">:</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#x5728;alloc_bootmem_core&#x4E2D;= PFN_UP(end_off)&#xFF0C;&#x5728;__free&#x7684;&#x65F6;&#x5019;= sidx&#xFF0C;&#x8BB0;&#x5F55;&#x7684;&#x662F;&#x53EF;&#x5206;&#x914D;&#x5730;&#x5740;&#x7684;&#x6700;&#x5C0F;&#x503C;&#x7684;&#x9875;&#x7D22;&#x5F15;</span></div><div><br></div><div>&#xA0; &#xA0; &#xA0;&#x4E86;&#x89E3;&#x8FD9;&#x4E9B;&#x6307;&#x6807;&#x4E4B;&#x540E;&#xFF0C;&#x5BF9;code&#x5C31;&#x6BD4;&#x8F83;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#x4E86;&#x3002;&#x6458;&#x5F55;&#x5982;&#x4E0B;</div><div><br></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">static void * __init alloc_bootmem_core (&#x2026;&#x2026;) {</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;</div><div><br></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">find_block:</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">sidx = find_next_zero_bit(bdata-&gt;node_bootmem_map, midx, sidx);</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">//&#xA0;find_next_zero_bit&#x53C2;&#x8003;&#x53E6;&#x4E00;&#x7BC7;&#x7B14;&#x8BB0;</span><a href=\"evernote:///view/161681/s10/3437e87a-af8c-418e-8219-747687b4f1af/3437e87a-af8c-418e-8219-747687b4f1af/\" style=\"font-family: &quot;Courier New&quot;;\">find_next_zero_bit</a></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; sidx = align_idx(bdata, sidx, step);</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; eidx = sidx + PFN_UP(size);</span></div><div><br></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (sidx &gt;= midx || eidx &gt; midx)</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// sidx &gt; midx&#x548C;eidx &gt; midx&#x6BD4;&#x8F83;&#x597D;&#x7406;&#x89E3;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break; <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">//&#xA0;</span></span><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">sidx = midx&#x7684;&#x60C5;&#x51B5;&#x6307;&#x7684;&#x662F;</span><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">find_next_zero_bit&#x8FD4;&#x56DE;&#x7684;&#x662F;</span><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">midx&#xFF0C;&#x6839;&#x636E;</span><a href=\"evernote:///view/161681/s10/3437e87a-af8c-418e-8219-747687b4f1af/3437e87a-af8c-418e-8219-747687b4f1af/\" style=\"font-family: &quot;Courier New&quot;;\">find_next_zero_bit</a><span style=\"color: rgb(65, 173, 28);\">&#x8FD9;&#x7BC7;&#x7B14;&#x8BB0;&#x53EF;&#x77E5;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x662F;</span><a href=\"evernote:///view/161681/s10/3437e87a-af8c-418e-8219-747687b4f1af/3437e87a-af8c-418e-8219-747687b4f1af/\" style=\"font-family: &quot;Courier New&quot;;\">find_next_zero_bit</a><span style=\"color: rgb(65, 173, 28);\">&#x5931;&#x8D25;&#xFF0C;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x672A;&#x5206;&#x914D;&#x9875;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">for (i = sidx; i &lt; eidx; i++)</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; start_off = PFN_PHYS(sidx);</span></div><div><br></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">merge = PFN_DOWN(start_off) &lt; sidx;</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x8868;&#x793A;&#x672C;&#x6B21;&#x5206;&#x914D;&#x4E0E;&#x4E0A;&#x6B21;&#x5206;&#x914D;&#x6709;&#x4EA4;&#x53E0;&#xFF0C;&#x53C2;&#x770B;&#x56FE;1</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;</div><div><br></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0; &#xA0;</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">/*</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * Reserve the area now:</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; */</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (__reserve(bdata, PFN_DOWN(start_off) + merge,</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// merge =0: &#x6CA1;&#x6709;&#x4EA4;&#x53E0;&#xFF0C;&#x6B63;&#x5E38;&#x5206;&#x914D;&#xFF0C;merge =1&#xFF1A;&#x548C;&#x4E0A;&#x6B21;&#x6709;&#x4EA4;&#x53E0;&#xFF0C;&#x4F46;&#x6709;&#x4EA4;&#x53E0;&#x7684;&#x9875;&#x5DF2;&#x7ECF;reserve&#x8FC7;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x4ECE;&#x4E0B;&#x4E00;&#x9875;&#x5F00;&#x59CB;reserve</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; PFN_UP(end_off), BOOTMEM_EXCLUSIVE))</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;<span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0;</span></div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">}</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<img class=\"enMedia\" src=\"/images/bootmem&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084960782\" hash=\"b9a9d387c218f326cac764cc823bb17c\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div><br></div><div>&#xA0; &#xA0; &#xA0;alloc_bootmem_core&#x4E2D;&#x8FD8;&#x6709;&#x4E2A;fall_back&#x673A;&#x5236;&#xFF0C;&#x5177;&#x4F53;&#x5982;&#x4E0B;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">static void * __init alloc_bootmem_core (&#x2026;&#x2026;) {</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x2026;&#x2026;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">if (bdata-&gt;hint_idx &gt; sidx) { <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">//&#xA0;</span></span><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">hint_idx&#x662F;&#x53EF;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#x7684;&#x6700;&#x5C0F;&#x503C;&#xFF0C;&#x8FD9;&#x4E2A;&#x6761;&#x4EF6;&#x8868;&#x793A;&#x641C;&#x7D22;&#x8D77;&#x59CB;&#x70B9;&#x53EF;&#x4EE5;&#x5411;&#x524D;&#x63D0;&#x5347;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">/*</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * Handle the valid case of sidx being zero and still</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * catch the fallback below.</span></div><div><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; */</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; fallback = sidx + 1;</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x8BB0;&#x5F55;fall_back&#x503C;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; sidx = align_idx(bdata, bdata-&gt;hint_idx, step);</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x5C06;</span><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">sidx&#x63D0;&#x5347;&#x5230;</span><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">hint_idx&#x9644;&#x8FD1;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">}</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0;while(1) {</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">find_block:</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">&#x2026;&#x2026;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;}</span></div><div><br></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">if (fallback) {</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">// &#x5982;&#x679C;&#x641C;&#x7D22;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x5C06;sidx&#x8FD8;&#x539F;&#x518D;&#x91CD;&#x65B0;&#x641C;&#x7D22;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; sidx = align_idx(bdata, fallback - 1, step);</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; fallback = 0;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto find_block;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">}</span></div><div><br></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0;return NULL;</span></div><div>&#xA0; &#xA0; &#xA0;}</div><div><br></div><div>6) init_currently_empty_zone</div><div>&#x672C;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x521D;&#x59CB;&#x5316;zone&#x7ED3;&#x6784;&#xFF0C;&#x66F4;&#x660E;&#x786E;&#x7684;&#x5C31;&#x662F;&#xFF1A;&#xFF08;1&#xFF09;wait queue table&#x521D;&#x59CB;&#x5316;&#xFF0C;&#xFF08;2&#xFF09;free_area&#x521D;&#x59CB;&#x5316;</div><div>&#x8C03;&#x7528;&#x987A;&#x5E8F;&#x5982;&#x4E0B;</div><div>zone_wait_table_init -&gt;&#xA0;zone_init_free_lists(zone)</div><div>&#xA0; &#xA0; &#xA0;a)&#xA0;zone_wait_table_init&#xA0;</div><div>&#xA0; &#xA0; &#xA0;&#x6B64;&#x51FD;&#x6570;&#x521D;&#x59CB;&#x5316;&#x4E86;zone-&gt;wait_table&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x5F20;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x6709;zone-&gt;wait_table_hash_nr_entries&#x4E2A;&#x8868;&#x9879;&#xFF08;&#x6700;&#x5C11;4&#xFF0C;&#x6700;&#x591A;4096&#xFF09;&#x3002;wait_table&#x76F8;&#x5173;&#x5185;&#x5BB9;&#x53EF;&#x53C2;&#x8003;&#x53EF;&#x4EE5;&#x53C2;&#x8003;Mel Gorman&#x7684;&#x300A;Understanding the Linux&#xAE;&#xA0;Virtual Memory Manager&#x300B;P40&#xFF1A;Zone Wait Queue Table&#x4E00;&#x8282;&#x3002;&#x5185;&#x5B58;&#x9875;&#x7684;wait-wake&#x673A;&#x5236;&#x8BF7;&#x53C2;&#x8003;&#x7B14;&#x8BB0;<a href=\"evernote:///view/161681/s10/00adfa18-d628-4d70-a080-7c1590a5e613/00adfa18-d628-4d70-a080-7c1590a5e613/\" style=\"color: rgb(105, 170, 53);\">&#x5185;&#x5B58;&#x9875;&#x7684;wait-wake&#x673A;&#x5236;</a>&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#x672C;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x4E3A;&#xFF1A;</div><div>wait_table_hash_nr_entries(zone_size_pages) -&gt;&#xA0;wait_table_bits(zone-&gt;wait_table_hash_nr_entries) -&gt;&#xA0;alloc_bootmem_node(pgdat, alloc_size) -&gt; &#x904D;&#x5386;&#x6240;&#x6709;&#x54C8;&#x5E0C;&#x9879;&#xFF0C;&#x5E76;&#x521D;&#x59CB;&#x5316;init_waitqueue_head(zone-&gt;wait_table + i)</div><div>&#xA0; &#xA0; &#xA0;b&#xFF09;zone_init_free_lists</div><div>&#xA0; &#xA0; &#xA0;&#x7275;&#x6D89;&#x5230;migrate type&#xFF0C;&#x5C1A;&#x4E0D;&#x6E05;&#x695A;&#x5176;&#x4E2D;&#x7684;&#x673A;&#x5236;&#xFF0C;&#x4F1A;&#x7528;&#x65B0;&#x7BC7;&#x6765;&#x4F5C;&#x4ECB;&#x7ECD;</div><div><br></div><div><br></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/10/08/memblock%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/",
            "url": "https://blog.zhougy.top/2012/10/08/memblock%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/",
            "title": "memblock工作原理",
            "date_published": "2012-10-08T10:35:54.000Z",
            "content_html": "<div class=\"enNote\" style title lang xml:lang dir><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\">memblock&#x662F;Linux&#x542F;&#x52A8;&#x9636;&#x6BB5;&#x7684;&#x4E00;&#x79CD;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x65B9;&#x5F0F;&#xFF0C;&#x662F;&#x5BF9;bootmem&#x7684;&#x8865;&#x5145;&#xFF0C;&#x662F;&#x4E3A;&#x4E86;&#x5E94;&#x5BF9;bootmem&#x6613;&#x4EA7;&#x751F;&#x5916;&#x90E8;&#x788E;&#x7247;&#x800C;&#x4EA7;&#x751F;&#x3002;&#x4ED6;&#x7684;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;arm_memblock_init&#x548C;bootmem&#x521D;&#x59CB;&#x5316;&#x6240;&#x5728;&#x7684;&#x51FD;&#x6570;paging_init&#x7D27;&#x6328;&#x7740;&#xFF0C;&#x90FD;&#x5728;setup_arch&#x4E2D;&#x3002;</span></div><div style=\"margin: 0px 0px 0px 40px; border: none; padding: 0px;\"><div><span style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><span style=\"font-family: &quot;Courier New&quot;;\">struct memblock {</span></span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0; phys_addr_t current_limit;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0; phys_addr_t memory_size;&#xA0;&#xA0;&#xA0;</span> <span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">/* Updated by memblock_analyze() */</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0; struct memblock_type memory;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0; struct memblock_type reserved;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">};</span></div><div><br></div><div><span style=\"font-family: &quot;Courier New&quot;;\">current_limit&#xFF1A;&#x8868;&#x793A;memblock&#x53EF;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#x7684;&#x4E0A;&#x9650;&#x503C;&#xFF0C;&#x5176;&#x521D;&#x59CB;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x4E3A;</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;<span style=\"font-family: &quot;Courier New&quot;;\">paging_init -&gt; sanity_check_meminfo -&gt; memblock_set current_limit(limit)</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#x5176;&#x4E2D;limit = __pa(vmalloc_min-1) + 1 = VMALLOC_END - 128M = 4G - 128M(high mem)</div><div><span style=\"font-family: &quot;Courier New&quot;;\">memory_size&#xFF1A;&#x8BB0;&#x5F55;&#x603B;&#x7684;&#x5185;&#x5B58;&#x6570;&#x91CF;&#xFF0C;&#x5728;memory_analyze&#x4E2D;&#x66F4;&#x65B0;</span></div><div><span style=\"font-family: &quot;Courier New&quot;;\">memory,reserved&#xFF1A;&#x662F;&#x4E24;&#x5F20;&#x8868;&#x683C;&#xFF0C;&#x524D;&#x8005;&#x662F;&#x7CFB;&#x7EDF;&#x6240;&#x62E5;&#x6709;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x540E;&#x8005;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x5DF2;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5757;</span></div><div><br></div></div><div>1. &#x521D;&#x59CB;&#x5316;</div><div><img class=\"enMedia\" src=\"/images/memblock&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084959865\" hash=\"7ab6740575d50f5739c1e48b2d63b4cb\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;1&#xFF09;mdesc-&gt;reserve&#x662F;&#x5728;arch/arm/mach-omap2/board-d7800.c&#x4E2D;&#x5206;&#x914D;&#x7ED9;machine_desc&#x53D8;&#x91CF;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;meminfo&#x7684;&#x521D;&#x59CB;&#x5316;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x53E6;&#x5916;&#x4E00;&#x7BC7;&#x7B14;&#x8BB0;<a href=\"evernote:///view/161681/s10/638c401b-6ae0-4f04-85a6-a35529f7768b/638c401b-6ae0-4f04-85a6-a35529f7768b/\" style=\"color: rgb(105, 170, 53);\">meminfo&#x521D;&#x59CB;&#x5316;</a></div><div><br></div><div>2.&#x5185;&#x5B58;&#x5206;&#x914D;</div><div><img class=\"enMedia\" src=\"/images/memblock&#x5DE5;&#x4F5C;&#x539F;&#x7406;/1537084959870\" hash=\"89a57c932790964dce9ee3e7e6f8d052\" align alt longdesc width=\"1142\" height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>&#xA0; &#xA0; &#xA0;1&#xFF09;MEMBLOCK_ALLOC_ACCESSIBLE&#x7684;&#x503C;&#x4E3A;0&#xFF0C;&#x5219;&#x540E;&#x9762;&#x7684;max_addr&#x4E5F;&#x4E3A;0&#xFF0C;&#x4F46;&#x5E76;&#x4E0D;&#x610F;&#x5473;&#x7740;&#x641C;&#x7D22;&#x7684;&#x4E0A;&#x9650;&#x4E5F;&#x4E3A;0&#x3002;&#x5728;memblock_find_base&#x4E2D;end&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x641C;&#x7D22;&#x7684;&#x4E0A;&#x9650;&#xFF08;&#x5176;&#x5B9E;&#x662F;&#x641C;&#x7D22;&#x7684;&#x8D77;&#x59CB;&#x503C;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x641C;&#x7D22;&#x65F6;&#x4ECE;&#x5185;&#x5B58;&#x7684;&#x6700;&#x9AD8;&#x503C;&#x5F00;&#x59CB;&#x7684;&#xFF0C;&#x8FD9;&#x4E48;&#x505A;&#x662F;&#x6709;&#x7528;&#x610F;&#x7684;&#xFF0C;&#x8BE6;&#x89C1;&#x7B2C;2&#x70B9;&#xFF09;&#x8D4B;&#x4E3A;memblock.current_limit&#xFF0C;&#x5B83;&#x7684;&#x503C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x672C;&#x6587;&#x524D;&#x9762;&#x7684;&#x4ECB;&#x7ECD;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;&#x4E3A;&#x4EC0;&#x4E48;&#x662F;&#x4ECE;&#x5185;&#x5B58;&#x7684;&#x9AD8;&#x5730;&#x5740;&#x5F00;&#x59CB;&#x641C;&#x7D22;&#xFF0C;mm/memblock.c&#x4E2D;&#x7684;&#x6709;&#x6CE8;&#x91CA;&#x9053;</div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</span><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">/* We do a top-down search, this tends to limit memory</span></div><div style=\"margin: 0px 0px 0px 40px; border: none; padding: 0px;\"><div><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0; * fragmentation by keeping early boot allocs near the</span></div><div><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0; * top of memory</span></div><div><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0; */</span></div></div><div style=\"margin-left: 40px;\">&#x770B;&#x8D77;&#x6765;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x788E;&#x7247;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x89E3;&#x51B3;&#xFF0C;&#x4E0D;&#x6E05;&#x695A;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;3&#xFF09;&#x4EE3;&#x7801;&#x4E2D;&#x7684;&#x8DDF;&#x5185;&#x5B58;&#x533A;&#x7684;&#x59CB;&#x672B;&#x4F4D;&#x7F6E;&#x6709;&#x5173;&#x7684;&#x503C;&#x90FD;&#x8FDB;&#x884C;&#x4E86;&#x5BF9;&#x9F50;&#xFF0C;&#x7528;&#x5230;&#x5982;&#x4E0B;&#x7684;&#x8BED;&#x53E5;</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style=\"color: rgb(45, 79, 201); font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0;size = memblock_align_up(size, align)</span></div><div><span style=\"color: rgb(45, 79, 201); font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;base = memblock_align_down((end - size), align)</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x8FD9;&#x4E9B;&#x4E5F;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x788E;&#x7247;&#x95EE;&#x9898;&#xFF0C;mm/memblock.c &#x4E2D;&#x6709;&#x6CE8;&#x91CA;&#xFF0C;&#x9053;</div><div><span style=\"font-family: &quot;Courier New&quot;;\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</span><span style=\"font-family: &quot;Courier New&quot;; color: rgb(65, 173, 28);\">/* We align the size to limit fragmentation. Without this, a lot of</span></div><div style=\"margin: 0px 0px 0px 40px; border: none; padding: 0px;\"><div><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0; * small allocs quickly eat up the whole reserve array on sparc</span></div><div><span style=\"color: rgb(65, 173, 28); font-family: &quot;Courier New&quot;;\">&#xA0;&#xA0;&#xA0;&#xA0; */</span></div></div><div>&#xA0; &#xA0; &#xA0;4&#xFF09;memblock_addrs_overlap&#x4E2D;&#x5224;&#x65AD;&#x4EA4;&#x53E0;&#x7684;&#x65B9;&#x6CD5;&#x5F88;&#x503C;&#x5F97;&#x5B66;&#x4E60;&#x3002;</div><div><br></div></div>",
            "tags": [
                "Linux",
                "内存管理"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/09/29/meminfo%E5%88%9D%E5%A7%8B%E5%8C%96/",
            "url": "https://blog.zhougy.top/2012/09/29/meminfo%E5%88%9D%E5%A7%8B%E5%8C%96/",
            "title": "meminfo初始化",
            "date_published": "2012-09-29T02:46:46.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir>1. u-boot&#x4E2D;&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;<div>&#xA0; &#xA0; &#xA0;1&#xFF09;&#x542F;&#x52A8;&#x547D;&#x4EE4;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;u-boot-env.txt</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">bootcmd&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if ${recovery}; then&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;run nandrecovery;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;else&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if mmc init; then&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if run loadbootscript; then&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;run bootscript;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;else&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;if run loaduImage; then&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;run mmcboot;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;else&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;run nandboot;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;fi;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;fi;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;else&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<b><font color=\"#FF0000\">run nandboot;</font></b>&#xA0;</font></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; fi;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;fi</font></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">nandboot&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;echo Booting from nand ...;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font color=\"#FF0000\">run nandargs;</font>&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;nand read ${loadaddr} boot;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;booti 0x82000008</font></div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"font-family: &apos;Courier New&apos;;\">nandargs</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">setenv bootargs console=${console} init=${init} <font color=\"#FF0000\">mem=${mem}</font> ip=${ip} mpurate=${mpurate} omap_vout.vid1_static_vrfb_alloc=y vram=${vram} omapfb.vram=0:8M androidboot.console=${tty} root=${root_nand} rootfstype=${rootfstype_nand} ubi.mtd=${ubi_mtd}</font></div><div><font face=\"Courier New\"><br></font></div><div>&#xA0; &#xA0; &#xA0;&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x5C5E;&#x4E8E;commandline&#xFF0C;&#x4F1A;&#x5728;setup_commandline_tag&#x4E2D;&#x63D2;&#x5165;params&#x6570;&#x7EC4;&#xFF0C;&#x5E76;&#x6807;&#x4E0A;ATAG_CMDLINE&#xFF0C;&#x4F1A;&#x5728;parse_args&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7528;&#x5BF9;&#x5E94;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x6765;&#x5904;&#x7406;&#xFF0C;&#x5177;&#x4F53;&#x5982;&#x4E0B;</div><div>&#xA0; &#xA0; &#xA0;</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;&#x73AF;&#x5883;&#x53D8;&#x91CF;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;include/configs/d7800.h</div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0;#define CONFIG_EXTRA_ENV_SETTINGS \\</font></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">&#xA0; &#xA0; &quot;init=/init\\0&quot; \\<br>&#xA0; &#xA0; <font color=\"#FF0000\">&quot;mem=256M\\0&quot;</font> \\<br>&#xA0; &#xA0; &quot;mpurate=800\\0&quot; \\<br>&#xA0; &#xA0;&#x2026;&#x2026;</font></blockquote><div><font face=\"Courier New\"><br></font></div><div>2.<font face=\"Courier New\">kernel&#x4E2D;&#x7528;parse_args&#x89E3;&#x6790;&#x6B64;bootarg&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x53C2;&#x8003;&#x53E6;&#x4E00;&#x4EFD;&#x7B14;&#x8BB0;</font><a href=\"evernote:///view/161681/s10/39d4ca69-e5d9-4582-9635-d9963aa05e29/39d4ca69-e5d9-4582-9635-d9963aa05e29/\" style=\"color: rgb(105, 170, 53);\">Linux&#x542F;&#x52A8;&#x53C2;&#x6570;&#x201C;init=xxx&#x201D;&#x5206;&#x6790;</a></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0;parse_args -&gt;&#xA0;parse_one -&gt;&#xA0;unknown_bootoption -&gt;&#xA0;obsolete_checksetup -&gt;&#xA0;obs_kernel_param.setup_func =&#xA0;early_mem</font></div><div><font face=\"Courier New\"><br></font></div><div><div><font face=\"Courier New\">3.kernel&#x4E2D;&#x8BBE;&#x7F6E;&#x5BF9;&#x5E94;bootarg&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;</font></div><div>&#xA0; &#xA0; &#xA0;<font face=\"Courier New\">early_param(&quot;mem&quot;, early_mem); -&gt;&#xA0;__setup_param(str, fn, fn, 1) -&gt;&#xA0;</font></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0;#define __setup_param(str, unique_id, fn, early)&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; \\</font></div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0;static const char __setup_str_##unique_id[] __initconst \\<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; __aligned(1) = str; \\<br>&#xA0; &#xA0; &#xA0;static struct obs_kernel_param __setup_##unique_id&#xA0; \\<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; __used __section(<font color=\"#FF0000\">.init.setup</font>)&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; \\<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; __attribute__((aligned((sizeof(long)))))&#xA0;&#xA0;&#xA0; \\<br></font><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; = { __setup_str_##unique_id, fn, early } &#xA0;&#xA0;</font></div></div><div><font face=\"Courier New\"><br></font></div><div><font face=\"Courier New\">4.</font><span style=\"font-family: &apos;Courier New&apos;;\">early_mem&#x51FD;&#x6570;</span></div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<font face=\"Courier New\">static int __init early_mem(char *p)</font></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\">{<br>&#xA0;&#xA0;&#xA0; static int usermem __initdata = 0;<br>&#xA0;&#xA0;&#xA0; unsigned long size, start;<br>&#xA0;&#xA0;&#xA0; char *endp;<br>&#xA0;&#xA0;&#xA0; <font color=\"#41AD1C\">/*<br>&#xA0;&#xA0;&#xA0;&#xA0; * If the user specifies memory size, we<br>&#xA0;&#xA0;&#xA0;&#xA0; * blow away any automatically generated<br>&#xA0;&#xA0;&#xA0;&#xA0; * size.<br>&#xA0;&#xA0;&#xA0;&#xA0; */</font><br>&#xA0;&#xA0;&#xA0; if (usermem == 0) {<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; usermem = 1;<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; meminfo.nr_banks = 0;<br>&#xA0;&#xA0;&#xA0; }</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\">&#xA0; &#xA0; &#xA0; &#xA0;&#xA0;<span style=\"color: rgb(65, 173, 28); font-family: &apos;Courier New&apos;;\">/*</span><div><span style=\"color: rgb(65, 173, 28); font-family: &apos;Courier New&apos;;\">&#xA0;&#xA0;&#xA0;&#xA0;</span> <font color=\"#41AD1C\"><span style=\"font-family: &apos;Courier New&apos;;\">*&#xA0;</span><span style=\"font-family: &apos;Courier New&apos;;\">defined in</span><span style=\"font-family: &apos;Courier New&apos;;\">&#xA0;</span><span style=\"font-family: &apos;Courier New&apos;;\">arch/arm/plat-omap/include/plat/memory.h</span><span style=\"font-family: &apos;Courier New&apos;;\"><br></span><span style=\"font-family: &apos;Courier New&apos;;\">&#xA0;&#xA0;&#xA0;&#xA0; *&#xA0;</span>PHYS_OFFSET &#xA0;= UL(0x80000000)</font><br style=\"color: rgb(65, 173, 28); font-family: &apos;Courier New&apos;;\"><span style=\"color: rgb(65, 173, 28); font-family: &apos;Courier New&apos;;\">&#xA0;&#xA0;&#xA0;&#xA0; */</span></div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0; start = PHYS_OFFSET;<br>&#xA0;&#xA0;&#xA0; size&#xA0; = memparse(p, &amp;endp);<br>&#xA0;&#xA0;&#xA0; if (*endp == &apos;@&apos;)<br>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; start = memparse(endp + 1, NULL);<br>&#xA0;&#xA0;&#xA0; arm_add_memory(start, size);<br>&#xA0;&#xA0;&#xA0; return 0;<br>}</font></blockquote><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><font face=\"Courier New\"><br></font></blockquote><font face=\"Courier New\">&#x6700;&#x540E;&#x9057;&#x7559;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x5047;&#x5982;&#x6709;&#x51E0;&#x5757;&#x5185;&#x5B58;&#x9700;&#x8981;&#x5904;&#x7406;&#x600E;&#x4E48;&#x529E;&#xFF1F;<br></font><div>&#xA0; &#xA0; &#xA0;<font face=\"Courier New\">&#x6CA1;&#x5173;&#x7CFB;&#xFF0C;Linux&#x63D0;&#x4F9B;&#x4E86;&#x5BF9;&#x5E94;&#x7684;&#x673A;&#x5236;&#x3002;&#x5C31;&#x662F;</font>__tagtable(ATAG_MEM, parse_tag_mem32);&#x8FD9;&#x662F;&#x4E00;&#x5F20;&#x8868;&#x683C;&#xFF0C;&#x4EE3;&#x8868;&#x4E86;&#x4E00;&#x7EC4;ATAG_MEM param&#xFF0C;&#x7528;parse_tag_mem32&#x6765;&#x5904;&#x7406;&#x3002;&#x8FD9;&#x4E00;&#x7EC4;param&#x540C;&#x6837;&#x4E5F;&#x662F;&#x5728;u-boot&#x9636;&#x6BB5;&#x5C31;&#x52A0;&#x5165;&#x4E86;&#x3002;&#x5373;&#xFF1A;</div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0;do_bootm_linux -&gt;&#xA0;setup_memory_tags (u-boot)</font></div><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font face=\"Courier New\">static void setup_memory_tags (bd_t *bd)</font></div><div><font face=\"Courier New\">{</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0; int i;</font></div><div><font face=\"Courier New\"><br></font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0; for (i = 0; i &lt; CONFIG_NR_DRAM_BANKS; i++) {</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; params-&gt;hdr.tag = ATAG_MEM;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; params-&gt;hdr.size = tag_size (tag_mem32);</font></div><div><font face=\"Courier New\"><br></font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; params-&gt;u.mem.start = bd-&gt;bi_dram[i].start;</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; params-&gt;u.mem.size = bd-&gt;bi_dram[i].size;</font></div><div><font face=\"Courier New\"><br></font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; params = tag_next (params);</font></div><div><font face=\"Courier New\">&#xA0;&#xA0;&#xA0; }</font></div><div><font face=\"Courier New\">}</font></div><div><font face=\"Courier New\"><br></font></div></blockquote>&#xA0; &#xA0; &#xA0;&#x53EA;&#x4E0D;&#x8FC7;&#x5728;D7800&#x4E2D;<span style=\"font-family: &apos;Courier New&apos;;\">CONFIG_NR_DRAM_BANKS=1&#xFF08;configs/d7800.h&#xFF09;&#x3002;</span><div><font face=\"Courier New\"><br></font></div><div>&#xA0; &#xA0; &#xA0;meminfo&#x4E2D;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#x5168;&#x90E8;&#x662F;&#x771F;&#x6B63;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x3002;<font face=\"Courier New\"><br></font><blockquote style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><font face=\"Courier New\"><br></font></div></blockquote><div><br></div><div>&#xA0; &#xA0; &#xA0;</div></div></blockquote></div>",
            "tags": [
                "Linux",
                "内存管理",
                "uboot"
            ]
        },
        {
            "id": "https://blog.zhougy.top/2012/09/12/USB%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/",
            "url": "https://blog.zhougy.top/2012/09/12/USB%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/",
            "title": "USB驱动程序",
            "date_published": "2012-09-12T06:23:07.000Z",
            "content_html": "<div class=\"enNote\" style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\" title lang xml:lang dir><div>1. device&#xFF0C;configuration&#xFF0C;interface&#xFF0C;endpoint</div><div>&#x6211;&#x7684;&#x7406;&#x89E3;&#xFF1A;</div><div>&#xA0; &#xA0; &#xA0;1&#xFF09;&#x9996;&#x5148;&#xFF0C;&#x4E00;&#x4E2A;device&#x5305;&#x542B;&#x591A;&#x4E2A;configuration&#xFF0C;</div><div>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#x4E00;&#x4E2A;configuration&#x5305;&#x542B;&#x591A;&#x4E2A;interface</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x4E00;&#x4E2A;interface&#x4F7F;&#x7528;&#x591A;&#x4E2A;endpoint&#x6765;&#x5B8C;&#x6210;&#x529F;&#x80FD;</div><div>&#xA0; &#xA0; &#xA0;2&#xFF09;&#x5176;&#x6B21;&#xFF0C;interface&#x5BF9;&#x5E94;&#x5230;USB device&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;&#x903B;&#x8F91;&#x8BBE;&#x5907;&#x3002;&#x4E00;&#x4E2A;configuration&#x5C31;&#x5305;&#x542B;&#x4E86;&#x591A;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x903B;&#x8F91;&#x8BBE;&#x5907;&#xFF0C;&#x5B83;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x5BF9;&#x5E94;&#x4E86;&#x67D0;&#x4E00;&#x4E2A;&#x65F6;&#x523B;&#x7684;USB device&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x4E00;&#x4E2A;USB device&#x5728;&#x4E0D;&#x540C;&#x7684;&#x65F6;&#x523B;&#xFF0C;&#x9700;&#x8981;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x7528;&#x9014;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x7528;&#x9014;&#x7531;&#x591A;&#x4E2A;&#x903B;&#x8F91;&#x8BBE;&#x5907;&#x6765;&#x8FBE;&#x6210;&#x3002;&#x4E3E;&#x4F8B;&#x6765;&#x8BF4;&#xFF1A;&#x4E00;&#x4E9B;USB&#x8BBE;&#x5907;&#x9700;&#x8981;&#x4E0B;&#x8F7D;&#x56FA;&#x4EF6;&#x5230;&#x5176;&#x4E0A;&#xFF0C;&#x5219;&#x8FD9;&#x4E9B;&#x8BBE;&#x5907;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x65F6;&#x5019;&#x626E;&#x6F14;&#x4E0D;&#x540C;&#x7684;&#x89D2;&#x8272;&#xFF08;&#x5B58;&#x50A8;&#x8BBE;&#x5907;&#xFF0C;&#x6216;&#x8005;&#x65E0;&#x7EBF;&#x7F51;&#x5361;&#x7B49;&#x7B49;&#xFF09;&#x3002;</div><div><br></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0;usb_interface --&#xA0;usb_host_interface (altsetting) --&#xA0;usb_interface_descriptor --&#xA0;bAlternateSetting:<font color=\"#3665EE\">altsetting&#x7F16;&#x53F7;</font></font></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;| &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;|- &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;+ bInterfaceNumber&#xFF1A;<font color=\"#3665EE\">interface&#x7F16;&#x53F7;</font></font></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;| &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;|- extra: <font color=\"#3665EE\">following usb_host_interface_descriptor in this interface (hence usb_interface)</font></font></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;| &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;|- usb_host_endpoint: <font color=\"#3665EE\">&#x6B64;&#x914D;&#x7F6E;&#x4E0B;&#x7684;endpoint&#x6570;&#x7EC4;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E86;&#x6BCF;&#x4E2A;ep&#x7684;desc&#x548C;urb_list</font></font></div><div><font face=\"Courier New\">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;|-&#xA0;</font><span style=\"font-family: &apos;Courier New&apos;;\">usb_host_interface</span><span style=\"font-family: &apos;Courier New&apos;;\">&#xA0;</span><span style=\"font-family: &apos;Courier New&apos;;\">(altsetting[1])</span></div><div>&#xA0; &#xA0; &#xA0;3&#xFF09;&#x5982;&#x4E0A;&#x56FE;&#xFF0C;&#x6BCF;&#x4E2A;interface&#x53EF;&#x4EE5;&#x5305;&#x542B;&#x591A;&#x79CD;&#x914D;&#x7F6E;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x662F;&#x4E00;&#x4E2A;altsetting&#xFF0C;&#x7C7B;&#x578B;&#x662F;usb_host_interface&#xFF0C;&#x6BCF;&#x4E2A;altsetting&#x5305;&#x542B;&#x4E86;&#x4E00;&#x4E2A;descriptor&#xFF08;&#x8BB0;&#x5F55;&#x4E86;&#x5F53;&#x524D;interface&#x548C;&#x5F53;&#x524D;interface&#x7684;altsetting&#x7684;&#x4FE1;&#x606F;&#xFF09;&#xFF0C;&#x548C;&#x4E00;&#x7EC4;endpoint&#xFF08;&#x5305;&#x542B;&#x4E86;endpoint&#x7684;descriptor&#x548C;&#x5BF9;&#x5E94;&#x7684;urb_list&#xFF09;&#x3002;</div><div>&#xA0; &#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;Alternate settings allow a portion of the device configuration to be varied while other interfaces remain in&#xA0;operation. &#xA0;-- USB 2.0 spec.</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0;The default setting for an interface is always alternate setting zero.The SetInterface() request is used to select an alternate setting or to return to the default setting. &#xA0;&#xA0;-- USB 2.0 spec.</div><div>&#xA0; &#xA0; &#xA0;4&#xFF09;&#x6CE8;&#x610F;&#x4E0D;&#x540C;&#x7684;DescriptorType&#x503C;&#xFF0C;&#x4F1A;&#x6709;&#x4E0D;&#x540C;descriptor&#x7684;&#x683C;&#x5F0F;</div><div><br></div><div><br></div>2. USB&#x8BBE;&#x5907;&#x95F4;&#x7684;&#x901A;&#x8BAF;&#x7684;&#x57FA;&#x672C;&#x5355;&#x4F4D;&#x4E3A;endpoint&#xFF0C;&#x6709;4&#x79CD;ep&#xFF0C;&#x5BF9;&#x5E94;&#x5230;4&#x4E2D;USB&#x4F20;&#x8F93;&#x7C7B;&#x578B;&#xFF1A;control&#xFF0C;bulk&#xFF0C;interrupt&#xFF0C;isochronous&#x3002;&#x6240;&#x8C13;&#x7684;pipe&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6307;&#x5B9A;&#x4E86;&#x7684;&#x76EE;&#x7684;ep&#xFF0C;&#x5F88;&#x5F62;&#x8C61;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x60F3;&#x8C61;&#x6210;&#x4E00;&#x4E2A;&#x7BA1;&#x9053;&#x3002;&#x8868;&#x5F81;&#x8D77;&#x6765;&#x5C31;&#x662F;&#x4E00;&#x4E2A;int&#x7C7B;&#x578B;&#xFF0C;&#x5305;&#x542B;&#x4E86;&#x76EE;&#x7684;ep&#x4FE1;&#x606F;&#xFF08;8&#x4F4D;&#xFF09;&#x548C;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x4FE1;&#x606F;&#x3002;<div><br></div><div>3. USB sysfs&#x540D;&#x5B57;&#x89E3;&#x6790;</div><div><img class=\"enMedia\" src=\"/images/USB&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;/sysfs&#x547D;&#x540D;.jpg\" hash=\"364251971225dd3ebb0a891194318f2e\" align alt longdesc width height border hspace vspace usemap style=\"cursor: default;cursor: default;cursor: default;cursor: default;\" title lang xml:lang dir></div><div>sysfs&#x4E2D;&#x53EA;&#x663E;&#x793A;&#x4E86;&#x548C;&#x5F53;&#x524D;&#x914D;&#x7F6E;&#x548C;&#x63A5;&#x53E3;&#xFF0C;&#x6240;&#x6709;&#x53EF;&#x9009;&#x7684;&#x5176;&#x4ED6;&#x914D;&#x7F6E;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x67E5;&#x770B;usbfs(/proc/bus/usb)&#x6765;&#x83B7;&#x5F97;&#x9700;&#x8981;&#x7684;&#x4FE1;&#x606F;</div><div><br></div><div>4. 1&#xFF09;USB&#x8BBE;&#x5907;&#x4E4B;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#x901A;&#x8FC7;urb&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x5F02;&#x6B65;&#x901A;&#x4FE1;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x540C;&#x6B65;&#x901A;&#x4FE1;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5373;&#x7ED5;&#x5F00;urb&#x76F4;&#x63A5;&#x4F20;&#x8F93;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x79CD;&#x540C;&#x6B65;&#x65B9;&#x5F0F;&#x53EA;&#x6709;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x652F;&#x6301;&#xFF0C;&#x5206;&#x522B;&#x4E3A;usb_bulk_msg&#x548C;usb_control_msg&#x3002;</div><div>&#xA0; &#xA0; 2&#xFF09;&#x63A7;&#x5236;&#xFF0C;&#x4E2D;&#x65AD;&#xFF0C;&#x6279;&#x91CF;&#xFF0C;&#x7B49;&#x65F6;&#x56DB;&#x79CD;urb&#x53EA;&#x6709;&#x7B49;&#x65F6;urb&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x624B;&#x52A8;&#x7684;&#x521D;&#x59CB;&#x5316;&#x3002;&#x5176;&#x4ED6;&#x7684;&#x5747;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5F62;&#x4E3A;usb_fill_xxx_urb&#x7684;&#x51FD;&#x6570;&#x6765;&#x4F5C;&#x521D;&#x59CB;&#x5316;&#x3002;</div><div>&#xA0; &#xA0; 3&#xFF09;&#x901A;&#x8FC7;usb_submit_urb&#x6765;&#x63D0;&#x4EA4;urb&#x7ED9;USB core&#x3002;urb&#x88AB;&#x5904;&#x7406;&#x5B8C;&#x540E;&#x4F1A;&#x8C03;&#x7528;urb&#x6CE8;&#x518C;&#x7684;complete&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x505A;&#x7ED3;&#x675F;&#x5DE5;&#x4F5C;&#x3002;</div><div>5. usb_driver&#x901A;&#x8FC7;usb_device_id&#x6570;&#x7EC4;&#x544A;&#x8BC9;USB core&#xFF0C;&#x672C;&#x9A71;&#x52A8;&#x652F;&#x6301;&#x4EC0;&#x4E48;&#x6837;&#x7684;USB&#x8BBE;&#x5907;&#x3002;&#x5F53;&#x6709;&#x8BBE;&#x5907;&#x63D2;&#x5165;&#x65F6;&#xFF0C;USB core&#x6765;&#x5224;&#x65AD;&#x54EA;&#x4E2A;&#x9A71;&#x52A8;&#x652F;&#x6301;&#x8BE5;&#x8BBE;&#x5907;&#xFF0C;&#x627E;&#x5230;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x8C03;&#x7528;usb_driver-&gt;probe&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x3002;&#x5E76;&#x5728;&#x9000;&#x51FA;&#x65F6;&#x8C03;&#x7528;disconnect&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x3002;</div><div><br></div><div>6. &#x4E3A;&#x4E86;&#x4F7F;&#x7528;&#x4F20;&#x7EDF;&#x7684;&#x5B57;&#x7B26;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x53EF;&#x4EE5;&#x8C03;&#x7528;usb_register_dev&#x6765;&#x6CE8;&#x518C;USB&#x8BBE;&#x5907;</div><div><br></div><div><br></div><div><br></div></div>",
            "tags": [
                "Linux",
                "USB",
                "Linux Device Drivers"
            ]
        }
    ]
}